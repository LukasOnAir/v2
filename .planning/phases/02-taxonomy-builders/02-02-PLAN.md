---
phase: 02-taxonomy-builders
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/components/taxonomy/TaxonomyNode.tsx
  - src/components/taxonomy/TaxonomyTree.tsx
  - src/components/taxonomy/TaxonomyToolbar.tsx
  - src/components/taxonomy/TaxonomyTabs.tsx
  - src/pages/TaxonomyPage.tsx
autonomous: false

must_haves:
  truths:
    - "User can create risk items at any level up to 5 deep"
    - "User can create process items at any level up to 5 deep"
    - "User can edit name via double-click inline editing"
    - "User can delete items via hover-revealed delete button"
    - "User can drag items to reorder and reparent"
    - "Each item shows auto-generated hierarchical ID (1.2.3 format)"
    - "Visual tree displays hierarchy with indentation and level colors"
    - "User can expand/collapse branches"
    - "User can search/filter items"
    - "User can switch between Risk and Process taxonomies via tabs"
    - "Changes persist after browser refresh"
  artifacts:
    - path: "src/components/taxonomy/TaxonomyNode.tsx"
      provides: "Custom tree node renderer"
      min_lines: 50
    - path: "src/components/taxonomy/TaxonomyTree.tsx"
      provides: "Tree wrapper using react-arborist"
      min_lines: 60
    - path: "src/components/taxonomy/TaxonomyToolbar.tsx"
      provides: "Toolbar with expand/collapse, search, toggles"
      min_lines: 30
    - path: "src/components/taxonomy/TaxonomyTabs.tsx"
      provides: "Tab switcher for Risk/Process"
      min_lines: 20
    - path: "src/pages/TaxonomyPage.tsx"
      provides: "Complete taxonomy page composition"
      min_lines: 30
  key_links:
    - from: "src/components/taxonomy/TaxonomyTree.tsx"
      to: "src/stores/taxonomyStore.ts"
      via: "useTaxonomyStore hook for state"
      pattern: "useTaxonomyStore"
    - from: "src/components/taxonomy/TaxonomyTree.tsx"
      to: "react-arborist"
      via: "Tree component from library"
      pattern: "import.*Tree.*from.*react-arborist"
    - from: "src/components/taxonomy/TaxonomyNode.tsx"
      to: "src/types/taxonomy.ts"
      via: "TaxonomyItem type for node data"
      pattern: "TaxonomyItem"
    - from: "src/pages/TaxonomyPage.tsx"
      to: "src/components/taxonomy/*"
      via: "imports all taxonomy components"
      pattern: "from.*components/taxonomy"
---

<objective>
Build the complete taxonomy builder UI with react-arborist: custom node renderer, tree wrapper, toolbar, tabs, and integrated TaxonomyPage.

Purpose: Deliver the full CRUD interface for Risk and Process taxonomies with drag-drop, inline editing, and visual hierarchy.
Output: Complete taxonomy components and updated TaxonomyPage
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-taxonomy-builders/02-CONTEXT.md
@.planning/phases/02-taxonomy-builders/02-RESEARCH.md

# Prior plan summary (required - provides types and store)
@.planning/phases/02-taxonomy-builders/02-01-SUMMARY.md

# Existing patterns
@src/stores/uiStore.ts
@src/components/layout/Layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaxonomyNode and TaxonomyTree components</name>
  <files>src/components/taxonomy/TaxonomyNode.tsx, src/components/taxonomy/TaxonomyTree.tsx</files>
  <action>
Create the tree components using react-arborist.

**TaxonomyNode.tsx** - Custom node renderer:
- Receives `NodeRendererProps<TaxonomyItem>` from react-arborist
- Displays: expand/collapse chevron (ChevronRight/ChevronDown from lucide-react), hierarchical ID badge, name, description
- Double-click name to enter edit mode (uses node.edit(), node.submit(), node.reset())
- Hover reveals action buttons: add child (+), delete (Trash2 icon)
- Level-based left border color using LEVEL_COLORS array (5 distinct colors for 5 levels)
- Handle node.isLeaf (no chevron), node.isEditing (show input), node.isSelected (highlight)
- Apply dark theme styling (bg-surface-elevated on hover, text-text-primary/secondary)
- Description can be inline-editable via separate click handler (not using react-arborist's edit mode)

**TaxonomyTree.tsx** - Tree wrapper component:
- Props: `type: 'risks' | 'processes'` to determine which store data to use
- Uses `useTaxonomyStore()` to get/set data based on type prop
- Configures react-arborist Tree with:
  - `data` prop with items from store (already has hierarchicalIds)
  - `onCreate`, `onRename`, `onMove`, `onDelete` handlers that update store
  - `openByDefault={true}` (all expanded by default per CONTEXT.md)
  - `width="100%"`, height calculated from container
  - `indent={24}`, `rowHeight={48}` (enough for ID + name + description)
  - `overscanCount={5}` for virtualization
- Expose tree ref via forwardRef for parent to call expandAll/collapseAll
- Search support: `searchTerm` prop, `searchMatch` function matching name or description

Handler implementations:
- `onCreate`: Generate new TaxonomyItem with crypto.randomUUID(), add to tree, call setRisks/setProcesses (which regenerates IDs)
- `onRename`: Update item name, call setter
- `onMove`: React-arborist provides new structure, call setter
- `onDelete`: Remove items by ids, call setter

Note: Use react-arborist's uncontrolled mode with handlers per RESEARCH.md recommendation.
  </action>
  <verify>
- Files exist in src/components/taxonomy/
- `npx tsc --noEmit` passes
- No import errors for react-arborist, lucide-react, or store
  </verify>
  <done>TaxonomyNode renders with ID/name/description and action buttons; TaxonomyTree wraps react-arborist with store integration</done>
</task>

<task type="auto">
  <name>Task 2: Create TaxonomyToolbar and TaxonomyTabs, update TaxonomyPage</name>
  <files>src/components/taxonomy/TaxonomyToolbar.tsx, src/components/taxonomy/TaxonomyTabs.tsx, src/pages/TaxonomyPage.tsx</files>
  <action>
**TaxonomyToolbar.tsx** - Header toolbar above tree:
- Props: `treeRef` (to call expandAll/collapseAll), `searchTerm`, `onSearchChange`, `title`
- Displays title ("Risk Taxonomy" or "Process Taxonomy")
- Search input with Search icon from lucide-react
- Expand All / Collapse All buttons (using treeRef.current?.openAll() / closeAll())
- "Add Root Item" button that triggers tree.create() at root level
- Optional: Show/hide toggles for IDs and descriptions (store in local state or uiStore)

**TaxonomyTabs.tsx** - Tab switcher:
- Props: `activeTab`, `onTabChange`
- Two tabs: "Risk Taxonomy" and "Process Taxonomy"
- Styled as pill tabs with amber accent on active
- Icons: AlertTriangle for risks, GitBranch for processes (lucide-react)

**TaxonomyPage.tsx** - Complete page composition:
- Manages active tab state: `useState<'risks' | 'processes'>('risks')`
- Manages search term state: `useState('')`
- Refs for both trees (to pass to toolbar)
- Layout:
  1. TaxonomyTabs at top
  2. TaxonomyToolbar below tabs
  3. TaxonomyTree taking remaining space
- Include "Add root item" button at BOTTOM of tree as well (per CONTEXT.md "both top AND bottom")
- Empty state: When no items, show call-to-action "Add your first risk" / "Add your first process"

Ensure proper container height so tree virtualization works (use flex-1 or explicit height calculation).
  </action>
  <verify>
- All components exist and import correctly
- `npx tsc --noEmit` passes
- `npm run dev` shows taxonomy page with tabs, toolbar, and empty state
  </verify>
  <done>Complete taxonomy UI with tabs, toolbar, tree, and empty state</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete taxonomy builder UI with:
- Tab switching between Risk and Process taxonomies
- Tree component with react-arborist (drag-drop, inline edit, keyboard nav)
- Custom node renderer showing ID, name, description
- Level-based color coding
- Add/edit/delete functionality
- Search/filter
- Expand/collapse all
- LocalStorage persistence
  </what-built>
  <how-to-verify>
1. Visit http://localhost:5173 (ensure dev server running with `npm run dev`)
2. Navigate to Taxonomy page (should be default view)

**Test Risk Taxonomy (default tab):**
3. Click "Add Root Item" - should create a new item
4. Double-click the name to edit it - type "Operational Risk", press Enter
5. Hover over the item - should see + and X buttons appear
6. Click + to add a child - creates nested item
7. Edit the child name to "Process Failure"
8. Add more items to create a 3-level hierarchy (at minimum)
9. Verify hierarchical IDs update automatically (1, 1.1, 1.2, etc.)
10. Drag an item to reorder within its level
11. Drag an item to a different parent (reparenting)
12. Verify IDs regenerate after any move
13. Use search input to filter items
14. Click Expand All / Collapse All
15. Delete an item via the trash icon

**Test Process Taxonomy:**
16. Click "Process Taxonomy" tab
17. Repeat steps 3-15 for processes
18. Verify Risk and Process data are separate

**Test Persistence:**
19. Add several items to both taxonomies
20. Hard refresh the browser (Ctrl+F5 or Cmd+Shift+R)
21. Verify all items are still there with correct IDs
22. Check DevTools > Application > LocalStorage > riskguard-taxonomy

**Test Edge Cases:**
23. Try adding 5 levels deep - should work
24. Try adding 6th level - should either prevent or limit (5 max per requirement)
25. Verify keyboard navigation works (arrow keys in tree)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. Both Risk and Process taxonomy builders fully functional
2. All CRUD operations work: create, edit (name), delete
3. Drag-drop works for reorder and reparent
4. Hierarchical IDs auto-generate correctly
5. Data persists to LocalStorage
6. Search/filter works
7. Expand/collapse works
8. 5-level depth supported
</verification>

<success_criteria>
Requirements fulfilled:
- RTAX-01: User can create hierarchical risk taxonomy with up to 5 levels
- RTAX-02: Risks have auto-generated hierarchical IDs (e.g., 1.1.1)
- RTAX-03: Each risk has name and description fields
- RTAX-04: Visual tree structure displays the taxonomy
- RTAX-05: User can add, edit, delete risks at any level
- PTAX-01 through PTAX-05: Same as above for processes

Phase success criteria met:
1. User can create, edit, and delete risk items at any level (up to 5 deep)
2. User can create, edit, and delete process items at any level (up to 5 deep)
3. Each item shows auto-generated hierarchical ID (e.g., 1.2.3)
4. Visual tree structure displays the hierarchy clearly
5. Changes persist after browser refresh
</success_criteria>

<output>
After completion, create `.planning/phases/02-taxonomy-builders/02-02-SUMMARY.md`
</output>
