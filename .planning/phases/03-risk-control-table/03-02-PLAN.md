---
phase: 03-risk-control-table
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/rct/ScoreSelector.tsx
  - src/components/rct/HeatmapCell.tsx
  - src/components/rct/ControlPanel.tsx
  - src/components/rct/RCTTable.tsx
  - src/components/rct/index.ts
autonomous: true

must_haves:
  truths:
    - "User can enter gross probability score (1-5) via visual selector"
    - "User can enter gross impact score (1-5) via visual selector"
    - "Gross risk score auto-calculates as probability x impact"
    - "User can open control panel and add controls"
    - "Net score displays as lowest net score from controls"
  artifacts:
    - path: "src/components/rct/ScoreSelector.tsx"
      provides: "Visual 1-5 scale selector with labels"
      min_lines: 40
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Side panel for control management with Radix Dialog"
      min_lines: 80
    - path: "src/components/rct/HeatmapCell.tsx"
      provides: "Reusable heatmap cell component"
      min_lines: 20
  key_links:
    - from: "src/components/rct/ScoreSelector.tsx"
      to: "src/stores/rctStore.ts"
      via: "updateRow action"
      pattern: "updateRow"
    - from: "src/components/rct/ControlPanel.tsx"
      to: "src/stores/rctStore.ts"
      via: "addControl/updateControl/removeControl actions"
      pattern: "(addControl|updateControl|removeControl)"
    - from: "src/components/rct/RCTTable.tsx"
      to: "src/components/rct/ScoreSelector.tsx"
      via: "cell renderer import"
      pattern: "ScoreSelector"
---

<objective>
Add interactive scoring and control management to RCT

Purpose: Enable users to assess risks by entering probability and impact scores, and manage controls to mitigate risks that exceed appetite. This completes the core RCT workflow.

Output: Interactive score selectors in table cells, auto-calculating gross/net scores, and a side panel for adding/editing controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-risk-control-table/03-CONTEXT.md
@.planning/phases/03-risk-control-table/03-RESEARCH.md
@src/components/rct/RCTTable.tsx
@src/stores/rctStore.ts
@src/types/rct.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScoreSelector and HeatmapCell components</name>
  <files>
    src/components/rct/ScoreSelector.tsx
    src/components/rct/HeatmapCell.tsx
    src/components/rct/index.ts
  </files>
  <action>
Create src/components/rct/ScoreSelector.tsx - Visual 1-5 scale selector:

```typescript
import { clsx } from 'clsx'

const PROBABILITY_LABELS = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain']
const IMPACT_LABELS = ['Negligible', 'Minor', 'Moderate', 'Major', 'Catastrophic']

interface ScoreSelectorProps {
  value: number | null
  onChange: (value: number) => void
  type: 'probability' | 'impact'
  disabled?: boolean
}

export function ScoreSelector({ value, onChange, type, disabled = false }: ScoreSelectorProps) {
  const labels = type === 'probability' ? PROBABILITY_LABELS : IMPACT_LABELS

  return (
    <div className="flex gap-1">
      {[1, 2, 3, 4, 5].map(score => (
        <button
          key={score}
          onClick={() => !disabled && onChange(score)}
          disabled={disabled}
          className={clsx(
            'w-7 h-7 rounded text-xs font-medium transition-all duration-150',
            'focus:outline-none focus:ring-2 focus:ring-accent-500 focus:ring-offset-1 focus:ring-offset-surface-base',
            value === score
              ? 'bg-accent-500 text-white shadow-sm'
              : 'bg-surface-overlay text-text-secondary hover:bg-surface-border hover:text-text-primary',
            disabled && 'opacity-50 cursor-not-allowed'
          )}
          title={`${score} - ${labels[score - 1]}`}
        >
          {score}
        </button>
      ))}
    </div>
  )
}

// Inline display variant (for showing value without interaction)
export function ScoreDisplay({ value, type }: { value: number | null; type: 'probability' | 'impact' }) {
  const labels = type === 'probability' ? PROBABILITY_LABELS : IMPACT_LABELS

  if (value === null) return <span className="text-text-muted">-</span>

  return (
    <span className="text-text-primary" title={labels[value - 1]}>
      {value}
    </span>
  )
}
```

Create src/components/rct/HeatmapCell.tsx - Reusable heatmap cell:

```typescript
import { getHeatmapColor, getContrastingText, getAppetiteColor } from '@/utils/heatmapColors'

interface HeatmapCellProps {
  score: number | null
  variant?: 'score' | 'appetite'
}

export function HeatmapCell({ score, variant = 'score' }: HeatmapCellProps) {
  if (score === null) {
    return (
      <div className="w-full h-8 flex items-center justify-center text-text-muted">
        -
      </div>
    )
  }

  const bgColor = variant === 'appetite' ? getAppetiteColor(score) : getHeatmapColor(score)
  const textColor = getContrastingText(bgColor)

  const displayValue = variant === 'appetite' && score >= 0 ? `+${score}` : score

  return (
    <div
      className="w-full h-8 flex items-center justify-center font-medium rounded text-sm"
      style={{ backgroundColor: bgColor, color: textColor }}
    >
      {displayValue}
    </div>
  )
}
```

Update src/components/rct/index.ts to export new components:

```typescript
export { RCTTable } from './RCTTable'
export { ScoreSelector, ScoreDisplay } from './ScoreSelector'
export { HeatmapCell } from './HeatmapCell'
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ScoreSelector provides visual 1-5 scale with hover labels. HeatmapCell provides reusable colored score display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ControlPanel side panel component</name>
  <files>
    src/components/rct/ControlPanel.tsx
    src/components/rct/index.ts
  </files>
  <action>
Create src/components/rct/ControlPanel.tsx using Radix Dialog for slide-out panel:

```typescript
import { useState } from 'react'
import * as Dialog from '@radix-ui/react-dialog'
import { X, Plus, Trash2 } from 'lucide-react'
import { nanoid } from 'nanoid'
import { useRCTStore } from '@/stores/rctStore'
import { ScoreSelector } from './ScoreSelector'
import { HeatmapCell } from './HeatmapCell'
import type { RCTRow, Control } from '@/types/rct'

interface ControlPanelProps {
  isOpen: boolean
  onClose: () => void
  row: RCTRow | null
}

export function ControlPanel({ isOpen, onClose, row }: ControlPanelProps) {
  const { addControl, updateControl, removeControl } = useRCTStore()
  const [newDescription, setNewDescription] = useState('')

  if (!row) return null

  const handleAddControl = () => {
    if (!newDescription.trim()) return

    const control: Control = {
      id: nanoid(),
      description: newDescription.trim(),
      netProbability: null,
      netImpact: null,
      netScore: null,
    }

    addControl(row.id, control)
    setNewDescription('')
  }

  const handleUpdateControlScore = (
    controlId: string,
    field: 'netProbability' | 'netImpact',
    value: number
  ) => {
    updateControl(row.id, controlId, { [field]: value })
  }

  const handleRemoveControl = (controlId: string) => {
    removeControl(row.id, controlId)
  }

  return (
    <Dialog.Root open={isOpen} onOpenChange={(open) => !open && onClose()}>
      <Dialog.Portal>
        <Dialog.Overlay className="fixed inset-0 bg-black/60 z-40" />
        <Dialog.Content className="fixed right-0 top-0 h-full w-[500px] bg-surface-elevated border-l border-surface-border shadow-xl z-50 flex flex-col overflow-hidden">
          {/* Header */}
          <div className="flex items-center justify-between p-4 border-b border-surface-border">
            <div>
              <Dialog.Title className="text-lg font-semibold text-text-primary">
                Controls
              </Dialog.Title>
              <Dialog.Description className="text-sm text-text-secondary mt-1">
                {row.riskName} x {row.processName}
              </Dialog.Description>
            </div>
            <Dialog.Close asChild>
              <button className="p-2 rounded-lg hover:bg-surface-overlay transition-colors">
                <X size={20} className="text-text-secondary" />
              </button>
            </Dialog.Close>
          </div>

          {/* Risk context */}
          <div className="p-4 border-b border-surface-border bg-surface-overlay/50">
            <div className="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span className="text-text-muted">Gross Score</span>
                <div className="mt-1">
                  <HeatmapCell score={row.grossScore} />
                </div>
              </div>
              <div>
                <span className="text-text-muted">Appetite</span>
                <div className="mt-1 text-text-primary font-medium">
                  {row.riskAppetite}
                </div>
              </div>
              <div>
                <span className="text-text-muted">Net Score</span>
                <div className="mt-1">
                  <HeatmapCell score={row.netScore} />
                </div>
              </div>
            </div>
          </div>

          {/* Controls list */}
          <div className="flex-1 overflow-auto p-4">
            {row.controls.length === 0 ? (
              <p className="text-text-secondary text-sm text-center py-8">
                No controls added yet. Add a control to mitigate this risk.
              </p>
            ) : (
              <div className="space-y-4">
                {row.controls.map((control, index) => (
                  <div
                    key={control.id}
                    className="bg-surface-overlay rounded-lg p-4 border border-surface-border"
                  >
                    <div className="flex items-start justify-between gap-3 mb-3">
                      <div>
                        <span className="text-text-muted text-xs">Control {index + 1}</span>
                        <p className="text-text-primary text-sm mt-1">
                          {control.description}
                        </p>
                      </div>
                      <button
                        onClick={() => handleRemoveControl(control.id)}
                        className="p-1.5 rounded hover:bg-red-500/20 text-text-muted hover:text-red-400 transition-colors"
                        title="Remove control"
                      >
                        <Trash2 size={16} />
                      </button>
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className="text-xs text-text-muted block mb-1.5">
                          Net Probability
                        </label>
                        <ScoreSelector
                          value={control.netProbability}
                          onChange={(v) => handleUpdateControlScore(control.id, 'netProbability', v)}
                          type="probability"
                        />
                      </div>
                      <div>
                        <label className="text-xs text-text-muted block mb-1.5">
                          Net Impact
                        </label>
                        <ScoreSelector
                          value={control.netImpact}
                          onChange={(v) => handleUpdateControlScore(control.id, 'netImpact', v)}
                          type="impact"
                        />
                      </div>
                      <div>
                        <label className="text-xs text-text-muted block mb-1.5">
                          Net Score
                        </label>
                        <HeatmapCell score={control.netScore} />
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Add control form */}
          <div className="p-4 border-t border-surface-border">
            <div className="flex gap-2">
              <input
                type="text"
                value={newDescription}
                onChange={(e) => setNewDescription(e.target.value)}
                placeholder="Control description..."
                className="flex-1 px-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-accent-500"
                onKeyDown={(e) => e.key === 'Enter' && handleAddControl()}
              />
              <button
                onClick={handleAddControl}
                disabled={!newDescription.trim()}
                className="px-4 py-2 bg-accent-500 text-white rounded-lg font-medium hover:bg-accent-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
              >
                <Plus size={16} />
                Add
              </button>
            </div>
          </div>
        </Dialog.Content>
      </Dialog.Portal>
    </Dialog.Root>
  )
}
```

Update src/components/rct/index.ts:

```typescript
export { RCTTable } from './RCTTable'
export { ScoreSelector, ScoreDisplay } from './ScoreSelector'
export { HeatmapCell } from './HeatmapCell'
export { ControlPanel } from './ControlPanel'
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ControlPanel provides slide-out side panel with control list, add form, and score selectors. Net score auto-calculates.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate scoring and controls into RCTTable</name>
  <files>
    src/components/rct/RCTTable.tsx
  </files>
  <action>
Update src/components/rct/RCTTable.tsx to use interactive score selectors and control panel:

1. Add state for selected row and panel open state
2. Update column definitions to use ScoreSelector for probability/impact
3. Add "Controls" button column that opens ControlPanel
4. Use HeatmapCell for score display columns

Key changes:

```typescript
import { useMemo, useRef, useCallback, useState } from 'react'
import {
  useReactTable,
  getCoreRowModel,
  getFilteredRowModel,
  ColumnDef,
  flexRender,
} from '@tanstack/react-table'
import { useVirtualizer } from '@tanstack/react-virtual'
import { Settings2 } from 'lucide-react'
import { useRCTStore } from '@/stores/rctStore'
import { useTaxonomyStore } from '@/stores/taxonomyStore'
import { generateRCTRows } from '@/utils/rctGenerator'
import { ScoreSelector } from './ScoreSelector'
import { HeatmapCell } from './HeatmapCell'
import { ControlPanel } from './ControlPanel'
import type { RCTRow } from '@/types/rct'

export function RCTTable() {
  const parentRef = useRef<HTMLDivElement>(null)
  const { rows, setRows, updateRow, columnVisibility } = useRCTStore()
  const { risks, processes } = useTaxonomyStore()

  // Control panel state
  const [selectedRowId, setSelectedRowId] = useState<string | null>(null)
  const [isPanelOpen, setIsPanelOpen] = useState(false)

  const selectedRow = useMemo(
    () => rows.find(r => r.id === selectedRowId) ?? null,
    [rows, selectedRowId]
  )

  const openControlPanel = useCallback((rowId: string) => {
    setSelectedRowId(rowId)
    setIsPanelOpen(true)
  }, [])

  const closeControlPanel = useCallback(() => {
    setIsPanelOpen(false)
  }, [])

  // Check if taxonomies have leaf items
  const hasData = useMemo(() => {
    return risks.length > 0 && processes.length > 0
  }, [risks, processes])

  // Generate rows button handler
  const handleGenerateRows = useCallback(() => {
    const newRows = generateRCTRows(risks, processes)
    setRows(newRows)
  }, [risks, processes, setRows])

  // Handle score changes
  const handleScoreChange = useCallback((
    rowId: string,
    field: 'grossProbability' | 'grossImpact' | 'riskAppetite',
    value: number
  ) => {
    updateRow(rowId, { [field]: value })
  }, [updateRow])

  // Column definitions with interactive cells
  const columns = useMemo<ColumnDef<RCTRow>[]>(() => [
    // Risk hierarchy columns
    { accessorKey: 'riskL1Id', header: 'Risk L1 ID', size: 80 },
    { accessorKey: 'riskL1Name', header: 'Risk L1 Name', size: 150 },
    { accessorKey: 'riskL2Id', header: 'Risk L2 ID', size: 80 },
    { accessorKey: 'riskL2Name', header: 'Risk L2 Name', size: 150 },
    { accessorKey: 'riskL3Id', header: 'Risk L3 ID', size: 80 },
    { accessorKey: 'riskL3Name', header: 'Risk L3 Name', size: 150 },
    { accessorKey: 'riskL4Id', header: 'Risk L4 ID', size: 80 },
    { accessorKey: 'riskL4Name', header: 'Risk L4 Name', size: 150 },
    { accessorKey: 'riskL5Id', header: 'Risk L5 ID', size: 80 },
    { accessorKey: 'riskL5Name', header: 'Risk L5 Name', size: 150 },
    // Process hierarchy columns
    { accessorKey: 'processL1Id', header: 'Process L1 ID', size: 80 },
    { accessorKey: 'processL1Name', header: 'Process L1 Name', size: 150 },
    { accessorKey: 'processL2Id', header: 'Process L2 ID', size: 80 },
    { accessorKey: 'processL2Name', header: 'Process L2 Name', size: 150 },
    { accessorKey: 'processL3Id', header: 'Process L3 ID', size: 80 },
    { accessorKey: 'processL3Name', header: 'Process L3 Name', size: 150 },
    { accessorKey: 'processL4Id', header: 'Process L4 ID', size: 80 },
    { accessorKey: 'processL4Name', header: 'Process L4 Name', size: 150 },
    { accessorKey: 'processL5Id', header: 'Process L5 ID', size: 80 },
    { accessorKey: 'processL5Name', header: 'Process L5 Name', size: 150 },
    // Scoring columns with interactive cells
    {
      accessorKey: 'grossProbability',
      header: 'Gross Prob.',
      size: 180,
      cell: ({ row }) => (
        <ScoreSelector
          value={row.original.grossProbability}
          onChange={(v) => handleScoreChange(row.original.id, 'grossProbability', v)}
          type="probability"
        />
      ),
    },
    {
      accessorKey: 'grossImpact',
      header: 'Gross Impact',
      size: 180,
      cell: ({ row }) => (
        <ScoreSelector
          value={row.original.grossImpact}
          onChange={(v) => handleScoreChange(row.original.id, 'grossImpact', v)}
          type="impact"
        />
      ),
    },
    {
      accessorKey: 'grossScore',
      header: 'Gross Score',
      size: 100,
      cell: ({ row }) => <HeatmapCell score={row.original.grossScore} />,
    },
    {
      accessorKey: 'riskAppetite',
      header: 'Appetite',
      size: 80,
      cell: ({ row }) => (
        <input
          type="number"
          min={1}
          max={25}
          value={row.original.riskAppetite}
          onChange={(e) => handleScoreChange(row.original.id, 'riskAppetite', Number(e.target.value))}
          className="w-16 px-2 py-1 bg-surface-overlay border border-surface-border rounded text-sm text-text-primary text-center focus:outline-none focus:ring-1 focus:ring-accent-500"
        />
      ),
    },
    {
      accessorKey: 'withinAppetite',
      header: 'Within Appetite',
      size: 120,
      cell: ({ row }) => <HeatmapCell score={row.original.withinAppetite} variant="appetite" />,
    },
    {
      accessorKey: 'netScore',
      header: 'Net Score',
      size: 100,
      cell: ({ row }) => <HeatmapCell score={row.original.netScore} />,
    },
    // Controls column
    {
      id: 'controls',
      header: 'Controls',
      size: 100,
      cell: ({ row }) => (
        <button
          onClick={() => openControlPanel(row.original.id)}
          className="flex items-center gap-1.5 px-2 py-1 text-xs rounded bg-surface-overlay hover:bg-surface-border transition-colors"
        >
          <Settings2 size={14} />
          <span>{row.original.controls.length}</span>
        </button>
      ),
    },
  ], [handleScoreChange, openControlPanel])

  // Table instance
  const table = useReactTable({
    data: rows,
    columns,
    state: {
      columnVisibility,
    },
    getCoreRowModel: getCoreRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
  })

  // Virtualizer for rows
  const { rows: tableRows } = table.getRowModel()
  const virtualizer = useVirtualizer({
    count: tableRows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 56, // Slightly taller for interactive cells
    overscan: 10,
  })

  // Empty state - no taxonomies
  if (!hasData) {
    return (
      <div className="bg-surface-elevated rounded-lg p-6 border border-surface-border text-center">
        <p className="text-text-secondary mb-4">
          Build your Risk and Process taxonomies first to generate the Risk Control Table.
        </p>
        <a
          href="/taxonomy"
          className="text-accent-500 hover:text-accent-400 font-medium transition-colors"
        >
          Go to Taxonomies
        </a>
      </div>
    )
  }

  // No rows generated yet
  if (rows.length === 0) {
    return (
      <div className="bg-surface-elevated rounded-lg p-6 border border-surface-border text-center">
        <p className="text-text-secondary mb-4">
          Taxonomies are ready. Generate the Risk Control Table from your risk and process combinations.
        </p>
        <button
          onClick={handleGenerateRows}
          className="px-4 py-2 bg-accent-500 text-white rounded-lg font-medium hover:bg-accent-600 transition-colors"
        >
          Generate RCT
        </button>
      </div>
    )
  }

  return (
    <div className="flex flex-col h-full">
      {/* Toolbar */}
      <div className="flex items-center gap-4 mb-4">
        <span className="text-text-secondary text-sm">
          {rows.length} rows
        </span>
        <button
          onClick={handleGenerateRows}
          className="px-3 py-1.5 text-sm bg-surface-elevated border border-surface-border rounded hover:bg-surface-overlay transition-colors"
        >
          Regenerate
        </button>
      </div>

      {/* Table container */}
      <div
        ref={parentRef}
        className="flex-1 overflow-auto border border-surface-border rounded-lg"
      >
        <table className="w-full border-collapse">
          <thead className="sticky top-0 bg-surface-elevated z-10">
            {table.getHeaderGroups().map(headerGroup => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map(header => (
                  <th
                    key={header.id}
                    className="px-3 py-2 text-left text-sm font-medium text-text-secondary border-b border-surface-border whitespace-nowrap"
                    style={{ width: header.getSize() }}
                  >
                    {header.isPlaceholder
                      ? null
                      : flexRender(header.column.columnDef.header, header.getContext())}
                  </th>
                ))}
              </tr>
            ))}
          </thead>
          <tbody
            style={{
              height: `${virtualizer.getTotalSize()}px`,
              position: 'relative',
            }}
          >
            {virtualizer.getVirtualItems().map(virtualRow => {
              const row = tableRows[virtualRow.index]
              return (
                <tr
                  key={row.id}
                  className="hover:bg-surface-overlay/50 transition-colors"
                  style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    width: '100%',
                    height: `${virtualRow.size}px`,
                    transform: `translateY(${virtualRow.start}px)`,
                  }}
                >
                  {row.getVisibleCells().map(cell => (
                    <td
                      key={cell.id}
                      className="px-3 py-2 text-sm text-text-primary border-b border-surface-border whitespace-nowrap overflow-hidden text-ellipsis"
                      style={{ width: cell.column.getSize() }}
                    >
                      {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </td>
                  ))}
                </tr>
              )
            })}
          </tbody>
        </table>
      </div>

      {/* Control Panel */}
      <ControlPanel
        isOpen={isPanelOpen}
        onClose={closeControlPanel}
        row={selectedRow}
      />
    </div>
  )
}
```

This is a full replacement of RCTTable.tsx with interactive scoring and control panel integration.
  </action>
  <verify>
Run `npm run dev` and navigate to RCT page.
1. Score selectors: Click probability/impact cells to select 1-5 scores
2. Gross score auto-calculates and shows heatmap color
3. Within appetite shows green (positive) or red (negative)
4. Click Controls button to open side panel
5. Add a control with description
6. Set net probability/impact scores for control
7. Net score updates on main table row
8. Refresh browser - all data persists
  </verify>
  <done>
Interactive scoring with visual selectors, auto-calculating gross/net scores, and full control panel integration. Covers RCT-03, RCT-04, RCT-05, RCT-06, RCT-07, RCT-08.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. ScoreSelector shows 1-5 buttons with hover labels
2. Clicking score updates row immediately
3. Gross score = probability x impact (auto-calculated)
4. Within appetite = appetite - gross score (color coded)
5. Control panel opens with risk context header
6. Can add controls with description
7. Control net scores auto-calculate
8. Row net score = lowest control net score
9. All changes persist after refresh
</verification>

<success_criteria>
- User can enter gross probability (1-5) via visual selector (RCT-03)
- User can enter gross impact (1-5) via visual selector (RCT-04)
- Gross risk score auto-calculates (RCT-05)
- User can set risk appetite threshold (RCT-06)
- Control columns available via side panel (RCT-07)
- Control includes description, net probability, net impact, net score (RCT-08)
</success_criteria>

<output>
After completion, create `.planning/phases/03-risk-control-table/03-02-SUMMARY.md`
</output>
