---
phase: 04-matrix-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/matrixStore.ts
  - src/utils/aggregation.ts
  - src/components/matrix/MatrixGrid.tsx
  - src/components/matrix/MatrixCell.tsx
  - src/components/matrix/MatrixExpandedView.tsx
  - src/components/matrix/MatrixToolbar.tsx
  - src/components/matrix/index.ts
  - src/pages/MatrixPage.tsx
autonomous: true

must_haves:
  truths:
    - "Matrix displays with processes as rows and risks as columns"
    - "Cells show color-coded aggregated scores from child RCT rows"
    - "Clicking a cell shows expandable mini-table with related RCT rows"
    - "User can edit scores directly in expanded view"
    - "User can jump to filtered RCT view from expanded cell"
    - "Matrix auto-updates when taxonomies or scores change"
  artifacts:
    - path: "src/stores/matrixStore.ts"
      provides: "Matrix-specific state (zoom, weights, expanded cell)"
      exports: ["useMatrixStore"]
    - path: "src/utils/aggregation.ts"
      provides: "Weighted average calculation from RCT rows"
      exports: ["calculateWeightedAverage", "matchesHierarchy", "AggregationWeights"]
    - path: "src/components/matrix/MatrixGrid.tsx"
      provides: "Main matrix grid with CSS sticky headers"
      exports: ["MatrixGrid"]
    - path: "src/components/matrix/MatrixCell.tsx"
      provides: "Individual cell with heatmap color and click handler"
      exports: ["MatrixCell"]
    - path: "src/components/matrix/MatrixExpandedView.tsx"
      provides: "Popover mini-table showing related RCT rows"
      exports: ["MatrixExpandedView"]
  key_links:
    - from: "src/components/matrix/MatrixGrid.tsx"
      to: "src/stores/rctStore.ts"
      via: "useRCTStore for rows data"
      pattern: "useRCTStore.*rows"
    - from: "src/components/matrix/MatrixCell.tsx"
      to: "src/utils/aggregation.ts"
      via: "calculateWeightedAverage for cell score"
      pattern: "calculateWeightedAverage"
    - from: "src/components/matrix/MatrixCell.tsx"
      to: "src/utils/heatmapColors.ts"
      via: "getHeatmapColor for cell background"
      pattern: "getHeatmapColor"
    - from: "src/components/matrix/MatrixExpandedView.tsx"
      to: "react-router"
      via: "useNavigate for jump to RCT"
      pattern: "useNavigate.*rct"
---

<objective>
Build the Risk-Process Matrix visualization with scrollable grid, sticky headers, weighted aggregation, and expandable drill-down cells.

Purpose: Enable users to see aggregated risk posture across all risk-process combinations at a glance, with ability to drill down into specific cells.

Output: Working matrix page with CSS Grid layout, position sticky headers on both axes, weighted average scores displayed as heatmap colors, and Radix Popover expandable cells showing related RCT rows.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-matrix-and-polish/04-CONTEXT.md
@.planning/phases/04-matrix-and-polish/04-RESEARCH.md

# Key existing files to reference
@src/stores/rctStore.ts
@src/stores/taxonomyStore.ts
@src/utils/heatmapColors.ts
@src/components/rct/HeatmapCell.tsx
@src/types/rct.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Matrix store and aggregation utilities</name>
  <files>
    src/stores/matrixStore.ts
    src/utils/aggregation.ts
  </files>
  <action>
Create matrixStore.ts following existing Zustand patterns (persist + immer):

```typescript
interface AggregationWeights {
  l1: number; l2: number; l3: number; l4: number; l5: number;
}

interface MatrixState {
  zoomLevel: number                    // 1 = normal, 0.5 = zoomed out, 2 = zoomed in
  showNumbers: boolean                 // Show score numbers in cells (auto-toggle at zoom threshold)
  weights: AggregationWeights          // Default all 1
  expandedCell: { riskId: string; processId: string } | null
  expandedViewColumns: string[]        // Default: ['riskName', 'processName', 'grossScore', 'netScore']
  // Actions
  setZoomLevel: (level: number) => void
  setWeights: (weights: Partial<AggregationWeights>) => void
  setExpandedCell: (cell: { riskId: string; processId: string } | null) => void
  setExpandedViewColumns: (columns: string[]) => void
}
```

Create aggregation.ts with:
1. `matchesHierarchy(row: RCTRow, type: 'risk' | 'process', hierarchyId: string): boolean` - Check if row belongs to a hierarchy node (checks all L1-L5 fields)
2. `calculateWeightedAverage(rows: RCTRow[], riskId: string, processId: string, weights: AggregationWeights, scoreType: 'gross' | 'net'): number | null` - Filter matching rows, calculate weighted average based on deepest level, return null if no valid scores
3. Export `DEFAULT_WEIGHTS` constant with all values = 1

Use memoization-friendly pure functions (no side effects).
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
matrixStore exports useMatrixStore with all state and actions. aggregation.ts exports matchesHierarchy, calculateWeightedAverage, AggregationWeights type, and DEFAULT_WEIGHTS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Matrix grid with sticky headers</name>
  <files>
    src/components/matrix/MatrixGrid.tsx
    src/components/matrix/MatrixCell.tsx
    src/components/matrix/MatrixToolbar.tsx
    src/components/matrix/index.ts
  </files>
  <action>
Create MatrixGrid.tsx:
- Use CSS Grid with `grid-template-columns: 200px repeat(var(--col-count), 60px)`
- Container has `overflow: auto; max-height: calc(100vh - 200px)`
- Column headers (risks): `position: sticky; top: 0; z-index: 2; background: var(--surface-elevated)`
- Row headers (processes): `position: sticky; left: 0; z-index: 2; background: var(--surface-elevated)`
- Corner cell: `position: sticky; top: 0; left: 0; z-index: 3`
- Get leaf nodes from taxonomyStore (items with no children or deepest level)
- Use `useMemo` to compute aggregation map: `Map<'riskId-processId', score>` keyed on `rows` from rctStore

Create MatrixCell.tsx:
- Receives riskId, processId, score props
- Uses getHeatmapColor(score) for background
- Uses getContrastingText(bgColor) for text color
- Shows score number when matrixStore.showNumbers is true (threshold: zoomLevel >= 0.75)
- Cell size: `${60 * zoomLevel}px` width and height
- onClick: set expandedCell in matrixStore

Create MatrixToolbar.tsx:
- Zoom slider (0.5 to 2.0, step 0.25)
- Settings gear icon (placeholder for weight editing - hidden by default per CONTEXT.md)

Create index.ts barrel export.

Style with Tailwind dark theme classes matching existing app (bg-surface, border-surface-border, text-text-primary).
  </action>
  <verify>
Run dev server: `npm run dev`. Navigate to /matrix. Grid displays with scrolling in both directions. Headers stay sticky. Cells show colors.
  </verify>
  <done>
Matrix grid renders with processes as rows, risks as columns. Headers stick during scroll. Cells show heatmap colors based on aggregated scores.
  </done>
</task>

<task type="auto">
  <name>Task 3: Expandable cell drill-down and RCT navigation</name>
  <files>
    src/components/matrix/MatrixExpandedView.tsx
    src/components/matrix/MatrixCell.tsx (update)
    src/pages/MatrixPage.tsx
  </files>
  <action>
Create MatrixExpandedView.tsx:
- Receives riskId, processId, rows (filtered) props
- Displays mini-table with columns: Risk Name, Process Name, Gross Score, Net Score
- Each row is editable: gross probability/impact dropdowns using ScoreDropdown pattern from RCT
- "Jump to RCT" button: navigates to `/rct?riskFilter={riskId}&processFilter={processId}`
- Use existing Tailwind table styling (bg-surface-elevated, border-surface-border)
- Close button in top-right corner

Update MatrixCell.tsx:
- Wrap cell in Radix Popover.Root with open state from matrixStore.expandedCell
- Popover.Content contains MatrixExpandedView
- Click outside closes popover (Radix default behavior)
- Click cell again also closes (toggle expandedCell)

Update MatrixPage.tsx:
- Replace placeholder with full matrix implementation
- Import MatrixGrid, MatrixToolbar
- Layout: toolbar at top, grid below
- Handle empty state: show message if no taxonomies or RCT rows exist

Wire up RCT navigation:
- Use `useNavigate` from react-router
- Build search params with `createSearchParams`
- RCT page should read URL params and apply filters (this is existing functionality from Phase 3)
  </action>
  <verify>
Run dev server. Click a matrix cell. Popover appears with mini-table. Edit a score. Click "Jump to RCT". Navigate to RCT with filters applied. Click outside popover to close.
  </verify>
  <done>
Clicking a cell opens expandable view showing related RCT rows. User can edit scores in expanded view. "Jump to RCT" navigates with filters. Matrix auto-updates when scores change.
  </done>
</task>

</tasks>

<verification>
1. Matrix loads without errors on /matrix route
2. Scrolling horizontally keeps process names visible (left sticky)
3. Scrolling vertically keeps risk names visible (top sticky)
4. Cell colors match aggregated scores (green for low, red for high)
5. Clicking cell opens popover with related RCT rows
6. Editing score in expanded view updates both matrix and RCT
7. "Jump to RCT" navigates correctly with filters
8. Zoom slider changes cell sizes
9. Empty state shows helpful message when no data
</verification>

<success_criteria>
Requirements covered:
- RPM-01: Matrix displays risks as columns, processes as rows
- RPM-02: Cells show aggregated risk scores (weighted average)
- RPM-03: Cells are color-coded by severity (heatmap)
- RPM-04: Matrix auto-updates when taxonomies/scores change
- RPM-05: Clicking cell navigates to filtered RCT view (via expanded view)
</success_criteria>

<output>
After completion, create `.planning/phases/04-matrix-and-polish/04-01-SUMMARY.md`
</output>
