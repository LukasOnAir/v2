---
phase: 04-matrix-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/utils/excelExport.ts
  - src/components/rct/RCTToolbar.tsx
  - src/components/matrix/MatrixToolbar.tsx
  - src/hooks/usePermissions.ts
  - src/stores/rctStore.ts
  - src/components/rct/ControlPanel.tsx
  - src/components/rct/RCTTable.tsx
autonomous: true
user_setup:
  - service: exceljs
    why: "Excel file generation with styling"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "User can export RCT data to Excel file"
    - "Export includes RCT, Matrix summary, and both Taxonomies as separate sheets"
    - "User is prompted to choose filtered vs all data before export"
    - "Risk Manager has full access to all features"
    - "Control Owner can only edit control assessments, not control definitions"
    - "Control Owner can flag issues via change request comments"
  artifacts:
    - path: "src/utils/excelExport.ts"
      provides: "ExcelJS workbook generation with styled sheets"
      exports: ["exportToExcel"]
    - path: "src/hooks/usePermissions.ts"
      provides: "Role-based permission hook"
      exports: ["usePermissions"]
  key_links:
    - from: "src/components/rct/RCTToolbar.tsx"
      to: "src/utils/excelExport.ts"
      via: "Export button calls exportToExcel"
      pattern: "exportToExcel"
    - from: "src/components/rct/ControlPanel.tsx"
      to: "src/hooks/usePermissions.ts"
      via: "Conditional rendering based on canEditControls"
      pattern: "usePermissions.*canEditControls"
    - from: "src/components/rct/RCTTable.tsx"
      to: "src/hooks/usePermissions.ts"
      via: "Disable editing based on role"
      pattern: "usePermissions.*canEdit"
---

<objective>
Add Excel export functionality and implement role-based access control for Risk Manager vs Control Owner views.

Purpose: Complete the demo-ready feature set with data export capability and role-based UI restrictions that showcase the ERM workflow.

Output: Export button that generates multi-sheet Excel workbook. Role picker (already in Header) controls what UI elements are editable. Control Owner can view everything but can only edit control assessments and request changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-matrix-and-polish/04-CONTEXT.md
@.planning/phases/04-matrix-and-polish/04-RESEARCH.md
@.planning/phases/04-matrix-and-polish/04-01-SUMMARY.md

# Key existing files
@src/stores/uiStore.ts
@src/stores/rctStore.ts
@src/stores/taxonomyStore.ts
@src/components/rct/ControlPanel.tsx
@src/components/rct/RCTToolbar.tsx
@src/components/layout/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Excel export utility</name>
  <files>
    package.json
    src/utils/excelExport.ts
  </files>
  <action>
Install ExcelJS and file-saver:
```bash
npm install exceljs file-saver
npm install -D @types/file-saver
```

Create excelExport.ts:

```typescript
import ExcelJS from 'exceljs'
import { saveAs } from 'file-saver'
import type { RCTRow } from '@/types/rct'
import type { TaxonomyItem } from '@/types/taxonomy'

interface ExportOptions {
  exportAll: boolean  // true = all data, false = filtered view only
}

export async function exportToExcel(
  rctRows: RCTRow[],
  filteredRows: RCTRow[],  // Currently visible rows after filters
  risks: TaxonomyItem[],
  processes: TaxonomyItem[],
  options: ExportOptions
): Promise<void>
```

Implementation:
1. Create workbook with creator 'RiskGuard ERM' and current date
2. Sheet 1 "Risk Control Table":
   - Columns: Risk L1-L5 IDs/Names, Process L1-L5 IDs/Names, Gross P/I/Score, Appetite, Within Appetite, Controls count, Net Score
   - Use `options.exportAll ? rctRows : filteredRows`
   - Style header row: bold, dark background (#1E293B), light text (#FAFAFA)
   - Auto-width columns (min 10, max 40)
3. Sheet 2 "Risk-Process Matrix":
   - Row headers = process L1 names, Column headers = risk L1 names
   - Cell values = average gross score for that combination
   - Color cells using heatmap colors (ExcelJS fill pattern)
4. Sheet 3 "Risk Taxonomy":
   - Flatten hierarchy: ID, Name, Description, Level, Parent ID
   - Recursive traversal of risks tree
5. Sheet 4 "Process Taxonomy":
   - Same structure as Risk Taxonomy

File naming: `RiskGuard_Export_${new Date().toISOString().slice(0,10)}.xlsx`

Use try/catch and show error toast if export fails (use existing toast pattern if available, or console.error).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
excelExport.ts exports `exportToExcel` function. Dependencies installed. Function creates 4-sheet workbook with styled headers and heatmap colors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export buttons to RCT and Matrix toolbars</name>
  <files>
    src/components/rct/RCTToolbar.tsx
    src/components/matrix/MatrixToolbar.tsx
  </files>
  <action>
Update RCTToolbar.tsx:
1. Add export button with download icon (use Lucide `Download` icon or similar SVG)
2. On click, show Radix AlertDialog asking: "Export filtered view only, or all data?"
   - "Filtered ({N} rows)" button
   - "All ({M} rows)" button
   - "Cancel" button
3. Pass choice to exportToExcel with correct options
4. Get filteredRows from table.getFilteredRowModel().rows
5. Get all rows from rctStore
6. Get taxonomies from taxonomyStore

Update MatrixToolbar.tsx:
1. Add same export button
2. Matrix export always exports all data (no filter concept in matrix)
3. Skip the dialog, just call exportToExcel with exportAll: true

Button styling: match existing toolbar buttons (bg-surface-elevated, hover:bg-surface, border-surface-border)
  </action>
  <verify>
Run dev server. Go to RCT page. Click export button. Dialog appears. Choose option. Excel file downloads. Open in Excel - verify 4 sheets exist with data. Repeat from Matrix page.
  </verify>
  <done>
Export button appears in both RCT and Matrix toolbars. RCT export prompts for filtered vs all. Matrix exports all. Files download correctly with styled sheets.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement role-based permissions and change requests</name>
  <files>
    src/hooks/usePermissions.ts
    src/stores/rctStore.ts
    src/types/rct.ts
    src/components/rct/ControlPanel.tsx
    src/components/rct/RCTTable.tsx
  </files>
  <action>
Create usePermissions.ts:
```typescript
import { useUIStore } from '@/stores/uiStore'

export function usePermissions() {
  const role = useUIStore(state => state.selectedRole)

  return {
    // Risk Manager: full access
    // Control Owner: restricted
    canEditRiskDefinitions: role === 'risk-manager',      // Taxonomy editing
    canEditGrossScores: role === 'risk-manager',          // P, I, Appetite
    canEditControlDefinitions: role === 'risk-manager',   // Add/delete controls, control type
    canEditControlAssessments: true,                       // Both roles can edit net P/I
    canViewAll: true,                                      // Both can view everything
    canRequestChanges: role === 'control-owner',          // Only Control Owner requests
    isRiskManager: role === 'risk-manager',
    isControlOwner: role === 'control-owner',
  }
}
```

Update rct.ts - add ChangeRequest type:
```typescript
export interface ChangeRequest {
  id: string
  rowId: string
  controlId?: string  // If requesting change to specific control
  message: string
  timestamp: Date
  status: 'pending' | 'resolved'
}
```

Update rctStore.ts:
- Add `changeRequests: ChangeRequest[]` to state
- Add `addChangeRequest(rowId: string, message: string, controlId?: string): void`
- Add `resolveChangeRequest(requestId: string): void`

Update ControlPanel.tsx:
1. Import usePermissions
2. Disable "Delete Control" button when !canEditControlDefinitions
3. Disable control type dropdown when !canEditControlDefinitions
4. Disable control description input when !canEditControlDefinitions
5. Keep net probability/impact editable (canEditControlAssessments = true)
6. Add "Request Change" button when canRequestChanges:
   - Opens small form: textarea for message + "Submit" button
   - Calls addChangeRequest
   - Shows existing pending requests for this row

Update RCTTable.tsx:
1. Import usePermissions
2. Disable gross probability/impact/appetite dropdowns when !canEditGrossScores
3. Gray out disabled fields visually (opacity-50, cursor-not-allowed)

Use consistent disabled styling: `disabled:opacity-50 disabled:cursor-not-allowed`
  </action>
  <verify>
Run dev server. Switch to Control Owner role via Header dropdown. Go to RCT:
- Gross score dropdowns should be disabled
- Open a control: type/description disabled, net scores editable
- "Request Change" button visible
- Submit a change request
Switch back to Risk Manager: full editing restored, can see pending change requests.
  </verify>
  <done>
Role picker controls UI access. Risk Manager has full access. Control Owner can only edit net scores and submit change requests. Pending requests visible to Risk Manager.
  </done>
</task>

</tasks>

<verification>
1. Export button visible in RCT toolbar
2. Export dialog shows row counts correctly
3. Downloaded Excel opens with 4 sheets
4. RCT sheet has styled headers and correct data
5. Matrix sheet shows heatmap colors
6. Taxonomy sheets show flattened hierarchy
7. Control Owner cannot edit gross scores
8. Control Owner cannot edit control definitions (type, description)
9. Control Owner CAN edit net probability/impact
10. Control Owner can submit change requests
11. Risk Manager sees full editing capability
12. Role persists across page refresh (already in uiStore persist)
</verification>

<success_criteria>
Requirements covered:
- EXP-01: User can export RCT data to Excel format (with Matrix and Taxonomies as bonus)
- ROLE-01: Role picker dropdown in UI (already exists in Header)
- ROLE-02: Risk Manager has full access to all features
- ROLE-03: Control Owner can only edit control columns on assigned rows (net scores + change requests)
</success_criteria>

<output>
After completion, create `.planning/phases/04-matrix-and-polish/04-02-SUMMARY.md`
</output>
