---
phase: 04-matrix-and-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/utils/excelExport.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Excel Matrix sheet shows all L1 items from taxonomy, not just those with RCT data"
    - "Excel Taxonomy sheets show hierarchical IDs (1.2.3) not UUIDs"
  artifacts:
    - path: "src/utils/excelExport.ts"
      provides: "Fixed matrix L1 extraction and taxonomy ID output"
      contains: "hierarchicalId"
  key_links:
    - from: "src/utils/excelExport.ts"
      to: "risks/processes arrays"
      via: "L1 name extraction for matrix headers"
      pattern: "risks\\.filter|processes\\.filter"
---

<objective>
Fix Excel export bugs: Matrix sheet shows all taxonomy L1 items regardless of RCT data, and taxonomy sheets use hierarchical IDs instead of UUIDs.

Purpose: UAT Test 6 failed because exported Matrix only showed rows/columns with filled net risk values, and taxonomy IDs showed UUIDs like "69534640-ce54-452c-b5a6-9599815802d2" instead of "1.2.3".

Output: Corrected excelExport.ts with proper L1 extraction and hierarchicalId usage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-matrix-and-polish/04-02-SUMMARY.md
@src/utils/excelExport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Excel export - Matrix L1s and Taxonomy IDs</name>
  <files>src/utils/excelExport.ts</files>
  <action>
    Two bugs to fix:

    **Bug 1 - Matrix L1 names (lines ~230-231):**
    Current code extracts L1 names from rctRows, which only includes rows with data:
    ```typescript
    const riskL1s = [...new Set(rctRows.map(r => r.riskL1))];
    const processL1s = [...new Set(rctRows.map(r => r.processL1))];
    ```

    Fix: Extract L1 names from the risks and processes arrays passed to the function:
    ```typescript
    const riskL1s = risks.filter(r => r.level === 1).map(r => r.name);
    const processL1s = processes.filter(p => p.level === 1).map(p => p.name);
    ```

    **Bug 2 - Taxonomy hierarchical IDs (lines ~79, ~87):**
    Current flattenTaxonomy function uses item.id (UUID) for the ID column.

    Fix: Use item.hierarchicalId instead:
    - Line ~79: Change `id: item.id` to `id: item.hierarchicalId`
    - Line ~87: Same change for the other taxonomy type

    Note: The function signature already receives risks and processes arrays with hierarchicalId property available.
  </action>
  <verify>
    1. Open app, navigate to RCT page
    2. Click Export button, choose "All Data"
    3. Open Excel file
    4. Matrix sheet: Verify all L1 risks appear as columns and all L1 processes appear as rows (even if some cells are empty)
    5. Risk Taxonomy sheet: Verify ID column shows "1", "1.1", "1.2", etc. (not UUIDs)
    6. Process Taxonomy sheet: Verify ID column shows hierarchical format (not UUIDs)
  </verify>
  <done>
    - Matrix sheet displays complete L1 grid from taxonomy, not limited to RCT data
    - Taxonomy sheets show hierarchical IDs like "1.2.3" instead of UUIDs
  </done>
</task>

</tasks>

<verification>
- Export Excel from RCT page
- Matrix sheet contains all taxonomy L1 items as row/column headers
- Taxonomy sheets show hierarchical IDs (1, 1.1, 1.2, etc.) not UUIDs
- Existing export functionality (heatmap colors, RCT data) still works
</verification>

<success_criteria>
UAT Test 6 passes: Excel export shows all matrix elements and uses hierarchical IDs in taxonomy sheets.
</success_criteria>

<output>
After completion, create `.planning/phases/04-matrix-and-polish/04-03-SUMMARY.md`
</output>
