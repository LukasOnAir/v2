---
phase: 04-matrix-and-polish
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/usePermissions.ts
  - src/components/matrix/MatrixExpandedView.tsx
  - src/components/taxonomy/TaxonomyPage.tsx
  - src/components/taxonomy/TaxonomyNode.tsx
  - src/components/rct/RCTTable.tsx
  - src/components/rct/ControlPanel.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Control Owner cannot edit any RCT data (gross scores, net scores, control definitions)"
    - "Control Owner cannot edit scores via Matrix mini menu (expanded view)"
    - "Control Owner cannot add/edit/delete taxonomy items"
    - "Control Owner cannot edit custom column values"
    - "Control Owner can only view data and submit change requests"
    - "Change request button appears per control, not at panel level"
  artifacts:
    - path: "src/hooks/usePermissions.ts"
      provides: "Complete permission flags for Control Owner restrictions"
      contains: "canEditTaxonomies"
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Per-control change request buttons"
      contains: "activeChangeRequestControlId"
  key_links:
    - from: "src/components/matrix/MatrixExpandedView.tsx"
      to: "usePermissions"
      via: "disabled prop on ScoreDropdown"
      pattern: "usePermissions.*disabled"
    - from: "src/components/taxonomy/TaxonomyPage.tsx"
      to: "usePermissions"
      via: "conditional render of add buttons"
      pattern: "canEditTaxonomies"
---

<objective>
Fix Control Owner permissions and per-control change requests: Restrict Control Owner to view-only access across all editing surfaces, and move change request functionality to per-control level.

Purpose: UAT Tests 10 and 11 failed. Test 10: Control Owner can still edit custom columns, Matrix mini menu, and taxonomies. Test 11: Change request button is at panel level, not per control.

Output: Comprehensive permission enforcement and relocated change request UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-matrix-and-polish/04-02-SUMMARY.md
@src/hooks/usePermissions.ts
@src/components/matrix/MatrixExpandedView.tsx
@src/components/taxonomy/TaxonomyPage.tsx
@src/components/taxonomy/TaxonomyNode.tsx
@src/components/rct/RCTTable.tsx
@src/components/rct/ControlPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update usePermissions hook with complete Control Owner restrictions</name>
  <files>src/hooks/usePermissions.ts</files>
  <action>
    Update the usePermissions hook to properly restrict Control Owner:

    Current problem: canEditControlAssessments is true for both roles.

    Fix: Control Owner should have NO edit permissions (view only + change requests).

    ```typescript
    export function usePermissions() {
      const role = useUIStore((state) => state.role);
      const isRiskManager = role === 'risk-manager';

      return {
        // Existing flags - ensure Control Owner gets false
        canEditGrossScores: isRiskManager,
        canEditControlDefinitions: isRiskManager,
        canEditControlAssessments: isRiskManager, // WAS: true for both - FIX: only Risk Manager
        canEditNetScores: isRiskManager, // Control Owner cannot edit anything

        // New flags needed for comprehensive restriction
        canEditTaxonomies: isRiskManager,
        canManageCustomColumns: isRiskManager, // add/edit/delete column definitions
        canEditCustomColumnValues: isRiskManager, // edit values in custom columns

        // Change request is the ONLY action Control Owner can take
        canSubmitChangeRequests: !isRiskManager, // Control Owner only

        // Utility
        role,
        isRiskManager,
      };
    }
    ```

    The key insight from UAT: Control Owner should ONLY be able to view and submit change requests. All editing is restricted.
  </action>
  <verify>
    1. Check hook exports all new permission flags
    2. Verify Control Owner gets false for all edit permissions
    3. Verify Risk Manager gets true for all edit permissions
    4. Verify canSubmitChangeRequests is true only for Control Owner
  </verify>
  <done>
    - usePermissions returns complete permission flags
    - Control Owner: all edit flags false, canSubmitChangeRequests true
    - Risk Manager: all edit flags true, canSubmitChangeRequests false
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply permission checks across all editing surfaces</name>
  <files>
    src/components/matrix/MatrixExpandedView.tsx
    src/components/taxonomy/TaxonomyPage.tsx
    src/components/taxonomy/TaxonomyNode.tsx
    src/components/rct/RCTTable.tsx
    src/components/rct/ControlPanel.tsx
  </files>
  <action>
    Apply permission checks to all editing components:

    **MatrixExpandedView.tsx:**
    - Import usePermissions
    - Add disabled prop to ScoreDropdown components based on canEditGrossScores/canEditNetScores
    ```typescript
    const { canEditGrossScores, canEditNetScores } = usePermissions();
    // On gross score dropdowns: disabled={!canEditGrossScores}
    // On net score dropdowns: disabled={!canEditNetScores}
    ```

    **TaxonomyPage.tsx:**
    - Import usePermissions
    - Conditionally render "Add" buttons based on canEditTaxonomies
    ```typescript
    const { canEditTaxonomies } = usePermissions();
    // Wrap add buttons: {canEditTaxonomies && <AddButton ... />}
    ```

    **TaxonomyNode.tsx:**
    - Import usePermissions
    - Hide or disable edit/delete buttons based on canEditTaxonomies
    ```typescript
    const { canEditTaxonomies } = usePermissions();
    // Hide action buttons when !canEditTaxonomies
    ```

    **RCTTable.tsx:**
    - Import usePermissions (may already exist)
    - Add disabled prop to custom column cell inputs/selects based on canEditCustomColumnValues
    - Find where custom column cells render and add: disabled={!canEditCustomColumnValues}

    **ControlPanel.tsx:**
    - Import usePermissions (may already exist)
    - Disable Net P/I dropdowns based on canEditNetScores
    - **Move change request button inside control card iteration:**
      1. Remove the panel-level change request button (lines ~265-308)
      2. Inside the control.map() iteration, add a "Request Change" button per control
      3. Track activeChangeRequestControlId (string | null) instead of boolean showChangeRequestForm
      4. Pass controlId to addChangeRequest when submitting
    ```typescript
    // State change:
    const [activeChangeRequestControlId, setActiveChangeRequestControlId] = useState<string | null>(null);

    // Inside control card:
    {canSubmitChangeRequests && (
      <Button onClick={() => setActiveChangeRequestControlId(control.id)}>
        Request Change
      </Button>
    )}

    // Change request form (inside control card, shown when activeChangeRequestControlId === control.id):
    {activeChangeRequestControlId === control.id && (
      <form onSubmit={() => {
        addChangeRequest(row.id, controlId, message);
        setActiveChangeRequestControlId(null);
      }}>
        ...
      </form>
    )}
    ```
  </action>
  <verify>
    1. Switch to Control Owner role in header
    2. Matrix: Click cell, try to edit scores in expanded view - should be disabled
    3. Taxonomy: Navigate to taxonomy page - add/edit/delete buttons should be hidden
    4. RCT: Custom column cells should be disabled/read-only
    5. RCT: Open control panel - net score dropdowns should be disabled
    6. RCT: Each control card should show its own "Request Change" button
    7. Switch back to Risk Manager - all editing should work
  </verify>
  <done>
    - MatrixExpandedView score dropdowns disabled for Control Owner
    - TaxonomyPage/TaxonomyNode add/edit/delete hidden for Control Owner
    - RCT custom column cells disabled for Control Owner
    - ControlPanel net score dropdowns disabled for Control Owner
    - Change request button appears per control, not at panel level
  </done>
</task>

</tasks>

<verification>
As Control Owner:
- Cannot edit any scores in RCT table
- Cannot edit scores in Matrix expanded view
- Cannot add/edit/delete taxonomy items
- Cannot edit custom column values
- Can see "Request Change" button on each control card
- Submitting change request includes control ID

As Risk Manager:
- All editing capabilities work as before
- No change request buttons visible
</verification>

<success_criteria>
UAT Tests 10 and 11 pass:
- Control Owner role restricts all editing (RCT, matrix, taxonomies, custom columns)
- Change request form is per control, not a general button
</success_criteria>

<output>
After completion, create `.planning/phases/04-matrix-and-polish/04-05-SUMMARY.md`
</output>
