---
phase: 04-matrix-and-polish
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/rctStore.ts
  - src/components/rct/RCTToolbar.tsx
  - src/components/rct/ControlPanel.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Risk ID and Process ID columns are hidden after page refresh"
    - "Control Owner cannot see Add Column or Manage Columns buttons"
    - "Change request textarea auto-expands as user types"
  artifacts:
    - path: "src/stores/rctStore.ts"
      provides: "Merge function for zustand persist"
      contains: "merge:"
    - path: "src/components/rct/RCTToolbar.tsx"
      provides: "Permission-gated column buttons"
      contains: "canManageCustomColumns"
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Auto-resize textarea"
      contains: "scrollHeight"
  key_links:
    - from: "src/stores/rctStore.ts"
      to: "localStorage persist"
      via: "merge function"
      pattern: "merge:.*riskId.*false"
    - from: "src/components/rct/RCTToolbar.tsx"
      to: "usePermissions hook"
      via: "conditional rendering"
      pattern: "canManageCustomColumns.*&&"
---

<objective>
Fix 3 UAT gaps from user testing: hidden columns visible after refresh, Control Owner can add columns, change request textarea too small.

Purpose: Close all diagnosed issues before phase completion
Output: All 3 gaps resolved, UAT can re-verify
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-matrix-and-polish/04-UAT.md
@src/stores/rctStore.ts
@src/components/rct/RCTToolbar.tsx
@src/components/rct/ControlPanel.tsx
@src/hooks/usePermissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hidden columns visible after refresh</name>
  <files>src/stores/rctStore.ts</files>
  <action>
Add a merge function to the zustand persist config (lines 227-231) to ensure riskId and processId are always hidden, even when localStorage has stale state.

In the persist options object, add:

```typescript
merge: (persistedState, currentState) => ({
  ...currentState,
  ...(persistedState as Partial<RCTState>),
  columnVisibility: {
    ...((persistedState as Partial<RCTState>)?.columnVisibility || {}),
    // Always enforce hidden ID columns regardless of persisted state
    riskId: false,
    processId: false,
  },
}),
```

This ensures that even if a user has old localStorage data without these keys, the columns will be hidden after merge.
  </action>
  <verify>
1. Open browser DevTools > Application > Local Storage
2. Find 'riskguard-rct' key, edit columnVisibility to remove riskId/processId or set them to true
3. Refresh the page
4. Navigate to RCT - columns should be hidden (not visible in table)
  </verify>
  <done>riskId and processId columns stay hidden even when localStorage lacks these settings</done>
</task>

<task type="auto">
  <name>Task 2: Block Control Owner from column management</name>
  <files>src/components/rct/RCTToolbar.tsx</files>
  <action>
Import usePermissions hook and conditionally render the column management buttons.

1. Add import at top:
   ```typescript
   import { usePermissions } from '@/hooks/usePermissions'
   ```

2. Inside the component, destructure the permission:
   ```typescript
   const { canManageCustomColumns } = usePermissions()
   ```

3. Wrap the "Manage Columns" button (lines 112-118) with the permission check:
   ```tsx
   {canManageCustomColumns && (
     <button
       onClick={() => setIsManageColumnsOpen(true)}
       ...
     >
       <Settings2 size={14} />
       Manage Columns
     </button>
   )}
   ```

4. Wrap the "Add Column" button (lines 120-126) with the same check:
   ```tsx
   {canManageCustomColumns && (
     <button
       onClick={() => setIsAddColumnOpen(true)}
       ...
     >
       <Plus size={14} />
       Add Column
     </button>
   )}
   ```

Do NOT wrap the ColumnVisibilityMenu or Export button - those should remain accessible to all roles.
  </action>
  <verify>
1. Select "Control Owner" role in the UI
2. Navigate to RCT page
3. Verify: "Add Column" and "Manage Columns" buttons are NOT visible
4. Switch to "Risk Manager" role
5. Verify: Both buttons appear and function normally
  </verify>
  <done>Control Owner sees no column management buttons; Risk Manager sees both</done>
</task>

<task type="auto">
  <name>Task 3: Auto-resize change request textarea</name>
  <files>src/components/rct/ControlPanel.tsx</files>
  <action>
Fix the change request textarea (lines 280-286) to auto-resize like the Notes textarea already does.

1. Change rows from 2 to 3 for better initial size
2. Remove the resize-none class (keep other classes)
3. Add auto-resize onChange handler

Update the textarea from:
```tsx
<textarea
  value={changeRequestMessage}
  onChange={(e) => setChangeRequestMessage(e.target.value)}
  placeholder="Describe the change you need..."
  rows={2}
  className="w-full px-2 py-1.5 bg-surface-elevated border border-surface-border rounded text-sm text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-1 focus:ring-accent-500 resize-none"
  autoFocus
/>
```

To:
```tsx
<textarea
  value={changeRequestMessage}
  onChange={(e) => {
    setChangeRequestMessage(e.target.value)
    // Auto-expand textarea
    e.target.style.height = 'auto'
    e.target.style.height = `${Math.max(64, e.target.scrollHeight)}px`
  }}
  placeholder="Describe the change you need..."
  rows={3}
  className="w-full px-2 py-1.5 bg-surface-elevated border border-surface-border rounded text-sm text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-1 focus:ring-accent-500 resize-y min-h-[64px]"
  autoFocus
/>
```

This mirrors the exact pattern used by the Notes textarea at lines 259-271.
  </action>
  <verify>
1. As Control Owner, open Control Panel for a row with controls
2. Click "Request Change" on any control
3. Type a long multi-line message
4. Verify: Textarea expands as you type and can be manually resized
  </verify>
  <done>Change request textarea starts larger (3 rows), auto-expands with content, allows manual resize</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` completes without errors
2. All 3 UAT gaps are manually verifiable as fixed:
   - Hidden columns stay hidden after localStorage manipulation + refresh
   - Control Owner cannot see Add Column or Manage Columns buttons
   - Change request textarea auto-resizes with content
</verification>

<success_criteria>
- All 3 diagnosed UAT gaps resolved
- No regressions to existing functionality
- Build passes
- Ready for UAT re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/04-matrix-and-polish/04-06-SUMMARY.md`
</output>
