---
phase: 06-risk-sunburst-visualization
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/sunburst/SunburstChart.tsx
  - src/components/sunburst/SunburstTooltip.tsx
  - src/components/sunburst/SunburstBreadcrumb.tsx
  - src/components/sunburst/index.ts
autonomous: true

must_haves:
  truths:
    - "Sunburst chart renders with center and L1-L5 rings"
    - "Clicking a segment zooms to make it the new center"
    - "Breadcrumb shows navigation path and allows jumping back"
    - "Hover tooltip displays segment name and score"
    - "Segments colored using existing heatmap color scale"
  artifacts:
    - path: "src/components/sunburst/SunburstChart.tsx"
      provides: "Main D3 sunburst visualization"
      exports: ["SunburstChart"]
    - path: "src/components/sunburst/SunburstTooltip.tsx"
      provides: "Hover tooltip component"
      exports: ["SunburstTooltip"]
    - path: "src/components/sunburst/SunburstBreadcrumb.tsx"
      provides: "Navigation breadcrumb"
      exports: ["SunburstBreadcrumb"]
  key_links:
    - from: "SunburstChart"
      to: "useSunburstData"
      via: "uses hook for hierarchical data"
      pattern: "useSunburstData"
    - from: "SunburstChart"
      to: "heatmapColors"
      via: "getHeatmapColor for arc fill"
      pattern: "getHeatmapColor"
    - from: "SunburstChart"
      to: "sunburstStore"
      via: "reads visibleLevels, zoom state"
      pattern: "useSunburstStore"
---

<objective>
Create the core sunburst visualization component with zoom interaction, tooltip, and breadcrumb navigation.

Purpose: Implement the D3-based zoomable sunburst chart following the Observable pattern, with React state integration for hover and zoom interactions.

Output: SunburstChart.tsx, SunburstTooltip.tsx, SunburstBreadcrumb.tsx
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-risk-sunburst-visualization/06-CONTEXT.md
@.planning/phases/06-risk-sunburst-visualization/06-RESEARCH.md
@.planning/phases/06-risk-sunburst-visualization/06-01-SUMMARY.md

Reference existing patterns:
@src/utils/heatmapColors.ts
@src/components/matrix/MatrixCell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SunburstTooltip component</name>
  <files>src/components/sunburst/SunburstTooltip.tsx</files>
  <action>
Create a simple tooltip component for hover display.

**Props:**
- `visible: boolean`
- `x: number` - mouse X position
- `y: number` - mouse Y position
- `name: string` - segment name
- `hierarchicalId: string` - e.g., "1.2.3"
- `score: number | null` - aggregated score

**Implementation:**
- Use absolute positioning based on x/y
- Offset tooltip slightly from cursor (e.g., +10px both directions)
- Keep tooltip within viewport bounds (check if would overflow right/bottom)
- Display: hierarchicalId, name on separate lines, score with 1 decimal
- Style: dark background (bg-surface-elevated), border, rounded corners, shadow
- Handle null score by showing "No data"
- Transition opacity for smooth appear/disappear

Example display:
```
1.2.3
Cyberattack
Score: 14.2
```

Use portal rendering (createPortal) to avoid clipping issues.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SunburstTooltip renders minimal hover info with proper positioning</done>
</task>

<task type="auto">
  <name>Task 2: Create SunburstBreadcrumb component</name>
  <files>src/components/sunburst/SunburstBreadcrumb.tsx</files>
  <action>
Create breadcrumb navigation for drill-down path.

**Props:**
- `path: Array<{ id: string; name: string; hierarchicalId: string }>` - path from root to current
- `onNavigate: (nodeId: string) => void` - callback when clicking a breadcrumb item

**Implementation:**
- Render "All" as first item (represents root)
- Render each path item with ">" separator
- Current item (last) is bold, not clickable
- Previous items are clickable, hover underline
- On click, call onNavigate with the node ID to zoom to that level
- Style: text-sm, text-secondary for non-current, text-primary for current
- Handle empty path (root view) by showing only "All" as bold

Example:
```
All > 1 Operational > 1.2 IT Risks > 1.2.3 Cyberattack
```
(Operational, IT Risks are clickable; Cyberattack is current = bold)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SunburstBreadcrumb shows clickable path for navigation</done>
</task>

<task type="auto">
  <name>Task 3: Create SunburstChart component with D3 visualization</name>
  <files>src/components/sunburst/SunburstChart.tsx, src/components/sunburst/index.ts</files>
  <action>
Create the main sunburst chart using D3 partition layout and arc generator.

**Component structure:**

```typescript
interface SunburstChartProps {
  width?: number   // Default: 600
  height?: number  // Default: 600
}
```

**Implementation approach (Observable Zoomable Sunburst pattern):**

1. **Setup:**
   - Call useSunburstData() to get the d3 hierarchy
   - Read visibleLevels, zoomPath, currentCenterId from sunburstStore
   - Calculate radius = Math.min(width, height) / 2
   - Create partition layout: `partition<SunburstNode>().size([2 * Math.PI, radius])`
   - Apply partition to hierarchy root

2. **Arc generator:**
   ```typescript
   const arcGenerator = arc<HierarchyRectangularNode<SunburstNode>>()
     .startAngle(d => d.x0)
     .endAngle(d => d.x1)
     .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
     .padRadius(radius / 2)
     .innerRadius(d => d.y0)
     .outerRadius(d => d.y1 - 1)
   ```

3. **Visibility filtering:**
   Filter nodes based on:
   - visibleLevels (if l3 is false, hide depth=3 nodes)
   - Current zoom (show only nodes within 3 levels of center)
   - hideNoData setting (if true and value is null, hide)

   ```typescript
   function arcVisible(d: HierarchyRectangularNode<SunburstNode>): boolean {
     const levelKey = `l${d.depth}` as keyof typeof visibleLevels
     if (d.depth > 0 && d.depth <= 5 && !visibleLevels[levelKey]) return false
     return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0
   }
   ```

4. **Coloring:**
   - Use getHeatmapColor(node.data.value) for segments with scores
   - Gray color (#4a5568) for null values
   - Use getContrastingText for labels

5. **Labels:**
   - Show only for segments with sufficient arc angle (> 0.03 radians)
   - Default: show hierarchicalId only
   - If zoomed in (node is within 2 levels of center): show "ID Name"
   - Position labels at arc centroid
   - Use textPath along arc for curved text (or simple centered text)

6. **Hover interaction:**
   - Track hovered node in local state
   - onMouseEnter: set hovered node
   - onMouseLeave: clear hovered node
   - Pass to SunburstTooltip

7. **Click interaction (zoom):**
   - onClick: call store.zoomTo(node.data.id, computePathToNode)
   - Animate arcs to new positions using d3-interpolate
   - Use requestAnimationFrame or CSS transitions for smooth animation

8. **Center display:**
   - Render a circle at center showing:
     - If at root: "Enterprise Risk" or "Enterprise Process" + overall score
     - If zoomed: current center node name + score
   - Click center to zoom out (call store.zoomOut)

9. **Right-click context menu:**
   - On right-click, prevent default
   - Store context menu state (position, node)
   - Render simple menu with "View in RCT" option
   - On "View in RCT" click, navigate to `/rct?risk={hierarchicalId}` or `?process={hierarchicalId}`
   - Use React Router's useNavigate

10. **SVG structure:**
    ```tsx
    <svg ref={svgRef} width={width} height={height}>
      <g transform={`translate(${width/2},${height/2})`}>
        {/* Center circle */}
        <circle r={innerRadius} fill="..." onClick={handleZoomOut} />
        <text>{centerLabel}</text>

        {/* Arcs */}
        {visibleNodes.map(node => (
          <path
            key={node.data.id}
            d={arcGenerator(node)}
            fill={getColor(node)}
            onClick={() => handleZoom(node)}
            onMouseEnter={() => setHovered(node)}
            onMouseLeave={() => setHovered(null)}
            onContextMenu={(e) => handleContextMenu(e, node)}
          />
        ))}

        {/* Labels */}
        {labelNodes.map(node => (
          <text key={node.data.id} transform={getLabelTransform(node)}>
            {getLabel(node)}
          </text>
        ))}
      </g>
    </svg>
    ```

11. **Expose svgRef** for export functionality (will be used by Plan 03)

**Update index.ts** to export all components:
```typescript
export { useSunburstData, type SunburstNode } from './useSunburstData'
export { SunburstChart } from './SunburstChart'
export { SunburstTooltip } from './SunburstTooltip'
export { SunburstBreadcrumb } from './SunburstBreadcrumb'
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SunburstChart renders interactive sunburst with zoom, tooltip, right-click menu</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- SunburstChart, SunburstTooltip, SunburstBreadcrumb exported from index.ts
- Components use heatmapColors for consistent coloring
- Zoom interaction updates store state
</verification>

<success_criteria>
1. Sunburst chart renders arcs for hierarchy levels
2. Segments colored by score using heatmap gradient
3. Click zooms to make segment the new center
4. Breadcrumb shows navigation path
5. Hover tooltip shows name and score
6. Right-click offers "View in RCT" navigation
7. Level visibility respected per store settings
</success_criteria>

<output>
After completion, create `.planning/phases/06-risk-sunburst-visualization/06-02-SUMMARY.md`
</output>
