---
phase: 06-risk-sunburst-visualization
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/sunburst/SunburstControls.tsx
  - src/components/sunburst/SunburstLegend.tsx
  - src/utils/sunburstExport.ts
  - src/components/sunburst/index.ts
autonomous: true

must_haves:
  truths:
    - "Control panel has toggles for taxonomy, score type, aggregation mode"
    - "Level checkboxes control L1-L5 visibility"
    - "Export buttons produce PNG and SVG files"
    - "Legend shows color scale with score ranges"
  artifacts:
    - path: "src/components/sunburst/SunburstControls.tsx"
      provides: "Toolbar with view controls and export"
      exports: ["SunburstControls"]
    - path: "src/components/sunburst/SunburstLegend.tsx"
      provides: "Color scale legend for chart and export"
      exports: ["SunburstLegend"]
    - path: "src/utils/sunburstExport.ts"
      provides: "PNG/SVG export utilities"
      exports: ["exportSunburstPng", "exportSunburstSvg"]
  key_links:
    - from: "SunburstControls"
      to: "sunburstStore"
      via: "calls store actions for settings"
      pattern: "useSunburstStore"
    - from: "sunburstExport"
      to: "save-svg-as-png"
      via: "saveSvgAsPng function"
      pattern: "saveSvgAsPng"
---

<objective>
Create the control toolbar, color legend, and export functionality for the sunburst visualization.

Purpose: Give users control over visualization options (taxonomy, scores, levels) and enable high-quality PNG/SVG export for presentations.

Output: SunburstControls.tsx, SunburstLegend.tsx, sunburstExport.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-risk-sunburst-visualization/06-CONTEXT.md
@.planning/phases/06-risk-sunburst-visualization/06-RESEARCH.md
@.planning/phases/06-risk-sunburst-visualization/06-01-SUMMARY.md

Reference existing patterns:
@src/components/matrix/MatrixToolbar.tsx
@src/utils/excelExport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SunburstLegend component</name>
  <files>src/components/sunburst/SunburstLegend.tsx</files>
  <action>
Create a color scale legend showing the score-to-color mapping.

**Props:**
- `inline?: boolean` - if true, render horizontally (for export); if false, render vertically (for UI)

**Implementation:**
- Show gradient bar from green (low risk, score 1) to red (high risk, score 25)
- Label minimum (1) and maximum (25) scores
- Optionally show intermediate markers (6, 12, 18)
- Use same HEATMAP_STOPS from heatmapColors.ts for consistency

**Styles:**
- Gradient bar: 100px wide for inline, 20px wide for vertical
- Text: text-xs text-text-secondary
- Background: bg-surface-elevated with border for visibility

**Horizontal (inline) layout:**
```
Low (1) [===gradient===] High (25)
```

**Vertical layout:**
```
High (25)
  |
[gradient]
  |
Low (1)
```

This component will be rendered:
1. In the UI next to the chart
2. Included in the SVG export for context
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SunburstLegend shows color scale with score labels</done>
</task>

<task type="auto">
  <name>Task 2: Create sunburstExport utilities</name>
  <files>src/utils/sunburstExport.ts</files>
  <action>
Create export utilities for PNG and SVG download.

**Functions:**

```typescript
interface ExportOptions {
  title?: string           // Title to add above chart
  showLegend?: boolean     // Include color legend
  showFilters?: boolean    // Show current filter settings
  filters?: {
    taxonomyType: 'risk' | 'process'
    scoreType: 'gross' | 'net'
    aggregationMode: 'weighted' | 'max'
    visibleLevels: { l1: boolean; l2: boolean; l3: boolean; l4: boolean; l5: boolean }
  }
  backgroundColor?: string // Default: '#1e293b' (app background)
  scale?: number          // Default: 2 (retina)
}

export async function exportSunburstPng(
  svgElement: SVGSVGElement,
  filename: string,
  options?: ExportOptions
): Promise<void>

export function exportSunburstSvg(
  svgElement: SVGSVGElement,
  filename: string,
  options?: ExportOptions
): void
```

**PNG export implementation:**
1. Clone the SVG element to avoid modifying original
2. If options.title, prepend a text element at top
3. If options.showLegend, append legend SVG (create inline)
4. If options.showFilters, append filter info text
5. Use saveSvgAsPng from save-svg-as-png:
   ```typescript
   import { saveSvgAsPng } from 'save-svg-as-png'

   await saveSvgAsPng(clonedSvg, filename, {
     scale: options?.scale ?? 2,
     backgroundColor: options?.backgroundColor ?? '#1e293b',
     encoderOptions: 0.9
   })
   ```

**SVG export implementation:**
1. Clone SVG element
2. Add title, legend, filters as above
3. Serialize with XMLSerializer
4. Create Blob and trigger download with file-saver:
   ```typescript
   import { saveAs } from 'file-saver'

   const serializer = new XMLSerializer()
   const svgString = serializer.serializeToString(clonedSvg)
   const blob = new Blob([svgString], { type: 'image/svg+xml' })
   saveAs(blob, filename)
   ```

**Helper to create legend for export:**
Create an inline SVG group that renders the legend (gradient rect + labels) that can be appended to the main SVG for export purposes.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Export utilities produce PNG/SVG with optional title, legend, and filter info</done>
</task>

<task type="auto">
  <name>Task 3: Create SunburstControls component</name>
  <files>src/components/sunburst/SunburstControls.tsx, src/components/sunburst/index.ts</files>
  <action>
Create the toolbar with all sunburst controls.

**Props:**
- `svgRef: React.RefObject<SVGSVGElement>` - reference to chart SVG for export

**Implementation:**

Render a horizontal toolbar with sections:

1. **View Toggle (Risk/Process):**
   - Two buttons or tabs: "Risk" | "Process"
   - Active state shows which taxonomy is displayed
   - onClick: store.setTaxonomyType()

2. **Score Type Toggle:**
   - Two buttons: "Gross" | "Net"
   - onClick: store.setScoreType()

3. **Aggregation Mode Toggle:**
   - Two buttons: "Weighted Avg" | "Maximum"
   - Small info tooltip explaining the difference
   - onClick: store.setAggregationMode()

4. **Level Visibility Checkboxes:**
   - Label "Levels:" followed by checkboxes
   - L1 [ ] L2 [ ] L3 [ ] L4 [ ] L5 [ ]
   - Each checkbox: checked = level visible
   - onChange: store.toggleLevel()

5. **Hide No-Data Toggle:**
   - Checkbox: "Hide empty"
   - Controls whether segments with null scores are hidden
   - onChange: store.setHideNoData()

6. **Export Dropdown/Buttons:**
   - "Export" button with dropdown or two separate buttons
   - "PNG" - high-res image for presentations
   - "SVG" - vector format for editing
   - On click, call export utilities with current settings
   - Filename: `risk-sunburst-{timestamp}.png` or `.svg`

**Styling:**
- Follow MatrixToolbar pattern for consistent look
- Use gap-4 between sections
- Buttons: bg-surface-overlay, hover states
- Active state: bg-accent-500/20, text-accent-500
- Small text labels above each section

**Update index.ts:**
```typescript
export { useSunburstData, type SunburstNode } from './useSunburstData'
export { SunburstChart } from './SunburstChart'
export { SunburstTooltip } from './SunburstTooltip'
export { SunburstBreadcrumb } from './SunburstBreadcrumb'
export { SunburstControls } from './SunburstControls'
export { SunburstLegend } from './SunburstLegend'
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SunburstControls renders complete toolbar with all settings and export buttons</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- All components exported from index.ts
- SunburstControls connects to sunburstStore for all settings
- Export buttons trigger download
</verification>

<success_criteria>
1. Controls toggle taxonomy type (Risk/Process)
2. Controls toggle score type (Gross/Net)
3. Controls toggle aggregation mode (Weighted/Max)
4. Level checkboxes control L1-L5 visibility
5. Hide empty checkbox hides no-data segments
6. PNG export downloads with title, legend, current settings
7. SVG export downloads with title, legend, current settings
8. Legend component shows color scale
</success_criteria>

<output>
After completion, create `.planning/phases/06-risk-sunburst-visualization/06-03-SUMMARY.md`
</output>
