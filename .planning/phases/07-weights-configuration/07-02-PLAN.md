---
phase: 07-weights-configuration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/taxonomy/WeightBadge.tsx
  - src/components/taxonomy/TaxonomyNode.tsx
  - src/components/taxonomy/LevelWeightsBar.tsx
  - src/components/taxonomy/TaxonomyToolbar.tsx
  - src/components/taxonomy/index.ts
  - src/pages/TaxonomyPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see weight badge on each taxonomy node"
    - "User can click weight badge to edit inline"
    - "User can set level default weights (L1-L5)"
    - "Custom override weights are visually distinct from level defaults"
    - "User can clear an override to revert to level default"
  artifacts:
    - path: "src/components/taxonomy/WeightBadge.tsx"
      provides: "Click-to-edit weight badge component"
      min_lines: 50
    - path: "src/components/taxonomy/LevelWeightsBar.tsx"
      provides: "Level defaults editor UI"
      min_lines: 30
    - path: "src/components/taxonomy/TaxonomyNode.tsx"
      provides: "Node with integrated weight badge"
      contains: "WeightBadge"
  key_links:
    - from: "src/components/taxonomy/WeightBadge.tsx"
      to: "src/stores/taxonomyStore.ts"
      via: "useTaxonomyStore hook"
      pattern: "useTaxonomyStore"
    - from: "src/components/taxonomy/TaxonomyNode.tsx"
      to: "src/components/taxonomy/WeightBadge.tsx"
      via: "component import"
      pattern: "import.*WeightBadge"
---

<objective>
Create WeightBadge component with click-to-edit interaction and integrate into TaxonomyNode for per-node weight configuration.

Purpose: Enable users to configure weights directly in the taxonomy tree via inline editing.
Output: Clickable weight badges on each node, level defaults bar, visual distinction for overrides.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-weights-configuration/07-CONTEXT.md
@.planning/phases/07-weights-configuration/07-RESEARCH.md
@.planning/phases/07-weights-configuration/07-01-SUMMARY.md

# Existing files
@src/components/taxonomy/TaxonomyNode.tsx
@src/components/taxonomy/TaxonomyToolbar.tsx
@src/components/taxonomy/index.ts
@src/pages/TaxonomyPage.tsx
@src/stores/taxonomyStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeightBadge component</name>
  <files>src/components/taxonomy/WeightBadge.tsx</files>
  <action>
Create WeightBadge.tsx with click-to-edit functionality:

```typescript
import { useState, useRef, useEffect } from 'react'
import { X } from 'lucide-react'
import clsx from 'clsx'

interface WeightBadgeProps {
  /** Current weight value */
  value: number
  /** Whether this is a node override (vs level default) */
  isOverride: boolean
  /** Called when weight changes */
  onChange: (value: number) => void
  /** Called to clear override (only available when isOverride) */
  onClear?: () => void
  /** Disable editing */
  disabled?: boolean
}

export function WeightBadge({
  value,
  isOverride,
  onChange,
  onClear,
  disabled = false,
}: WeightBadgeProps) {
  const [isEditing, setIsEditing] = useState(false)
  const [localValue, setLocalValue] = useState(value.toFixed(1))
  const inputRef = useRef<HTMLInputElement>(null)

  // Focus and select input when entering edit mode
  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus()
      inputRef.current.select()
    }
  }, [isEditing])

  // Sync local value when prop changes
  useEffect(() => {
    if (!isEditing) {
      setLocalValue(value.toFixed(1))
    }
  }, [value, isEditing])

  const handleSave = () => {
    const parsed = parseFloat(localValue)
    if (!isNaN(parsed) && parsed >= 0.1 && parsed <= 5.0) {
      // Round to 1 decimal place
      onChange(Math.round(parsed * 10) / 10)
    } else {
      // Reset to original value if invalid
      setLocalValue(value.toFixed(1))
    }
    setIsEditing(false)
  }

  const handleClear = (e: React.MouseEvent) => {
    e.stopPropagation()
    onClear?.()
  }

  if (isEditing) {
    return (
      <input
        ref={inputRef}
        type="number"
        step="0.1"
        min="0.1"
        max="5.0"
        value={localValue}
        onChange={(e) => setLocalValue(e.target.value)}
        onBlur={handleSave}
        onKeyDown={(e) => {
          e.stopPropagation() // Prevent tree navigation
          if (e.key === 'Enter') handleSave()
          if (e.key === 'Escape') {
            setLocalValue(value.toFixed(1))
            setIsEditing(false)
          }
        }}
        onClick={(e) => e.stopPropagation()}
        className={clsx(
          'w-14 px-1 py-0.5 text-xs text-center rounded',
          'bg-surface-overlay border border-accent-500',
          'text-text-primary',
          'focus:outline-none focus:ring-1 focus:ring-accent-500'
        )}
      />
    )
  }

  return (
    <span
      onClick={(e) => {
        e.stopPropagation()
        if (!disabled) setIsEditing(true)
      }}
      className={clsx(
        'inline-flex items-center gap-1 px-1.5 py-0.5 text-xs rounded transition-colors',
        isOverride
          ? 'bg-accent-500/30 text-accent-300 border border-accent-500/50'
          : 'bg-surface-overlay text-text-muted border border-transparent hover:border-surface-border',
        disabled ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'
      )}
      title={
        isOverride
          ? 'Custom weight override (click to edit)'
          : 'Level default weight (click to override)'
      }
    >
      <span>{value.toFixed(1)}x</span>
      {isOverride && onClear && !disabled && (
        <button
          onClick={handleClear}
          className="p-0.5 -mr-0.5 rounded hover:bg-surface-elevated transition-colors"
          title="Clear override (use level default)"
        >
          <X size={10} />
        </button>
      )}
    </span>
  )
}
```

Key behaviors:
- Click badge to enter edit mode
- Blur or Enter saves value (validates 0.1-5.0 range)
- Escape cancels edit
- Override badges show accent color and X button to clear
- All click handlers call stopPropagation to prevent tree interactions
  </action>
  <verify>`npm run build` compiles without errors</verify>
  <done>WeightBadge component exists with click-to-edit, override styling, and clear functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create LevelWeightsBar component for level defaults</name>
  <files>src/components/taxonomy/LevelWeightsBar.tsx</files>
  <action>
Create LevelWeightsBar.tsx to display and edit level default weights:

```typescript
import { WeightBadge } from './WeightBadge'
import clsx from 'clsx'

interface LevelWeightsBarProps {
  /** Current level default weights */
  weights: { l1: number; l2: number; l3: number; l4: number; l5: number }
  /** Called when a level weight changes */
  onWeightChange: (level: 1 | 2 | 3 | 4 | 5, weight: number) => void
  /** Disable editing */
  disabled?: boolean
}

const LEVELS = [1, 2, 3, 4, 5] as const

export function LevelWeightsBar({
  weights,
  onWeightChange,
  disabled = false,
}: LevelWeightsBarProps) {
  return (
    <div className="flex items-center gap-3 px-3 py-2 bg-surface-elevated rounded-md border border-surface-border">
      <span className="text-xs font-medium text-text-secondary">Level Weights:</span>
      <div className="flex items-center gap-2">
        {LEVELS.map((level) => (
          <div key={level} className="flex items-center gap-1">
            <span className="text-xs text-text-muted">L{level}</span>
            <WeightBadge
              value={weights[`l${level}` as keyof typeof weights]}
              isOverride={false}
              onChange={(value) => onWeightChange(level, value)}
              disabled={disabled}
            />
          </div>
        ))}
      </div>
    </div>
  )
}
```

This bar displays all 5 level defaults in a row with editable WeightBadge for each.
Place above the tree in TaxonomyPage (will integrate in Task 3).
  </action>
  <verify>`npm run build` compiles without errors</verify>
  <done>LevelWeightsBar component displays L1-L5 weights with inline editing</done>
</task>

<task type="auto">
  <name>Task 3: Integrate WeightBadge into TaxonomyNode and page</name>
  <files>src/components/taxonomy/TaxonomyNode.tsx, src/components/taxonomy/index.ts, src/pages/TaxonomyPage.tsx</files>
  <action>
1. Update src/components/taxonomy/index.ts to export new components:
```typescript
export { WeightBadge } from './WeightBadge'
export { LevelWeightsBar } from './LevelWeightsBar'
```

2. Update TaxonomyNode.tsx to include WeightBadge:

Add imports:
```typescript
import { WeightBadge } from './WeightBadge'
import { useTaxonomyStore } from '@/stores/taxonomyStore'
```

Add new props to interface:
```typescript
interface TaxonomyNodeProps extends NodeRendererProps<TaxonomyItem> {
  // ... existing props ...
  /** Taxonomy type for weight lookups */
  taxonomyType?: 'risk' | 'process'
  /** Whether to show weight badges */
  showWeights?: boolean
}
```

Inside the component, add weight handling:
```typescript
const { getEffectiveWeight, setNodeWeight, riskWeights, processWeights } = useTaxonomyStore()
const taxonomyWeights = taxonomyType === 'risk' ? riskWeights : processWeights

// Get effective weight for this node (level is 0-indexed in react-arborist, weights use 1-5)
const nodeLevel = node.level + 1
const effectiveWeight = taxonomyType ? getEffectiveWeight(taxonomyType, node.id, nodeLevel) : 1
const hasOverride = taxonomyType ? node.id in taxonomyWeights.nodeOverrides : false

const handleWeightChange = (value: number) => {
  if (taxonomyType) {
    setNodeWeight(taxonomyType, node.id, value)
  }
}

const handleWeightClear = () => {
  if (taxonomyType) {
    setNodeWeight(taxonomyType, node.id, null)
  }
}
```

Add WeightBadge to the JSX after the ID badge, conditionally rendered:
```tsx
{/* Weight badge (after ID badge) */}
{showWeights && taxonomyType && (
  <WeightBadge
    value={effectiveWeight}
    isOverride={hasOverride}
    onChange={handleWeightChange}
    onClear={hasOverride ? handleWeightClear : undefined}
    disabled={!canEditTaxonomies}
  />
)}
```

Place it right after the hierarchical ID badge section, before the name/description container.

3. Update TaxonomyPage.tsx:

Add imports:
```typescript
import { LevelWeightsBar } from '@/components/taxonomy'
import { useTaxonomyStore } from '@/stores/taxonomyStore'
```

Add state and handlers:
```typescript
const [showWeights, setShowWeights] = useState(false)
const { riskWeights, processWeights, setLevelWeight } = useTaxonomyStore()

const currentWeights = activeTab === 'risk' ? riskWeights : processWeights

const handleLevelWeightChange = (level: 1|2|3|4|5, weight: number) => {
  setLevelWeight(activeTab, level, weight)
}
```

Add toggle button to toolbar area (can add to TaxonomyToolbar props or inline):
```tsx
{/* Weight toggle button */}
<button
  onClick={() => setShowWeights(!showWeights)}
  className={clsx(
    'p-2 rounded-md transition-colors border border-surface-border',
    showWeights
      ? 'bg-accent-500/20 text-accent-400 border-accent-500/30'
      : 'bg-surface-overlay text-text-muted hover:text-text-secondary'
  )}
  title={showWeights ? 'Hide Weights' : 'Show Weights'}
>
  <Scale size={16} />
</button>
```

Import Scale icon from lucide-react.

Add LevelWeightsBar below toolbar when showWeights is true:
```tsx
{showWeights && (
  <LevelWeightsBar
    weights={currentWeights.levelDefaults}
    onWeightChange={handleLevelWeightChange}
    disabled={!canEditTaxonomies}
  />
)}
```

Pass showWeights and taxonomyType to TaxonomyTree/TaxonomyNode:
- Update TaxonomyTree to accept and pass through showWeights and taxonomyType props to TaxonomyNode
  </action>
  <verify>
1. `npm run build` compiles without errors
2. Manual test: Navigate to Taxonomy page, toggle weight visibility, see badges on nodes
3. Manual test: Click a weight badge, edit value, see it persist
  </verify>
  <done>Weight badges visible on nodes, level defaults editable, toggle to show/hide weights</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- Taxonomy page shows weight toggle button
- Clicking toggle shows level weights bar and node badges
- Clicking badge allows inline editing
- Overrides show accent styling with clear button
- Changes persist after page refresh
</verification>

<success_criteria>
1. WeightBadge component exists with click-to-edit functionality
2. LevelWeightsBar displays L1-L5 defaults with editing
3. TaxonomyNode shows weight badge for each node
4. Override weights are visually distinct (accent color)
5. User can clear override via X button
6. Weight toggle button controls visibility
7. Only Risk Manager can edit weights (permission-gated)
</success_criteria>

<output>
After completion, create `.planning/phases/07-weights-configuration/07-02-SUMMARY.md`
</output>
