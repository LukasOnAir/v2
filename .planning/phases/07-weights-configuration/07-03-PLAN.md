---
phase: 07-weights-configuration
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/sunburst/useSunburstData.ts
  - src/components/matrix/MatrixGrid.tsx
  - src/stores/matrixStore.ts
autonomous: true

must_haves:
  truths:
    - "Sunburst chart uses weights from taxonomyStore"
    - "Matrix uses weights from taxonomyStore"
    - "Weight changes in Taxonomy page immediately affect Matrix and Sunburst calculations"
    - "Per-node overrides are respected in aggregation"
  artifacts:
    - path: "src/components/sunburst/useSunburstData.ts"
      provides: "Sunburst data hook reading from taxonomyStore"
      contains: "useTaxonomyStore"
    - path: "src/components/matrix/MatrixGrid.tsx"
      provides: "Matrix using taxonomyStore weights"
      contains: "riskWeights|processWeights"
  key_links:
    - from: "src/components/sunburst/useSunburstData.ts"
      to: "src/stores/taxonomyStore.ts"
      via: "useTaxonomyStore hook"
      pattern: "useTaxonomyStore.*riskWeights"
    - from: "src/components/matrix/MatrixGrid.tsx"
      to: "src/stores/taxonomyStore.ts"
      via: "useTaxonomyStore hook"
      pattern: "useTaxonomyStore.*riskWeights"
---

<objective>
Update weight consumers (Sunburst and Matrix) to read from taxonomyStore instead of matrixStore.

Purpose: Unify weight source of truth in taxonomyStore so that weight changes in Taxonomy page propagate to visualizations.
Output: Sunburst and Matrix both use taxonomyStore weights, matrixStore.weights deprecated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-weights-configuration/07-CONTEXT.md
@.planning/phases/07-weights-configuration/07-RESEARCH.md
@.planning/phases/07-weights-configuration/07-01-SUMMARY.md

# Existing files
@src/components/sunburst/useSunburstData.ts
@src/components/matrix/MatrixGrid.tsx
@src/utils/aggregation.ts
@src/stores/matrixStore.ts
@src/stores/taxonomyStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useSunburstData to read weights from taxonomyStore</name>
  <files>src/components/sunburst/useSunburstData.ts</files>
  <action>
1. Update imports to include taxonomyStore weight types:
```typescript
import { useTaxonomyStore } from '@/stores/taxonomyStore'
import type { TaxonomyWeights } from '@/types/taxonomy'
```

2. Replace matrixStore weights subscription with taxonomyStore:

Before:
```typescript
const weights = useMatrixStore((state) => state.weights)
```

After:
```typescript
const { riskWeights, processWeights, getEffectiveWeight } = useTaxonomyStore()
```

3. Update getWeightForLevel function to support node-specific overrides:

Create a new helper that uses getEffectiveWeight:
```typescript
/**
 * Get weight for a specific node at a level
 * Uses node override if exists, otherwise level default
 */
function getEffectiveWeightForNode(
  weights: TaxonomyWeights,
  nodeId: string,
  level: number
): number {
  if (nodeId in weights.nodeOverrides) {
    return weights.nodeOverrides[nodeId]
  }
  const levelKey = `l${level}` as keyof TaxonomyWeights['levelDefaults']
  return weights.levelDefaults[levelKey]
}
```

4. Update calculateLeafScore to use the appropriate weights based on taxonomy type:

The function already receives `type` parameter. Pass the correct weights object:
```typescript
const weights = type === 'risk' ? riskWeights : processWeights
```

And update the weight lookup to use node IDs where applicable.

5. Update the useMemo dependencies to include riskWeights and processWeights instead of weights:
```typescript
}, [taxonomyType, scoreType, aggregationMode, risks, processes, rows, riskWeights, processWeights])
```

6. Remove the useMatrixStore import for weights (keep if used for other things like zoomLevel).

Note: The existing aggregation logic uses level-based weights. For per-node overrides, update calculateLeafScore to check if the matching row's node has an override. Since rows match multiple levels, use the leaf node ID for override lookup.
  </action>
  <verify>`npm run build` compiles without errors</verify>
  <done>useSunburstData reads weights from taxonomyStore and respects node overrides</done>
</task>

<task type="auto">
  <name>Task 2: Update Matrix to read weights from taxonomyStore</name>
  <files>src/components/matrix/MatrixGrid.tsx</files>
  <action>
1. Find where MatrixGrid uses weights. Check if it directly uses matrixStore.weights or calls aggregation utilities.

2. If MatrixGrid imports useMatrixStore for weights:
   - Add import for useTaxonomyStore
   - Subscribe to riskWeights and processWeights from taxonomyStore
   - Replace matrixStore weights usage

3. MatrixGrid likely uses calculateWeightedAverage from aggregation.ts. Check how weights are passed:

Option A: If calculateWeightedAverage is called directly with weights:
   - Pass taxonomyStore weights instead of matrixStore weights
   - Need to decide which weights to use (risk or process) - use risk weights for risk axis, process weights for process axis
   - For matrix cells, use the taxonomy type that makes sense for the cell's parent axis

Option B: If MatrixGrid doesn't directly pass weights but aggregation.ts gets them internally:
   - Update aggregation.ts to accept weights as parameter (it already does)
   - Ensure MatrixGrid passes correct weights

4. The matrix shows risk x process combinations. For weighted averages:
   - Risk column headers should use riskWeights
   - Process row headers should use processWeights
   - Cell values aggregate based on the hierarchy being aggregated

In practice, calculateWeightedAverage uses a single weights object for all levels. For the matrix:
   - When aggregating by risk hierarchy, use riskWeights.levelDefaults
   - When aggregating by process hierarchy, use processWeights.levelDefaults

5. Update MatrixGrid to:
```typescript
const { riskWeights, processWeights } = useTaxonomyStore()

// When calculating risk column aggregates:
calculateWeightedAverage(rows, riskId, processId, riskWeights.levelDefaults, scoreType)

// When calculating process row aggregates:
calculateWeightedAverage(rows, riskId, processId, processWeights.levelDefaults, scoreType)
```

Actually, looking at the existing code, calculateWeightedAverage already uses a single weight object for simplicity. For now, use riskWeights.levelDefaults as the primary weight source since that's the most common use case (risk hierarchy visualization).

The exact implementation depends on how MatrixGrid currently works. Read the file and adapt accordingly.
  </action>
  <verify>
1. `npm run build` compiles without errors
2. Manual test: Open Matrix, change weights in Taxonomy page, Matrix colors should update
  </verify>
  <done>Matrix uses taxonomyStore weights for aggregation calculations</done>
</task>

<task type="auto">
  <name>Task 3: Deprecate matrixStore weights (optional cleanup)</name>
  <files>src/stores/matrixStore.ts</files>
  <action>
1. Add deprecation comment to matrixStore weights:
```typescript
/**
 * @deprecated Use taxonomyStore.riskWeights and taxonomyStore.processWeights instead.
 * Kept for backwards compatibility during migration.
 */
weights: AggregationWeights
```

2. Add deprecation comment to setWeights:
```typescript
/**
 * @deprecated Use taxonomyStore.setLevelWeight instead.
 */
setWeights: (weights: Partial<AggregationWeights>) => void
```

3. Verify no other components use matrixStore.weights or setWeights:
   - Search codebase for `useMatrixStore.*weights`
   - Search for `setWeights`
   - If found in unexpected places, update them to use taxonomyStore

4. If weights are no longer used anywhere:
   - Remove from matrixStore state
   - Remove from partialize (if present)
   - Remove DEFAULT_WEIGHTS export if not used elsewhere

   However, leave them in place if any legacy code still references them. The deprecation comment serves as documentation.

5. Keep AggregationWeights type export from matrixStore.ts or move to a shared types file. aggregation.ts imports it, so ensure the import path still works.

Actually, check aggregation.ts - it exports its own AggregationWeights. The matrixStore one may be redundant. Verify imports across codebase and consolidate if possible.
  </action>
  <verify>
1. `npm run build` compiles without errors
2. No runtime errors when using Matrix or Sunburst
3. Deprecation comments visible in IDE hover
  </verify>
  <done>matrixStore.weights marked as deprecated, consumers migrated to taxonomyStore</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- Sunburst colors update when changing weights in Taxonomy page
- Matrix colors update when changing weights in Taxonomy page
- Per-node weight overrides affect aggregated scores
- No references to matrixStore.weights remain (except deprecated definition)
</verification>

<success_criteria>
1. useSunburstData reads from taxonomyStore.riskWeights / processWeights
2. MatrixGrid reads from taxonomyStore weights
3. Changing weights in Taxonomy page immediately updates Sunburst and Matrix
4. matrixStore.weights is deprecated with comment
5. Build passes with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-weights-configuration/07-03-SUMMARY.md`
</output>
