---
phase: 08-remediation-issue-tracking
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/rct/RemediationSection.tsx
  - src/components/rct/RemediationForm.tsx
  - src/components/rct/ControlPanel.tsx
  - src/components/rct/index.ts
autonomous: true

must_haves:
  truths:
    - "User can view existing remediation plans for a control"
    - "User can create remediation plan from failed/partial test"
    - "User can update remediation status"
    - "User can add/complete action items"
    - "Risk Manager can create/edit, Control Owner can view"
  artifacts:
    - path: "src/components/rct/RemediationSection.tsx"
      provides: "Collapsible remediation UI in ControlPanel"
      min_lines: 100
    - path: "src/components/rct/RemediationForm.tsx"
      provides: "Form for creating/editing remediation plans"
      min_lines: 80
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Integration of RemediationSection"
      contains: "RemediationSection"
  key_links:
    - from: "src/components/rct/RemediationSection.tsx"
      to: "src/stores/rctStore.ts"
      via: "useRCTStore hook"
      pattern: "useRCTStore"
    - from: "src/components/rct/ControlPanel.tsx"
      to: "src/components/rct/RemediationSection.tsx"
      via: "component import"
      pattern: "import.*RemediationSection"
---

<objective>
Create remediation UI components integrated into ControlPanel

Purpose: Enable users to create and manage remediation plans directly from control test findings
Output: RemediationSection and RemediationForm components that allow viewing, creating, and updating remediation plans within the existing ControlPanel slide-out
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-remediation-issue-tracking/08-RESEARCH.md
@.planning/phases/08-remediation-issue-tracking/08-01-SUMMARY.md
@src/components/rct/ControlPanel.tsx
@src/components/rct/ControlTestSection.tsx
@src/hooks/usePermissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RemediationForm component</name>
  <files>src/components/rct/RemediationForm.tsx</files>
  <action>
Create a new file src/components/rct/RemediationForm.tsx with a form for creating/editing remediation plans.

Follow the existing ControlTestForm pattern:

```typescript
import { useState } from 'react'
import { format, addDays } from 'date-fns'
import { useRCTStore } from '@/stores/rctStore'
import type { ControlTest } from '@/types/rct'

interface RemediationFormProps {
  rowId: string
  controlId: string
  test: ControlTest  // The triggering test with findings
  grossScore: number | null
  onComplete: () => void
}

export function RemediationForm({ rowId, controlId, test, grossScore, onComplete }: RemediationFormProps) {
  // Form state for title, description, owner, deadline
  // Default deadline: 30 days from today
  // Default title: "Remediate: " + first 50 chars of findings

  // Get createRemediationPlan from store

  // On submit: call createRemediationPlan, then onComplete()

  // Form with:
  // - Title input (required)
  // - Owner input (required)
  // - Deadline date input (required, default +30 days)
  // - Description textarea (optional, prefilled with test.findings)
  // - Initial action item from test.recommendations if present

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      {/* Title */}
      <div>
        <label className="text-xs text-text-muted block mb-1">Title *</label>
        <input ... />
      </div>

      {/* Owner */}
      <div>
        <label className="text-xs text-text-muted block mb-1">Owner *</label>
        <input ... />
      </div>

      {/* Deadline */}
      <div>
        <label className="text-xs text-text-muted block mb-1">Deadline *</label>
        <input type="date" ... />
      </div>

      {/* Description */}
      <div>
        <label className="text-xs text-text-muted block mb-1">Description</label>
        <textarea ... />
      </div>

      {/* Buttons */}
      <div className="flex justify-end gap-2 pt-2">
        <button type="button" onClick={onComplete}>Cancel</button>
        <button type="submit" disabled={!isValid}>Create</button>
      </div>
    </form>
  )
}
```

Style consistently with existing ControlTestForm.tsx (input styles, button styles, spacing).
  </action>
  <verify>`npm run build` compiles without errors</verify>
  <done>RemediationForm component exists and accepts required props for creating remediation plans</done>
</task>

<task type="auto">
  <name>Task 2: Create RemediationSection component</name>
  <files>src/components/rct/RemediationSection.tsx</files>
  <action>
Create src/components/rct/RemediationSection.tsx following the ControlTestSection pattern.

Structure:
1. Collapsible header with ChevronDown/ChevronRight, ClipboardList icon, "Remediation" label
2. Quick status indicator showing active remediation count when collapsed
3. Expanded content with:
   - List of existing remediation plans for this control
   - Each plan shows: title, status badge, priority badge, owner, deadline, action items checklist
   - Status dropdown to update status (Risk Manager only)
   - Action items with checkboxes to toggle completion
   - "Add Action Item" input
   - Delete button (Risk Manager only)
4. "Create Remediation" button that appears for deficient tests (fail/partial) without existing remediation
5. RemediationForm appears when creating new remediation

Props:
```typescript
interface RemediationSectionProps {
  rowId: string
  control: Control
  tests: ControlTest[]  // Tests for this control (to find deficient ones)
  grossScore: number | null
}
```

Key behaviors:
- Show active remediation count in header
- Only show "Create Remediation" for tests with result 'fail' or 'partial' that don't already have a remediation plan
- Status updates: use updateRemediationStatus from store
- Action item toggles: use toggleActionItem from store
- Permission checks: canEditControlDefinitions for create/edit/delete, others can view and toggle action items

Status badge colors (from research):
- open: bg-blue-500/20 text-blue-400
- in-progress: bg-amber-500/20 text-amber-400
- resolved: bg-green-500/20 text-green-400
- closed: bg-surface-overlay text-text-muted

Priority badge colors:
- critical: bg-red-500/20 text-red-400
- high: bg-orange-500/20 text-orange-400
- medium: bg-amber-500/20 text-amber-400
- low: bg-green-500/20 text-green-400
  </action>
  <verify>`npm run build` compiles without errors</verify>
  <done>RemediationSection component renders existing remediation plans and allows creating new ones from deficient tests</done>
</task>

<task type="auto">
  <name>Task 3: Integrate RemediationSection into ControlPanel</name>
  <files>src/components/rct/ControlPanel.tsx, src/components/rct/index.ts</files>
  <action>
1. Update src/components/rct/ControlPanel.tsx:

   a. Add import at top:
      ```typescript
      import { RemediationSection } from './RemediationSection'
      ```

   b. Get controlTests from store (already have changeRequests):
      ```typescript
      const { ..., controlTests } = useRCTStore()
      ```

   c. Inside the control card (after ControlTestSection), add RemediationSection:
      ```typescript
      {/* Control Testing Section */}
      <ControlTestSection rowId={row.id} control={control} />

      {/* Remediation Section */}
      <RemediationSection
        rowId={row.id}
        control={control}
        tests={controlTests.filter(t => t.controlId === control.id)}
        grossScore={row.grossScore}
      />
      ```

2. Update src/components/rct/index.ts to export new components:
   ```typescript
   export { RemediationSection } from './RemediationSection'
   export { RemediationForm } from './RemediationForm'
   ```

The RemediationSection should appear below the Testing section in each control card, following the same visual pattern (border-t, collapsible).
  </action>
  <verify>
1. `npm run build` compiles without errors
2. Run `npm run dev`, navigate to RCT, click a control to open ControlPanel
3. See "Remediation" collapsible section below "Testing" section
  </verify>
  <done>RemediationSection is visible in ControlPanel below the Testing section for every control</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. ControlPanel shows Remediation section below Testing section
3. Creating a remediation plan from a failed test works
4. Status updates and action item toggles work
5. Permission checks restrict editing to Risk Manager
</verification>

<success_criteria>
- RemediationSection appears in ControlPanel for each control
- User can view existing remediation plans
- User can create remediation from failed/partial tests
- User can update status and toggle action items
- Permission model: Risk Manager creates/edits, Control Owner views and toggles action items
</success_criteria>

<output>
After completion, create `.planning/phases/08-remediation-issue-tracking/08-02-SUMMARY.md`
</output>
