---
phase: 09-audit-trail-version-control
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - src/components/audit/AuditTimeline.tsx
  - src/components/audit/AuditFilters.tsx
  - src/components/audit/ChangeDetail.tsx
  - src/components/audit/EntityHistoryPanel.tsx
  - src/hooks/useAuditLog.ts
  - src/pages/AuditPage.tsx
  - src/components/layout/Sidebar.tsx
  - src/App.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can navigate to Audit page from sidebar"
    - "Audit page displays chronological timeline of changes"
    - "User can filter audit log by date range"
    - "User can filter audit log by entity type"
    - "User can filter audit log by change type"
    - "Before/after values are visible for each change"
    - "User can view history for a specific entity"
  artifacts:
    - path: "src/pages/AuditPage.tsx"
      provides: "Main audit trail page with timeline and filters"
      exports: ["default"]
    - path: "src/components/audit/AuditTimeline.tsx"
      provides: "Vertical timeline component showing chronological changes"
      exports: ["AuditTimeline"]
    - path: "src/components/audit/AuditFilters.tsx"
      provides: "Filter controls for date range, entity type, change type"
      exports: ["AuditFilters"]
    - path: "src/components/audit/ChangeDetail.tsx"
      provides: "Before/after value comparison display"
      exports: ["ChangeDetail"]
    - path: "src/hooks/useAuditLog.ts"
      provides: "Hook for filtered audit queries"
      exports: ["useAuditLog"]
  key_links:
    - from: "src/pages/AuditPage.tsx"
      to: "src/hooks/useAuditLog.ts"
      via: "useAuditLog hook"
      pattern: "useAuditLog"
    - from: "src/hooks/useAuditLog.ts"
      to: "src/stores/auditStore.ts"
      via: "useAuditStore"
      pattern: "useAuditStore"
    - from: "src/components/layout/Sidebar.tsx"
      to: "src/pages/AuditPage.tsx"
      via: "NavLink to /audit"
      pattern: "to=\"/audit\""
---

<objective>
Build the audit trail UI components for viewing change history with filtering.

Purpose: Users need to see who changed what and when. The audit page provides a central view of all changes with filters, while entity-specific history can be viewed in context.

Output: AuditPage with timeline, filters, and detail views; sidebar navigation to reach it.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-audit-trail-version-control/09-RESEARCH.md
@.planning/phases/09-audit-trail-version-control/09-01-SUMMARY.md
@.planning/phases/09-audit-trail-version-control/09-02-SUMMARY.md

# Relevant source files
@src/types/audit.ts
@src/stores/auditStore.ts
@src/pages/RemediationPage.tsx
@src/components/remediation/RemediationDashboard.tsx
@src/components/layout/Sidebar.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAuditLog hook and filter types</name>
  <files>src/hooks/useAuditLog.ts</files>
  <action>
Create a custom hook for querying filtered audit data:

1. **Filter State Interface:**
```typescript
interface AuditFilters {
  dateRange: { start: Date | null; end: Date | null }
  entityTypes: EntityType[]  // Empty means all
  changeTypes: ChangeType[]  // Empty means all
  searchQuery: string        // Filter by entityName
}
```

2. **useAuditLog hook:**
```typescript
export function useAuditLog(filters: AuditFilters) {
  const entries = useAuditStore((state) => state.entries)

  const filteredEntries = useMemo(() => {
    let result = [...entries]

    // Date range filter
    if (filters.dateRange.start) {
      result = result.filter(e =>
        new Date(e.timestamp) >= filters.dateRange.start!
      )
    }
    if (filters.dateRange.end) {
      result = result.filter(e =>
        new Date(e.timestamp) <= filters.dateRange.end!
      )
    }

    // Entity type filter
    if (filters.entityTypes.length > 0) {
      result = result.filter(e =>
        filters.entityTypes.includes(e.entityType)
      )
    }

    // Change type filter
    if (filters.changeTypes.length > 0) {
      result = result.filter(e =>
        filters.changeTypes.includes(e.changeType)
      )
    }

    // Search query filter (entityName)
    if (filters.searchQuery.trim()) {
      const query = filters.searchQuery.toLowerCase()
      result = result.filter(e =>
        e.entityName?.toLowerCase().includes(query) ||
        e.summary?.toLowerCase().includes(query)
      )
    }

    // Sort newest first
    return result.sort((a, b) =>
      new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
    )
  }, [entries, filters])

  return {
    entries: filteredEntries,
    totalCount: entries.length,
    filteredCount: filteredEntries.length,
  }
}
```

3. **Helper exports:**
- Default filter state constant
- Entity type labels for display
- Change type labels for display

Use date-fns for date comparisons (already in project).
  </action>
  <verify>
1. `npx tsc --noEmit` compiles without errors
2. Hook exports are correct
  </verify>
  <done>useAuditLog hook filters audit entries by date range, entity type, change type, and search query</done>
</task>

<task type="auto">
  <name>Task 2: Create audit UI components</name>
  <files>src/components/audit/AuditTimeline.tsx, src/components/audit/AuditFilters.tsx, src/components/audit/ChangeDetail.tsx, src/components/audit/EntityHistoryPanel.tsx</files>
  <action>
Create the audit trail UI components:

**1. AuditTimeline.tsx:**
Vertical timeline showing chronological changes.

```typescript
interface AuditTimelineProps {
  entries: AuditEntry[]
  onEntityClick?: (entityId: string, entityType: EntityType) => void
}
```

- Use Tailwind for styling (border-l pattern from research)
- Show timestamp formatted with date-fns (PPpp format: "Jan 21, 2026, 3:45 PM")
- Show entity type icon/badge (color-coded)
- Show entity name and change summary
- Expandable details showing ChangeDetail
- Show user role badge (risk-manager=amber, control-owner=blue)
- Handle empty state ("No audit entries")
- Limit initial render to 100 entries with "Load more" button

**2. AuditFilters.tsx:**
Filter controls for the audit log.

```typescript
interface AuditFiltersProps {
  filters: AuditFilters
  onChange: (filters: AuditFilters) => void
}
```

- Date range picker using native date inputs (start/end)
- Entity type multi-select checkboxes (risks, processes, controls, etc.)
- Change type multi-select checkboxes (create, update, delete)
- Search input for entity name
- "Clear filters" button
- Show count: "Showing X of Y entries"
- Follow RCTToolbar styling pattern for consistency

**3. ChangeDetail.tsx:**
Before/after comparison for field changes.

```typescript
interface ChangeDetailProps {
  fieldChanges: FieldChange[]
  changeType: ChangeType
}
```

- Table layout: Field | Before | After
- Color coding: green for new values, red for removed, amber for changed
- Handle null/undefined display gracefully (show "â€”")
- Truncate long values with tooltip for full view
- Format dates nicely if field looks like a date
- For create: show only "After" column
- For delete: show only "Before" column
- For arrays (like actionItems): show summary "Added 2 items" or similar

**4. EntityHistoryPanel.tsx:**
Panel showing history for a specific entity (for use in ControlPanel, etc.).

```typescript
interface EntityHistoryPanelProps {
  entityId: string
  entityType: EntityType
  title?: string
}
```

- Query entries using useAuditStore.getState().getEntriesForEntity(entityId)
- Compact timeline view (no filters needed)
- Limit to most recent 20 entries
- "View all in Audit Log" link that navigates to /audit with pre-filter
- Collapsible section (follows pattern from ControlTestSection)

All components use dark theme (zinc-900, zinc-800, zinc-700 backgrounds, zinc-200/400 text).
  </action>
  <verify>
1. `npx tsc --noEmit` compiles without errors
2. Components use consistent styling with existing app
  </verify>
  <done>Four audit UI components exist: AuditTimeline, AuditFilters, ChangeDetail, EntityHistoryPanel</done>
</task>

<task type="auto">
  <name>Task 3: Create AuditPage and integrate into app</name>
  <files>src/pages/AuditPage.tsx, src/components/layout/Sidebar.tsx, src/App.tsx</files>
  <action>
**1. AuditPage.tsx:**
Main audit trail page combining timeline and filters.

Structure:
```
Header: "Audit Trail" title
Toolbar: AuditFilters component
Content: AuditTimeline with filtered entries
```

- Use useState for filter state (initialized to default)
- Use useAuditLog hook with filters
- Follow RemediationPage layout pattern for consistency
- Show loading state while entries load (though instant with localStorage)
- Handle URL params for pre-filtering (optional - nice to have for EntityHistoryPanel links)

**2. Sidebar.tsx update:**
Add navigation link to Audit page.

- Add History/Clock icon for audit trail (use Lucide React - already in project)
- Link to /audit route
- Position after Remediation in sidebar (near bottom, utility section)
- Label: "Audit Trail"

**3. App.tsx update:**
Add route for AuditPage.

```typescript
import AuditPage from '@/pages/AuditPage'

// In routes:
<Route path="/audit" element={<AuditPage />} />
```

Ensure the route is inside the Layout wrapper for consistent navigation.
  </action>
  <verify>
1. `npx tsc --noEmit` compiles without errors
2. `npm run build` succeeds
3. App runs: `npm run dev`
4. Navigate to /audit - page loads with timeline and filters
5. Sidebar shows "Audit Trail" link
  </verify>
  <done>AuditPage is accessible from sidebar, displays timeline and filters, allows date/type filtering</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. App runs without console errors: `npm run dev`
4. Sidebar shows "Audit Trail" navigation link
5. /audit page displays timeline of changes
6. Filters work: date range, entity type, change type
7. Before/after values visible in change details
8. Search filters by entity name
</verification>

<success_criteria>
- User can navigate to Audit page from sidebar
- Timeline displays chronological changes (newest first)
- Date range filter restricts displayed entries
- Entity type filter shows only selected types
- Change type filter shows only create/update/delete as selected
- ChangeDetail shows before/after values in table format
- Search filters by entity name
- Empty state handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/09-audit-trail-version-control/09-03-SUMMARY.md`
</output>
