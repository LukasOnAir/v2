---
phase: 09-audit-trail-version-control
plan: 04
type: execute
wave: 4
depends_on: ["09-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All data changes are logged with timestamp and change type"
    - "User can view change history for any risk, process, control, or RCT row"
    - "Changes show before/after values where applicable"
    - "Audit log is filterable by date range, entity type, and change type"
    - "Audit data persists across sessions"
---

<objective>
Verify the complete audit trail feature works end-to-end.

Purpose: Ensure all Phase 9 success criteria are met before marking complete.

Output: Verified feature working correctly with all filters and persistence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-audit-trail-version-control/09-01-SUMMARY.md
@.planning/phases/09-audit-trail-version-control/09-02-SUMMARY.md
@.planning/phases/09-audit-trail-version-control/09-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Verify audit trail feature</name>
  <what-built>
Complete audit trail system with:
- Automatic change logging for all entities
- Audit page with timeline view
- Filters for date range, entity type, change type
- Before/after value display
- Persistent storage across sessions
  </what-built>
  <how-to-verify>
**Start the app:** `npm run dev`

**Test 1: Audit page access**
1. Click "Audit Trail" in sidebar
2. Verify page loads with timeline (may be empty initially)
3. Verify filters are visible (date range, entity types, change types)

**Test 2: Taxonomy change logging**
1. Go to Taxonomy page
2. Add a new risk item (e.g., "Test Risk")
3. Navigate to Audit Trail page
4. Verify entry shows: entityType=risk, changeType=create
5. Expand entry to see change details (name: null -> "Test Risk")

**Test 3: RCT score change logging**
1. Go to RCT page (ensure you have some rows)
2. Edit a gross probability score (e.g., change from 3 to 4)
3. Navigate to Audit Trail page
4. Verify entry shows: entityType=rctRow, changeType=update
5. Expand to see: grossProbability: 3 -> 4

**Test 4: Control change logging**
1. Go to RCT page, open a row's control panel
2. Add a new control
3. Navigate to Audit Trail
4. Verify entry shows: entityType=control, changeType=create

**Test 5: Filter functionality**
1. On Audit Trail page, filter by entityType=risk only
2. Verify only risk entries shown
3. Filter by changeType=update only
4. Verify only update entries shown
5. Set a date range that excludes today
6. Verify entries are filtered out
7. Clear filters
8. Verify all entries return

**Test 6: Persistence**
1. Note the number of entries on Audit Trail page
2. Refresh the browser (F5)
3. Verify entries persist (same count)

**Test 7: Before/after values**
1. Find an "update" entry
2. Expand to view change details
3. Verify "Before" and "After" columns show old/new values

**Test 8: User tracking**
1. Switch role to "Control Owner" (if available in header)
2. Make a change (e.g., edit a control's net score)
3. Switch back to "Risk Manager"
4. Check Audit Trail
5. Verify the new entry shows "control-owner" as user
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
All manual tests pass as documented above.
</verification>

<success_criteria>
Phase 9 roadmap criteria verified:
- All data changes are logged with timestamp and change type
- User can view change history for any risk, process, control, or RCT row
- Changes show before/after values where applicable
- Audit log is filterable by date range, entity type, and change type
- Audit data persists across sessions
</success_criteria>

<output>
After approval, create `.planning/phases/09-audit-trail-version-control/09-04-SUMMARY.md`
Update `.planning/STATE.md` and `.planning/ROADMAP.md` to mark Phase 9 complete.
</output>
