---
phase: 10-analytics-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/utils/samplingCalculator.ts
  - src/hooks/useAnalyticsData.ts
  - src/components/analytics/index.ts
autonomous: true

must_haves:
  truths:
    - "Recharts library is installed and available for import"
    - "Sample size calculation returns industry-standard values for given inputs"
    - "Control test trend data can be derived from controlTests array"
    - "Risk score history can be derived from audit entries"
  artifacts:
    - path: "src/utils/samplingCalculator.ts"
      provides: "AICPA-aligned sample size calculator"
      exports: ["calculateSampleSize", "SamplingInput", "SamplingResult"]
    - path: "src/hooks/useAnalyticsData.ts"
      provides: "Data transformation hooks for charts"
      exports: ["useControlTestTrends", "useRiskScoreHistory", "useAggregationByCategory"]
    - path: "src/components/analytics/index.ts"
      provides: "Barrel export for analytics components"
      min_lines: 3
  key_links:
    - from: "src/hooks/useAnalyticsData.ts"
      to: "src/stores/rctStore.ts"
      via: "useRCTStore selector for controlTests"
      pattern: "useRCTStore.*controlTests"
    - from: "src/hooks/useAnalyticsData.ts"
      to: "src/stores/auditStore.ts"
      via: "useAuditStore selector for entries"
      pattern: "useAuditStore.*entries"
---

<objective>
Create analytics infrastructure: install Recharts, build sampling calculator utility, and data transformation hooks.

Purpose: Foundation for trend charts and sampling guidance that Phase 10 requires.
Output: Recharts available, sampling calculator utility, and three data hooks (useControlTestTrends, useRiskScoreHistory, useAggregationByCategory).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-analytics-reporting/10-RESEARCH.md

# Existing stores and types
@src/stores/rctStore.ts
@src/stores/auditStore.ts
@src/types/rct.ts
@src/types/audit.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and create sampling calculator</name>
  <files>package.json, src/utils/samplingCalculator.ts</files>
  <action>
1. Run `npm install recharts` to add the charting library.

2. Create `src/utils/samplingCalculator.ts` with:
   - `SamplingInput` interface with fields:
     - populationSize: number
     - confidenceLevel: 90 | 95
     - tolerableDeviationRate: 5 | 10
     - expectedDeviationRate: 0 | 1 | 2
   - `SamplingResult` interface with fields:
     - recommendedSampleSize: number
     - methodology: string
     - notes: string[]
   - `SAMPLE_SIZE_TABLE` constant with AICPA-aligned values:
     - '90-10-0': 23, '90-5-0': 46
     - '95-10-0': 29, '95-5-0': 59
     - '95-10-1': 46, '95-5-1': 93
     - '95-10-2': 77, '95-5-2': 124
   - `calculateSampleSize(input: SamplingInput): SamplingResult` function:
     - Build lookup key as `${confidenceLevel}-${tolerableDeviationRate}-${expectedDeviationRate}`
     - Get base size from table (default to 25 if key not found)
     - Apply finite population correction for populationSize < 250:
       adjustedSize = ceil((baseSize * populationSize) / (baseSize + populationSize - 1))
       Return max of (adjustedSize, min(populationSize, 2))
     - For larger populations, return base size unchanged
     - Include methodology note ("AICPA attribute sampling table" or "Finite population correction applied")

Export all types and functions.
  </action>
  <verify>
- `npm ls recharts` shows recharts installed
- `src/utils/samplingCalculator.ts` exists with calculateSampleSize export
  </verify>
  <done>
- Recharts available for import
- Sample size calculator returns 59 for {populationSize: 500, confidenceLevel: 95, tolerableDeviationRate: 5, expectedDeviationRate: 0}
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analytics data transformation hooks</name>
  <files>src/hooks/useAnalyticsData.ts, src/components/analytics/index.ts</files>
  <action>
1. Create `src/hooks/useAnalyticsData.ts` with:

```typescript
interface TrendDataPoint {
  date: string       // ISO date or formatted string for label
  timestamp: number  // For XAxis type="number"
  value: number
  label?: string
}

interface CategoryAggregation {
  categoryId: string
  categoryName: string
  avgGrossScore: number | null
  avgNetScore: number | null
  rowCount: number
  controlCount: number
}
```

- `useControlTestTrends(controlId?: string, dateRange?: { start: Date; end: Date }): TrendDataPoint[]`
  - Get controlTests from useRCTStore
  - Filter by controlId if provided
  - Filter by dateRange if provided
  - Map to TrendDataPoint: value = effectiveness ?? (result === 'pass' ? 5 : result === 'partial' ? 3 : 1)
  - Sort by timestamp ascending
  - Use useMemo with [controlTests, controlId, dateRange?.start?.getTime(), dateRange?.end?.getTime()] deps

- `useRiskScoreHistory(rowId?: string, dateRange?: { start: Date; end: Date }): TrendDataPoint[]`
  - Get entries from useAuditStore
  - Filter to entityType === 'rctRow'
  - Filter by entityId === rowId if provided
  - Filter by dateRange if provided
  - Filter to entries with fieldChanges including 'grossScore' or 'netScore'
  - Map to TrendDataPoint: value = newValue of score change
  - Sort by timestamp ascending
  - Aggregate by day (keep latest value per day) using date-fns startOfDay
  - Use useMemo

- `useAggregationByCategory(groupBy: 'riskL1' | 'processL1' = 'riskL1'): CategoryAggregation[]`
  - Get rows from useRCTStore
  - Group by riskL1Id or processL1Id
  - For each group calculate:
    - avgGrossScore: average of non-null grossScores
    - avgNetScore: average of non-null netScores
    - rowCount: number of rows
    - controlCount: sum of controls.length
  - Use useMemo

2. Create `src/components/analytics/index.ts` as empty barrel export file:
```typescript
// Analytics components barrel export
// Components will be added in subsequent plans
```
  </action>
  <verify>
- `src/hooks/useAnalyticsData.ts` exists with all three hooks exported
- `src/components/analytics/index.ts` exists
- TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>
- useControlTestTrends returns array of TrendDataPoints from controlTests
- useRiskScoreHistory returns array of TrendDataPoints from audit entries
- useAggregationByCategory returns array of CategoryAggregation objects
  </done>
</task>

</tasks>

<verification>
- [ ] `npm ls recharts` shows recharts@^2.x installed
- [ ] `src/utils/samplingCalculator.ts` exports calculateSampleSize function
- [ ] `src/hooks/useAnalyticsData.ts` exports three hooks
- [ ] `npx tsc --noEmit` passes without errors
</verification>

<success_criteria>
- Recharts library installed and importable
- Sampling calculator returns standard AICPA values
- Data transformation hooks compile and can be used by chart components
</success_criteria>

<output>
After completion, create `.planning/phases/10-analytics-reporting/10-01-SUMMARY.md`
</output>
