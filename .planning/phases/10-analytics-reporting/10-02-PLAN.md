---
phase: 10-analytics-reporting
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/components/analytics/ControlTestTrendChart.tsx
  - src/components/analytics/RiskScoreTrendChart.tsx
  - src/components/analytics/TrendChartSection.tsx
  - src/components/analytics/index.ts
autonomous: true

must_haves:
  truths:
    - "User can view trend chart showing control test results over time"
    - "User can see risk score changes over time"
    - "Charts render with dark theme styling matching application"
    - "Empty states display gracefully when no data"
  artifacts:
    - path: "src/components/analytics/ControlTestTrendChart.tsx"
      provides: "Line chart for control test effectiveness trends"
      min_lines: 40
    - path: "src/components/analytics/RiskScoreTrendChart.tsx"
      provides: "Line chart for risk score history"
      min_lines: 40
    - path: "src/components/analytics/TrendChartSection.tsx"
      provides: "Container for trend charts with date range filter"
      min_lines: 50
  key_links:
    - from: "src/components/analytics/ControlTestTrendChart.tsx"
      to: "src/hooks/useAnalyticsData.ts"
      via: "useControlTestTrends hook"
      pattern: "useControlTestTrends"
    - from: "src/components/analytics/RiskScoreTrendChart.tsx"
      to: "src/hooks/useAnalyticsData.ts"
      via: "useRiskScoreHistory hook"
      pattern: "useRiskScoreHistory"
---

<objective>
Build trend chart components using Recharts for control test results and risk score history.

Purpose: Visualize control testing effectiveness and risk score changes over time (ANALYTICS-01, ANALYTICS-02).
Output: Two trend chart components wrapped in a section with date range filtering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-analytics-reporting/10-RESEARCH.md
@.planning/phases/10-analytics-reporting/10-01-SUMMARY.md

# Hooks and utilities from Plan 01
@src/hooks/useAnalyticsData.ts
@src/utils/samplingCalculator.ts

# Theme reference
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Control Test Trend Chart</name>
  <files>src/components/analytics/ControlTestTrendChart.tsx</files>
  <action>
Create `src/components/analytics/ControlTestTrendChart.tsx`:

1. Import from recharts: LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
2. Import format from date-fns for axis formatting
3. Import useControlTestTrends from hooks

4. Define chart colors matching dark theme:
```typescript
const CHART_COLORS = {
  primary: 'rgb(251, 191, 36)',    // amber-400 (accent)
  secondary: 'rgb(34, 197, 94)',   // green-500
  grid: '#27272a',                  // zinc-800 (surface-border)
  text: '#a1a1aa',                  // zinc-400 (text-secondary)
  background: '#18181b'             // zinc-900 (surface-elevated)
}
```

5. Create CustomTooltip component for dark theme styling:
   - bg-surface-elevated border border-surface-border rounded-lg p-3 shadow-lg
   - Show date and effectiveness value

6. Create ControlTestTrendChart component with props:
   - controlId?: string (optional filter)
   - dateRange?: { start: Date; end: Date }
   - height?: number (default 300)

7. Use useControlTestTrends hook with props
8. Handle empty state: Show centered message "No test data available" with muted text
9. Render ResponsiveContainer > LineChart:
   - CartesianGrid with strokeDasharray="3 3" and grid color
   - XAxis with dataKey="date", format(new Date(d), 'MMM d'), text color
   - YAxis domain={[1, 5]} for effectiveness scale, text color
   - Tooltip with CustomTooltip content
   - Line type="monotone" dataKey="value" with primary color, strokeWidth=2, dots

Export the component.
  </action>
  <verify>
- File exists with ControlTestTrendChart export
- Component imports from recharts
- Uses useControlTestTrends hook
  </verify>
  <done>
- ControlTestTrendChart renders line chart with control test effectiveness data
- Empty state shows when no data
- Dark theme colors applied
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Risk Score Trend Chart and Section</name>
  <files>src/components/analytics/RiskScoreTrendChart.tsx, src/components/analytics/TrendChartSection.tsx, src/components/analytics/index.ts</files>
  <action>
1. Create `src/components/analytics/RiskScoreTrendChart.tsx`:
   - Same structure as ControlTestTrendChart
   - Props: rowId?: string, dateRange?: { start: Date; end: Date }, height?: number
   - Use useRiskScoreHistory hook
   - YAxis domain={[1, 25]} for risk score range
   - Different empty state: "No score history available"
   - Can show gross vs net scores with two lines if data available (primary for gross, secondary for net)
   - For simplicity, show single "value" line initially

2. Create `src/components/analytics/TrendChartSection.tsx`:
   - Props: title: string, children: React.ReactNode
   - Wrapper with:
     - Section container with dark background (bg-surface-elevated rounded-lg p-4)
     - Title in h3 with text-lg font-medium text-text-primary mb-4
     - Children slot for chart
   - Add date range selector:
     - Two date inputs (start, end) using native date input styled for dark theme
     - Default range: last 90 days (use date-fns subDays)
     - Pass dateRange to children via context or render props pattern
   - For simplicity, use render props: children is function receiving dateRange

Example usage:
```tsx
<TrendChartSection title="Control Test Effectiveness">
  {(dateRange) => <ControlTestTrendChart dateRange={dateRange} />}
</TrendChartSection>
```

3. Update `src/components/analytics/index.ts`:
```typescript
export { ControlTestTrendChart } from './ControlTestTrendChart'
export { RiskScoreTrendChart } from './RiskScoreTrendChart'
export { TrendChartSection } from './TrendChartSection'
```
  </action>
  <verify>
- `src/components/analytics/RiskScoreTrendChart.tsx` exists
- `src/components/analytics/TrendChartSection.tsx` exists
- All three components exported from index.ts
- `npx tsc --noEmit` passes
  </verify>
  <done>
- RiskScoreTrendChart renders risk score history from audit trail
- TrendChartSection wraps charts with title and date filtering
- Components follow dark theme styling
  </done>
</task>

</tasks>

<verification>
- [ ] ControlTestTrendChart renders with useControlTestTrends data
- [ ] RiskScoreTrendChart renders with useRiskScoreHistory data
- [ ] TrendChartSection provides date range filtering
- [ ] Empty states display when no data
- [ ] Dark theme colors consistent with application
- [ ] `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Trend charts visualize control test effectiveness over time
- Risk score history shows changes tracked by audit trail
- Charts styled consistently with dark theme
- Date range filtering available
</success_criteria>

<output>
After completion, create `.planning/phases/10-analytics-reporting/10-02-SUMMARY.md`
</output>
