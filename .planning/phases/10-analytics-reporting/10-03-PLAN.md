---
phase: 10-analytics-reporting
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/components/analytics/SamplingCalculator.tsx
  - src/components/analytics/SamplingResults.tsx
  - src/components/analytics/AggregationReport.tsx
  - src/components/analytics/index.ts
autonomous: true

must_haves:
  truths:
    - "User can input population size and get recommended sample size"
    - "Sampling tool displays methodology and assumptions"
    - "Aggregation report shows average scores by risk category"
    - "User can toggle between risk and process groupings"
  artifacts:
    - path: "src/components/analytics/SamplingCalculator.tsx"
      provides: "UI for statistical sampling inputs"
      min_lines: 60
    - path: "src/components/analytics/SamplingResults.tsx"
      provides: "Display component for sample size recommendations"
      min_lines: 30
    - path: "src/components/analytics/AggregationReport.tsx"
      provides: "Risk aggregation table by category"
      min_lines: 50
  key_links:
    - from: "src/components/analytics/SamplingCalculator.tsx"
      to: "src/utils/samplingCalculator.ts"
      via: "calculateSampleSize function"
      pattern: "calculateSampleSize"
    - from: "src/components/analytics/AggregationReport.tsx"
      to: "src/hooks/useAnalyticsData.ts"
      via: "useAggregationByCategory hook"
      pattern: "useAggregationByCategory"
---

<objective>
Build sampling calculator UI and risk aggregation report components.

Purpose: Provide sampling guidance (ANALYTICS-03) and category-level risk views (success criteria 5).
Output: Sampling calculator with methodology documentation, aggregation report by business unit/risk category.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-analytics-reporting/10-RESEARCH.md
@.planning/phases/10-analytics-reporting/10-01-SUMMARY.md

# Utilities and hooks from Plan 01
@src/utils/samplingCalculator.ts
@src/hooks/useAnalyticsData.ts

# UI patterns reference
@src/components/remediation/RemediationDashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sampling Calculator components</name>
  <files>src/components/analytics/SamplingCalculator.tsx, src/components/analytics/SamplingResults.tsx</files>
  <action>
1. Create `src/components/analytics/SamplingResults.tsx`:
   - Props: result: SamplingResult | null
   - If null, show placeholder text "Enter parameters to calculate sample size"
   - Display:
     - Recommended sample size in large bold text (text-3xl font-bold text-accent)
     - Methodology below (text-text-secondary)
     - Notes as bullet list if any (text-text-muted text-sm)
   - Container: bg-surface-elevated rounded-lg p-4

2. Create `src/components/analytics/SamplingCalculator.tsx`:
   - Import { calculateSampleSize, SamplingInput, SamplingResult } from utils
   - Local state for inputs:
     - populationSize: number (default 100)
     - confidenceLevel: 90 | 95 (default 95)
     - tolerableDeviationRate: 5 | 10 (default 5)
     - expectedDeviationRate: 0 | 1 | 2 (default 0)
   - Calculate result using useMemo whenever inputs change
   - Layout in grid (2 columns on md+, 1 on mobile):
     - Left column: Input form
       - Population size: number input with label "Control Population Size"
       - Confidence level: radio buttons 90% / 95%
       - Tolerable deviation rate: radio buttons 5% / 10%
       - Expected deviation rate: dropdown 0% / 1% / 2%
     - Right column: SamplingResults component

3. Add methodology section below inputs:
   - Collapsible section (use details/summary for simplicity)
   - Title "Sampling Methodology"
   - Content explaining:
     - Based on AICPA Audit Sampling Guide
     - Confidence level = probability sample represents population
     - Tolerable deviation = max acceptable error rate
     - Expected deviation = anticipated error rate from prior experience
     - Finite population correction applies when population < 250
   - Use muted text styling

4. Style inputs for dark theme:
   - bg-surface border border-surface-border rounded px-3 py-2
   - text-text-primary
   - focus:ring-2 focus:ring-accent focus:outline-none
  </action>
  <verify>
- `src/components/analytics/SamplingResults.tsx` exists
- `src/components/analytics/SamplingCalculator.tsx` exists
- SamplingCalculator uses calculateSampleSize function
- Form inputs work with controlled state
  </verify>
  <done>
- SamplingCalculator accepts population and parameters
- Sample size updates reactively when inputs change
- Methodology documentation visible in collapsible section
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Aggregation Report component</name>
  <files>src/components/analytics/AggregationReport.tsx, src/components/analytics/index.ts</files>
  <action>
1. Create `src/components/analytics/AggregationReport.tsx`:
   - Import useAggregationByCategory from hooks
   - Import getHeatmapColor from utils/heatmapColors for score coloring
   - Local state: groupBy: 'riskL1' | 'processL1' (default 'riskL1')
   - Use useAggregationByCategory(groupBy) hook

2. Component structure:
   - Header row with title and toggle buttons:
     - "Risk Aggregation by Category"
     - Two buttons: "By Risk" (riskL1) | "By Process" (processL1)
     - Active button has accent styling

3. Data table with columns:
   - Category (name with ID in smaller text)
   - Rows (rowCount)
   - Controls (controlCount)
   - Avg Gross Score (with heatmap background)
   - Avg Net Score (with heatmap background)

4. Table styling:
   - Use existing RCT table patterns (dark theme)
   - Sticky header
   - Alternating row colors: bg-surface / bg-surface-elevated
   - Score cells: getHeatmapColor for background, text-white or text-black based on contrast
   - Null scores show "â€”"

5. Empty state: "No data available. Add risks and processes to see aggregations."

6. Update `src/components/analytics/index.ts`:
```typescript
export { ControlTestTrendChart } from './ControlTestTrendChart'
export { RiskScoreTrendChart } from './RiskScoreTrendChart'
export { TrendChartSection } from './TrendChartSection'
export { SamplingCalculator } from './SamplingCalculator'
export { SamplingResults } from './SamplingResults'
export { AggregationReport } from './AggregationReport'
```
  </action>
  <verify>
- `src/components/analytics/AggregationReport.tsx` exists
- Uses useAggregationByCategory hook
- Toggle between risk and process groupings works
- All components exported from index.ts
- `npx tsc --noEmit` passes
  </verify>
  <done>
- AggregationReport displays average scores by L1 category
- User can toggle between risk and process groupings
- Heatmap colors indicate score severity
  </done>
</task>

</tasks>

<verification>
- [ ] SamplingCalculator shows recommended sample size for inputs
- [ ] Methodology documentation explains sampling approach
- [ ] AggregationReport groups data by risk or process L1
- [ ] Score cells show heatmap colors
- [ ] `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Sampling tool provides guidance based on population and confidence level
- Methodology documentation available for testing procedures
- Aggregation report shows scores by business unit (L1 categories)
</success_criteria>

<output>
After completion, create `.planning/phases/10-analytics-reporting/10-03-SUMMARY.md`
</output>
