---
phase: 11-collaboration-comments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/collaboration.ts
  - src/stores/collaborationStore.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Comment type supports entity linking (risk, process, control, rctRow)"
    - "Comment type supports threading via parentId"
    - "KnowledgeBaseEntry type supports categories and tags"
    - "collaborationStore persists to localStorage"
    - "Fuse.js installed for search functionality"
  artifacts:
    - path: "src/types/collaboration.ts"
      provides: "Comment, KnowledgeBaseEntry, CommentableEntityType, KnowledgeBaseCategory types"
      exports: ["Comment", "KnowledgeBaseEntry", "CommentableEntityType", "KnowledgeBaseCategory"]
    - path: "src/stores/collaborationStore.ts"
      provides: "Zustand store for comments and knowledge base entries"
      exports: ["useCollaborationStore"]
  key_links:
    - from: "src/stores/collaborationStore.ts"
      to: "src/types/collaboration.ts"
      via: "import types"
      pattern: "import.*from.*@/types/collaboration"
---

<objective>
Create type definitions and Zustand store for collaboration features (comments and knowledge base).

Purpose: Establish the data layer for threaded comments on entities and searchable knowledge base articles. This follows the same pattern as auditStore and rctStore.

Output: Types file, store with CRUD actions, fuse.js dependency installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-collaboration-comments/11-RESEARCH.md

@src/types/audit.ts
@src/stores/auditStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fuse.js dependency</name>
  <files>package.json</files>
  <action>
Install fuse.js for client-side fuzzy search:

```bash
npm install fuse.js
```

This is a lightweight fuzzy search library for the knowledge base search feature. Version 7.x is current and stable.
  </action>
  <verify>Run `npm ls fuse.js` and confirm version ~7.0.0 installed. Check package.json includes fuse.js in dependencies.</verify>
  <done>Fuse.js is installed and available for import.</done>
</task>

<task type="auto">
  <name>Task 2: Create collaboration types</name>
  <files>src/types/collaboration.ts</files>
  <action>
Create type definitions following the pattern from src/types/audit.ts:

1. **CommentableEntityType** - Union type for entities that can have comments:
   - 'risk' | 'process' | 'control' | 'rctRow'

2. **Comment** interface:
   - id: string (nanoid)
   - entityType: CommentableEntityType
   - entityId: string (ID of the risk, process, control, or RCT row)
   - parentId: string | null (null = top-level comment, otherwise reply to this comment)
   - content: string
   - author: 'risk-manager' | 'control-owner' (role who created)
   - createdAt: string (ISO timestamp)
   - updatedAt?: string (ISO timestamp if edited)
   - isEdited: boolean

3. **KnowledgeBaseCategory** - Union type for article categories:
   - 'testing-procedure' | 'best-practice' | 'policy' | 'template' | 'reference'

4. **KnowledgeBaseEntry** interface:
   - id: string (nanoid)
   - title: string
   - content: string (plain text)
   - category: KnowledgeBaseCategory
   - tags: string[] (free-form tags for filtering)
   - author: string (role who created)
   - createdAt: string (ISO timestamp)
   - updatedAt?: string (ISO timestamp if edited)
   - relatedControlTypes?: ControlType[] (optional link to control types from rct.ts)

Export all types for use by store and components.
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors in collaboration.ts.</verify>
  <done>Comment and KnowledgeBaseEntry types are defined with all required fields.</done>
</task>

<task type="auto">
  <name>Task 3: Create collaborationStore</name>
  <files>src/stores/collaborationStore.ts</files>
  <action>
Create Zustand store following the pattern from auditStore.ts:

1. **State interface (CollaborationState):**
   - comments: Comment[]
   - knowledgeBaseEntries: KnowledgeBaseEntry[]

2. **Comment actions:**
   - addComment(comment: Omit&lt;Comment, 'id' | 'createdAt' | 'isEdited'&gt;): string
     - Generate ID with nanoid()
     - Set createdAt to new Date().toISOString()
     - Set isEdited to false
     - Push to comments array
     - Return ID
   - updateComment(commentId: string, content: string): void
     - Find comment by ID
     - Update content
     - Set updatedAt to new Date().toISOString()
     - Set isEdited to true
   - deleteComment(commentId: string): void
     - Also delete all replies (cascade delete where parentId === commentId)
     - Use recursive or iterative approach to get all descendant IDs
   - getCommentsForEntity(entityType: CommentableEntityType, entityId: string): Comment[]
     - Filter and return sorted by createdAt ascending (oldest first for chronological display)

3. **Knowledge base actions:**
   - addKnowledgeBaseEntry(entry: Omit&lt;KnowledgeBaseEntry, 'id' | 'createdAt'&gt;): string
     - Generate ID with nanoid()
     - Set createdAt to new Date().toISOString()
     - Push to knowledgeBaseEntries array
     - Return ID
   - updateKnowledgeBaseEntry(entryId: string, updates: Partial&lt;KnowledgeBaseEntry&gt;): void
     - Find entry by ID
     - Apply updates with Object.assign
     - Set updatedAt to new Date().toISOString()
   - deleteKnowledgeBaseEntry(entryId: string): void
     - Filter out entry from array
   - getEntriesByCategory(category: KnowledgeBaseCategory): KnowledgeBaseEntry[]
     - Filter and return
   - getEntriesByTag(tag: string): KnowledgeBaseEntry[]
     - Filter where tags.includes(tag)

4. **Store setup:**
   - Use create from zustand
   - Wrap with persist middleware (name: 'riskguard-collaboration')
   - Wrap with immer middleware for nested updates
   - Use createJSONStorage(() => localStorage)

Export useCollaborationStore hook.
  </action>
  <verify>
1. Import the store in a test: `import { useCollaborationStore } from '@/stores/collaborationStore'`
2. Run `npx tsc --noEmit` and confirm no type errors.
3. Check that store follows same pattern as auditStore (persist + immer).
  </verify>
  <done>collaborationStore exports useCollaborationStore with full CRUD for comments and knowledge base entries, persisted to localStorage.</done>
</task>

</tasks>

<verification>
1. `npm ls fuse.js` shows version installed
2. `npx tsc --noEmit` passes with no errors
3. Both types file and store file exist and export correctly
4. Store uses persist + immer pattern consistent with auditStore
</verification>

<success_criteria>
- Fuse.js is installed as a dependency
- Comment type has entityType, entityId, parentId, content, author, timestamps, isEdited
- KnowledgeBaseEntry type has title, content, category, tags, author, timestamps
- collaborationStore persists to 'riskguard-collaboration' key
- Store has addComment, updateComment, deleteComment, getCommentsForEntity
- Store has addKnowledgeBaseEntry, updateKnowledgeBaseEntry, deleteKnowledgeBaseEntry
- deleteComment cascades to delete all replies
</success_criteria>

<output>
After completion, create `.planning/phases/11-collaboration-comments/11-01-SUMMARY.md`
</output>
