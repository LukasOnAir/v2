---
phase: 11-collaboration-comments
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/rct/CommentsSection.tsx
  - src/components/rct/CommentThread.tsx
  - src/components/rct/CommentForm.tsx
  - src/components/rct/ControlPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can add comments to controls in ControlPanel"
    - "Comments show author role and timestamp"
    - "User can reply to existing comments (threaded)"
    - "Comments are collapsible like ControlTestSection"
    - "User can edit and delete their own comments"
  artifacts:
    - path: "src/components/rct/CommentsSection.tsx"
      provides: "Collapsible section for viewing and adding comments"
      min_lines: 50
    - path: "src/components/rct/CommentThread.tsx"
      provides: "Recursive component for rendering threaded comments"
      min_lines: 40
    - path: "src/components/rct/CommentForm.tsx"
      provides: "Form for adding new comments or replies"
      min_lines: 30
  key_links:
    - from: "src/components/rct/CommentsSection.tsx"
      to: "src/stores/collaborationStore.ts"
      via: "useCollaborationStore"
      pattern: "useCollaborationStore"
    - from: "src/components/rct/ControlPanel.tsx"
      to: "src/components/rct/CommentsSection.tsx"
      via: "import and render"
      pattern: "<CommentsSection"

scope_note: |
  Comments are integrated into ControlPanel only (not TaxonomyNode or RCT row detail).
  This provides adequate demonstration of the collaboration feature for the demo application.
  The type system supports future expansion to risks/processes/RCT rows if needed.
---

<objective>
Create comment UI components and integrate into ControlPanel for control-level comments.

Purpose: Enable users to have threaded discussions on controls, following the same collapsible section pattern as ControlTestSection and RemediationSection. This demonstrates the collaboration feature at the most actionable level (controls).

Output: CommentsSection, CommentThread, CommentForm components integrated into ControlPanel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-collaboration-comments/11-RESEARCH.md
@.planning/phases/11-collaboration-comments/11-01-SUMMARY.md

@src/components/rct/ControlTestSection.tsx
@src/components/rct/ControlPanel.tsx
@src/stores/collaborationStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentForm component</name>
  <files>src/components/rct/CommentForm.tsx</files>
  <action>
Create a form component for adding new comments or replies. Follow the pattern from ControlTestForm.tsx:

**Props interface:**
```typescript
interface CommentFormProps {
  entityType: CommentableEntityType
  entityId: string
  parentId?: string | null  // If provided, this is a reply
  onSubmit: () => void
  onCancel?: () => void
}
```

**Implementation:**
1. Local state for content (useState)
2. Get selectedRole from useUIStore
3. Get addComment from useCollaborationStore

4. handleSubmit function:
   - Guard: return if content.trim() is empty
   - Call addComment with entityType, entityId, parentId (default null), content.trim(), author: selectedRole
   - Clear content
   - Call onSubmit callback

5. Render:
   - textarea with dark theme styling (bg-surface-elevated, border-surface-border)
   - Placeholder: "Write a reply..." if parentId, else "Add a comment..."
   - autoFocus
   - Min height 64px, resize-y
   - Button row with Cancel (if onCancel provided) and submit button
   - Submit button text: "Reply" if parentId, else "Comment"
   - Submit button disabled if content is empty

Use existing class patterns from ControlTestForm.tsx for consistent styling.
  </action>
  <verify>Import CommentForm in a test file and render. Check TypeScript compiles without errors.</verify>
  <done>CommentForm component allows adding top-level comments and replies with proper styling.</done>
</task>

<task type="auto">
  <name>Task 2: Create CommentThread component</name>
  <files>src/components/rct/CommentThread.tsx</files>
  <action>
Create a recursive component for rendering threaded comments:

**Props interface:**
```typescript
interface CommentThreadProps {
  comments: Comment[]           // All comments for this entity
  parentId: string | null       // Which level to render
  entityType: CommentableEntityType
  entityId: string
  depth?: number                // Current nesting depth (default 0)
}
```

**CommentItem sub-component:**
Display a single comment with:
1. Author badge showing role (Risk Manager or Control Owner)
2. Timestamp using formatDistanceToNow from date-fns (e.g., "2 hours ago")
3. "[edited]" indicator if isEdited is true
4. Comment content
5. Action buttons (visible on hover or always for own comments):
   - Reply button (shows CommentForm for reply)
   - Edit button (only for own role - compare with useUIStore selectedRole)
   - Delete button (only for own role, or Risk Manager can delete any)
6. Editing state: Replace content with CommentForm in edit mode

**CommentThread component:**
1. Filter comments where parentId matches props.parentId
2. Sort by createdAt ascending (oldest first)
3. For each comment, render CommentItem
4. If depth < MAX_DEPTH (3), recursively render CommentThread for replies
5. Apply left border and margin for nested levels (ml-6 pl-4 border-l border-surface-border)

**Styling:**
- Use dark theme colors (text-text-primary, text-text-muted, bg-surface-overlay)
- Role badges: Risk Manager = accent color, Control Owner = blue
- Hover effects on action buttons
- Transitions for smooth interactions

**Delete confirmation:**
- Show confirm dialog before deleting
- Warn that replies will also be deleted (if any exist)
  </action>
  <verify>TypeScript compiles without errors. Component handles empty state, single comment, and nested replies.</verify>
  <done>CommentThread recursively renders threaded comments with edit/delete/reply capabilities.</done>
</task>

<task type="auto">
  <name>Task 3: Create CommentsSection and integrate into ControlPanel</name>
  <files>src/components/rct/CommentsSection.tsx, src/components/rct/ControlPanel.tsx</files>
  <action>
**Part A: Create CommentsSection.tsx**

Follow the pattern from ControlTestSection.tsx exactly:

**Props interface:**
```typescript
interface CommentsSectionProps {
  entityType: CommentableEntityType
  entityId: string
}
```

**Implementation:**
1. State: isExpanded (boolean, default false), showForm (boolean, default false)
2. Get comments using useCollaborationStore.getCommentsForEntity(entityType, entityId)
3. Memoize comment count

**Render structure:**
1. Collapsible header (button with onClick to toggle isExpanded):
   - ChevronDown/ChevronRight icon based on isExpanded
   - MessageCircle icon (from lucide-react)
   - "Comments" text
   - Comment count badge (e.g., "(3)")

2. Expanded content (only if isExpanded):
   - CommentThread rendering all comments
   - "Add Comment" button (if not showForm)
   - CommentForm (if showForm, with onSubmit and onCancel)

**Styling:**
- Match ControlTestSection border-t, pt-3, mt-3 pattern
- Indent expanded content with pl-6

**Part B: Integrate into ControlPanel.tsx**

1. Import CommentsSection at top
2. Add CommentsSection inside each control card, after RemediationSection:
   ```tsx
   <RemediationSection ... />
   <CommentsSection
     entityType="control"
     entityId={control.id}
   />
   ```

This places comments at the control level, not the row level. Each control gets its own comment thread.
  </action>
  <verify>
1. Open ControlPanel for a row with controls
2. See "Comments" collapsible section under each control
3. Expand section, add a comment, see it appear
4. Reply to a comment, see threaded display
5. Edit and delete own comments
  </verify>
  <done>CommentsSection integrated into ControlPanel with full threaded comment functionality.</done>
</task>

</tasks>

<verification>
1. All three component files exist and compile
2. ControlPanel imports and renders CommentsSection
3. Comments persist across page refresh (localStorage)
4. Thread nesting displays correctly with visual indentation
5. Role-based edit/delete works (can only edit own comments)
</verification>

<success_criteria>
- User can see "Comments" collapsible section in each control
- User can add a new comment with content
- Comment shows author role and timestamp
- User can reply to comments (creates nested thread)
- User can edit their own comments (shows [edited] indicator)
- User can delete their own comments (with confirmation)
- Risk Manager can delete any comment
- Comments persist after page refresh
- Maximum nesting depth of 3 levels enforced visually
</success_criteria>

<output>
After completion, create `.planning/phases/11-collaboration-comments/11-02-SUMMARY.md`
</output>
