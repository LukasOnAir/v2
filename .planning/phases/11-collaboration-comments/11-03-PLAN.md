---
phase: 11-collaboration-comments
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/hooks/useKnowledgeBaseSearch.ts
  - src/components/knowledge-base/index.ts
  - src/components/knowledge-base/CategoryFilter.tsx
  - src/components/knowledge-base/KnowledgeBaseList.tsx
  - src/components/knowledge-base/KnowledgeBaseArticle.tsx
  - src/components/knowledge-base/KnowledgeBaseForm.tsx
  - src/pages/KnowledgeBasePage.tsx
  - src/components/layout/Sidebar.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of knowledge base articles"
    - "User can search articles with fuzzy matching"
    - "User can filter articles by category"
    - "User can create new knowledge base entries"
    - "User can edit and delete existing entries"
    - "Knowledge Base is accessible from sidebar navigation"
  artifacts:
    - path: "src/hooks/useKnowledgeBaseSearch.ts"
      provides: "Fuse.js search hook for knowledge base"
      exports: ["useKnowledgeBaseSearch"]
    - path: "src/pages/KnowledgeBasePage.tsx"
      provides: "Main knowledge base page"
      min_lines: 50
    - path: "src/components/knowledge-base/KnowledgeBaseList.tsx"
      provides: "List of filterable articles"
      min_lines: 40
  key_links:
    - from: "src/pages/KnowledgeBasePage.tsx"
      to: "src/hooks/useKnowledgeBaseSearch.ts"
      via: "import hook"
      pattern: "useKnowledgeBaseSearch"
    - from: "src/App.tsx"
      to: "src/pages/KnowledgeBasePage.tsx"
      via: "Route component"
      pattern: "KnowledgeBasePage"
    - from: "src/components/layout/Sidebar.tsx"
      to: "/knowledge-base"
      via: "navigation link"
      pattern: "knowledge-base"
---

<objective>
Create knowledge base UI with search, filtering, and CRUD operations for testing procedures and best practices.

Purpose: Provide a searchable repository of testing procedures, best practices, policies, and templates that users can reference when testing controls.

Output: KnowledgeBasePage with search, category filtering, article list, and create/edit forms. Sidebar navigation added.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-collaboration-comments/11-RESEARCH.md
@.planning/phases/11-collaboration-comments/11-01-SUMMARY.md

@src/pages/AuditPage.tsx
@src/components/layout/Sidebar.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useKnowledgeBaseSearch hook</name>
  <files>src/hooks/useKnowledgeBaseSearch.ts</files>
  <action>
Create a reusable Fuse.js search hook:

```typescript
import Fuse from 'fuse.js'
import { useMemo, useState } from 'react'
import type { KnowledgeBaseEntry } from '@/types/collaboration'

interface UseKnowledgeBaseSearchOptions {
  items: KnowledgeBaseEntry[]
  threshold?: number  // 0.0 = exact match, 1.0 = anything matches (default 0.3)
}

export function useKnowledgeBaseSearch({ items, threshold = 0.3 }: UseKnowledgeBaseSearchOptions) {
  const [query, setQuery] = useState('')

  // Recreate Fuse instance when items change
  const fuse = useMemo(() =>
    new Fuse(items, {
      keys: ['title', 'content', 'tags'],
      threshold,
      includeScore: true,
    }),
    [items, threshold]
  )

  // Compute results when query or items change
  const results = useMemo(() => {
    if (!query.trim()) return items
    return fuse.search(query).map(result => result.item)
  }, [fuse, query, items])

  return { query, setQuery, results }
}
```

Key points:
- Search across title, content, and tags
- Return all items when query is empty
- Memoize Fuse instance for performance
- Include items in fuse useMemo dependency to recreate when data changes
  </action>
  <verify>Import hook and test with mock data. Verify TypeScript compiles.</verify>
  <done>useKnowledgeBaseSearch hook provides fuzzy search with Fuse.js.</done>
</task>

<task type="auto">
  <name>Task 2: Create CategoryFilter and KnowledgeBaseList components</name>
  <files>src/components/knowledge-base/index.ts, src/components/knowledge-base/CategoryFilter.tsx, src/components/knowledge-base/KnowledgeBaseList.tsx</files>
  <action>
**Part A: Create barrel export (index.ts)**
```typescript
export { CategoryFilter } from './CategoryFilter'
export { KnowledgeBaseList } from './KnowledgeBaseList'
export { KnowledgeBaseArticle } from './KnowledgeBaseArticle'
export { KnowledgeBaseForm } from './KnowledgeBaseForm'
```

**Part B: Create CategoryFilter.tsx**

Category filter chips following the toggle button pattern from AnalyticsPage:

```typescript
const CATEGORY_OPTIONS: { value: KnowledgeBaseCategory; label: string; icon: LucideIcon }[] = [
  { value: 'testing-procedure', label: 'Testing Procedures', icon: ClipboardCheck },
  { value: 'best-practice', label: 'Best Practices', icon: Star },
  { value: 'policy', label: 'Policies', icon: FileText },
  { value: 'template', label: 'Templates', icon: File },
  { value: 'reference', label: 'Reference', icon: BookOpen },
]
```

Props: selected (KnowledgeBaseCategory | null), onChange
Render: "All" button + category buttons with icons
Active state: bg-accent-500 text-white
Inactive state: bg-surface-overlay text-text-secondary hover:text-text-primary

**Part C: Create KnowledgeBaseList.tsx**

Display list of articles:
- Props: entries (KnowledgeBaseEntry[]), onSelect (entry => void)
- Render each entry as a card with:
  - Title (bold)
  - Category badge (colored by category)
  - Tags (small, comma-separated)
  - Created date
  - Truncated content preview (first 100 chars)
- Empty state: "No articles found. Create your first article."
- Click on card calls onSelect
  </action>
  <verify>Components compile without TypeScript errors. CategoryFilter shows all categories. KnowledgeBaseList renders entries.</verify>
  <done>CategoryFilter and KnowledgeBaseList components created with proper styling.</done>
</task>

<task type="auto">
  <name>Task 3: Create KnowledgeBaseArticle and KnowledgeBaseForm components</name>
  <files>src/components/knowledge-base/KnowledgeBaseArticle.tsx, src/components/knowledge-base/KnowledgeBaseForm.tsx</files>
  <action>
**Part A: Create KnowledgeBaseArticle.tsx**

Full article view/edit:
- Props: entry (KnowledgeBaseEntry), onClose, onEdit, onDelete
- Display: title, category badge, tags, author, dates, full content
- Action buttons: Edit, Delete, Close
- Delete confirmation modal before deletion

**Part B: Create KnowledgeBaseForm.tsx**

Create/edit form:
- Props: entry? (for edit mode), onSubmit, onCancel
- Fields:
  - Title (text input, required)
  - Category (select dropdown)
  - Tags (text input, comma-separated, convert to array)
  - Content (textarea, larger, min-h-[200px])
  - Related Control Types (multi-select of ControlType values, optional)
- Get author from useUIStore selectedRole
- Submit button: "Create" or "Update"
- Cancel button calls onCancel
  </action>
  <verify>Components compile without TypeScript errors. Form validates required fields. Article displays all entry fields.</verify>
  <done>KnowledgeBaseArticle and KnowledgeBaseForm components created with view/edit/create capabilities.</done>
</task>

<task type="auto">
  <name>Task 4: Create KnowledgeBasePage and integrate navigation</name>
  <files>src/pages/KnowledgeBasePage.tsx, src/components/layout/Sidebar.tsx, src/App.tsx</files>
  <action>
**Part A: Create KnowledgeBasePage.tsx**

Follow the pattern from AuditPage.tsx:

1. State:
   - selectedCategory: KnowledgeBaseCategory | null (default null)
   - selectedEntry: KnowledgeBaseEntry | null (for detail view)
   - showForm: boolean (for create/edit)
   - editingEntry: KnowledgeBaseEntry | null (for edit mode)

2. Get entries from useCollaborationStore
3. Use useKnowledgeBaseSearch hook
4. Filter results by selectedCategory (if not null)
5. Permission: use usePermissions - Risk Manager can create/edit/delete

Render structure:
```tsx
<div className="space-y-6">
  <div className="flex items-center justify-between">
    <h1 className="text-2xl font-semibold text-text-primary">Knowledge Base</h1>
    {canEdit && (
      <button onClick={() => setShowForm(true)} className="...">
        <Plus size={16} /> New Article
      </button>
    )}
  </div>

  {/* Search and filters */}
  <section className="space-y-4">
    <input type="text" value={query} onChange={e => setQuery(e.target.value)}
      placeholder="Search articles..." className="..." />
    <CategoryFilter selected={selectedCategory} onChange={setSelectedCategory} />
  </section>

  {/* Results count */}
  <p className="text-sm text-text-muted">
    Showing {filteredEntries.length} of {entries.length} articles
  </p>

  {/* Article list or detail view */}
  <section className="bg-surface-elevated rounded-lg border border-surface-border">
    {selectedEntry ? (
      <KnowledgeBaseArticle
        entry={selectedEntry}
        onClose={() => setSelectedEntry(null)}
        onEdit={() => { setEditingEntry(selectedEntry); setShowForm(true); setSelectedEntry(null); }}
        onDelete={...}
      />
    ) : (
      <KnowledgeBaseList entries={filteredEntries} onSelect={setSelectedEntry} />
    )}
  </section>
</div>

{/* Create/Edit form dialog */}
{showForm && (
  <Dialog ...>
    <KnowledgeBaseForm
      entry={editingEntry}
      onSubmit={...}
      onCancel={() => { setShowForm(false); setEditingEntry(null); }}
    />
  </Dialog>
)}
```

**Part B: Update Sidebar.tsx**

Add Knowledge Base link following the existing pattern:
- Import BookOpen icon from lucide-react
- Add nav item after Analytics:
  ```tsx
  { name: 'Knowledge Base', path: '/knowledge-base', icon: BookOpen }
  ```

**Part C: Update App.tsx**

Add route for knowledge base:
```tsx
import { KnowledgeBasePage } from '@/pages/KnowledgeBasePage'

// In Routes:
<Route path="/knowledge-base" element={<KnowledgeBasePage />} />
```
  </action>
  <verify>
1. Navigate to /knowledge-base from sidebar
2. See empty state or list of articles
3. Create a new article (as Risk Manager)
4. Search for article by title
5. Filter by category
6. Edit and delete article
  </verify>
  <done>KnowledgeBasePage accessible from sidebar with full CRUD, search, and category filtering.</done>
</task>

</tasks>

<verification>
1. Knowledge Base link appears in sidebar navigation
2. Page loads at /knowledge-base route
3. Search box filters articles by title, content, and tags
4. Category chips filter articles by category
5. Create form allows adding new articles
6. Edit form allows updating existing articles
7. Delete removes article with confirmation
8. Articles persist across page refresh
</verification>

<success_criteria>
- Sidebar shows "Knowledge Base" with BookOpen icon
- /knowledge-base route renders KnowledgeBasePage
- Empty state shows when no articles exist
- Risk Manager can create articles with title, category, tags, content
- Search filters articles with fuzzy matching (typos tolerated)
- Category filter shows only matching articles
- Article detail view shows full content
- Edit button opens form with pre-filled values
- Delete button removes article after confirmation
- Control Owner can view but not create/edit/delete articles
</success_criteria>

<output>
After completion, create `.planning/phases/11-collaboration-comments/11-03-SUMMARY.md`
</output>
