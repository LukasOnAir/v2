---
phase: 12-formula-bug-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/formulaEngine.ts
autonomous: true

must_haves:
  truths:
    - "IF function returns false clause value when condition is false"
    - "Smart quotes (curly) are normalized to straight quotes automatically"
    - "Unquoted string arguments produce clear error message"
    - "Existing formulas continue to work"
  artifacts:
    - path: "src/utils/formulaEngine.ts"
      provides: "normalizeQuotes function and updated evaluate/validate functions"
      contains: "normalizeQuotes"
  key_links:
    - from: "normalizeQuotes"
      to: "evaluateFormula"
      via: "preprocessing call"
      pattern: "normalizeQuotes\\(formula\\)"
    - from: "normalizeQuotes"
      to: "validateFormula"
      via: "preprocessing call"
      pattern: "normalizeQuotes\\(formula\\)"
---

<objective>
Fix the formula engine to properly handle IF function false clause by normalizing smart quotes and improving error messages.

Purpose: Users copy-paste formulas from Word/email which introduces curly quotes that fail silently. This fix ensures formulas work regardless of quote style.
Output: Updated formulaEngine.ts with quote normalization and better error messages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-formula-bug-fix/12-RESEARCH.md
@src/utils/formulaEngine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add normalizeQuotes function and apply to evaluateFormula</name>
  <files>src/utils/formulaEngine.ts</files>
  <action>
Add a new helper function `normalizeQuotes` at the top of the file (after imports, before `evaluateFormula`):

```typescript
/**
 * Normalize smart quotes to straight quotes
 * Handles copy-paste from Word, email, and other rich text sources
 */
function normalizeQuotes(formula: string): string {
  return formula
    .replace(/[\u201C\u201D\u201E\u201F]/g, '"')  // Smart double quotes -> straight
    .replace(/[\u2018\u2019\u201A\u201B]/g, "'"); // Smart single quotes -> straight
}
```

Then update `evaluateFormula` to apply normalization at the start:
- After `const parser = new Parser()` add: `const normalizedFormula = normalizeQuotes(formula)`
- Change `parser.parse(formula)` to `parser.parse(normalizedFormula)`

This ensures smart quotes from copy-paste are converted before parsing.
  </action>
  <verify>
Read the file and confirm:
1. `normalizeQuotes` function exists with correct Unicode replacements
2. `evaluateFormula` uses `normalizedFormula` variable
3. `parser.parse(normalizedFormula)` is called (not `parser.parse(formula)`)
  </verify>
  <done>Smart quotes are normalized before formula evaluation</done>
</task>

<task type="auto">
  <name>Task 2: Update validateFormula with normalization and better error messages</name>
  <files>src/utils/formulaEngine.ts</files>
  <action>
Update `validateFormula` function:

1. Apply quote normalization at the start (after parser creation):
   `const normalizedFormula = normalizeQuotes(formula)`

2. Add unquoted string detection BEFORE parsing (after normalization):
```typescript
// Detect unquoted string arguments in IF function (common mistake)
const ifMatch = normalizedFormula.match(/IF\s*\([^,]+,\s*([A-Za-z_][A-Za-z0-9_]*)\s*(?:,|\))/i)
if (ifMatch) {
  const potentialString = ifMatch[1]
  const normalizedPotential = potentialString.toLowerCase()
  const potentialWithSpaces = potentialString.replace(/_/g, ' ').toLowerCase()

  // Check if it's NOT a known variable (then it's likely unquoted text)
  if (!builtInVars.has(normalizedPotential) &&
      !customVars.has(normalizedPotential) &&
      !customVars.has(potentialWithSpaces)) {
    return {
      valid: false,
      error: `"${potentialString}" looks like text. Add quotes: "${potentialString}" or '${potentialString}'`
    }
  }
}
```

3. Change `parser.parse(formula)` to `parser.parse(normalizedFormula)`

This provides clear error messages when users forget to quote text values.
  </action>
  <verify>
Read the file and confirm:
1. `validateFormula` applies `normalizeQuotes`
2. Unquoted string detection code is present with helpful error message
3. `parser.parse(normalizedFormula)` is called
  </verify>
  <done>validateFormula normalizes quotes and provides clear error for unquoted strings</done>
</task>

<task type="auto">
  <name>Task 3: Verify fix with test formulas</name>
  <files>src/utils/formulaEngine.ts</files>
  <action>
Create a simple test file to verify the fix works. Run in the browser console or create a temporary test:

Test cases to verify manually in the app:
1. Create formula column: `IF(Gross_Score>10, "High", "Low")`
   - Rows with Gross_Score > 10 should show "High"
   - Rows with Gross_Score <= 10 should show "Low" (THE BUG FIX)

2. Create formula with smart quotes (copy from this): IF(Gross_Score>10, "High", "Low")
   - Should work after normalization (not #ERROR!)

3. Try to create formula: `IF(Gross_Score>10, High, Low)` (no quotes)
   - Should show error message about adding quotes

Run the dev server and create a custom formula column in the RCT to verify each case.
  </action>
  <verify>
Run `npm run dev` and verify in browser:
1. Navigate to RCT page
2. Click Columns button
3. Add custom column with type "Formula"
4. Test formula: IF(Gross_Score>10, "High", "Low")
5. Verify cells show correct values based on condition
  </verify>
  <done>Formula IF function properly returns false clause when condition is false</done>
</task>

</tasks>

<verification>
- [ ] normalizeQuotes function handles all smart quote variants (U+201C-201F, U+2018-201B)
- [ ] evaluateFormula applies quote normalization before parsing
- [ ] validateFormula applies quote normalization before parsing
- [ ] Unquoted string detection provides helpful error message
- [ ] IF(Gross_Score>10, "High", "Low") returns "Low" when Gross_Score <= 10
- [ ] No regression in existing formula functionality
</verification>

<success_criteria>
1. IF function properly evaluates false clause (e.g., IF(A>5, "High", "Low") returns "Low" when A<=5)
2. Smart quotes from copy-paste are automatically converted to straight quotes
3. Clear error message when user forgets to quote text values
4. All existing formula functionality continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/12-formula-bug-fix/12-01-SUMMARY.md`
</output>
