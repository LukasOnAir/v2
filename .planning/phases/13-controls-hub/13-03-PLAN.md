---
phase: 13-controls-hub
plan: 03
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - src/pages/ControlsPage.tsx
  - src/components/controls/ControlsTable.tsx
  - src/components/controls/ControlDetailPanel.tsx
  - src/components/controls/ControlFilters.tsx
  - src/components/controls/index.ts
  - src/components/layout/Sidebar.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to Controls page from sidebar"
    - "Controls page shows all controls across all RCT rows"
    - "Each control shows how many risks it covers"
    - "User can search and filter controls"
    - "User can click a control to see detail panel"
    - "Detail panel shows linked risks and allows editing"
  artifacts:
    - path: "src/pages/ControlsPage.tsx"
      provides: "Controls Hub page component"
      exports: ["ControlsPage"]
    - path: "src/components/controls/ControlsTable.tsx"
      provides: "Table showing all controls with link counts"
      exports: ["ControlsTable"]
    - path: "src/components/controls/ControlDetailPanel.tsx"
      provides: "Slide-out panel for control details and linked risks"
      exports: ["ControlDetailPanel"]
    - path: "src/components/controls/ControlFilters.tsx"
      provides: "Search and filter controls"
      exports: ["ControlFilters"]
  key_links:
    - from: "src/pages/ControlsPage.tsx"
      to: "src/stores/controlsStore.ts"
      via: "reads controls for display"
      pattern: "useControlsStore"
    - from: "src/components/controls/ControlsTable.tsx"
      to: "src/stores/controlsStore.ts"
      via: "reads controls and links"
      pattern: "useControlsStore"
    - from: "src/components/controls/ControlDetailPanel.tsx"
      to: "src/stores/rctStore.ts"
      via: "reads row details for linked risks"
      pattern: "useRCTStore"
---

<objective>
Create the Controls Hub page with table, search/filter, and detail panel.

Purpose: Provide a central view of all controls in the system, showing which risks each control covers and allowing management of control-to-risk links.

Output: ControlsPage with table, filters, and slide-out detail panel. Integrated into app routing and sidebar navigation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-controls-hub/13-RESEARCH.md
@.planning/phases/13-controls-hub/13-01-SUMMARY.md
@.planning/phases/13-controls-hub/13-02-SUMMARY.md

@src/stores/controlsStore.ts
@src/stores/rctStore.ts
@src/components/remediation/RemediationTable.tsx
@src/components/rct/ControlPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ControlFilters component</name>
  <files>src/components/controls/ControlFilters.tsx</files>
  <action>
Create src/components/controls/ControlFilters.tsx for search and filtering.

```typescript
import { useState } from 'react'
import { Search, X } from 'lucide-react'
import Fuse from 'fuse.js'
import type { Control, ControlType } from '@/types/rct'

const CONTROL_TYPES: ControlType[] = [
  'Preventative', 'Detective', 'Corrective', 'Directive', 'Deterrent',
  'Compensating', 'Acceptance', 'Tolerance', 'Manual', 'Automated',
]

interface ControlFiltersProps {
  controls: Control[]
  onFilteredChange: (filtered: Control[]) => void
}

export function ControlFilters({ controls, onFilteredChange }: ControlFiltersProps) {
  const [search, setSearch] = useState('')
  const [selectedType, setSelectedType] = useState<ControlType | 'all'>('all')

  // Fuse.js instance for fuzzy search
  const fuse = new Fuse(controls, {
    keys: ['name', 'description'],
    threshold: 0.3,
    includeScore: true,
  })

  const applyFilters = (searchTerm: string, typeFilter: ControlType | 'all') => {
    let result = controls

    // Apply search
    if (searchTerm.trim()) {
      const fuseResults = fuse.search(searchTerm)
      result = fuseResults.map(r => r.item)
    }

    // Apply type filter
    if (typeFilter !== 'all') {
      result = result.filter(c => c.controlType === typeFilter)
    }

    onFilteredChange(result)
  }

  const handleSearchChange = (value: string) => {
    setSearch(value)
    applyFilters(value, selectedType)
  }

  const handleTypeChange = (type: ControlType | 'all') => {
    setSelectedType(type)
    applyFilters(search, type)
  }

  const clearFilters = () => {
    setSearch('')
    setSelectedType('all')
    onFilteredChange(controls)
  }

  const hasFilters = search.trim() || selectedType !== 'all'

  return (
    <div className="flex flex-wrap items-center gap-4 p-4 bg-surface-elevated rounded-lg border border-surface-border">
      {/* Search */}
      <div className="relative flex-1 min-w-[200px]">
        <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted" />
        <input
          type="text"
          value={search}
          onChange={(e) => handleSearchChange(e.target.value)}
          placeholder="Search controls..."
          className="w-full pl-9 pr-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-accent-500"
        />
      </div>

      {/* Type filter */}
      <div>
        <select
          value={selectedType}
          onChange={(e) => handleTypeChange(e.target.value as ControlType | 'all')}
          className="px-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary focus:outline-none focus:ring-2 focus:ring-accent-500"
        >
          <option value="all">All Types</option>
          {CONTROL_TYPES.map(type => (
            <option key={type} value={type}>{type}</option>
          ))}
        </select>
      </div>

      {/* Clear filters */}
      {hasFilters && (
        <button
          onClick={clearFilters}
          className="flex items-center gap-1 px-2 py-1 text-xs text-text-secondary hover:text-text-primary transition-colors"
        >
          <X size={14} />
          Clear
        </button>
      )}
    </div>
  )
}
```

Features:
- Fuzzy search using Fuse.js (already installed for knowledge base)
- Filter by control type dropdown
- Clear filters button when filters active
- Calls onFilteredChange with filtered results
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors.</verify>
  <done>ControlFilters component with search and type filter is created.</done>
</task>

<task type="auto">
  <name>Task 2: Create ControlsTable component</name>
  <files>src/components/controls/ControlsTable.tsx</files>
  <action>
Create src/components/controls/ControlsTable.tsx following the pattern from RemediationTable.tsx.

```typescript
import { useMemo, useState } from 'react'
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  flexRender,
  type SortingState,
  type ColumnDef,
} from '@tanstack/react-table'
import { ChevronUp, ChevronDown, Link2 } from 'lucide-react'
import { useControlsStore } from '@/stores/controlsStore'
import { useRCTStore } from '@/stores/rctStore'
import { HeatmapCell } from '@/components/rct/HeatmapCell'
import type { Control } from '@/types/rct'

interface EnrichedControl extends Control {
  linkCount: number
  linkedRisks: string[]
}

interface ControlsTableProps {
  controls: Control[]
  onControlClick: (controlId: string) => void
}

export function ControlsTable({ controls, onControlClick }: ControlsTableProps) {
  const controlLinks = useControlsStore(state => state.controlLinks)
  const rows = useRCTStore(state => state.rows)
  const [sorting, setSorting] = useState<SortingState>([])

  // Enrich controls with link information
  const data = useMemo<EnrichedControl[]>(() => {
    return controls.map(control => {
      const links = controlLinks.filter(l => l.controlId === control.id)
      const linkedRows = links
        .map(l => rows.find(r => r.id === l.rowId))
        .filter(Boolean)
      const linkedRisks = [...new Set(linkedRows.map(r => r?.riskName).filter(Boolean))] as string[]

      return {
        ...control,
        linkCount: links.length,
        linkedRisks,
      }
    })
  }, [controls, controlLinks, rows])

  const columns = useMemo<ColumnDef<EnrichedControl>[]>(
    () => [
      {
        accessorKey: 'name',
        header: 'Control Name',
        cell: ({ row }) => (
          <button
            onClick={() => onControlClick(row.original.id)}
            className="text-left text-accent-400 hover:underline"
          >
            {row.original.name}
          </button>
        ),
      },
      {
        accessorKey: 'controlType',
        header: 'Type',
        cell: ({ getValue }) => (
          <span className="text-text-secondary">{getValue<string>() || '—'}</span>
        ),
      },
      {
        accessorKey: 'netScore',
        header: 'Net Score',
        cell: ({ getValue }) => <HeatmapCell score={getValue<number | null>()} />,
      },
      {
        accessorKey: 'linkCount',
        header: () => (
          <span className="flex items-center gap-1">
            <Link2 size={14} />
            Linked Risks
          </span>
        ),
        cell: ({ row }) => {
          const count = row.original.linkCount
          return (
            <span className={count > 0 ? 'text-text-primary' : 'text-text-muted'}>
              {count} {count === 1 ? 'risk' : 'risks'}
            </span>
          )
        },
      },
      {
        accessorKey: 'linkedRisks',
        header: 'Risk Names',
        cell: ({ row }) => {
          const risks = row.original.linkedRisks
          if (risks.length === 0) return <span className="text-text-muted">—</span>
          if (risks.length <= 2) return <span className="text-text-secondary">{risks.join(', ')}</span>
          return (
            <span className="text-text-secondary" title={risks.join(', ')}>
              {risks.slice(0, 2).join(', ')} +{risks.length - 2} more
            </span>
          )
        },
      },
    ],
    [onControlClick]
  )

  const table = useReactTable({
    data,
    columns,
    state: { sorting },
    onSortingChange: setSorting,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
  })

  if (data.length === 0) {
    return (
      <div className="text-center py-12 text-text-secondary">
        No controls found. Controls will appear here once created in the Risk Control Table.
      </div>
    )
  }

  return (
    <div className="bg-surface-elevated rounded-lg border border-surface-border overflow-hidden">
      <table className="w-full">
        <thead>
          {table.getHeaderGroups().map(headerGroup => (
            <tr key={headerGroup.id} className="bg-surface-overlay">
              {headerGroup.headers.map(header => (
                <th
                  key={header.id}
                  className="px-4 py-3 text-left text-sm font-medium text-text-secondary cursor-pointer hover:bg-surface-border/50"
                  onClick={header.column.getToggleSortingHandler()}
                >
                  <div className="flex items-center gap-1">
                    {flexRender(header.column.columnDef.header, header.getContext())}
                    {header.column.getIsSorted() && (
                      header.column.getIsSorted() === 'asc'
                        ? <ChevronUp size={14} />
                        : <ChevronDown size={14} />
                    )}
                  </div>
                </th>
              ))}
            </tr>
          ))}
        </thead>
        <tbody>
          {table.getRowModel().rows.map(row => (
            <tr
              key={row.id}
              className="border-t border-surface-border hover:bg-surface-overlay/50 transition-colors"
            >
              {row.getVisibleCells().map(cell => (
                <td key={cell.id} className="px-4 py-3 text-sm text-text-primary">
                  {flexRender(cell.column.columnDef.cell, cell.getContext())}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}
```

Features:
- Enriches controls with linkCount and linkedRisks
- Clickable control name opens detail panel
- Shows net score with heatmap colors
- Shows link count and risk names
- Sortable columns
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors.</verify>
  <done>ControlsTable component with TanStack Table, sorting, and enriched link data is created.</done>
</task>

<task type="auto">
  <name>Task 3: Create ControlDetailPanel component</name>
  <files>src/components/controls/ControlDetailPanel.tsx</files>
  <action>
Create src/components/controls/ControlDetailPanel.tsx following the pattern from ControlPanel.tsx.

```typescript
import { useState, useEffect } from 'react'
import * as Dialog from '@radix-ui/react-dialog'
import { X, Link2, Unlink, Plus } from 'lucide-react'
import { useControlsStore } from '@/stores/controlsStore'
import { useRCTStore } from '@/stores/rctStore'
import { usePermissions } from '@/hooks/usePermissions'
import { ScoreDropdown } from '@/components/rct/ScoreDropdown'
import { HeatmapCell } from '@/components/rct/HeatmapCell'
import type { ControlType } from '@/types/rct'

const CONTROL_TYPES: ControlType[] = [
  'Preventative', 'Detective', 'Corrective', 'Directive', 'Deterrent',
  'Compensating', 'Acceptance', 'Tolerance', 'Manual', 'Automated',
]

interface ControlDetailPanelProps {
  isOpen: boolean
  onClose: () => void
  controlId: string | null
}

export function ControlDetailPanel({ isOpen, onClose, controlId }: ControlDetailPanelProps) {
  const { controls, controlLinks, updateControl, linkControl, unlinkControl } = useControlsStore()
  const rows = useRCTStore(state => state.rows)
  const { canEditControlDefinitions, canEditNetScores } = usePermissions()

  const [showLinkDialog, setShowLinkDialog] = useState(false)

  const control = controls.find(c => c.id === controlId)
  const links = controlLinks.filter(l => l.controlId === controlId)
  const linkedRowIds = new Set(links.map(l => l.rowId))
  const linkedRows = rows.filter(r => linkedRowIds.has(r.id))
  const unlinkedRows = rows.filter(r => !linkedRowIds.has(r.id))

  // Local state for editing
  const [localName, setLocalName] = useState('')
  const [localDescription, setLocalDescription] = useState('')

  // Sync local state when control changes
  useEffect(() => {
    if (control) {
      setLocalName(control.name)
      setLocalDescription(control.description ?? '')
    }
  }, [control])

  if (!control) return null

  const handleNameBlur = () => {
    if (localName !== control.name && localName.trim()) {
      updateControl(control.id, { name: localName.trim() })
    }
  }

  const handleDescriptionBlur = () => {
    if (localDescription !== (control.description ?? '')) {
      updateControl(control.id, { description: localDescription })
    }
  }

  const handleTypeChange = (type: ControlType | '') => {
    updateControl(control.id, { controlType: type || null })
  }

  const handleScoreChange = (field: 'netProbability' | 'netImpact', value: number) => {
    updateControl(control.id, { [field]: value })
  }

  const handleLinkRow = (rowId: string) => {
    linkControl(control.id, rowId)
  }

  const handleUnlinkRow = (rowId: string) => {
    const link = links.find(l => l.rowId === rowId)
    if (link) {
      unlinkControl(link.id)
    }
  }

  return (
    <>
      <Dialog.Root open={isOpen} onOpenChange={(open) => !open && onClose()}>
        <Dialog.Portal>
          <Dialog.Overlay className="fixed inset-0 bg-black/60 z-40" />
          <Dialog.Content className="fixed right-0 top-0 h-full w-[500px] bg-surface-elevated border-l border-surface-border shadow-xl z-50 flex flex-col overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between p-4 border-b border-surface-border">
              <Dialog.Title className="text-lg font-semibold text-text-primary">
                Control Details
              </Dialog.Title>
              <Dialog.Close asChild>
                <button className="p-2 rounded-lg hover:bg-surface-overlay transition-colors">
                  <X size={20} className="text-text-secondary" />
                </button>
              </Dialog.Close>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-auto p-4 space-y-6">
              {/* Control Info */}
              <div className="space-y-4">
                <div>
                  <label className="text-xs text-text-muted block mb-1">Name</label>
                  <input
                    type="text"
                    value={localName}
                    onChange={(e) => setLocalName(e.target.value)}
                    onBlur={handleNameBlur}
                    disabled={!canEditControlDefinitions}
                    className="w-full px-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary disabled:opacity-50"
                  />
                </div>

                <div>
                  <label className="text-xs text-text-muted block mb-1">Description</label>
                  <textarea
                    value={localDescription}
                    onChange={(e) => setLocalDescription(e.target.value)}
                    onBlur={handleDescriptionBlur}
                    disabled={!canEditControlDefinitions}
                    rows={3}
                    className="w-full px-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary resize-y min-h-[80px] disabled:opacity-50"
                  />
                </div>

                <div>
                  <label className="text-xs text-text-muted block mb-1">Type</label>
                  <select
                    value={control.controlType ?? ''}
                    onChange={(e) => handleTypeChange(e.target.value as ControlType | '')}
                    disabled={!canEditControlDefinitions}
                    className="w-full px-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary disabled:opacity-50"
                  >
                    <option value="">Select type...</option>
                    {CONTROL_TYPES.map(type => (
                      <option key={type} value={type}>{type}</option>
                    ))}
                  </select>
                </div>

                {/* Scores */}
                <div className="grid grid-cols-3 gap-4">
                  <div>
                    <label className="text-xs text-text-muted block mb-1">Net Probability</label>
                    <ScoreDropdown
                      value={control.netProbability}
                      onChange={(v) => handleScoreChange('netProbability', v)}
                      type="probability"
                      disabled={!canEditNetScores}
                    />
                  </div>
                  <div>
                    <label className="text-xs text-text-muted block mb-1">Net Impact</label>
                    <ScoreDropdown
                      value={control.netImpact}
                      onChange={(v) => handleScoreChange('netImpact', v)}
                      type="impact"
                      disabled={!canEditNetScores}
                    />
                  </div>
                  <div>
                    <label className="text-xs text-text-muted block mb-1">Net Score</label>
                    <HeatmapCell score={control.netScore} />
                  </div>
                </div>
              </div>

              {/* Linked Risks */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-sm font-medium text-text-primary flex items-center gap-2">
                    <Link2 size={16} />
                    Linked Risks ({links.length})
                  </h3>
                  {canEditControlDefinitions && unlinkedRows.length > 0 && (
                    <button
                      onClick={() => setShowLinkDialog(true)}
                      className="flex items-center gap-1 px-2 py-1 text-xs text-accent-400 hover:text-accent-300 transition-colors"
                    >
                      <Plus size={14} />
                      Link to Risk
                    </button>
                  )}
                </div>

                {linkedRows.length === 0 ? (
                  <p className="text-sm text-text-secondary py-4 text-center bg-surface-overlay rounded-lg">
                    This control is not linked to any risks.
                  </p>
                ) : (
                  <div className="space-y-2">
                    {linkedRows.map(row => (
                      <div
                        key={row.id}
                        className="flex items-center justify-between p-3 bg-surface-overlay rounded-lg border border-surface-border"
                      >
                        <div>
                          <p className="text-sm text-text-primary">{row.riskName}</p>
                          <p className="text-xs text-text-secondary">{row.processName}</p>
                        </div>
                        {canEditControlDefinitions && (
                          <button
                            onClick={() => handleUnlinkRow(row.id)}
                            className="p-1.5 rounded hover:bg-red-500/20 text-text-muted hover:text-red-400 transition-colors"
                            title="Unlink from this risk"
                          >
                            <Unlink size={14} />
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </Dialog.Content>
        </Dialog.Portal>
      </Dialog.Root>

      {/* Link Dialog */}
      <Dialog.Root open={showLinkDialog} onOpenChange={setShowLinkDialog}>
        <Dialog.Portal>
          <Dialog.Overlay className="fixed inset-0 bg-black/60 z-50" />
          <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] max-h-[80vh] bg-surface-elevated border border-surface-border rounded-lg shadow-xl z-50 flex flex-col overflow-hidden">
            <div className="flex items-center justify-between p-4 border-b border-surface-border">
              <Dialog.Title className="text-lg font-semibold text-text-primary">
                Link to Risk
              </Dialog.Title>
              <Dialog.Close asChild>
                <button className="p-2 rounded-lg hover:bg-surface-overlay transition-colors">
                  <X size={20} className="text-text-secondary" />
                </button>
              </Dialog.Close>
            </div>
            <div className="flex-1 overflow-auto p-4">
              {unlinkedRows.length === 0 ? (
                <p className="text-sm text-text-secondary text-center py-4">
                  All risks are already linked to this control.
                </p>
              ) : (
                <div className="space-y-2">
                  {unlinkedRows.map(row => (
                    <button
                      key={row.id}
                      onClick={() => {
                        handleLinkRow(row.id)
                        setShowLinkDialog(false)
                      }}
                      className="w-full flex items-center justify-between p-3 bg-surface-overlay rounded-lg border border-surface-border hover:border-accent-500 transition-colors text-left"
                    >
                      <div>
                        <p className="text-sm text-text-primary">{row.riskName}</p>
                        <p className="text-xs text-text-secondary">{row.processName}</p>
                      </div>
                      <Link2 size={16} className="text-text-muted" />
                    </button>
                  ))}
                </div>
              )}
            </div>
          </Dialog.Content>
        </Dialog.Portal>
      </Dialog.Root>
    </>
  )
}
```

Features:
- Displays control details with editable fields
- Shows linked risks with unlink button
- Link dialog to add control to new risks
- Permission-gated editing
- Uses existing ScoreDropdown and HeatmapCell components
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors.</verify>
  <done>ControlDetailPanel component with control editing and link management is created.</done>
</task>

<task type="auto">
  <name>Task 4: Create barrel export and ControlsPage</name>
  <files>src/components/controls/index.ts, src/pages/ControlsPage.tsx</files>
  <action>
**Create src/components/controls/index.ts:**
```typescript
export { ControlFilters } from './ControlFilters'
export { ControlsTable } from './ControlsTable'
export { ControlDetailPanel } from './ControlDetailPanel'
```

**Create src/pages/ControlsPage.tsx:**
```typescript
import { useState, useEffect } from 'react'
import { Shield, Plus } from 'lucide-react'
import { useControlsStore } from '@/stores/controlsStore'
import { usePermissions } from '@/hooks/usePermissions'
import { ControlFilters, ControlsTable, ControlDetailPanel } from '@/components/controls'
import type { Control } from '@/types/rct'
import { nanoid } from 'nanoid'

export function ControlsPage() {
  const { controls, addControl } = useControlsStore()
  const { canEditControlDefinitions } = usePermissions()

  const [filteredControls, setFilteredControls] = useState<Control[]>(controls)
  const [selectedControlId, setSelectedControlId] = useState<string | null>(null)

  // Keep filtered controls in sync with source
  useEffect(() => {
    setFilteredControls(controls)
  }, [controls])

  const handleAddControl = () => {
    const id = addControl({
      name: 'New Control',
      description: '',
      controlType: null,
      netProbability: null,
      netImpact: null,
      netScore: null,
      comment: '',
      testFrequency: null,
      nextTestDate: null,
      lastTestDate: null,
      testProcedure: '',
    })
    setSelectedControlId(id)
  }

  return (
    <div className="h-full flex flex-col">
      {/* Header */}
      <div className="flex items-center justify-between p-6 border-b border-surface-border">
        <div className="flex items-center gap-3">
          <Shield className="w-6 h-6 text-accent-500" />
          <div>
            <h1 className="text-xl font-semibold text-text-primary">Controls Hub</h1>
            <p className="text-sm text-text-secondary">
              {controls.length} {controls.length === 1 ? 'control' : 'controls'} total
            </p>
          </div>
        </div>
        {canEditControlDefinitions && (
          <button
            onClick={handleAddControl}
            className="flex items-center gap-2 px-4 py-2 bg-accent-500 text-white rounded-lg font-medium hover:bg-accent-600 transition-colors"
          >
            <Plus size={16} />
            Add Control
          </button>
        )}
      </div>

      {/* Content */}
      <div className="flex-1 overflow-auto p-6 space-y-4">
        <ControlFilters
          controls={controls}
          onFilteredChange={setFilteredControls}
        />

        <ControlsTable
          controls={filteredControls}
          onControlClick={setSelectedControlId}
        />
      </div>

      {/* Detail Panel */}
      <ControlDetailPanel
        isOpen={selectedControlId !== null}
        onClose={() => setSelectedControlId(null)}
        controlId={selectedControlId}
      />
    </div>
  )
}
```

Features:
- Header with control count and Add Control button
- Filters component for search/filter
- Table with clickable controls
- Slide-out detail panel
- Permission-gated add button
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors.</verify>
  <done>ControlsPage and barrel export are created.</done>
</task>

<task type="auto">
  <name>Task 5: Add routing and sidebar navigation</name>
  <files>src/App.tsx, src/components/layout/Sidebar.tsx</files>
  <action>
**Update src/App.tsx to add route:**

Add import:
```typescript
import { ControlsPage } from './pages/ControlsPage'
```

Add route inside the Routes (after existing routes, before closing Route element):
```typescript
<Route path="controls" element={<ControlsPage />} />
```

**Update src/components/layout/Sidebar.tsx to add nav item:**

Add Shield icon to imports:
```typescript
import { Folders, Table, Grid3x3, Sun, ClipboardList, History, BarChart3, BookOpen, Shield, PanelLeftClose, PanelLeft } from 'lucide-react'
```

Add Controls nav item to navItems array (after 'Risk Control Table', before 'Matrix'):
```typescript
const navItems = [
  { to: '/taxonomy', icon: Folders, label: 'Taxonomies' },
  { to: '/rct', icon: Table, label: 'Risk Control Table' },
  { to: '/controls', icon: Shield, label: 'Controls' },  // NEW
  { to: '/matrix', icon: Grid3x3, label: 'Matrix' },
  // ... rest unchanged
]
```

Position rationale: Controls is closely related to RCT, so it follows RCT in navigation order.
  </action>
  <verify>
1. Run `npx tsc --noEmit` and confirm no type errors.
2. Verify /controls route exists in App.tsx.
3. Verify Controls nav item exists in Sidebar.tsx.
  </verify>
  <done>Controls page is routed at /controls and appears in sidebar navigation.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All component files exist in src/components/controls/
3. ControlsPage.tsx exists in src/pages/
4. Controls nav item appears in sidebar
5. /controls route works
6. Table shows controls with link counts
7. Clicking control opens detail panel
8. Search filters controls by name/description
9. Type filter filters by control type
</verification>

<success_criteria>
- ControlsPage displays all controls from controlsStore
- Each control shows name, type, net score, and link count
- Clicking control name opens ControlDetailPanel
- Detail panel shows linked risks with unlink button
- Link to Risk button opens dialog to link control to unlinked rows
- Search uses Fuse.js for fuzzy matching
- Type filter dropdown works
- Add Control button creates new control (Risk Manager only)
- Navigation to /controls works from sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/13-controls-hub/13-03-SUMMARY.md`
</output>
