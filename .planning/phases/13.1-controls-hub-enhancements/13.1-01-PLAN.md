---
phase: 13.1-controls-hub-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/rct/ControlPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can link an existing control to a risk-process row from the RCT ControlPanel"
    - "User sees which controls are linked to multiple risks via badge indicator"
    - "User sees risk ID alongside risk name when selecting controls to link"
  artifacts:
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Link Existing dialog, multi-link badge"
      contains: "Link Existing"
  key_links:
    - from: "src/components/rct/ControlPanel.tsx"
      to: "controlsStore.linkControl"
      via: "handleLinkExistingControl callback"
      pattern: "linkControl"
---

<objective>
Add "Link Existing Control" functionality to RCT ControlPanel with multi-link indicators

Purpose: Allow users to reuse existing controls across multiple risk-process combinations without recreating them, improving control management efficiency
Output: Modified ControlPanel with Link Existing dialog and multi-link badge indicators
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13.1-controls-hub-enhancements/13.1-RESEARCH.md
@src/components/rct/ControlPanel.tsx
@src/stores/controlsStore.ts
@src/types/rct.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Link Existing Control dialog to ControlPanel</name>
  <files>src/components/rct/ControlPanel.tsx</files>
  <action>
Modify ControlPanel.tsx to add "Link Existing Control" functionality:

1. Import additional dependencies:
   - `Link2, Search` from lucide-react
   - `useControlsStore` from '@/stores/controlsStore'
   - `Fuse` from 'fuse.js'

2. Add state for the Link Existing dialog:
   ```typescript
   const [showLinkExistingDialog, setShowLinkExistingDialog] = useState(false)
   const [linkSearch, setLinkSearch] = useState('')
   ```

3. Get controls and links from controlsStore:
   ```typescript
   const { controls, controlLinks, linkControl } = useControlsStore()
   ```

4. Create filtered list of available controls (excluding already-linked):
   ```typescript
   const existingControlIds = new Set(row.controls.map(c => c.id))
   // Also exclude controls already linked via controlLinks
   const linkedControlIds = controlLinks
     .filter(l => l.rowId === row.id)
     .map(l => l.controlId)
   linkedControlIds.forEach(id => existingControlIds.add(id))

   const availableControls = controls.filter(c => !existingControlIds.has(c.id))
   ```

5. Add Fuse.js search for controls:
   ```typescript
   const fuse = useMemo(() => new Fuse(availableControls, {
     keys: ['name', 'description'],
     threshold: 0.3,
   }), [availableControls])

   const filteredControls = linkSearch.trim()
     ? fuse.search(linkSearch).map(r => r.item)
     : availableControls
   ```

6. Create helper to get link count for display:
   ```typescript
   const getLinkCount = (controlId: string) =>
     controlLinks.filter(l => l.controlId === controlId).length
   ```

7. Create handler for linking:
   ```typescript
   const handleLinkExistingControl = (controlId: string) => {
     linkControl(controlId, row.id)
     setShowLinkExistingDialog(false)
     setLinkSearch('')
   }
   ```

8. Modify the "Add control form" section at bottom of panel. Change from single input+button to a button group with two options. Replace the existing form section with:
   ```tsx
   {/* Add control form (Risk Manager only) */}
   {canEditControlDefinitions && (
     <div className="p-4 border-t border-surface-border">
       <div className="flex gap-2">
         <input
           type="text"
           value={newDescription}
           onChange={(e) => setNewDescription(e.target.value)}
           placeholder="New control name..."
           className="flex-1 px-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-accent-500"
           onKeyDown={(e) => e.key === 'Enter' && handleAddControl()}
         />
         <button
           onClick={handleAddControl}
           disabled={!newDescription.trim()}
           className="px-4 py-2 bg-accent-500 text-white rounded-lg font-medium hover:bg-accent-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
         >
           <Plus size={16} />
           Add
         </button>
       </div>
       {availableControls.length > 0 && (
         <button
           onClick={() => setShowLinkExistingDialog(true)}
           className="mt-2 w-full px-3 py-2 border border-dashed border-surface-border rounded-lg text-sm text-text-secondary hover:text-accent-400 hover:border-accent-500 transition-colors flex items-center justify-center gap-2"
         >
           <Link2 size={16} />
           Link Existing Control ({availableControls.length} available)
         </button>
       )}
     </div>
   )}
   ```

9. Add the Link Existing dialog at the end of the component (after the main Dialog.Root but before the closing fragment or final return):
   ```tsx
   {/* Link Existing Control Dialog */}
   <Dialog.Root open={showLinkExistingDialog} onOpenChange={setShowLinkExistingDialog}>
     <Dialog.Portal>
       <Dialog.Overlay className="fixed inset-0 bg-black/60 z-50" />
       <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[450px] max-h-[80vh] bg-surface-elevated border border-surface-border rounded-lg shadow-xl z-50 flex flex-col overflow-hidden">
         <div className="flex items-center justify-between p-4 border-b border-surface-border">
           <Dialog.Title className="text-lg font-semibold text-text-primary">
             Link Existing Control
           </Dialog.Title>
           <Dialog.Close asChild>
             <button className="p-2 rounded-lg hover:bg-surface-overlay transition-colors">
               <X size={20} className="text-text-secondary" />
             </button>
           </Dialog.Close>
         </div>
         <div className="p-4 border-b border-surface-border">
           <div className="relative">
             <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted" />
             <input
               type="text"
               value={linkSearch}
               onChange={(e) => setLinkSearch(e.target.value)}
               placeholder="Search controls..."
               className="w-full pl-9 pr-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-accent-500"
               autoFocus
             />
           </div>
         </div>
         <div className="flex-1 overflow-auto p-4">
           {filteredControls.length === 0 ? (
             <p className="text-sm text-text-secondary text-center py-8">
               {linkSearch ? 'No controls match your search.' : 'No controls available to link.'}
             </p>
           ) : (
             <div className="space-y-2">
               {filteredControls.map(control => {
                 const linkCount = getLinkCount(control.id)
                 return (
                   <button
                     key={control.id}
                     onClick={() => handleLinkExistingControl(control.id)}
                     className="w-full flex items-center justify-between p-3 bg-surface-overlay rounded-lg border border-surface-border hover:border-accent-500 transition-colors text-left"
                   >
                     <div className="flex-1 min-w-0">
                       <p className="text-sm text-text-primary truncate">{control.name}</p>
                       <p className="text-xs text-text-secondary mt-0.5">
                         {control.controlType ?? 'No type'} | Linked to {linkCount} {linkCount === 1 ? 'risk' : 'risks'}
                       </p>
                     </div>
                     <Link2 size={16} className="text-text-muted ml-2 flex-shrink-0" />
                   </button>
                 )
               })}
             </div>
           )}
         </div>
       </Dialog.Content>
     </Dialog.Portal>
   </Dialog.Root>
   ```

10. The component must return a fragment `<>...</>` to wrap both dialogs.
  </action>
  <verify>
- `npm run build` completes without TypeScript errors
- ControlPanel renders without console errors
  </verify>
  <done>Link Existing Control button appears in ControlPanel footer, clicking opens dialog with searchable control list showing control type and link count</done>
</task>

<task type="auto">
  <name>Task 2: Add multi-link badge indicator to control cards</name>
  <files>src/components/rct/ControlPanel.tsx</files>
  <action>
Add a badge to show when a control is linked to multiple risks:

1. Inside the control card render (in the `.space-y-4` div that maps over `row.controls`), modify the control header section.

2. Find the `<label className="text-text-muted text-xs block mb-1">Control {index + 1} - Name</label>` line.

3. Add a multi-link badge next to the control label. Compute link count for each control:
   ```tsx
   {row.controls.map((control, index) => {
     const linkCount = controlLinks.filter(l => l.controlId === control.id).length

     return (
       <div key={control.id} className="bg-surface-overlay rounded-lg p-4 border border-surface-border">
         <div className="flex items-start justify-between gap-3 mb-3">
           <div className="flex-1">
             <div className="flex items-center gap-2 mb-1">
               <label className="text-text-muted text-xs">Control {index + 1} - Name</label>
               {linkCount > 1 && (
                 <span className="px-1.5 py-0.5 text-xs bg-accent-500/20 text-accent-400 rounded" title={`This control is linked to ${linkCount} risks`}>
                   {linkCount} risks
                 </span>
               )}
             </div>
             <BlurCommitInput ... />
           </div>
           ...
         </div>
         ...
       </div>
     )
   })}
   ```

4. Also display risk IDs in the Link Existing dialog by adding the row's riskId. In the filteredControls mapping inside the dialog, enhance the display to show which risks each control covers:
   - The dialog is for linking controls TO a row, so we don't need to show risk IDs here
   - The risk ID requirement is about showing the current row's risk ID in the dialog header - update the Dialog.Description:
   ```tsx
   <Dialog.Description className="text-xs text-text-muted mt-1">
     Linking to: {row.riskId} - {row.riskName}
   </Dialog.Description>
   ```
   Add this below the Dialog.Title inside the dialog header.
  </action>
  <verify>
- `npm run build` completes without TypeScript errors
- Badge appears on control cards when linkCount > 1
- Risk ID visible in Link Existing dialog header
  </verify>
  <done>Multi-link badge shows "X risks" when control is linked to multiple rows, Risk ID displayed in Link Existing dialog header alongside risk name</done>
</task>

</tasks>

<verification>
1. Build verification: `npm run build` passes
2. Runtime verification: Open RCT, click a control cell to open ControlPanel
3. Verify "Link Existing Control" button appears below Add Control input
4. Verify clicking opens dialog with searchable control list
5. Verify controls show type and link count in dialog
6. Verify linking a control adds it to the row
7. Verify multi-link badge appears on controls linked to >1 risk
8. Verify Risk ID shown in Link Existing dialog header
</verification>

<success_criteria>
- "Link Existing Control" button visible in ControlPanel footer when controls available
- Dialog shows searchable list with control name, type, and link count
- Multi-link badge (e.g., "3 risks") appears on control cards with linkCount > 1
- Risk ID displayed in dialog header: "Linking to: [riskId] - [riskName]"
- Linking a control via dialog successfully adds it to the RCT row
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-controls-hub-enhancements/13.1-01-SUMMARY.md`
</output>
