---
phase: 13.1-controls-hub-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/controls/ControlDetailPanel.tsx
  - src/components/controls/ControlsTable.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit per-link net scores (P/I) independently for each linked risk"
    - "User sees visual expand indicator on control names in Controls Hub table"
    - "User sees risk ID alongside risk name in linked risks section"
  artifacts:
    - path: "src/components/controls/ControlDetailPanel.tsx"
      provides: "Per-link score editing UI"
      contains: "updateLink"
    - path: "src/components/controls/ControlsTable.tsx"
      provides: "Expand indicator on name column"
      contains: "PanelRight"
  key_links:
    - from: "src/components/controls/ControlDetailPanel.tsx"
      to: "controlsStore.updateLink"
      via: "handleLinkScoreChange callback"
      pattern: "updateLink.*netProbability|netImpact"
---

<objective>
Add per-link score editing to ControlDetailPanel and expand indicator to ControlsTable

Purpose: Allow users to set different net scores per risk-control link (same control can have different effectiveness on different risks) and make it clear that clicking control names opens the detail panel
Output: Modified ControlDetailPanel with per-link score dropdowns, ControlsTable with expand icon
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13.1-controls-hub-enhancements/13.1-RESEARCH.md
@src/components/controls/ControlDetailPanel.tsx
@src/components/controls/ControlsTable.tsx
@src/stores/controlsStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-link score editing to ControlDetailPanel</name>
  <files>src/components/controls/ControlDetailPanel.tsx</files>
  <action>
Modify ControlDetailPanel.tsx to add per-link score editing in the Linked Risks section:

1. Add `updateLink` to the controlsStore destructuring:
   ```typescript
   const { controls, controlLinks, updateControl, linkControl, unlinkControl, updateLink } = useControlsStore()
   ```

2. Create handler for per-link score changes:
   ```typescript
   const handleLinkScoreChange = (
     linkId: string,
     field: 'netProbability' | 'netImpact',
     value: number | null
   ) => {
     updateLink(linkId, { [field]: value })
   }

   const handleClearLinkOverride = (linkId: string) => {
     updateLink(linkId, { netProbability: null, netImpact: null, netScore: null })
   }
   ```

3. Modify the linked risks section (currently shows just risk name and process name). Replace the existing linkedRows.map with an enhanced version showing per-link scores:

   ```tsx
   {linkedRows.length === 0 ? (
     <p className="text-sm text-text-secondary py-4 text-center bg-surface-overlay rounded-lg">
       This control is not linked to any risks.
     </p>
   ) : (
     <div className="space-y-3">
       {linkedRows.map(row => {
         const link = links.find(l => l.rowId === row.id)!
         const hasOverride = link.netProbability !== null || link.netImpact !== null
         // Compute displayed values: link override or fall back to control base
         const displayP = link.netProbability ?? control.netProbability
         const displayI = link.netImpact ?? control.netImpact
         const displayScore = link.netScore ?? control.netScore

         return (
           <div
             key={row.id}
             className="p-3 bg-surface-overlay rounded-lg border border-surface-border"
           >
             <div className="flex items-start justify-between mb-3">
               <div>
                 <p className="text-sm text-text-primary">{row.riskName}</p>
                 <p className="text-xs text-text-muted">ID: {row.riskId}</p>
                 <p className="text-xs text-text-secondary">{row.processName}</p>
               </div>
               <div className="flex items-center gap-1">
                 {hasOverride && (
                   <button
                     onClick={() => handleClearLinkOverride(link.id)}
                     disabled={!canEditNetScores}
                     className="px-2 py-1 text-xs text-text-secondary hover:text-text-primary transition-colors disabled:opacity-50"
                     title="Clear override, use control defaults"
                   >
                     Reset
                   </button>
                 )}
                 {canEditControlDefinitions && (
                   <button
                     onClick={() => handleUnlinkRow(row.id)}
                     className="p-1.5 rounded hover:bg-red-500/20 text-text-muted hover:text-red-400 transition-colors"
                     title="Unlink from this risk"
                   >
                     <Unlink size={14} />
                   </button>
                 )}
               </div>
             </div>

             {/* Per-link score editing */}
             <div className="pt-3 border-t border-surface-border">
               <div className="flex items-center justify-between mb-2">
                 <span className="text-xs text-text-muted">Scores for this risk</span>
                 {hasOverride && (
                   <span className="text-xs text-accent-400">Override active</span>
                 )}
               </div>
               <div className="grid grid-cols-3 gap-3">
                 <div>
                   <label className="text-xs text-text-muted block mb-1">Net P</label>
                   <ScoreDropdown
                     value={displayP}
                     onChange={(v) => handleLinkScoreChange(link.id, 'netProbability', v)}
                     type="probability"
                     disabled={!canEditNetScores}
                   />
                 </div>
                 <div>
                   <label className="text-xs text-text-muted block mb-1">Net I</label>
                   <ScoreDropdown
                     value={displayI}
                     onChange={(v) => handleLinkScoreChange(link.id, 'netImpact', v)}
                     type="impact"
                     disabled={!canEditNetScores}
                   />
                 </div>
                 <div>
                   <label className="text-xs text-text-muted block mb-1">Net Score</label>
                   <HeatmapCell score={displayScore} />
                 </div>
               </div>
             </div>
           </div>
         )
       })}
     </div>
   )}
   ```

4. Ensure ScoreDropdown and HeatmapCell are imported (they should already be).
  </action>
  <verify>
- `npm run build` completes without TypeScript errors
- ControlDetailPanel renders linked risks with per-link score dropdowns
  </verify>
  <done>Per-link score editing (Net P, Net I) available in linked risks section, risk ID shown for each link, "Reset" button clears override to use control defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add expand indicator to ControlsTable name column</name>
  <files>src/components/controls/ControlsTable.tsx</files>
  <action>
Modify ControlsTable.tsx to add a visual expand indicator:

1. Add PanelRight icon to imports:
   ```typescript
   import { ChevronUp, ChevronDown, Link2, PanelRight } from 'lucide-react'
   ```

2. Modify the 'name' column cell to include the expand icon. The icon should appear on hover to indicate clickability:

   Replace the existing name column definition:
   ```typescript
   {
     accessorKey: 'name',
     header: 'Control Name',
     cell: ({ row }) => (
       <button
         onClick={() => onControlClick(row.original.id)}
         className="flex items-center gap-2 text-left text-accent-400 hover:underline group"
       >
         <span>{row.original.name}</span>
         <PanelRight
           size={14}
           className="text-text-muted opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"
         />
       </button>
     ),
   },
   ```

This makes the expand indicator visible on hover, following the pattern from EntityHistoryPanel.tsx but using PanelRight to indicate "opens side panel".
  </action>
  <verify>
- `npm run build` completes without TypeScript errors
- ControlsTable shows PanelRight icon on hover over control name
  </verify>
  <done>PanelRight icon appears on hover over control names in ControlsTable, indicating clickability to open detail panel</done>
</task>

</tasks>

<verification>
1. Build verification: `npm run build` passes
2. Navigate to Controls Hub page (/controls)
3. Verify control names show PanelRight icon on hover
4. Click a control name to open ControlDetailPanel
5. Verify Linked Risks section shows risk ID for each link
6. Verify per-link score dropdowns (Net P, Net I) are editable
7. Verify changing per-link score shows "Override active" indicator
8. Verify "Reset" button clears override values
9. Verify HeatmapCell displays computed net score
</verification>

<success_criteria>
- PanelRight icon appears on hover for control names in ControlsTable
- Risk ID displayed below risk name in linked risks section: "ID: [riskId]"
- Per-link Net P and Net I dropdowns functional in linked risks section
- "Override active" indicator shown when per-link values differ from control defaults
- "Reset" button clears link-specific scores back to control defaults
- Net score HeatmapCell updates when per-link scores change
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-controls-hub-enhancements/13.1-02-SUMMARY.md`
</output>
