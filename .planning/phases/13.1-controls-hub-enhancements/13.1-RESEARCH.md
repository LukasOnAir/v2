# Phase 13.1: Controls Hub Enhancements - Research

**Researched:** 2026-01-22
**Domain:** React UI enhancements, Zustand state management, many-to-many data patterns
**Confidence:** HIGH

## Summary

Phase 13.1 addresses five specific UX improvements identified during Phase 13 verification. The enhancements center around improving control-to-risk linking workflows and providing better visual feedback. The existing architecture from Phase 13 (controlsStore with first-class controls and ControlLink junction table) fully supports all requirements - no data model changes are needed.

The key insight is that the ControlLink type already has `netProbability`, `netImpact`, and `netScore` fields for per-link overrides. The existing `updateLink()` action in controlsStore handles score updates. The implementation is purely UI-focused: adding components and modifying existing ones to expose functionality that the data layer already supports.

**Primary recommendation:** Implement as pure UI enhancements without modifying controlsStore or the ControlLink type. Add a "Link Existing Control" option to ControlPanel, per-link score editing in ControlDetailPanel, and visual indicators (expand icon, multi-link badge) to ControlsTable and RCTTable.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| zustand | 5.0.10 | State management | Already used, controlsStore has all needed actions |
| @tanstack/react-table | 8.21.3 | Data tables | Already used for ControlsTable |
| @radix-ui/react-dialog | 1.1.15 | Modal dialogs | Already used for panels and dialogs |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| lucide-react | 0.562.0 | Icons | ExternalLink/PanelRight for expand indicator, Link2 for multi-link badge |
| fuse.js | 7.1.0 | Fuzzy search | Already used in ControlFilters, can reuse for link dialog search |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| ExternalLink icon | PanelRight icon | PanelRight more accurate but ExternalLink already used in codebase |
| Badge component | Inline count | Badge more visible, matches design language |

**Installation:**
No new dependencies required - all needed libraries already in package.json.

## Architecture Patterns

### Current Architecture (Sufficient for Phase 13.1)

The existing controlsStore already supports all required functionality:

```typescript
// ControlLink already has per-link score fields (src/types/rct.ts)
interface ControlLink {
  id: string
  controlId: string
  rowId: string
  netProbability?: number | null  // Per-link override
  netImpact?: number | null       // Per-link override
  netScore?: number | null        // Computed if P/I set
  createdAt: string
}

// controlsStore already has updateLink action (src/stores/controlsStore.ts)
updateLink: (linkId: string, updates: Partial<ControlLink>) => void
```

### Pattern 1: Link Existing Control from RCT

**What:** Add "Link Existing" option alongside "Add New" in ControlPanel
**When to use:** User wants to reuse an existing control for a different risk-process combination
**Component structure:**

```
ControlPanel (modified)
├── Header
├── Control list
├── Add control section (modified)
│   ├── "Add New" button (existing)
│   └── "Link Existing" button (NEW)
└── LinkExistingDialog (NEW)
    ├── Search/filter controls
    ├── Control list with risk ID shown
    └── Select to link
```

### Pattern 2: Per-Link Score Editing

**What:** Edit net P/I/score per risk-control link independently from control's base scores
**When to use:** Same control has different effectiveness on different risks
**Component structure:**

```
ControlDetailPanel (modified)
├── Control details section
│   └── Global scores (control.netP/I/score)
└── Linked Risks section (modified)
    └── Per-link row (modified)
        ├── Risk name + ID
        ├── Per-link P/I dropdowns (NEW)
        ├── Per-link net score display (NEW)
        └── Unlink button
```

### Pattern 3: Visual Indicator for Clickable Names

**What:** Add PanelRight/ExternalLink icon next to control names in ControlsTable
**When to use:** Indicate that clicking opens the detail panel
**Example from codebase:**

```typescript
// Pattern from EntityHistoryPanel.tsx - icon indicating clickable/expandable
<button className="flex items-center gap-2">
  <span>{control.name}</span>
  <ExternalLink size={14} className="text-text-muted" />
</button>
```

### Pattern 4: Multi-Link Indicator in RCT

**What:** Show badge when a control is linked to multiple risks
**When to use:** In RCT ControlPanel, to highlight controls that affect multiple risk-process combinations
**Component structure:**

```
ControlPanel control card (modified)
├── Control name
├── Multi-link badge (NEW) - shows "2 risks" if linkCount > 1
├── Control details
└── Actions
```

### Recommended Project Structure

```
src/
├── components/
│   ├── controls/
│   │   ├── ControlsTable.tsx        # Modified: add expand icon to name column
│   │   ├── ControlDetailPanel.tsx   # Modified: add per-link score editing
│   │   └── LinkExistingDialog.tsx   # NEW: dialog for linking existing controls
│   └── rct/
│       └── ControlPanel.tsx         # Modified: add "Link Existing" button, multi-link badge
└── (no store or type changes needed)
```

### Anti-Patterns to Avoid
- **Duplicating score editing logic:** Use existing ScoreDropdown component, don't create new score inputs
- **Breaking existing workflows:** "Add New" should work exactly as before, "Link Existing" is additive
- **Per-link scores overwriting control scores:** Keep them separate - link scores are OVERRIDES, not replacements

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Score dropdowns | Custom inputs | ScoreDropdown component | Already handles styling, validation, tooltips |
| Heatmap display | Manual color coding | HeatmapCell component | Consistent coloring across app |
| Dialog modals | Custom portals | @radix-ui/react-dialog | Accessibility, focus trap, keyboard handling |
| Fuzzy search | Manual filtering | Fuse.js | Already used in ControlFilters, handles typos |

**Key insight:** All UI patterns for this phase already exist in the codebase. This is purely a matter of composing existing components in new arrangements.

## Common Pitfalls

### Pitfall 1: Confusing Per-Link and Control Scores
**What goes wrong:** User edits per-link scores thinking they're editing the control's base scores, or vice versa.
**Why it happens:** UI doesn't clearly distinguish between global control scores and link-specific overrides.
**How to avoid:**
1. Label sections clearly: "Control Default Scores" vs "Scores for This Risk"
2. Show both in ControlDetailPanel - control's scores at top, per-link scores in each linked risk row
3. When per-link scores are set, show indicator that override is active
**Warning signs:** User complaints about "scores not saving" or "wrong scores showing".

### Pitfall 2: Link Dialog Showing Too Many Controls
**What goes wrong:** Link dialog lists all controls including ones already linked to this row.
**Why it happens:** Not filtering out already-linked controls.
**How to avoid:**
1. Filter control list: `controls.filter(c => !existingControlIds.has(c.id))`
2. Show count: "X controls available to link"
3. If all controls already linked, show helpful message
**Warning signs:** Same control appearing twice in a row's control list.

### Pitfall 3: Risk ID Format Inconsistency
**What goes wrong:** Risk IDs shown in different formats or truncated, making identification difficult.
**Why it happens:** Different components using different ID fields or formatting.
**How to avoid:**
1. Use consistent format: `[riskId] - Risk Name` or `Risk Name (ID: xxx)`
2. Use riskId from RCTRow, not riskL1Id/L2Id etc.
3. Truncate name if needed, never truncate ID
**Warning signs:** Users can't distinguish between similar-named risks.

### Pitfall 4: Stale Link Count in RCT
**What goes wrong:** Multi-link badge shows wrong count after linking/unlinking.
**Why it happens:** Component not re-rendering when controlLinks changes.
**How to avoid:**
1. Use controlsStore selector for links: `useControlsStore(s => s.controlLinks)`
2. Compute linkCount inside render or useMemo with correct dependencies
3. Test: link control to second risk, verify badge appears immediately
**Warning signs:** Need to refresh page to see updated link counts.

### Pitfall 5: Net Score Calculation After Per-Link Override
**What goes wrong:** Row's net score doesn't reflect per-link override.
**Why it happens:** calculateNetScoreFromLinks not being called after link update.
**How to avoid:**
1. Existing implementation already handles this correctly (see rctStore.ts line 52-71)
2. The function checks link.netScore first, then falls back to control.netScore
3. Ensure updateLink action triggers re-render of affected components
**Warning signs:** Setting per-link score doesn't change row's displayed net score.

## Code Examples

Verified patterns from existing codebase:

### Link Existing Control Dialog Pattern
```typescript
// Pattern from ControlDetailPanel.tsx Link Dialog (lines 220-263)
// Adapt for linking controls TO a row instead of rows TO a control

<Dialog.Root open={showLinkDialog} onOpenChange={setShowLinkDialog}>
  <Dialog.Portal>
    <Dialog.Overlay className="fixed inset-0 bg-black/60 z-50" />
    <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] max-h-[80vh] bg-surface-elevated border border-surface-border rounded-lg shadow-xl z-50 flex flex-col overflow-hidden">
      <div className="flex items-center justify-between p-4 border-b border-surface-border">
        <Dialog.Title className="text-lg font-semibold text-text-primary">
          Link Existing Control
        </Dialog.Title>
        <Dialog.Close asChild>
          <button className="p-2 rounded-lg hover:bg-surface-overlay transition-colors">
            <X size={20} className="text-text-secondary" />
          </button>
        </Dialog.Close>
      </div>
      <div className="flex-1 overflow-auto p-4">
        {/* Search input using Fuse.js pattern from ControlFilters.tsx */}
        <div className="relative mb-4">
          <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted" />
          <input
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search controls..."
            className="w-full pl-9 pr-3 py-2 bg-surface-overlay border border-surface-border rounded-lg text-sm"
          />
        </div>
        {/* Control list with risk ID shown */}
        <div className="space-y-2">
          {filteredControls.map(control => (
            <button
              key={control.id}
              onClick={() => handleLinkControl(control.id)}
              className="w-full flex items-center justify-between p-3 bg-surface-overlay rounded-lg border border-surface-border hover:border-accent-500 transition-colors text-left"
            >
              <div>
                <p className="text-sm text-text-primary">{control.name}</p>
                <p className="text-xs text-text-secondary">
                  {control.controlType ?? 'No type'} | Linked to {linkCounts[control.id]} risks
                </p>
              </div>
              <Link2 size={16} className="text-text-muted" />
            </button>
          ))}
        </div>
      </div>
    </Dialog.Content>
  </Dialog.Portal>
</Dialog.Root>
```

### Per-Link Score Editing Pattern
```typescript
// Extend the linked risks list in ControlDetailPanel.tsx (around line 191)
// Add ScoreDropdown for per-link scores

{linkedRows.map(row => {
  const link = links.find(l => l.rowId === row.id)!
  return (
    <div key={row.id} className="p-3 bg-surface-overlay rounded-lg border border-surface-border">
      <div className="flex items-center justify-between mb-3">
        <div>
          <p className="text-sm text-text-primary">{row.riskName}</p>
          <p className="text-xs text-text-muted">ID: {row.riskId}</p>
          <p className="text-xs text-text-secondary">{row.processName}</p>
        </div>
        {canEditControlDefinitions && (
          <button onClick={() => handleUnlinkRow(row.id)} /* ... */ />
        )}
      </div>

      {/* Per-link score editing - NEW */}
      <div className="grid grid-cols-3 gap-3 pt-3 border-t border-surface-border">
        <div>
          <label className="text-xs text-text-muted block mb-1">Net Probability</label>
          <ScoreDropdown
            value={link.netProbability ?? control.netProbability}
            onChange={(v) => updateLink(link.id, { netProbability: v })}
            type="probability"
            disabled={!canEditNetScores}
          />
        </div>
        <div>
          <label className="text-xs text-text-muted block mb-1">Net Impact</label>
          <ScoreDropdown
            value={link.netImpact ?? control.netImpact}
            onChange={(v) => updateLink(link.id, { netImpact: v })}
            type="impact"
            disabled={!canEditNetScores}
          />
        </div>
        <div>
          <label className="text-xs text-text-muted block mb-1">Net Score</label>
          <HeatmapCell score={link.netScore ?? control.netScore} />
        </div>
      </div>
    </div>
  )
})}
```

### Expand Icon in Table Pattern
```typescript
// Modify ControlsTable.tsx name column (around line 53)
// Add visual indicator that clicking opens panel

{
  accessorKey: 'name',
  header: 'Control Name',
  cell: ({ row }) => (
    <button
      onClick={() => onControlClick(row.original.id)}
      className="flex items-center gap-2 text-left text-accent-400 hover:underline group"
    >
      <span>{row.original.name}</span>
      <PanelRight size={14} className="text-text-muted opacity-0 group-hover:opacity-100 transition-opacity" />
    </button>
  ),
},
```

### Multi-Link Badge Pattern
```typescript
// Add to ControlPanel.tsx control card (around line 273)
// Show badge when control is linked to multiple risks

const { getLinksForControl } = useControlsStore()

// Inside control card render:
<div className="flex items-start justify-between gap-3 mb-3">
  <div className="flex-1">
    <div className="flex items-center gap-2">
      <label className="text-text-muted text-xs">Control {index + 1}</label>
      {/* Multi-link badge */}
      {(() => {
        const linkCount = getLinksForControl(control.id).length
        return linkCount > 1 ? (
          <span className="px-1.5 py-0.5 text-xs bg-accent-500/20 text-accent-400 rounded">
            {linkCount} risks
          </span>
        ) : null
      })()}
    </div>
    {/* ... rest of control card */}
  </div>
</div>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Single control scores only | Per-link score overrides | Phase 13 (data layer) | Phase 13.1 exposes in UI |
| Controls embedded in rows | First-class controls with links | Phase 13 | Enables many-to-many linking |

**Already implemented (Phase 13):**
- ControlLink type with per-link score fields
- controlsStore.updateLink() action
- controlsStore.getLinksForControl() query
- calculateNetScoreFromLinks() function in rctStore

**Needs UI exposure (Phase 13.1):**
- Per-link score editing UI
- Link existing control from RCT
- Visual indicators (expand icon, multi-link badge)
- Risk ID in link dialog

## Data Model (No Changes Needed)

The existing ControlLink interface already supports all requirements:

```typescript
// src/types/rct.ts - NO CHANGES NEEDED
interface ControlLink {
  id: string
  controlId: string
  rowId: string
  netProbability?: number | null  // Already exists for per-link override
  netImpact?: number | null       // Already exists for per-link override
  netScore?: number | null        // Already computed from above
  createdAt: string
}
```

The existing controlsStore actions already support all requirements:

```typescript
// src/stores/controlsStore.ts - NO CHANGES NEEDED
linkControl: (controlId: string, rowId: string) => string
updateLink: (linkId: string, updates: Partial<ControlLink>) => void
getLinksForControl: (controlId: string) => ControlLink[]
```

## Files to Modify

### Modified Files
| File | Changes |
|------|---------|
| `src/components/controls/ControlsTable.tsx` | Add expand icon (PanelRight) to name column |
| `src/components/controls/ControlDetailPanel.tsx` | Add per-link score editing, show risk ID in linked risks list |
| `src/components/rct/ControlPanel.tsx` | Add "Link Existing" button, add multi-link badge, create LinkExistingDialog |

### New Files (Optional)
| File | Purpose |
|------|---------|
| `src/components/rct/LinkExistingDialog.tsx` | Could extract link dialog as separate component (or keep inline in ControlPanel) |

## Open Questions

Things that couldn't be fully resolved:

1. **Override indicator UI**
   - What we know: When per-link scores differ from control's base scores, user should know
   - What's unclear: How to visually indicate "this is an override, not the default"
   - Recommendation: Show control's base scores in lighter text below override, or use tooltip

2. **Risk ID format**
   - What we know: User wants to see risk ID in link dialog
   - What's unclear: Which ID (riskId vs riskL1Id vs generated row ID)
   - Recommendation: Use riskId from RCTRow - it's the most specific identifier

3. **Clear override action**
   - What we know: User can set per-link overrides
   - What's unclear: Should there be a "reset to control default" button?
   - Recommendation: Yes - add small "x" button to clear link-specific scores and revert to control's scores

## Sources

### Primary (HIGH confidence)
- `src/stores/controlsStore.ts` - Existing store with all needed actions
- `src/types/rct.ts` - ControlLink type with per-link score fields
- `src/components/controls/ControlDetailPanel.tsx` - Existing link dialog pattern
- `src/components/controls/ControlsTable.tsx` - Table component to modify
- `src/components/rct/ControlPanel.tsx` - Panel to add link existing option
- `.planning/phases/13-controls-hub/13-04-SUMMARY.md` - User requirements from verification

### Secondary (MEDIUM confidence)
- Lucide-react icon library - icons like PanelRight, ExternalLink, Link2
- `src/components/rct/ScoreDropdown.tsx` - Reusable score selection component

### Tertiary (LOW confidence)
- None - all research based on existing codebase patterns

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in use
- Architecture: HIGH - No data model changes, pure UI
- Implementation patterns: HIGH - Existing component patterns to follow
- Pitfalls: MEDIUM - Based on common UX issues, not app-tested

**Research date:** 2026-01-22
**Valid until:** 90 days (stable architecture, no external dependencies)
