---
phase: 14-delta-scores
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/sunburstStore.ts
  - src/components/sunburst/useSunburstData.ts
  - src/utils/deltaColors.ts
autonomous: true

must_haves:
  truths:
    - "Delta values are correctly calculated (gross-net, score-appetite)"
    - "View mode state persists across sessions"
    - "Parent nodes aggregate delta values from children"
  artifacts:
    - path: "src/stores/sunburstStore.ts"
      provides: "Extended view mode state with 4 options"
      contains: "viewMode"
    - path: "src/components/sunburst/useSunburstData.ts"
      provides: "Delta calculation logic for all view modes"
      contains: "calculateDeltaScore"
    - path: "src/utils/deltaColors.ts"
      provides: "Dynamic color scale based on max observed delta"
      exports: ["getDeltaColor", "buildDeltaGradient"]
  key_links:
    - from: "src/components/sunburst/useSunburstData.ts"
      to: "src/stores/sunburstStore.ts"
      via: "viewMode state consumption"
      pattern: "viewMode"
---

<objective>
Implement core delta calculation infrastructure for Sunburst view modes.

Purpose: Enable the Sunburst chart to display four different score perspectives (Net, Gross, Gross-Net Delta, vs Appetite Delta) by extending the store and data hook with delta calculation logic.

Output: Extended sunburstStore with viewMode, updated useSunburstData hook with delta calculations, and new deltaColors utility for dynamic color scaling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-delta-scores/14-CONTEXT.md
@src/stores/sunburstStore.ts
@src/components/sunburst/useSunburstData.ts
@src/utils/heatmapColors.ts
@src/types/rct.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend sunburstStore with viewMode</name>
  <files>src/stores/sunburstStore.ts</files>
  <action>
Replace the existing `scoreType: 'gross' | 'net'` state with a new `viewMode` state that supports four options:

1. Add new type: `type ViewMode = 'net' | 'gross' | 'delta-gross-net' | 'delta-vs-appetite'`

2. Replace `scoreType` with `viewMode: ViewMode` (default: 'net')

3. Replace `setScoreType` action with `setViewMode: (mode: ViewMode) => void`

4. Update the partialize function to persist `viewMode` instead of `scoreType`

5. Export the ViewMode type for use by other components

The store should maintain backwards compatibility with the existing behavior - 'net' and 'gross' modes should work exactly as before.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>sunburstStore has viewMode with 4 options, setViewMode action, and ViewMode type exported</done>
</task>

<task type="auto">
  <name>Task 2: Create deltaColors utility</name>
  <files>src/utils/deltaColors.ts</files>
  <action>
Create a new utility file for dynamic delta color scaling:

1. `getDeltaColor(delta: number, maxDelta: number): string`
   - Takes a delta value and the maximum observed delta
   - Returns interpolated color from green (0) to red (maxDelta)
   - Use same color stops as heatmap but scale dynamically:
     - 0% of maxDelta = green (rgb(34, 197, 94))
     - 50% of maxDelta = yellow/orange (rgb(249, 115, 22))
     - 100% of maxDelta = red (rgb(239, 68, 68))
   - Handle negative deltas (for vs-appetite where positive is good): invert scale

2. `buildDeltaGradient(maxDelta: number, direction: 'to right' | 'to top'): string`
   - Builds CSS gradient string for legend display
   - Shows actual max delta value instead of fixed 25

3. Export `NO_DATA_COLOR = '#4a5568'` (same gray as SunburstChart.tsx)

4. `getDeltaColorMode(viewMode: ViewMode): 'positive-bad' | 'positive-good' | 'absolute'`
   - Returns color mode based on view:
     - 'delta-gross-net': 'positive-bad' (higher delta = more risk reduction needed)
     - 'delta-vs-appetite': 'positive-good' (positive = within appetite, good)
     - Others: 'absolute' (use standard heatmap)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>deltaColors.ts exports getDeltaColor, buildDeltaGradient, getDeltaColorMode, NO_DATA_COLOR</done>
</task>

<task type="auto">
  <name>Task 3: Update useSunburstData for delta calculations</name>
  <files>src/components/sunburst/useSunburstData.ts</files>
  <action>
Extend the useSunburstData hook to calculate delta values for all four view modes:

1. Update imports to use `viewMode` instead of `scoreType` from sunburstStore

2. Extend SunburstNode interface:
   - Add `grossValue: number | null` (always calculated)
   - Add `netValue: number | null` (always calculated)
   - Add `appetiteValue: number | null` (risk appetite threshold)
   - Keep existing `value: number | null` (the displayed value based on viewMode)
   - Add `missingDataReason: string | null` (e.g., "No gross score", "No appetite set", "No net score")

3. Update `calculateLeafScore` to return an object with all score types:
   ```typescript
   interface LeafScores {
     gross: number | null
     net: number | null
     appetite: number | null
     missingDataReason: string | null
   }
   ```
   - gross: grossScore from matching RCT rows
   - net: netScore from matching RCT rows (minimum of control net scores)
   - appetite: riskAppetite from matching RCT rows (use minimum if multiple)

4. Create `calculateDisplayValue(scores: LeafScores, viewMode: ViewMode): number | null`
   - 'net': return scores.net
   - 'gross': return scores.gross
   - 'delta-gross-net': return (scores.gross !== null && scores.net !== null) ? scores.gross - scores.net : null
   - 'delta-vs-appetite': return (scores.gross !== null && scores.appetite !== null) ? scores.gross - scores.appetite : null

5. Create `getMissingDataReason(scores: LeafScores, viewMode: ViewMode): string | null`
   - Returns human-readable explanation when value is null
   - 'delta-gross-net' with missing net: "No net score (no controls)"
   - 'delta-gross-net' with missing gross: "No gross score assessed"
   - 'delta-vs-appetite' with missing appetite: "No risk appetite set"

6. Update `transformTaxonomyItem` to populate all score fields on SunburstNode

7. Update parent aggregation in `eachAfter`:
   - Aggregate grossValue, netValue separately
   - Calculate displayed value after aggregation based on viewMode
   - Propagate missingDataReason up (null if any child has data)

8. Add `maxDelta` calculation to returned data:
   - After hierarchy is built, traverse to find maximum absolute delta value
   - Return as part of hook result: `{ hierarchyData, maxDelta }`
   - maxDelta is needed for dynamic color scaling
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>useSunburstData calculates all four view modes with delta values and maxDelta for color scaling</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (no TypeScript errors)
- sunburstStore exports ViewMode type and has viewMode state
- useSunburstData returns hierarchyData with grossValue, netValue, value, missingDataReason
- deltaColors.ts exports all required functions
</verification>

<success_criteria>
- View mode state supports 4 options: net, gross, delta-gross-net, delta-vs-appetite
- Delta calculations are correct: gross-net shows control effectiveness, vs-appetite shows distance from threshold
- Missing data scenarios have explanatory reasons
- maxDelta is computed for dynamic color scaling
- All existing behavior preserved for net/gross modes
</success_criteria>

<output>
After completion, create `.planning/phases/14-delta-scores/14-01-SUMMARY.md`
</output>
