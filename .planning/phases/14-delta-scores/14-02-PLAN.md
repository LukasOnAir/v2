---
phase: 14-delta-scores
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/sunburst/SunburstControls.tsx
  - src/components/sunburst/SunburstChart.tsx
  - src/components/sunburst/SunburstLegend.tsx
  - src/components/sunburst/SunburstTooltip.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between all four view modes via toolbar"
    - "Chart colors update based on selected view mode"
    - "Legend shows dynamic scale for delta views"
    - "Gray segments display tooltip explaining why data is missing"
  artifacts:
    - path: "src/components/sunburst/SunburstControls.tsx"
      provides: "Four-option view mode toggle"
      contains: "viewMode"
    - path: "src/components/sunburst/SunburstChart.tsx"
      provides: "Dynamic coloring based on view mode"
      contains: "getDeltaColor"
    - path: "src/components/sunburst/SunburstLegend.tsx"
      provides: "Dynamic legend for delta views"
      contains: "maxDelta"
    - path: "src/components/sunburst/SunburstTooltip.tsx"
      provides: "Missing data explanation in tooltip"
      contains: "missingDataReason"
  key_links:
    - from: "src/components/sunburst/SunburstChart.tsx"
      to: "src/utils/deltaColors.ts"
      via: "color calculation"
      pattern: "getDeltaColor"
    - from: "src/components/sunburst/SunburstControls.tsx"
      to: "src/stores/sunburstStore.ts"
      via: "viewMode state"
      pattern: "setViewMode"
---

<objective>
Update Sunburst UI components to support the four view modes with dynamic coloring and informative tooltips.

Purpose: Enable users to toggle between view modes and see meaningful visualizations with appropriate color scales and explanations for missing data.

Output: Updated SunburstControls, SunburstChart, SunburstLegend, and SunburstTooltip components with full delta view support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-delta-scores/14-CONTEXT.md
@.planning/phases/14-delta-scores/14-01-SUMMARY.md
@src/components/sunburst/SunburstControls.tsx
@src/components/sunburst/SunburstChart.tsx
@src/components/sunburst/SunburstLegend.tsx
@src/components/sunburst/SunburstTooltip.tsx
@src/utils/deltaColors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SunburstControls with four-option view toggle</name>
  <files>src/components/sunburst/SunburstControls.tsx</files>
  <action>
Replace the existing two-button "Score" toggle (Gross/Net) with a four-option "View" toggle:

1. Import `ViewMode` type from sunburstStore

2. Update store destructuring: replace `scoreType, setScoreType` with `viewMode, setViewMode`

3. Replace the "Score" section with a new "View" section using a button group:
   - Net Score (value: 'net') - default, current behavior
   - Gross Score (value: 'gross') - current behavior
   - Delta (G-N) (value: 'delta-gross-net') - control effectiveness
   - Delta (vs App) (value: 'delta-vs-appetite') - distance from appetite

4. Use the same button group styling pattern as other toggles (View, Aggregation):
   - Active: `bg-accent-500/20 text-accent-500 border-accent-500`
   - Inactive: `bg-surface-overlay text-text-secondary hover:bg-surface-border`
   - Use `rounded-l` on first, `rounded-r` on last, `border-l-0` on middle buttons

5. Add Info icon with tooltip explaining delta views:
   - "Delta (G-N): Shows control effectiveness (Gross minus Net score)"
   - "Delta (vs App): Shows distance from risk appetite threshold"

6. Update the export options to include viewMode instead of scoreType in filters
  </action>
  <verify>Run dev server and verify toolbar shows 4 view options: `npm run dev`</verify>
  <done>SunburstControls has four-option view toggle with Net, Gross, Delta (G-N), Delta (vs App)</done>
</task>

<task type="auto">
  <name>Task 2: Update SunburstChart with dynamic coloring</name>
  <files>src/components/sunburst/SunburstChart.tsx</files>
  <action>
Update the chart to use dynamic coloring for delta views and show gray for missing data:

1. Import `getDeltaColor, getDeltaColorMode, NO_DATA_COLOR` from '@/utils/deltaColors'

2. Update `useSunburstData` consumption to destructure `{ hierarchyData, maxDelta }`

3. Get `viewMode` from sunburstStore (replace scoreType if still used)

4. Update `getNodeColor` function:
   ```typescript
   const getNodeColor = useCallback((node: HierarchyRectangularNode<SunburstNode>): string => {
     if (node.data.value === null) return NO_DATA_COLOR

     const colorMode = getDeltaColorMode(viewMode)
     if (colorMode === 'absolute') {
       return getHeatmapColor(node.data.value)
     }

     return getDeltaColor(node.data.value, maxDelta, colorMode)
   }, [viewMode, maxDelta])
   ```

5. Update center circle coloring:
   - Use same logic as getNodeColor for center background
   - Show "No Data" text if value is null

6. Update SunburstTooltip props:
   - Pass `missingDataReason` from node.data
   - Pass `viewMode` for context-aware display
  </action>
  <verify>Run dev server and switch between views - colors should change appropriately</verify>
  <done>SunburstChart uses dynamic colors for delta views and NO_DATA_COLOR for missing data</done>
</task>

<task type="auto">
  <name>Task 3: Update SunburstLegend for dynamic delta scales</name>
  <files>src/components/sunburst/SunburstLegend.tsx</files>
  <action>
Update the legend to show dynamic scale when in delta view modes:

1. Accept new props:
   ```typescript
   interface SunburstLegendProps {
     inline?: boolean
     viewMode?: ViewMode  // From sunburstStore
     maxDelta?: number    // Maximum observed delta for scale
   }
   ```

2. Import `buildDeltaGradient` from '@/utils/deltaColors'

3. Conditionally render based on viewMode:
   - 'net' or 'gross': Use existing fixed heatmap gradient (Low 1 - High 25)
   - 'delta-gross-net': Dynamic gradient showing "0 - {maxDelta}" with label "Control Effectiveness"
   - 'delta-vs-appetite': Dynamic gradient showing "Within - {maxDelta} Over" with appropriate colors

4. For delta views with maxDelta = 0 or undefined, show "No delta data" message

5. Update gradient labels:
   - For delta-gross-net: "Low (0)" to "High ({maxDelta})" - higher means more reduction achieved
   - For delta-vs-appetite: "Within (0)" to "Over ({maxDelta})" - 0 is good, higher is bad

6. Update inline export rendering to match the dynamic legend
  </action>
  <verify>Switch to delta views and verify legend updates with correct scale</verify>
  <done>SunburstLegend shows dynamic scale for delta views with actual maxDelta value</done>
</task>

<task type="auto">
  <name>Task 4: Update SunburstTooltip with missing data explanations</name>
  <files>src/components/sunburst/SunburstTooltip.tsx</files>
  <action>
Enhance the tooltip to explain why data is missing for gray segments:

1. Add new props:
   ```typescript
   interface SunburstTooltipProps {
     // ... existing props
     viewMode?: ViewMode
     missingDataReason?: string | null
     grossValue?: number | null
     netValue?: number | null
   }
   ```

2. Update score display based on viewMode:
   - 'net': "Net Score: {value}"
   - 'gross': "Gross Score: {value}"
   - 'delta-gross-net': "Delta (Gross-Net): {value}" with sub-text "(Gross: {grossValue}, Net: {netValue})"
   - 'delta-vs-appetite': "Delta (vs Appetite): {value}"

3. When score is null (gray segment), show explanation:
   ```tsx
   {score === null && missingDataReason && (
     <div className="text-xs text-amber-500 mt-1">
       {missingDataReason}
     </div>
   )}
   ```

4. Example missing data explanations (from useSunburstData):
   - "No gross score assessed"
   - "No net score (no controls)"
   - "No risk appetite set"
   - "Incomplete data for delta calculation"

5. Maintain existing tooltip positioning and styling
  </action>
  <verify>Hover over gray segments and verify tooltip shows explanation</verify>
  <done>SunburstTooltip explains why segments are gray with specific missing data reasons</done>
</task>

</tasks>

<verification>
- `npm run dev` starts without errors
- View toggle shows all four options
- Selecting each view updates chart colors appropriately
- Delta views show dynamic color scale (not fixed 1-25)
- Gray segments appear for missing data
- Hovering gray segments shows explanation tooltip
- Legend updates to show correct scale for current view
</verification>

<success_criteria>
- User can toggle between Net Score, Gross Score, Delta (Gross-Net), Delta (vs Appetite)
- Chart colors update immediately on view change
- Delta views use dynamic color scale based on max observed delta
- Gray segments are visually distinct but not distracting
- Tooltip provides clear explanation for missing data
- Legend accurately reflects current view's scale
</success_criteria>

<output>
After completion, create `.planning/phases/14-delta-scores/14-02-SUMMARY.md`
</output>
