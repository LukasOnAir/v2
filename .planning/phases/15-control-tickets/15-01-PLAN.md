---
phase: 15-control-tickets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/tickets.ts
  - src/types/audit.ts
  - src/stores/ticketsStore.ts
autonomous: true

must_haves:
  truths:
    - "Ticket type exists with all required fields (title, category, status, priority, owner, deadline, recurrence)"
    - "TicketControlLink junction type enables many-to-many ticket-to-control relationships"
    - "ticketsStore provides CRUD operations for tickets and links"
    - "Auto-archive logic moves done tickets to archive after configured period"
    - "Recurrence processing creates new tickets when recurring tickets complete"
  artifacts:
    - path: "src/types/tickets.ts"
      provides: "Ticket, TicketStatus, TicketCategory, TicketPriority, TicketRecurrence, TicketControlLink types"
      exports: ["Ticket", "TicketStatus", "TicketCategory", "TicketPriority", "RecurrenceInterval", "TicketRecurrence", "TicketControlLink"]
    - path: "src/stores/ticketsStore.ts"
      provides: "Ticket state management with CRUD, links, queries, recurrence"
      exports: ["useTicketsStore"]
  key_links:
    - from: "src/stores/ticketsStore.ts"
      to: "src/types/tickets.ts"
      via: "type imports"
      pattern: "import.*from.*types/tickets"
    - from: "src/stores/ticketsStore.ts"
      to: "src/stores/auditStore.ts"
      via: "audit logging"
      pattern: "useAuditStore"
---

<objective>
Create the ticket data infrastructure: types for tickets with status/priority/category/recurrence and a Zustand store following the controlsStore pattern.

Purpose: Establish the data layer for control maintenance tickets with many-to-many control relationships and automatic recurrence handling.
Output: Ticket types and fully functional ticketsStore with persistence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-control-tickets/15-CONTEXT.md
@.planning/phases/15-control-tickets/15-RESEARCH.md

# Reference patterns
@src/stores/controlsStore.ts (store pattern with links, CRUD, audit)
@src/types/rct.ts (RemediationPlan type for priority/status patterns)
@src/types/audit.ts (EntityType for audit integration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ticket types</name>
  <files>src/types/tickets.ts, src/types/audit.ts</files>
  <action>
Create src/types/tickets.ts with:

1. TicketStatus type: 'todo' | 'in-progress' | 'review' | 'done'
2. TicketCategory type: 'maintenance' | 'periodic-review' | 'update-change' | 'other'
3. TicketPriority type: 'critical' | 'high' | 'medium' | 'low' (matches RemediationPlan)
4. RecurrenceInterval type: 'monthly' | 'quarterly' | 'annually' | 'custom'
5. TicketRecurrence interface:
   - interval: RecurrenceInterval
   - customDays?: number (for 'custom' interval)
   - nextDue: string (ISO date string)
6. Ticket interface:
   - id: string
   - title: string
   - description?: string
   - category: TicketCategory
   - status: TicketStatus
   - priority: TicketPriority
   - owner: string
   - deadline: string (ISO date yyyy-MM-dd)
   - recurrence?: TicketRecurrence
   - createdDate: string
   - doneDate?: string (when status changed to done)
   - archived: boolean
   - notes?: string
7. TicketControlLink interface:
   - id: string
   - ticketId: string
   - controlId: string
   - createdAt: string

Also update src/types/audit.ts to add 'ticket' and 'ticketControlLink' to EntityType union.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>All ticket types exported and audit EntityType includes ticket types</done>
</task>

<task type="auto">
  <name>Task 2: Create ticketsStore with CRUD and links</name>
  <files>src/stores/ticketsStore.ts</files>
  <action>
Create src/stores/ticketsStore.ts following controlsStore pattern:

1. Interface TicketsState with:
   - tickets: Ticket[]
   - ticketControlLinks: TicketControlLink[]
   - archivedTickets: Ticket[] (separate storage for archived)
   - archiveDaysAfterDone: number (default 7)

2. CRUD actions:
   - createTicket(ticket: Omit<Ticket, 'id' | 'createdDate' | 'archived'>) => string
   - updateTicket(ticketId: string, updates: Partial<Ticket>) => void
   - updateTicketStatus(ticketId: string, status: TicketStatus) => void
     - Set doneDate when status becomes 'done'
     - Trigger recurrence processing for recurring tickets
   - deleteTicket(ticketId: string) => void (also removes links)

3. Link actions:
   - linkTicketToControl(ticketId: string, controlId: string) => string
   - unlinkTicketFromControl(ticketId: string, controlId: string) => void
   - getControlIdsForTicket(ticketId: string) => string[]
   - getTicketsForControl(controlId: string) => Ticket[]

4. Query getters:
   - getActiveTickets() => tickets.filter(t => !t.archived)
   - getOverdueTickets() => active tickets with deadline < today and status !== 'done'
   - getUpcomingTickets(days: number) => active tickets with deadline within N days

5. Recurrence processing:
   - processRecurringTicket(ticket: Ticket) => creates new ticket with next deadline
   - Call in updateTicketStatus when status becomes 'done' and ticket has recurrence

6. Archive management:
   - archiveEligibleTickets() => move done tickets older than archiveDaysAfterDone to archivedTickets
   - Call on store initialization or periodically

7. Audit logging:
   - Log create/update/delete for tickets and ticketControlLinks
   - Use useAuditStore.getState().addEntry pattern from controlsStore
   - Track fields: title, category, status, priority, owner, deadline

Use persist middleware with name 'riskguard-tickets'.
Use immer for immutable updates.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Store can be imported: create test file that imports and logs store methods
  </verify>
  <done>
- ticketsStore exports useTicketsStore hook
- All CRUD operations work
- Link operations work
- Recurrence creates new ticket when done
- Audit entries created for changes
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Ticket types properly defined with all fields
- ticketsStore has all CRUD, link, and query methods
- Audit logging integrated
</verification>

<success_criteria>
- types/tickets.ts exports all ticket types
- types/audit.ts includes 'ticket' and 'ticketControlLink' in EntityType
- stores/ticketsStore.ts exports useTicketsStore
- Store persists to localStorage as 'riskguard-tickets'
- Recurrence processing generates new tickets
- Archive management separates done tickets
</success_criteria>

<output>
After completion, create `.planning/phases/15-control-tickets/15-01-SUMMARY.md`
</output>
