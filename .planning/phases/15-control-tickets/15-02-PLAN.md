---
phase: 15-control-tickets
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/tickets/KanbanBoard.tsx
  - src/components/tickets/KanbanColumn.tsx
  - src/components/tickets/TicketCard.tsx
  - src/components/tickets/TicketForm.tsx
  - src/components/tickets/TicketFilters.tsx
  - src/components/tickets/index.ts
autonomous: true

must_haves:
  truths:
    - "Kanban board displays 4 columns (To Do, In Progress, Review, Done)"
    - "Tickets can be dragged between columns to change status"
    - "Overdue tickets show red border"
    - "User can create/edit tickets via modal form"
    - "User can filter tickets by category, priority, and search"
  artifacts:
    - path: "src/components/tickets/KanbanBoard.tsx"
      provides: "Drag-and-drop Kanban board with DndContext"
      exports: ["KanbanBoard"]
    - path: "src/components/tickets/KanbanColumn.tsx"
      provides: "Single status column with droppable area"
      exports: ["KanbanColumn"]
    - path: "src/components/tickets/TicketCard.tsx"
      provides: "Draggable ticket card with priority badge and deadline"
      exports: ["TicketCard"]
    - path: "src/components/tickets/TicketForm.tsx"
      provides: "Create/edit ticket modal with all fields"
      exports: ["TicketForm"]
  key_links:
    - from: "src/components/tickets/KanbanBoard.tsx"
      to: "src/stores/ticketsStore.ts"
      via: "useTicketsStore for status updates"
      pattern: "useTicketsStore"
    - from: "src/components/tickets/KanbanBoard.tsx"
      to: "@dnd-kit/core"
      via: "DndContext, DragOverlay, closestCorners"
      pattern: "DndContext"
    - from: "src/components/tickets/KanbanColumn.tsx"
      to: "@dnd-kit/core"
      via: "useDroppable for drop targets"
      pattern: "useDroppable"
    - from: "src/components/tickets/TicketCard.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable for draggable items"
      pattern: "useSortable"
---

<objective>
Build the Kanban board UI with drag-and-drop functionality using @dnd-kit. Users drag tickets between status columns to change status.

Purpose: Provide visual task management with intuitive drag-and-drop workflow.
Output: Functional Kanban board with ticket cards, forms, and filters.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-control-tickets/15-CONTEXT.md
@.planning/phases/15-control-tickets/15-RESEARCH.md

# Reference patterns
@src/components/rct/ColumnManager.tsx (existing @dnd-kit usage)
@src/components/remediation/RemediationSummary.tsx (status/priority badge styles)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KanbanBoard with drag-and-drop context</name>
  <files>src/components/tickets/KanbanBoard.tsx, src/components/tickets/KanbanColumn.tsx, src/components/tickets/TicketCard.tsx</files>
  <action>
Create src/components/tickets/KanbanBoard.tsx:

1. Import from @dnd-kit/core: DndContext, DragOverlay, closestCorners, PointerSensor, useSensor, useSensors
2. Import from @dnd-kit/sortable: SortableContext, verticalListSortingStrategy
3. State: activeTicket (Ticket | null) for DragOverlay
4. Sensors: PointerSensor with activationConstraint: { distance: 8 }
5. Filter tickets by status into 4 arrays (todo, in-progress, review, done)
6. Render 4 KanbanColumn components in flex row with gap-4, overflow-x-auto
7. handleDragStart: set activeTicket from event.active.id
8. handleDragEnd:
   - Extract ticketId from active, targetStatus from over.id
   - Call updateTicketStatus(ticketId, targetStatus)
   - Clear activeTicket
9. DragOverlay renders TicketCard with isDragging=true when activeTicket exists
10. Accept filters prop: { categories: TicketCategory[], priorities: TicketPriority[], searchQuery: string }
11. Apply filters before grouping by status

Create src/components/tickets/KanbanColumn.tsx:

1. Props: status: TicketStatus, tickets: Ticket[], onEditTicket: (ticket) => void
2. Use useDroppable({ id: status }) for drop target
3. Column styling: w-72 bg-surface-elevated rounded-lg p-3, ring-2 ring-accent-500 when isOver
4. Header: status label with count, e.g., "To Do (5)"
5. SortableContext with tickets.map(t => t.id) and verticalListSortingStrategy
6. Map tickets to TicketCard components
7. min-h-[100px] for empty column drop target

Status labels map:
- 'todo' -> 'To Do'
- 'in-progress' -> 'In Progress'
- 'review' -> 'Review'
- 'done' -> 'Done'

Create src/components/tickets/TicketCard.tsx:

1. Props: ticket: Ticket, isDragging?: boolean, onClick?: () => void
2. Use useSortable({ id: ticket.id }) for drag handle
3. Apply CSS.Transform.toString(transform) and transition from useSortable
4. Calculate isOverdue: isBefore(parseISO(ticket.deadline), startOfDay(new Date())) && ticket.status !== 'done'
5. Card styling:
   - p-3 bg-surface-overlay rounded-lg border cursor-grab active:cursor-grabbing
   - opacity-50 when isDragging
   - border-red-500 when isOverdue, else border-surface-border
6. Content:
   - Title (truncate, font-medium)
   - Category badge (small, muted)
   - Priority badge (colored per priority)
   - Owner name (text-xs text-text-muted)
   - Deadline (format: "Due: MMM d")
   - Controls count badge if linked to multiple controls
7. onClick triggers edit mode

Badge styles (match RemediationSummary):
- priority: critical=red, high=orange, medium=amber, low=green
- category: maintenance=cyan, periodic-review=violet, update-change=emerald, other=gray
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Components can be imported without error
  </verify>
  <done>
- KanbanBoard renders 4 columns with drag-and-drop
- Tickets can be dragged between columns
- Status updates on drop
- Overdue tickets have red border
- DragOverlay shows ticket being dragged
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TicketForm modal and TicketFilters</name>
  <files>src/components/tickets/TicketForm.tsx, src/components/tickets/TicketFilters.tsx, src/components/tickets/index.ts</files>
  <action>
Create src/components/tickets/TicketForm.tsx:

1. Props:
   - isOpen: boolean
   - onClose: () => void
   - ticket?: Ticket (for edit mode, undefined for create)
   - preselectedControlId?: string (when creating from control context)
2. Use Radix Dialog (Dialog.Root, Dialog.Portal, Dialog.Overlay, Dialog.Content)
3. Form fields:
   - title (required text input)
   - description (optional textarea)
   - category (select with 4 options)
   - priority (select with 4 options)
   - owner (text input)
   - deadline (date input)
   - recurrence (optional select: none, monthly, quarterly, annually, custom)
   - customDays (number input, shown only when recurrence is 'custom')
   - notes (optional textarea)
4. Control linking:
   - Show list of linked controls with remove button
   - "Add Control" button opens control selector (simple select from useControlsStore.controls)
5. Submit handler:
   - Create mode: createTicket() + linkTicketToControl for each control
   - Edit mode: updateTicket()
6. Delete button in edit mode (with confirmation)
7. Dialog styling matches existing modals (dark theme, rounded-lg, p-6)

Create src/components/tickets/TicketFilters.tsx:

1. Props:
   - filters: { categories: TicketCategory[], priorities: TicketPriority[], searchQuery: string }
   - onFiltersChange: (filters) => void
2. Search input with magnifying glass icon
3. Category filter chips (toggle on/off, all selected = show all)
4. Priority filter chips (toggle on/off)
5. "Clear filters" button when any filter is active
6. Horizontal layout with flex-wrap

Create src/components/tickets/index.ts:
Export all components: KanbanBoard, KanbanColumn, TicketCard, TicketForm, TicketFilters
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- All components export from index.ts
  </verify>
  <done>
- TicketForm creates and edits tickets
- TicketForm supports control linking
- TicketForm handles recurrence configuration
- TicketFilters provides category, priority, and search filtering
- All components exported from index.ts
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- KanbanBoard renders with 4 columns
- Drag-and-drop changes ticket status
- TicketForm creates/edits tickets with all fields
- Filters work correctly
</verification>

<success_criteria>
- Kanban board displays 4 status columns
- Tickets draggable between columns with visual feedback
- Overdue tickets highlighted with red border
- Create/edit modal with all fields including recurrence
- Filter by category, priority, and search text
</success_criteria>

<output>
After completion, create `.planning/phases/15-control-tickets/15-02-SUMMARY.md`
</output>
