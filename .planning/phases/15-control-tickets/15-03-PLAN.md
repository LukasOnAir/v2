---
phase: 15-control-tickets
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/tickets/TicketsSection.tsx
  - src/components/tickets/ControlTicketIndicator.tsx
  - src/components/rct/ControlPanel.tsx
  - src/components/controls/ControlsTable.tsx
  - src/components/tickets/index.ts
  - src/stores/controlsStore.ts
autonomous: true

must_haves:
  truths:
    - "ControlPanel shows TicketsSection with tickets linked to that control"
    - "TicketsSection is collapsible like other sections in ControlPanel"
    - "User can create ticket directly from control context"
    - "Controls Hub table shows ticket indicator badge per control"
    - "Ticket indicator shows count and color (red=overdue, amber=high priority, green=normal)"
  artifacts:
    - path: "src/components/tickets/TicketsSection.tsx"
      provides: "Collapsible tickets section for ControlPanel"
      exports: ["TicketsSection"]
    - path: "src/components/tickets/ControlTicketIndicator.tsx"
      provides: "Badge showing ticket count and status color"
      exports: ["ControlTicketIndicator"]
  key_links:
    - from: "src/components/tickets/TicketsSection.tsx"
      to: "src/stores/ticketsStore.ts"
      via: "getTicketsForControl"
      pattern: "useTicketsStore.*getTicketsForControl"
    - from: "src/components/rct/ControlPanel.tsx"
      to: "src/components/tickets/TicketsSection.tsx"
      via: "component import"
      pattern: "TicketsSection"
    - from: "src/components/controls/ControlsTable.tsx"
      to: "src/components/tickets/ControlTicketIndicator.tsx"
      via: "component import"
      pattern: "ControlTicketIndicator"
---

<objective>
Integrate tickets into control workflows: TicketsSection in ControlPanel for control-specific tickets, and ControlTicketIndicator in Controls Hub table.

Purpose: Make tickets accessible from control context and provide visual indication of ticket status on controls.
Output: Control-integrated ticket UI components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-control-tickets/15-CONTEXT.md
@.planning/phases/15-control-tickets/15-RESEARCH.md

# Reference patterns
@src/components/rct/ControlTestSection.tsx (collapsible section pattern)
@src/components/rct/RemediationSection.tsx (section in ControlPanel)
@src/components/rct/ControlPanel.tsx (target for integration)
@src/components/controls/ControlsTable.tsx (target for indicator)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TicketsSection and ControlTicketIndicator</name>
  <files>src/components/tickets/TicketsSection.tsx, src/components/tickets/ControlTicketIndicator.tsx</files>
  <action>
Create src/components/tickets/TicketsSection.tsx:

1. Props: controlId: string
2. State: isExpanded (default false), showForm (for create modal)
3. Get tickets for this control: useTicketsStore(s => s.getTicketsForControl(controlId))
4. Filter to active tickets: tickets.filter(t => !t.archived && t.status !== 'done')
5. Collapsible header (matches ControlTestSection pattern):
   - ChevronRight/ChevronDown icon based on isExpanded
   - Ticket icon (from lucide-react)
   - "Tickets" label
   - Active count badge: "(N active)"
   - Border top for section separation
6. Expanded content:
   - List of ticket cards (simplified: title, priority badge, deadline, status)
   - Each card clickable to open edit form
   - "Create Ticket" button at bottom
7. TicketForm modal for create/edit (pass controlId as preselectedControlId)
8. Handle ticket edit: open form with selected ticket

Create src/components/tickets/ControlTicketIndicator.tsx:

1. Props: controlId: string
2. Get tickets: useTicketsStore(s => s.getTicketsForControl(controlId))
3. Filter to active: tickets.filter(t => !t.archived && t.status !== 'done')
4. If no active tickets, return null
5. Determine color:
   - hasOverdue = any ticket with deadline < today
   - hasHighPriority = any ticket with priority 'critical' or 'high'
   - Red if hasOverdue, amber if hasHighPriority, green otherwise
6. Badge styling:
   - px-1.5 py-0.5 text-xs rounded
   - bg-red-500/20 text-red-400 for overdue
   - bg-amber-500/20 text-amber-400 for high priority
   - bg-green-500/20 text-green-400 for normal
7. Content: "{count} tickets" or "{count} ticket" for singular

Update src/components/tickets/index.ts to export TicketsSection and ControlTicketIndicator.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Components export correctly
  </verify>
  <done>
- TicketsSection shows tickets for a control with collapsible UI
- TicketsSection has create ticket button
- ControlTicketIndicator shows ticket count with color coding
- Components exported from index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate into ControlPanel and ControlsTable</name>
  <files>src/components/rct/ControlPanel.tsx, src/components/controls/ControlsTable.tsx, src/stores/controlsStore.ts</files>
  <action>
Update src/components/rct/ControlPanel.tsx:

1. Import TicketsSection from '@/components/tickets'
2. Add TicketsSection after RemediationSection (or after ControlTestSection if no remediation)
3. Pass controlId prop to TicketsSection
4. Ensure section order is logical: Testing -> Remediation -> Tickets -> Comments

Update src/components/controls/ControlsTable.tsx:

1. Import ControlTicketIndicator from '@/components/tickets'
2. Add ticket indicator column (or add to existing info column)
3. Position: after name column or near link count indicator
4. Render ControlTicketIndicator with controlId for each row

Update src/stores/controlsStore.ts:

1. In removeControl action, also remove ticketControlLinks for that control
2. Import useTicketsStore
3. After removing control, call:
   ```
   const ticketsStore = useTicketsStore.getState()
   const links = ticketsStore.ticketControlLinks.filter(l => l.controlId === controlId)
   for (const link of links) {
     ticketsStore.unlinkTicketFromControl(link.ticketId, controlId)
   }
   ```
   Note: This prevents orphaned ticket links when a control is deleted.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- App runs without errors: `npm run dev`
- ControlPanel shows Tickets section
- ControlsTable shows ticket indicators
  </verify>
  <done>
- ControlPanel displays TicketsSection for each control
- Controls Hub table shows ControlTicketIndicator per control
- Deleting a control removes its ticket links
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- ControlPanel has Tickets section below Remediation
- Controls Hub table has ticket count indicators
- Ticket indicators use correct colors (red/amber/green)
</verification>

<success_criteria>
- TicketsSection appears in ControlPanel with collapsible UI
- Create ticket from control context links ticket to that control
- ControlTicketIndicator shows in Controls Hub table
- Color coding: red=overdue, amber=high priority, green=normal
- Deleting control removes associated ticket links
</success_criteria>

<output>
After completion, create `.planning/phases/15-control-tickets/15-03-SUMMARY.md`
</output>
