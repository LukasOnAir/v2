# Plan: Fix Linked Items Persistence Bug

---
wave: 1
depends_on: []
files_modified:
  - src/components/tickets/TicketForm.tsx
  - src/stores/ticketsStore.ts
autonomous: true
---

## Objective

Fix the bug where linked items selected in a ticket are not persisted when saving, causing them to disappear when the ticket is reopened.

## Context

User reports:
1. Select a linked item in ticket form
2. Save the ticket
3. Reopen the same ticket
4. Linked item is not shown

After code analysis, potential causes:
- Race condition between ticket update and link creation
- Stale closure issue with `ticket` prop in handleSubmit
- Form state not being reset properly between opens
- Missing persistence of `ticketEntityLinks` array

## Tasks

<task id="1">
<title>Add debug logging to trace linked items flow</title>
<file>src/components/tickets/TicketForm.tsx</file>
<action>edit</action>
<description>
Add console.log statements in key locations to trace:
1. What `linkedEntities` state contains when form opens
2. What `currentLinks` contains from store when saving
3. What `toAdd` and `toRemove` contain during sync
4. Confirm links are being created/read correctly

This is temporary debugging to confirm the root cause.
</description>
</task>

<task id="2">
<title>Fix potential stale ticket ID reference in handleSubmit</title>
<file>src/components/tickets/TicketForm.tsx</file>
<action>edit</action>
<description>
In handleSubmit, the code uses `ticket.id` from the prop. However, `ticket` is from the component props which could be stale if the parent doesn't update.

Change to use a ref or ensure we're using the latest ticket ID:

```typescript
// Instead of using ticket directly from props, read fresh from state
const ticketId = ticket?.id
if (!ticketId) return

// Use ticketId throughout handleSubmit
```

This ensures we always have the correct ticket ID for link operations.
</description>
</task>

<task id="3">
<title>Ensure linkTicketToEntity completes before form closes</title>
<file>src/components/tickets/TicketForm.tsx</file>
<action>edit</action>
<description>
The issue may be that `onClose()` is called immediately after link operations without waiting. While Zustand is synchronous, we should ensure all operations complete in the correct order.

Move `onClose()` to the very end after all state mutations are confirmed.

Also add a small delay or use React's flushSync if needed to ensure localStorage persist completes.
</description>
</task>

<task id="4">
<title>Verify ticketEntityLinks is included in persist</title>
<file>src/stores/ticketsStore.ts</file>
<action>verify</action>
<description>
Confirm that `ticketEntityLinks` is being persisted to localStorage. The current persist configuration has no `partialize` function, so all state should be persisted. But verify:

1. Check if there's a merge function that might drop `ticketEntityLinks`
2. Add explicit logging in `onRehydrateStorage` to confirm links are restored
3. Check localStorage directly to see if links are being saved
</description>
</task>

<task id="5">
<title>Fix TicketsDashboard: separate showCreateForm and editingTicket logic</title>
<file>src/components/tickets/TicketsDashboard.tsx</file>
<action>edit</action>
<description>
Current issue: `handleEditTicket` sets `editingTicket` but doesn't set `showCreateForm`. The form opens due to `editingTicket !== null`, but the modal state might be inconsistent.

Refactor to use a single state variable for form mode:
```typescript
type FormMode = { type: 'closed' } | { type: 'create' } | { type: 'edit'; ticket: Ticket }
const [formMode, setFormMode] = useState<FormMode>({ type: 'closed' })
```

This ensures form state is always consistent.
</description>
</task>

<task id="6">
<title>Remove debug logging and verify fix</title>
<file>src/components/tickets/TicketForm.tsx</file>
<action>edit</action>
<description>
After identifying and fixing the root cause:
1. Remove all debug console.log statements
2. Test the complete flow:
   - Create ticket with linked item → verify persists
   - Edit ticket, add linked item → verify persists
   - Edit ticket, remove linked item → verify removal persists
3. Verify localStorage contains correct data after each operation
</description>
</task>

## Verification

After completion:
1. Create a new ticket with a linked control → Save → Reopen → Linked control appears
2. Edit existing ticket, add linked risk → Save → Reopen → Both links appear
3. Edit ticket, remove a link → Save → Reopen → Link is removed
4. Close browser, reopen → All ticket links persist correctly
5. Check localStorage `riskguard-tickets` contains `ticketEntityLinks` array

## must_haves

- [ ] Linked items persist correctly when creating a new ticket
- [ ] Linked items persist correctly when editing an existing ticket
- [ ] Reopening a ticket shows all previously linked items
- [ ] Linked items survive browser refresh (localStorage persistence)
