---
phase: 15.1-ticket-linked-items-fix
plan: 01
subsystem: ui
tags: [react, zustand, persist, tickets, forms]

# Dependency graph
requires:
  - phase: 15-control-tickets
    provides: Ticket form and store infrastructure
provides:
  - Fixed linked items persistence bug
  - Consistent form state management pattern (FormMode type)
  - Stale closure prevention using stored ID pattern
affects: [future ticket features, form patterns]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Store ID in state at mount to avoid stale closures
    - FormMode union type for consistent modal state
    - Read from getState() for fresh store data in handlers

key-files:
  created: []
  modified:
    - src/components/tickets/TicketForm.tsx
    - src/components/tickets/TicketsDashboard.tsx
    - src/stores/ticketsStore.ts

key-decisions:
  - "Store ticket ID in component state to prevent stale closure issues"
  - "Use FormMode union type instead of separate boolean/object states"
  - "Read links from store.getState() for fresh data during operations"

patterns-established:
  - "FormMode pattern: union type { type: 'closed' } | { type: 'create' } | { type: 'edit'; data }"
  - "Stale closure prevention: store IDs in state at mount when needed in handlers"

# Metrics
duration: 8min
completed: 2026-01-23
---

# Phase 15.1 Plan 01: Fix Linked Items Persistence Bug Summary

**Fixed ticket linked items persistence by storing ticket ID in state to avoid stale closures, using FormMode union type for consistent modal state, and reading fresh data from store.getState()**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-23T10:12:08Z
- **Completed:** 2026-01-23T10:20:00Z
- **Tasks:** 6
- **Files modified:** 3

## Accomplishments
- Fixed bug where linked items weren't persisting on ticket save
- Refactored TicketsDashboard to use FormMode union type for consistent state
- Established pattern for avoiding stale closures in form handlers
- Added defensive recurrence validation on ticket status update

## Task Commits

Each task was committed atomically:

1. **Task 1: Add debug logging to trace linked items flow** - `5ba3c09` (debug)
2. **Task 2: Fix stale ticket ID reference in handleSubmit** - `14d3044` (fix)
3. **Task 3: Verify localStorage persistence** - `a464ff4` (debug)
4. **Task 4: Add logging to linkTicketToEntity** - `e872b6e` (debug)
5. **Task 5: Use FormMode union type in TicketsDashboard** - `f69b5b9` (refactor)
6. **Task 6: Remove debug logging and clean up** - `77ab7ed` (fix)

## Files Created/Modified
- `src/components/tickets/TicketForm.tsx` - Store ticketId in state, read links from getState()
- `src/components/tickets/TicketsDashboard.tsx` - FormMode union type for modal state
- `src/stores/ticketsStore.ts` - Defensive recurrence validation, onRehydrateStorage cleanup

## Decisions Made
- **Store ticket ID in state**: Prevents stale closure when handleSubmit accesses ticket.id. The component is remounted via formKey, but this ensures the ID is always fresh within the handler closure.
- **FormMode union type**: Replaces separate `showCreateForm` boolean and `editingTicket` state with a single discriminated union. This prevents impossible states where both could be set incorrectly.
- **getState() for fresh reads**: In handlers like handleSubmit, use `useTicketsStore.getState()` to read the latest store data rather than relying on subscribed state which might be from an earlier render.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added defensive recurrence validation**
- **Found during:** Task 4 (examining ticketsStore.ts)
- **Issue:** updateTicketStatus could trigger recurring ticket creation even with malformed recurrence data
- **Fix:** Added hasValidRecurrence check with type guards before calling processRecurringTicket
- **Files modified:** src/stores/ticketsStore.ts
- **Verification:** Build passes, recurrence only triggers with valid interval
- **Committed in:** 5ba3c09 (included in Task 1 commit as pre-existing change)

**2. [Rule 2 - Missing Critical] Added onRehydrateStorage cleanup for malformed data**
- **Found during:** Task 4 (examining persistence)
- **Issue:** localStorage could contain tickets with invalid recurrence objects from past bugs
- **Fix:** Added onRehydrateStorage callback to clean up malformed recurrence data on app load
- **Files modified:** src/stores/ticketsStore.ts
- **Verification:** Build passes, malformed recurrence cleaned up on hydration
- **Committed in:** 5ba3c09 (included in Task 1 commit as pre-existing change)

---

**Total deviations:** 2 auto-fixed (2 missing critical)
**Impact on plan:** Both fixes prevent bugs related to data integrity. No scope creep - these were discovered during debugging and necessary for correct operation.

## Issues Encountered
None - debugging approach successfully identified the stale closure as the root cause and fixes were straightforward.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Linked items persistence bug is fixed
- Ready for Plan 02 (Add "Other" category option)
- FormMode pattern established for reuse in other modals

---
*Phase: 15.1-ticket-linked-items-fix*
*Completed: 2026-01-23*
