---
phase: 16-four-eye-approval
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/approval.ts
  - src/stores/approvalStore.ts
  - src/stores/uiStore.ts
  - src/hooks/usePermissions.ts
  - src/types/audit.ts
autonomous: true

must_haves:
  truths:
    - "Manager role exists and is selectable in role picker"
    - "Approval settings can be toggled globally"
    - "Pending changes can be created and stored"
    - "Manager inherits all Risk Manager permissions"
  artifacts:
    - path: "src/types/approval.ts"
      provides: "PendingChange, ApprovalSettings, ApprovalStatus types"
      exports: ["PendingChange", "ApprovalSettings", "ApprovalStatus", "PendingChangeEntityType"]
    - path: "src/stores/approvalStore.ts"
      provides: "Approval state management with Zustand"
      exports: ["useApprovalStore"]
    - path: "src/stores/uiStore.ts"
      provides: "Extended role type with manager"
      contains: "manager"
    - path: "src/hooks/usePermissions.ts"
      provides: "Manager-only permissions"
      contains: "canApproveChanges"
  key_links:
    - from: "src/stores/approvalStore.ts"
      to: "src/stores/auditStore.ts"
      via: "audit logging on pending change creation"
      pattern: "useAuditStore\\.getState\\(\\)"
    - from: "src/hooks/usePermissions.ts"
      to: "src/stores/uiStore.ts"
      via: "role check"
      pattern: "role === 'manager'"
---

<objective>
Create the foundational infrastructure for the four-eye approval workflow.

Purpose: Establish types, store, and role system that all approval features depend on.
Output: Working approval store with Manager role and permission checks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-four-eye-approval/16-CONTEXT.md
@.planning/phases/16-four-eye-approval/16-RESEARCH.md
@src/stores/uiStore.ts
@src/hooks/usePermissions.ts
@src/stores/auditStore.ts
@src/types/audit.ts
@src/components/layout/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create approval types and store</name>
  <files>
    src/types/approval.ts
    src/stores/approvalStore.ts
  </files>
  <action>
Create `src/types/approval.ts` with:

```typescript
// PendingChangeEntityType - entities subject to four-eye approval
export type PendingChangeEntityType = 'control' | 'risk' | 'process'

// ApprovalStatus - lifecycle states for pending changes
export type ApprovalStatus = 'pending' | 'approved' | 'rejected'

// PendingChange - a proposed modification awaiting manager review
export interface PendingChange {
  id: string                                // nanoid
  entityType: PendingChangeEntityType
  entityId: string                          // ID of entity being modified
  entityName: string                        // Captured name for display
  changeType: 'create' | 'update' | 'delete'
  proposedValues: Record<string, unknown>   // New values (full for create, delta for update)
  currentValues: Record<string, unknown>    // Snapshot at submission time
  status: ApprovalStatus
  submittedBy: string                       // Role who made change
  submittedAt: string                       // ISO timestamp
  reviewedBy?: string                       // Manager who reviewed
  reviewedAt?: string                       // ISO timestamp
  rejectionReason?: string                  // Optional reason text
  version: number                           // Increment on re-edit
}

// ApprovalSettings - configuration for four-eye requirements
export interface ApprovalSettings {
  globalEnabled: boolean                    // Master toggle
  requireForNewControls: boolean            // New control creation requires approval
  requireForNewRisks: boolean               // New risk items require approval
  requireForNewProcesses: boolean           // New process items require approval
  entityOverrides: Record<string, boolean>  // Per-entity enable/disable (entityId -> enabled)
}
```

Create `src/stores/approvalStore.ts` following existing Zustand patterns from ticketsStore.ts:

- Use `create<ApprovalState>()(persist(immer(...)))` pattern
- Store name: 'riskguard-approval'
- State: pendingChanges[], settings (ApprovalSettings)
- Actions:
  - `createPendingChange(change: Omit<PendingChange, 'id' | 'status' | 'submittedAt' | 'version'>)` - creates pending change, logs to audit with changeType 'proposed'
  - `approveChange(pendingId: string)` - sets status to 'approved', sets reviewedBy/reviewedAt, logs to audit
  - `rejectChange(pendingId: string, reason?: string)` - sets status to 'rejected', stores reason, logs to audit
  - `updateSettings(updates: Partial<ApprovalSettings>)` - update approval configuration
  - `toggleEntityApproval(entityId: string, enabled: boolean)` - toggle per-entity override
  - `getPendingForEntity(entityId: string)` - get pending changes for specific entity
  - `getPendingCount()` - return count of status === 'pending'
  - `isApprovalRequired(entityType: PendingChangeEntityType, entityId: string)` - check if approval needed based on global + overrides
  - `clearApprovedRejected()` - cleanup helper to remove non-pending entries older than 30 days

Initial settings state:
```typescript
settings: {
  globalEnabled: false,
  requireForNewControls: false,
  requireForNewRisks: false,
  requireForNewProcesses: false,
  entityOverrides: {},
}
```

Log to audit store for pending change creation using entityType 'pendingChange' and changeType 'create', then 'update' for approve/reject.
  </action>
  <verify>
- File exists: `src/types/approval.ts`
- File exists: `src/stores/approvalStore.ts`
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
- PendingChange and ApprovalSettings types exported
- approvalStore with all CRUD actions and settings management
- Audit logging integrated for pending change lifecycle
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend role system with Manager</name>
  <files>
    src/stores/uiStore.ts
    src/hooks/usePermissions.ts
    src/types/audit.ts
    src/components/layout/Header.tsx
  </files>
  <action>
Update `src/stores/uiStore.ts`:
- Change `selectedRole` type from `'risk-manager' | 'control-owner'` to `'manager' | 'risk-manager' | 'control-owner'`
- Update `setSelectedRole` parameter type accordingly
- Keep default as 'risk-manager'

Update `src/hooks/usePermissions.ts`:
- Add `isManager = role === 'manager'`
- Update `isRiskManager = role === 'risk-manager' || isManager` (Manager inherits RM permissions)
- Add new Manager-only permissions:
  - `canApproveChanges: isManager`
  - `canRejectChanges: isManager`
  - `canToggleFourEye: isManager`
  - `canRegenerateRCT: isManager` (will be used in Plan 05)
- Export `isManager` in return object

Update `src/types/audit.ts`:
- Add 'pendingChange' to EntityType union (for audit logging)

Update `src/components/layout/Header.tsx`:
- Add Manager option to role select dropdown
- Update onChange handler type to include 'manager'
- Order: Manager, Risk Manager, Control Owner (hierarchy order)
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Header.tsx includes Manager option in dropdown
- usePermissions returns canApproveChanges, canRejectChanges, canToggleFourEye
  </verify>
  <done>
- Manager role selectable in UI
- Manager inherits all Risk Manager permissions
- Manager-only approval permissions available
- Audit entity type extended for pending changes
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Role picker shows three options: Manager, Risk Manager, Control Owner
3. Switching to Manager role, `usePermissions()` returns `canApproveChanges: true`
4. Switching to Risk Manager role, `usePermissions()` returns `canApproveChanges: false`
5. `useApprovalStore.getState().settings.globalEnabled` returns `false` (initial state)
</verification>

<success_criteria>
1. Types exported from src/types/approval.ts
2. approvalStore persists to localStorage under 'riskguard-approval'
3. Manager role appears in header dropdown and is functional
4. Permission checks correctly identify Manager-only capabilities
5. Audit logging integrated for pending change operations
</success_criteria>

<output>
After completion, create `.planning/phases/16-four-eye-approval/16-01-SUMMARY.md`
</output>
