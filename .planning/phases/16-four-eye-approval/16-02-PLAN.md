---
phase: 16-four-eye-approval
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/hooks/useApprovalAwareUpdate.ts
  - src/stores/controlsStore.ts
  - src/components/approval/ApprovalBadge.tsx
  - src/components/approval/DiffViewer.tsx
  - src/components/approval/index.ts
  - src/components/controls/ControlDetailPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Control changes route through approval when four-eye enabled"
    - "Pending controls show amber badge indicating awaiting approval"
    - "Manager can see side-by-side diff of current vs proposed values"
    - "Risk Manager edits create pending changes instead of direct updates"
  artifacts:
    - path: "src/hooks/useApprovalAwareUpdate.ts"
      provides: "Hook that routes control updates through approval when required"
      exports: ["useApprovalAwareUpdate"]
    - path: "src/components/approval/ApprovalBadge.tsx"
      provides: "Visual indicator for pending/rejected status"
      exports: ["ApprovalBadge"]
    - path: "src/components/approval/DiffViewer.tsx"
      provides: "Side-by-side comparison of current vs proposed values"
      exports: ["DiffViewer"]
  key_links:
    - from: "src/hooks/useApprovalAwareUpdate.ts"
      to: "src/stores/approvalStore.ts"
      via: "createPendingChange call"
      pattern: "createPendingChange"
    - from: "src/components/controls/ControlDetailPanel.tsx"
      to: "src/hooks/useApprovalAwareUpdate.ts"
      via: "approval-aware update hook"
      pattern: "useApprovalAwareUpdate"
---

<objective>
Integrate approval workflow into control management.

Purpose: Make control changes go through approval when four-eye is enabled, with visual indicators.
Output: Controls show pending status badges, changes route through approval for non-Manager roles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-four-eye-approval/16-01-SUMMARY.md
@.planning/phases/16-four-eye-approval/16-CONTEXT.md
@src/stores/controlsStore.ts
@src/components/controls/ControlDetailPanel.tsx
@src/types/approval.ts
@src/stores/approvalStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create approval-aware update hook and UI components</name>
  <files>
    src/hooks/useApprovalAwareUpdate.ts
    src/components/approval/ApprovalBadge.tsx
    src/components/approval/DiffViewer.tsx
    src/components/approval/index.ts
  </files>
  <action>
Create `src/hooks/useApprovalAwareUpdate.ts`:

```typescript
import { useUIStore } from '@/stores/uiStore'
import { useApprovalStore } from '@/stores/approvalStore'
import { useControlsStore } from '@/stores/controlsStore'
import type { Control } from '@/types/rct'
import type { PendingChangeEntityType } from '@/types/approval'

export function useApprovalAwareUpdate() {
  const role = useUIStore((state) => state.selectedRole)
  const isApprovalRequired = useApprovalStore((state) => state.isApprovalRequired)
  const createPendingChange = useApprovalStore((state) => state.createPendingChange)
  const updateControl = useControlsStore((state) => state.updateControl)
  const addControl = useControlsStore((state) => state.addControl)
  const removeControl = useControlsStore((state) => state.removeControl)
  const getControlById = useControlsStore((state) => state.getControlById)

  const updateControlWithApproval = (
    controlId: string,
    updates: Partial<Control>,
    controlName: string
  ): { requiresApproval: boolean; pendingId?: string } => {
    const requiresApproval = isApprovalRequired('control', controlId) && role !== 'manager'

    if (requiresApproval) {
      const control = getControlById(controlId)
      const currentValues: Record<string, unknown> = {}
      for (const key of Object.keys(updates)) {
        currentValues[key] = control?.[key as keyof Control]
      }

      const pendingId = createPendingChange({
        entityType: 'control',
        entityId: controlId,
        entityName: controlName,
        changeType: 'update',
        proposedValues: updates as Record<string, unknown>,
        currentValues,
        submittedBy: role,
      })
      return { requiresApproval: true, pendingId }
    }

    updateControl(controlId, updates)
    return { requiresApproval: false }
  }

  const addControlWithApproval = (
    control: Omit<Control, 'id'>,
    rowId: string
  ): { requiresApproval: boolean; controlId?: string; pendingId?: string } => {
    const settings = useApprovalStore.getState().settings
    const requiresApproval = settings.requireForNewControls && role !== 'manager'

    if (requiresApproval) {
      const pendingId = createPendingChange({
        entityType: 'control',
        entityId: `new-${Date.now()}`, // Temporary ID for new control
        entityName: control.name,
        changeType: 'create',
        proposedValues: { ...control, rowId } as Record<string, unknown>,
        currentValues: {},
        submittedBy: role,
      })
      return { requiresApproval: true, pendingId }
    }

    const controlId = addControl(control)
    return { requiresApproval: false, controlId }
  }

  const removeControlWithApproval = (
    controlId: string,
    controlName: string
  ): { requiresApproval: boolean; pendingId?: string } => {
    const requiresApproval = isApprovalRequired('control', controlId) && role !== 'manager'

    if (requiresApproval) {
      const control = getControlById(controlId)
      const pendingId = createPendingChange({
        entityType: 'control',
        entityId: controlId,
        entityName: controlName,
        changeType: 'delete',
        proposedValues: {},
        currentValues: control as unknown as Record<string, unknown>,
        submittedBy: role,
      })
      return { requiresApproval: true, pendingId }
    }

    removeControl(controlId)
    return { requiresApproval: false }
  }

  return {
    updateControlWithApproval,
    addControlWithApproval,
    removeControlWithApproval,
    isManager: role === 'manager',
  }
}
```

Create `src/components/approval/ApprovalBadge.tsx`:
- Props: `status: 'pending' | 'rejected'`, `compact?: boolean`
- Pending: amber background (`bg-amber-500/20 text-amber-400`), Clock icon, "Pending" text
- Rejected: red background (`bg-red-500/20 text-red-400`), X icon, "Rejected" text
- Compact mode: only show icon, no text
- Use Lucide icons: Clock, X

Create `src/components/approval/DiffViewer.tsx`:
- Props: `currentValues: Record<string, unknown>`, `proposedValues: Record<string, unknown>`, `fieldLabels?: Record<string, string>`
- Two-column layout: "Current" vs "Proposed"
- Current values in red-tinted background (`bg-red-500/10 border-red-500/20`)
- Proposed values in green-tinted background (`bg-green-500/10 border-green-500/20`)
- Show field name above each value
- Handle null/undefined as "-"
- Only show fields that exist in proposedValues

Create `src/components/approval/index.ts` barrel export:
```typescript
export { ApprovalBadge } from './ApprovalBadge'
export { DiffViewer } from './DiffViewer'
```
  </action>
  <verify>
- Files exist: `src/hooks/useApprovalAwareUpdate.ts`, `src/components/approval/ApprovalBadge.tsx`, `src/components/approval/DiffViewer.tsx`, `src/components/approval/index.ts`
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
- useApprovalAwareUpdate hook routes control changes through approval when required
- ApprovalBadge shows pending/rejected status visually
- DiffViewer shows side-by-side current vs proposed values
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate approval into ControlDetailPanel</name>
  <files>
    src/components/controls/ControlDetailPanel.tsx
  </files>
  <action>
Update `src/components/controls/ControlDetailPanel.tsx`:

1. Import new hook and components:
```typescript
import { useApprovalAwareUpdate } from '@/hooks/useApprovalAwareUpdate'
import { useApprovalStore } from '@/stores/approvalStore'
import { ApprovalBadge, DiffViewer } from '@/components/approval'
```

2. In the component:
- Get `updateControlWithApproval`, `isManager` from `useApprovalAwareUpdate()`
- Get `getPendingForEntity` from `useApprovalStore`
- Check for pending changes on the control: `pendingChanges = getPendingForEntity(control.id)`
- Show `ApprovalBadge` next to control name if pending changes exist

3. Replace direct `updateControl` calls with `updateControlWithApproval`:
- When user edits control fields (name, description, controlType, scores, etc.)
- Show toast notification if change requires approval: "Change submitted for manager approval"
- Use existing toast/notification pattern from codebase (if none, use console.log for now)

4. Show pending changes section for Managers:
- If `isManager && pendingChanges.length > 0`, show a collapsible section "Pending Changes ({count})"
- For each pending change, show:
  - DiffViewer with currentValues and proposedValues
  - Approve button (green, Check icon)
  - Reject button (red, X icon) - opens small input for optional reason
- Wire buttons to `approveChange` and `rejectChange` from approvalStore

5. Show rejection info for Risk Manager:
- If there's a rejected pending change, show rejection reason and "Revise and Resubmit" option
- Revise and Resubmit creates a new pending change with version incremented

6. Add subtle amber left border to control card when pending changes exist (similar to ticket overdue indicator pattern):
```typescript
className={clsx(
  'border-l-4',
  hasPendingChanges ? 'border-l-amber-500' : 'border-l-transparent'
)}
```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- ControlDetailPanel shows ApprovalBadge when pending changes exist
- Manager can see and action pending changes in panel
  </verify>
  <done>
- Control edits by Risk Manager create pending changes when four-eye enabled
- ApprovalBadge visible on controls with pending changes
- Manager can approve/reject inline in ControlDetailPanel
- Rejected changes show reason and allow revision
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Enable four-eye globally in approvalStore (via dev tools or temporary UI)
3. As Risk Manager, edit a control field - change goes to pending, badge appears
4. Switch to Manager, see pending change with diff view
5. Manager approves - change applies, badge disappears
6. Test rejection flow - reason shown, Risk Manager can revise
</verification>

<success_criteria>
1. Control edits route through approval when four-eye enabled and user is not Manager
2. ApprovalBadge shows on controls with pending changes
3. DiffViewer displays current vs proposed values side-by-side
4. Manager can approve/reject pending changes from ControlDetailPanel
5. Rejected changes show reason and allow revision
</success_criteria>

<output>
After completion, create `.planning/phases/16-four-eye-approval/16-02-SUMMARY.md`
</output>
