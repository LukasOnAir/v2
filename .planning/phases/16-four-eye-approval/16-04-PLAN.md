---
phase: 16-four-eye-approval
plan: 04
type: execute
wave: 3
depends_on: ["16-02", "16-03"]
files_modified:
  - src/components/approval/ApprovalQueue.tsx
  - src/components/approval/ApprovalQueueRow.tsx
  - src/components/approval/ApprovalSettings.tsx
  - src/components/approval/index.ts
  - src/pages/ApprovalPage.tsx
  - src/App.tsx
  - src/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Manager can view all pending changes in dedicated queue page"
    - "Approval queue shows entity type, name, submitter, and timestamp"
    - "Manager can bulk approve or reject multiple items"
    - "Manager can configure approval settings from the page"
  artifacts:
    - path: "src/pages/ApprovalPage.tsx"
      provides: "Dedicated approval queue page"
      exports: ["ApprovalPage"]
    - path: "src/components/approval/ApprovalQueue.tsx"
      provides: "Table component for pending changes"
      exports: ["ApprovalQueue"]
    - path: "src/components/approval/ApprovalSettings.tsx"
      provides: "Configuration panel for approval toggles"
      exports: ["ApprovalSettings"]
  key_links:
    - from: "src/pages/ApprovalPage.tsx"
      to: "src/stores/approvalStore.ts"
      via: "pendingChanges state subscription"
      pattern: "useApprovalStore"
    - from: "src/App.tsx"
      to: "src/pages/ApprovalPage.tsx"
      via: "route definition"
      pattern: "path=\"approval\""
---

<objective>
Create the approval queue page for Managers to review and action pending changes.

Purpose: Centralized location for Managers to process all pending approvals efficiently.
Output: Working approval page with queue table, bulk actions, and settings configuration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-four-eye-approval/16-02-SUMMARY.md
@.planning/phases/16-four-eye-approval/16-03-SUMMARY.md
@.planning/phases/16-four-eye-approval/16-CONTEXT.md
@src/stores/approvalStore.ts
@src/components/approval/index.ts
@src/App.tsx
@src/components/layout/Sidebar.tsx
@src/pages/RemediationPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ApprovalQueue components</name>
  <files>
    src/components/approval/ApprovalQueue.tsx
    src/components/approval/ApprovalQueueRow.tsx
    src/components/approval/ApprovalSettings.tsx
    src/components/approval/index.ts
  </files>
  <action>
Create `src/components/approval/ApprovalQueue.tsx`:
- Uses TanStack Table for the queue display
- Columns: Select (checkbox), Entity Type, Entity Name, Change Type, Submitted By, Submitted At, Actions
- Filter by entity type (control, risk, process)
- Filter by status (pending, approved, rejected) - default to pending
- Sort by submitted date (newest first)
- Row selection for bulk actions
- Bulk action bar appears when items selected: "Approve Selected ({count})", "Reject Selected ({count})"

Table columns:
```typescript
const columns = [
  // Checkbox for selection
  {
    id: 'select',
    header: ({ table }) => <Checkbox checked={table.getIsAllRowsSelected()} ... />,
    cell: ({ row }) => <Checkbox checked={row.getIsSelected()} ... />,
  },
  // Entity Type with icon
  {
    accessorKey: 'entityType',
    header: 'Type',
    cell: ({ getValue }) => {
      const type = getValue() as string
      const Icon = type === 'control' ? Shield : type === 'risk' ? AlertTriangle : Folder
      return <span className="flex items-center gap-1.5"><Icon size={14} />{type}</span>
    },
  },
  // Entity Name
  { accessorKey: 'entityName', header: 'Name' },
  // Change Type with badge
  {
    accessorKey: 'changeType',
    header: 'Change',
    cell: ({ getValue }) => {
      const type = getValue() as string
      const colors = {
        create: 'bg-green-500/20 text-green-400',
        update: 'bg-blue-500/20 text-blue-400',
        delete: 'bg-red-500/20 text-red-400',
      }
      return <span className={clsx('px-2 py-0.5 rounded text-xs', colors[type])}>{type}</span>
    },
  },
  // Submitted By
  { accessorKey: 'submittedBy', header: 'Submitted By' },
  // Submitted At (relative time)
  {
    accessorKey: 'submittedAt',
    header: 'Submitted',
    cell: ({ getValue }) => formatDistanceToNow(new Date(getValue() as string), { addSuffix: true }),
  },
  // Actions column
  {
    id: 'actions',
    cell: ({ row }) => (
      <div className="flex items-center gap-1">
        <button onClick={() => openDiffDialog(row.original)} title="View Details">
          <Eye size={16} />
        </button>
        <button onClick={() => approveChange(row.original.id)} className="text-green-400" title="Approve">
          <Check size={16} />
        </button>
        <button onClick={() => openRejectDialog(row.original.id)} className="text-red-400" title="Reject">
          <X size={16} />
        </button>
      </div>
    ),
  },
]
```

Include a dialog for viewing diff details (uses DiffViewer component).
Include a dialog for rejection with optional reason textarea.

Create `src/components/approval/ApprovalQueueRow.tsx`:
- Expandable row component (optional - if inline expansion preferred over dialog)
- Shows DiffViewer when expanded
- Can be used as alternative to dialog pattern

Create `src/components/approval/ApprovalSettings.tsx`:
- Props: none (reads from approvalStore directly)
- Displays current settings with toggle switches:
  - Global four-eye approval (master toggle)
  - Require approval for new controls
  - Require approval for new risks
  - Require approval for new processes
- Each toggle calls `updateSettings` with appropriate changes
- Only visible to Manager role (component handles permission check)
- Styling: Card with sections, consistent with other settings patterns

Update `src/components/approval/index.ts`:
```typescript
export { ApprovalBadge } from './ApprovalBadge'
export { DiffViewer } from './DiffViewer'
export { ApprovalQueue } from './ApprovalQueue'
export { ApprovalQueueRow } from './ApprovalQueueRow'
export { ApprovalSettings } from './ApprovalSettings'
```
  </action>
  <verify>
- Files exist
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
- ApprovalQueue shows pending changes in table format
- Bulk selection and actions supported
- ApprovalSettings allows Manager to configure approval requirements
- DiffViewer dialog shows details of each change
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ApprovalPage and integrate routing</name>
  <files>
    src/pages/ApprovalPage.tsx
    src/App.tsx
    src/components/layout/Sidebar.tsx
  </files>
  <action>
Create `src/pages/ApprovalPage.tsx`:
- Page header: "Approval Queue" with settings button (opens ApprovalSettings in collapsible section)
- Show pending count prominently: "{N} pending approvals"
- Main content: ApprovalQueue component
- Summary stats at top (similar to RemediationPage pattern):
  - Total pending
  - By entity type (controls, risks, processes)
  - Oldest pending item age
- Permission check: If not Manager, show message "Only Managers can access the approval queue"
- Empty state: "No pending approvals" with checkmark icon when queue is empty

Layout:
```tsx
function ApprovalPage() {
  const { canApproveChanges } = usePermissions()
  const pendingChanges = useApprovalStore((state) =>
    state.pendingChanges.filter(p => p.status === 'pending')
  )
  const [showSettings, setShowSettings] = useState(false)

  if (!canApproveChanges) {
    return (
      <div className="p-6">
        <div className="bg-surface-elevated rounded-lg p-8 text-center">
          <Lock className="w-12 h-12 text-text-muted mx-auto mb-4" />
          <h2 className="text-lg font-medium text-text-primary mb-2">Access Restricted</h2>
          <p className="text-text-secondary">Only Managers can access the approval queue.</p>
        </div>
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-text-primary">Approval Queue</h1>
          <p className="text-text-secondary mt-1">
            {pendingChanges.length} pending approval{pendingChanges.length !== 1 ? 's' : ''}
          </p>
        </div>
        <button
          onClick={() => setShowSettings(!showSettings)}
          className="flex items-center gap-2 px-3 py-1.5 text-sm bg-surface-elevated border border-surface-border rounded hover:bg-surface-overlay"
        >
          <Settings size={16} />
          Settings
        </button>
      </div>

      {showSettings && (
        <div className="bg-surface-elevated rounded-lg p-4 border border-surface-border">
          <ApprovalSettings />
        </div>
      )}

      {/* Summary cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {/* Similar to RemediationPage summary cards */}
      </div>

      {/* Queue */}
      {pendingChanges.length > 0 ? (
        <ApprovalQueue />
      ) : (
        <div className="bg-surface-elevated rounded-lg p-12 text-center">
          <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
          <h2 className="text-lg font-medium text-text-primary mb-2">All Caught Up!</h2>
          <p className="text-text-secondary">No pending approvals at this time.</p>
        </div>
      )}
    </div>
  )
}
```

Update `src/App.tsx`:
- Import ApprovalPage
- Add route: `<Route path="approval" element={<ApprovalPage />} />`

Update `src/components/layout/Sidebar.tsx`:
- Import CheckCircle2 or similar icon from lucide-react
- Add nav item after "Audit Trail":
```typescript
{ to: '/approval', icon: CheckCircle2, label: 'Approvals' },
```
- Position in nav order: After Audit Trail, before Analytics
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Navigate to /approval shows ApprovalPage
- Sidebar shows "Approvals" link
- Non-Manager sees access restricted message
  </verify>
  <done>
- ApprovalPage accessible via /approval route
- Sidebar includes Approvals navigation item
- Manager can view and configure approval settings
- Queue displays pending changes with bulk actions
- Non-Manager sees restricted access message
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Navigate to /approval as Manager - see queue page
3. Navigate to /approval as Risk Manager - see restricted message
4. Create pending changes (from Plans 02/03), verify they appear in queue
5. Test bulk approve: select multiple, click approve, all get approved
6. Test bulk reject: select multiple, enter reason, all get rejected
7. Toggle settings, verify changes persist
</verification>

<success_criteria>
1. /approval route accessible and shows ApprovalPage
2. Sidebar includes Approvals navigation item
3. Manager can view all pending changes in queue table
4. Manager can approve/reject individual changes
5. Manager can bulk approve/reject selected changes
6. Manager can configure approval settings
7. Non-Manager sees access restricted message
</success_criteria>

<output>
After completion, create `.planning/phases/16-four-eye-approval/16-04-SUMMARY.md`
</output>
