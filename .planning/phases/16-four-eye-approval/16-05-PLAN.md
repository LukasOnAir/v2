---
phase: 16-four-eye-approval
plan: 05
type: execute
wave: 4
depends_on: ["16-04"]
files_modified:
  - src/components/layout/Header.tsx
  - src/components/layout/Sidebar.tsx
  - src/components/rct/RCTToolbar.tsx
  - src/stores/approvalStore.ts
autonomous: false

must_haves:
  truths:
    - "Manager sees pending approval count badge in navigation"
    - "RCT Regenerate button only visible to Manager role"
    - "Notification badge updates when new pending changes arrive"
    - "Approved/rejected changes are applied to actual entities"
  artifacts:
    - path: "src/components/layout/Header.tsx"
      provides: "Notification badge for pending approvals"
      contains: "pendingCount"
    - path: "src/components/rct/RCTToolbar.tsx"
      provides: "RCT Regenerate restricted to Manager"
      contains: "canRegenerateRCT"
  key_links:
    - from: "src/components/layout/Sidebar.tsx"
      to: "src/stores/approvalStore.ts"
      via: "getPendingCount subscription"
      pattern: "getPendingCount"
    - from: "src/stores/approvalStore.ts"
      to: "src/stores/controlsStore.ts"
      via: "applyPendingChange for controls"
      pattern: "updateControl|addControl|removeControl"
---

<objective>
Complete the approval workflow with notifications and RCT restrictions.

Purpose: Provide Manager visibility into pending items and restrict RCT regeneration.
Output: Nav badge shows pending count, RCT regenerate restricted, pending changes apply on approval.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-four-eye-approval/16-04-SUMMARY.md
@.planning/phases/16-four-eye-approval/16-CONTEXT.md
@src/components/layout/Header.tsx
@src/components/layout/Sidebar.tsx
@src/components/rct/RCTToolbar.tsx
@src/stores/approvalStore.ts
@src/stores/controlsStore.ts
@src/stores/taxonomyStore.ts
@src/hooks/usePermissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification badge and apply pending changes</name>
  <files>
    src/components/layout/Header.tsx
    src/components/layout/Sidebar.tsx
    src/stores/approvalStore.ts
  </files>
  <action>
Update `src/stores/approvalStore.ts` to add `applyPendingChange` function:

This is the critical function that actually applies approved changes to the real stores. Add it to the store:

```typescript
// Import the stores needed to apply changes
import { useControlsStore } from './controlsStore'
import { useTaxonomyStore } from './taxonomyStore'

// Inside the store actions:
applyPendingChange: (pendingId: string) => {
  const state = get()
  const pending = state.pendingChanges.find(p => p.id === pendingId)
  if (!pending || pending.status !== 'approved') return

  const { entityType, entityId, changeType, proposedValues, currentValues } = pending

  // Apply to real store based on entity type
  if (entityType === 'control') {
    const controlsStore = useControlsStore.getState()

    if (changeType === 'create') {
      // For new controls, proposedValues contains the full control + rowId
      const { rowId, ...controlData } = proposedValues as { rowId: string; [key: string]: unknown }
      const newId = controlsStore.addControl(controlData as Omit<Control, 'id'>)
      if (rowId) {
        controlsStore.linkControl(newId, rowId)
      }
    } else if (changeType === 'update') {
      controlsStore.updateControl(entityId, proposedValues as Partial<Control>)
    } else if (changeType === 'delete') {
      controlsStore.removeControl(entityId)
    }
  } else if (entityType === 'risk' || entityType === 'process') {
    const taxonomyStore = useTaxonomyStore.getState()
    const tree = entityType === 'risk' ? taxonomyStore.risks : taxonomyStore.processes
    const setTree = entityType === 'risk' ? taxonomyStore.setRisks : taxonomyStore.setProcesses

    if (changeType === 'update') {
      // Rename operation
      const updateTree = (items: TaxonomyItem[]): TaxonomyItem[] => {
        return items.map(item => {
          if (item.id === entityId) {
            return { ...item, name: proposedValues.name as string }
          }
          if (item.children) {
            return { ...item, children: updateTree(item.children) }
          }
          return item
        })
      }
      setTree(updateTree(tree))
    } else if (changeType === 'delete') {
      // Delete operation
      const removeFromTree = (items: TaxonomyItem[]): TaxonomyItem[] => {
        return items
          .filter(item => item.id !== entityId)
          .map(item => ({
            ...item,
            children: item.children ? removeFromTree(item.children) : undefined,
          }))
      }
      setTree(removeFromTree(tree))
    } else if (changeType === 'create') {
      // New item - need to add to tree
      const { name, parentId } = proposedValues as { name: string; parentId: string | null }
      const newItem: TaxonomyItem = {
        id: nanoid(),
        name,
        children: [],
      }

      if (!parentId) {
        // Add to root
        setTree([...tree, newItem])
      } else {
        // Add as child of parent
        const addToTree = (items: TaxonomyItem[]): TaxonomyItem[] => {
          return items.map(item => {
            if (item.id === parentId) {
              return { ...item, children: [...(item.children || []), newItem] }
            }
            if (item.children) {
              return { ...item, children: addToTree(item.children) }
            }
            return item
          })
        }
        setTree(addToTree(tree))
      }
    }
  }
}
```

Modify `approveChange` to call `applyPendingChange` after setting status to approved.

Update `src/components/layout/Sidebar.tsx`:
- Import useApprovalStore
- Get pending count: `const pendingCount = useApprovalStore((state) => state.getPendingCount())`
- Import usePermissions
- Show badge only for Manager role
- On the Approvals nav item, add a badge showing count if > 0:

```typescript
{navItems.map((item) => (
  <li key={item.to}>
    <NavLink ...>
      <item.icon className="w-5 h-5 flex-shrink-0" />
      {!isCollapsed && (
        <span className="text-sm font-medium truncate flex-1">{item.label}</span>
      )}
      {/* Pending count badge for Approvals */}
      {item.to === '/approval' && isManager && pendingCount > 0 && (
        <span className="bg-amber-500 text-white text-xs font-medium px-1.5 py-0.5 rounded-full min-w-[20px] text-center">
          {pendingCount > 99 ? '99+' : pendingCount}
        </span>
      )}
    </NavLink>
  </li>
))}
```

Update `src/components/layout/Header.tsx`:
- Add a small bell icon with badge for Managers showing pending count
- Position next to role selector
- Clicking navigates to /approval page
- Use Link from react-router

```typescript
import { Link } from 'react-router'
import { Bell } from 'lucide-react'
import { useApprovalStore } from '@/stores/approvalStore'
import { usePermissions } from '@/hooks/usePermissions'

// In component:
const { isManager } = usePermissions()
const pendingCount = useApprovalStore((state) => state.getPendingCount())

// In JSX, before role selector:
{isManager && (
  <Link
    to="/approval"
    className="relative p-2 text-text-secondary hover:text-text-primary transition-colors"
    title={`${pendingCount} pending approvals`}
  >
    <Bell size={20} />
    {pendingCount > 0 && (
      <span className="absolute -top-1 -right-1 bg-amber-500 text-white text-xs font-medium w-5 h-5 flex items-center justify-center rounded-full">
        {pendingCount > 9 ? '9+' : pendingCount}
      </span>
    )}
  </Link>
)}
```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Sidebar shows badge on Approvals nav item when pending changes exist
- Header shows bell icon with badge for Manager
- Click bell navigates to /approval
  </verify>
  <done>
- Notification badge shows pending count in nav
- Header bell icon for quick access to approvals
- applyPendingChange properly updates real stores on approval
  </done>
</task>

<task type="auto">
  <name>Task 2: Restrict RCT Regenerate to Manager</name>
  <files>
    src/components/rct/RCTToolbar.tsx
  </files>
  <action>
Update `src/components/rct/RCTToolbar.tsx`:

1. Import usePermissions if not already:
```typescript
import { usePermissions } from '@/hooks/usePermissions'
```

2. Get the permission:
```typescript
const { canManageCustomColumns, canRegenerateRCT } = usePermissions()
```

3. Wrap the Regenerate button in a permission check:
```typescript
{canRegenerateRCT && (
  <button
    onClick={onRegenerate}
    className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-surface-elevated border border-surface-border rounded hover:bg-surface-overlay transition-colors"
  >
    <RefreshCw size={14} />
    Regenerate
  </button>
)}
```

This ensures only Managers can regenerate the RCT, which is an impactful operation that could affect many rows.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- As Risk Manager, Regenerate button is NOT visible
- As Manager, Regenerate button IS visible and functional
  </verify>
  <done>
- RCT Regenerate button restricted to Manager role only
- Button completely hidden for Risk Manager and Control Owner
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete four-eye approval workflow:
- Manager role with elevated permissions
- Approval settings (global and per-entity toggles)
- Pending change creation for controls and taxonomies
- Approval queue page with bulk actions
- Notification badges in nav and header
- RCT regenerate restricted to Manager
  </what-built>
  <how-to-verify>
1. **Role System**
   - Switch to Manager role in header dropdown
   - Verify Manager sees bell icon with badge (may be 0)
   - Switch to Risk Manager, verify bell icon not visible

2. **Approval Settings**
   - As Manager, navigate to /approval
   - Toggle "Global four-eye approval" ON
   - Verify settings persist after page refresh

3. **Control Approval Flow**
   - Switch to Risk Manager
   - Edit a control (change name or score)
   - Verify amber "Pending" badge appears on control
   - Switch to Manager
   - Go to /approval, verify pending change in queue
   - Click approve, verify change is applied
   - Verify badge disappears from control

4. **Rejection Flow**
   - As Risk Manager, edit another control
   - Switch to Manager, reject with reason "Needs more detail"
   - Switch to Risk Manager, verify rejected badge shows
   - Verify rejection reason is visible

5. **Taxonomy Approval**
   - Enable approval for risks in settings
   - As Risk Manager, rename a risk item
   - Verify pending badge on that node
   - As Manager, approve from queue

6. **Bulk Actions**
   - Create multiple pending changes as Risk Manager
   - As Manager, select all, click "Approve Selected"
   - Verify all changes applied

7. **Notifications**
   - Create pending changes
   - Verify sidebar badge shows count
   - Verify header bell shows count
   - Click bell, navigate to /approval

8. **RCT Regenerate**
   - As Risk Manager, verify Regenerate button NOT visible
   - As Manager, verify Regenerate button IS visible
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Full workflow test: Risk Manager edit -> pending -> Manager approve -> applied
3. Full workflow test: Risk Manager edit -> pending -> Manager reject -> reason shown
4. Notification badges update correctly
5. RCT Regenerate only visible to Manager
</verification>

<success_criteria>
1. Manager sees notification badge in nav and header
2. Badge count reflects actual pending changes
3. Clicking header bell navigates to /approval
4. RCT Regenerate button only visible to Manager role
5. Approved changes properly apply to real entities
6. Human verification confirms end-to-end workflow works
</success_criteria>

<output>
After completion, create `.planning/phases/16-four-eye-approval/16-05-SUMMARY.md`
</output>
