---
phase: 16-four-eye-approval
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/rct/ControlPanel.tsx
  - src/components/taxonomy/TaxonomyTree.tsx
  - src/hooks/useApprovalAwareTaxonomy.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All control field changes in RCT view route through approval when four-eye enabled"
    - "Risk/process description changes route through approval when four-eye enabled"
    - "Pending badge appears on controls in RCT ControlPanel when changes await approval"
  artifacts:
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Approval-aware control updates in RCT view"
      contains: "useApprovalAwareUpdate"
    - path: "src/hooks/useApprovalAwareTaxonomy.ts"
      provides: "Description change approval routing"
      exports: ["updateDescriptionWithApproval"]
    - path: "src/components/taxonomy/TaxonomyTree.tsx"
      provides: "Approval-aware description changes"
      contains: "updateDescriptionWithApproval"
  key_links:
    - from: "src/components/rct/ControlPanel.tsx"
      to: "useApprovalAwareUpdate"
      via: "hook import and usage"
      pattern: "updateControlWithApproval\\("
    - from: "src/components/taxonomy/TaxonomyTree.tsx"
      to: "useApprovalAwareTaxonomy"
      via: "hook function call"
      pattern: "updateDescriptionWithApproval\\("
---

<objective>
Fix RCT ControlPanel to route control changes through approval workflow and add taxonomy description change tracking.

Purpose: Close verification gaps 1 and 2 - RCT ControlPanel currently bypasses approval entirely, and taxonomy description changes are not tracked.

Output: RCT control edits and taxonomy description changes properly routed through four-eye approval when enabled.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-four-eye-approval/16-VERIFICATION.md
@.planning/phases/16-four-eye-approval/16-02-SUMMARY.md
@.planning/phases/16-four-eye-approval/16-03-SUMMARY.md
@src/hooks/useApprovalAwareUpdate.ts
@src/hooks/useApprovalAwareTaxonomy.ts
@src/components/rct/ControlPanel.tsx
@src/components/taxonomy/TaxonomyTree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire RCT ControlPanel to approval-aware hook</name>
  <files>src/components/rct/ControlPanel.tsx</files>
  <action>
Import and use useApprovalAwareUpdate hook to route all control changes through approval workflow.

**Current problem (lines 220, 363, 387, 438, 451):**
- Line 220: `updateControl(row.id, controlId, { [field]: value })` - direct score update
- Line 363: `updateControl(row.id, control.id, { name })` - direct name update
- Line 387: `updateControl(row.id, control.id, { controlType: ... })` - direct type update
- Line 438: `updateControl(row.id, control.id, { description })` - direct description update
- Line 451: `updateControl(row.id, control.id, { comment })` - direct comment update

**Fix:**
1. Import `useApprovalAwareUpdate` from `@/hooks/useApprovalAwareUpdate`
2. Import `ApprovalBadge` from `@/components/approval`
3. Import `useApprovalStore` to get `getPendingForEntity`
4. Call hook at component top: `const { updateControlWithApproval } = useApprovalAwareUpdate()`
5. Get pending check: `const getPendingForEntity = useApprovalStore(state => state.getPendingForEntity)`

Replace each direct `updateControl` call with approval-aware version:

**For embedded controls (row.controls):**
- Get control name for audit: `const control = row.controls.find(c => c.id === controlId)`
- Score update: `updateControlWithApproval(controlId, { [field]: value }, control?.name || '')`
- Name update: `updateControlWithApproval(control.id, { name }, control.name)`
- Type update: `updateControlWithApproval(control.id, { controlType: ... }, control.name)`
- Description update: `updateControlWithApproval(control.id, { description }, control.name)`
- Comment update: `updateControlWithApproval(control.id, { comment }, control.name)`

**Note:** The embedded controls in `row.controls` need the rctStore's `updateControl` for the actual update. The approval-aware hook uses controlsStore. For embedded controls, we need to:
- Check approval using `isApprovalRequired` from approvalStore
- If approval required and not Manager, create pending change
- If no approval required or Manager, call the original `updateControl` from rctStore

Create a local wrapper function `handleControlUpdateWithApproval(controlId: string, updates: Partial<Control>, controlName: string)` that:
1. Gets approval settings from approvalStore
2. Checks role from uiStore
3. If approval required and role !== 'manager', create pending change via approvalStore
4. Otherwise, call original `updateControl(row.id, controlId, updates)`

**For linked controls (linkedControls):**
These already use `updateHubControl` from controlsStore which the existing hook handles.
The existing lines updating linked controls (around 562, 586, 645, 658) should use `updateControlWithApproval` instead.

**Add ApprovalBadge to control cards:**
For each control card, check if it has pending changes:
```tsx
const hasPending = getPendingForEntity(control.id).length > 0
```
Display ApprovalBadge next to control name if hasPending.
  </action>
  <verify>
1. Open RCT, click on a row to open ControlPanel
2. Switch to Risk Manager role
3. Enable four-eye approval globally
4. Edit a control name, type, description, or score
5. Verify amber pending badge appears
6. Verify change appears in approval queue (not applied directly)
  </verify>
  <done>All control edits in RCT ControlPanel route through four-eye approval when enabled; pending badge shows on controls with unapproved changes</done>
</task>

<task type="auto">
  <name>Task 2: Add description change approval to taxonomy hook</name>
  <files>src/hooks/useApprovalAwareTaxonomy.ts, src/components/taxonomy/TaxonomyTree.tsx</files>
  <action>
**Update useApprovalAwareTaxonomy.ts:**

Add new function `updateDescriptionWithApproval` following the pattern of `renameTaxonomyItemWithApproval`:

```typescript
const updateDescriptionWithApproval = (
  type: 'risk' | 'process',
  itemId: string,
  newDescription: string
): { requiresApproval: boolean; pendingId?: string } => {
  const tree = type === 'risk' ? risks : processes
  const item = findItemInTree(tree, itemId)
  if (!item) return { requiresApproval: false }

  const requiresApproval = checkTaxonomyApproval(type, itemId, false)

  if (requiresApproval) {
    const pendingId = createPendingChange({
      entityType: type,
      entityId: itemId,
      entityName: `${item.hierarchicalId} ${item.name}`,
      changeType: 'update',
      proposedValues: { description: newDescription },
      currentValues: { description: item.description },
      submittedBy: role,
    })
    return { requiresApproval: true, pendingId }
  }

  // Direct update - apply to tree
  const updateTree = (items: TaxonomyItem[]): TaxonomyItem[] => {
    return items.map(i => {
      if (i.id === itemId) {
        return { ...i, description: newDescription }
      }
      if (i.children) {
        return { ...i, children: updateTree(i.children) }
      }
      return i
    })
  }

  if (type === 'risk') {
    setRisks(updateTree(risks))
  } else {
    setProcesses(updateTree(processes))
  }
  return { requiresApproval: false }
}
```

Add to return object: `updateDescriptionWithApproval`

**Update TaxonomyTree.tsx:**

1. Import `updateDescriptionWithApproval` from the hook (add to existing destructure)

2. Update `handleDescriptionChange` callback (lines 251-259):

Current:
```typescript
const handleDescriptionChange = useCallback(
  (id: string, description: string) => {
    const newData = updateItemInTree(data, id, (item) => ({
      ...item,
      description,
    }))
    setData(newData)
  },
  [data, setData, updateItemInTree]
)
```

Replace with:
```typescript
const handleDescriptionChange = useCallback(
  (id: string, description: string) => {
    const result = updateDescriptionWithApproval(taxonomyType, id, description)
    if (result.requiresApproval) {
      showNotification('Description change submitted for approval')
    }
    // If not requiring approval, the hook already applied the change
  },
  [taxonomyType, updateDescriptionWithApproval, showNotification]
)
```
  </action>
  <verify>
1. Open Taxonomy page
2. Switch to Risk Manager role
3. Enable four-eye approval for risks
4. Edit a risk item's description
5. Verify notification toast appears "Description change submitted for approval"
6. Verify description change appears in approval queue
7. Verify original description remains until Manager approves
  </verify>
  <done>Taxonomy description changes route through four-eye approval when enabled; pending changes tracked with description in currentValues/proposedValues</done>
</task>

</tasks>

<verification>
**Gap 1 (RCT ControlPanel bypasses approval):**
- [ ] Edit control name in RCT panel -> creates pending change when four-eye enabled
- [ ] Edit control type in RCT panel -> creates pending change
- [ ] Edit control scores in RCT panel -> creates pending change
- [ ] Edit control description in RCT panel -> creates pending change
- [ ] Pending badge visible on controls with unapproved changes
- [ ] Manager role can still edit directly (no pending change created)

**Gap 2 (Taxonomy description not tracked):**
- [ ] Edit risk description -> creates pending change when four-eye enabled
- [ ] Edit process description -> creates pending change when four-eye enabled
- [ ] Pending change includes description in currentValues and proposedValues
- [ ] Notification toast appears when description change submitted
</verification>

<success_criteria>
- All control field changes in RCT ControlPanel route through approval when four-eye enabled
- Taxonomy description changes route through approval when four-eye enabled
- Pending badges display on controls with unapproved changes in RCT view
- Manager role bypasses approval for all operations
- Approval queue shows pending control and description changes with diff viewer
</success_criteria>

<output>
After completion, create `.planning/phases/16-four-eye-approval/16-06-SUMMARY.md`
</output>
