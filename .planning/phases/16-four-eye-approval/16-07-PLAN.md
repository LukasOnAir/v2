---
phase: 16-four-eye-approval
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/controls/ControlDetailPanel.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Risk Manager can see their proposed values after submission"
    - "Risk Manager sees alert banner when opening control with rejected changes"
    - "Rejected fields are highlighted with inline rejection reason"
  artifacts:
    - path: "src/components/controls/ControlDetailPanel.tsx"
      provides: "Pending value display and rejection visibility"
      contains: "Your proposed change"
  key_links:
    - from: "src/components/controls/ControlDetailPanel.tsx"
      to: "pendingChanges"
      via: "approvalStore subscription"
      pattern: "proposedValues\\."
---

<objective>
Fix pending value display for Risk Manager and improve rejection feedback visibility.

Purpose: Close verification gaps 3 and 4 - Risk Manager cannot see their proposed values after submission, and rejection feedback is not prominent enough.

Output: Risk Manager sees inline indicators of pending changes and prominent alerts for rejections.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-four-eye-approval/16-VERIFICATION.md
@.planning/phases/16-four-eye-approval/16-02-SUMMARY.md
@src/components/controls/ControlDetailPanel.tsx
@src/stores/approvalStore.ts
@src/types/approval.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Show pending proposed values to Risk Manager</name>
  <files>src/components/controls/ControlDetailPanel.tsx</files>
  <action>
**Current problem (from verification):**
- Form fields show control state from store (currentValues)
- Risk Manager submits change but sees original values
- Proposed values only visible to Manager in pending changes section

**Fix - Add inline pending indicators:**

1. Get pending changes for current user's submissions:
```typescript
// After existing controlPendingChanges definition (line ~57)
const myPendingChanges = controlPendingChanges.filter(
  c => c.submittedBy === role && c.status === 'pending'
)
```

2. Create helper to get pending value for a field:
```typescript
const getPendingValue = (field: string): unknown | undefined => {
  for (const change of myPendingChanges) {
    if (change.proposedValues[field] !== undefined) {
      return change.proposedValues[field]
    }
  }
  return undefined
}

const hasPendingForField = (field: string): boolean => {
  return myPendingChanges.some(c => c.proposedValues[field] !== undefined)
}
```

3. Add pending indicator component (inside the file or inline):
```tsx
function PendingChangeIndicator({
  field,
  currentValue,
  proposedValue
}: {
  field: string
  currentValue: unknown
  proposedValue: unknown
}) {
  return (
    <div className="mt-1 px-2 py-1 bg-amber-500/10 border border-amber-500/30 rounded text-xs">
      <span className="text-amber-400">Pending approval:</span>
      <span className="text-text-secondary ml-1">
        {String(currentValue || '(empty)')}
        <span className="text-text-muted mx-1">-></span>
        <span className="text-amber-400">{String(proposedValue || '(empty)')}</span>
      </span>
    </div>
  )
}
```

4. Update form fields to show pending indicators (non-Manager only):

**For Name field (around line 370-378):**
After the input element, add:
```tsx
{!isManager && hasPendingForField('name') && (
  <PendingChangeIndicator
    field="name"
    currentValue={control.name}
    proposedValue={getPendingValue('name')}
  />
)}
```

**For Description field (around line 382-390):**
After the textarea element, add similar indicator.

**For Type field (around line 394-406):**
After the select element, add similar indicator.

**For Net Probability (around line 411-417):**
After the ScoreDropdown, add:
```tsx
{!isManager && hasPendingForField('netProbability') && (
  <PendingChangeIndicator
    field="netProbability"
    currentValue={control.netProbability}
    proposedValue={getPendingValue('netProbability')}
  />
)}
```

**For Net Impact (around line 419-425):**
Same pattern as above.

5. Update the section header to show count for non-Managers:
Before the form fields, if user has pending changes, show summary:
```tsx
{!isManager && myPendingChanges.length > 0 && (
  <div className="mb-4 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
    <p className="text-sm text-amber-400">
      You have {myPendingChanges.length} pending {myPendingChanges.length === 1 ? 'change' : 'changes'} awaiting Manager approval
    </p>
  </div>
)}
```
  </action>
  <verify>
1. Switch to Risk Manager role
2. Enable four-eye approval
3. Open ControlDetailPanel for any control
4. Edit a field (name, description, type, or score)
5. Save the change (it creates pending change)
6. Verify inline indicator shows below the field: "Pending approval: oldValue -> newValue"
7. Verify summary banner shows "You have 1 pending change awaiting Manager approval"
8. Switch to Manager role - verify pending indicators are NOT shown (Manager sees pending changes section instead)
  </verify>
  <done>Risk Manager sees inline indicators showing their proposed values vs current values for all pending fields</done>
</task>

<task type="auto">
  <name>Task 2: Make rejection feedback more prominent</name>
  <files>src/components/controls/ControlDetailPanel.tsx</files>
  <action>
**Current problem (from verification, lines 329-365):**
- Rejected changes section exists but only shows below pending changes
- Placement is not prominent
- No alert/banner when opening a control with rejected changes
- No inline highlighting of rejected fields

**Fix - Add prominent rejection alert and inline indicators:**

1. Add alert banner at top of content area when rejected changes exist (for non-Manager):

Find the Content div (around line 234: `<div className="flex-1 overflow-auto p-4 space-y-6">`).

Add at the very start of this div, BEFORE the pending changes section:
```tsx
{/* Rejection Alert Banner - Non-Manager Only */}
{!isManager && rejectedChanges.length > 0 && (
  <div className="flex items-start gap-3 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
    <AlertTriangle size={20} className="text-red-400 flex-shrink-0 mt-0.5" />
    <div>
      <h4 className="text-sm font-medium text-red-400">
        {rejectedChanges.length} {rejectedChanges.length === 1 ? 'change was' : 'changes were'} rejected
      </h4>
      <p className="text-xs text-text-secondary mt-1">
        Your recent changes were not approved. Review the feedback below and revise if needed.
      </p>
    </div>
  </div>
)}
```

2. Create helper to check if a field was rejected:
```typescript
const getRejectedForField = (field: string): PendingChange | undefined => {
  return rejectedChanges.find(c => c.proposedValues[field] !== undefined)
}
```

3. Create RejectedFieldIndicator component:
```tsx
function RejectedFieldIndicator({
  field,
  rejectedChange,
  onRevise,
}: {
  field: string
  rejectedChange: PendingChange
  onRevise: (change: PendingChange) => void
}) {
  return (
    <div className="mt-1 px-2 py-1.5 bg-red-500/10 border border-red-500/30 rounded text-xs">
      <div className="flex items-center justify-between">
        <div>
          <span className="text-red-400">Rejected:</span>
          <span className="text-text-secondary ml-1">
            Your change to "{String(rejectedChange.proposedValues[field])}" was not approved
          </span>
        </div>
        <button
          onClick={() => onRevise(rejectedChange)}
          className="px-2 py-0.5 text-xs text-accent-400 hover:text-accent-300 transition-colors"
        >
          Revise
        </button>
      </div>
      {rejectedChange.rejectionReason && (
        <p className="text-text-muted mt-1">Reason: {rejectedChange.rejectionReason}</p>
      )}
    </div>
  )
}
```

4. Add rejection indicators to form fields (non-Manager only):

**For Name field:**
After the input and any pending indicator:
```tsx
{!isManager && getRejectedForField('name') && (
  <RejectedFieldIndicator
    field="name"
    rejectedChange={getRejectedForField('name')!}
    onRevise={handleReviseAndResubmit}
  />
)}
```

Apply same pattern to Description, Type, Net Probability, Net Impact fields.

5. Move the existing Rejected Changes Section (lines 329-365) higher in the layout:
- Currently it's placed AFTER the Manager pending section
- Move it to appear BEFORE the Control Info section
- Keep it below the new alert banner

The order should be:
1. Rejection Alert Banner (new, very top, prominent)
2. Pending Changes Section (Manager only, collapsible)
3. Rejected Changes Section (non-Manager only) - EXISTING, move higher
4. My Pending Changes Summary (non-Manager only, new)
5. Control Info (form fields with inline indicators)
6. Linked Risks section

6. Add visual highlighting to rejected fields:
Wrap each form field div with conditional border:
```tsx
<div className={getRejectedForField('name') ? 'ring-1 ring-red-500/50 rounded-lg p-2 -m-2' : ''}>
  {/* existing label and input */}
</div>
```
  </action>
  <verify>
1. As Manager, reject a Risk Manager's change with a reason
2. Switch to Risk Manager role
3. Open the control with rejected change
4. Verify alert banner at top: "1 change was rejected - Your recent changes were not approved..."
5. Verify rejected field has red ring highlight
6. Verify inline rejection indicator shows: "Rejected: Your change to X was not approved" with reason
7. Verify "Revise" button in inline indicator opens revision flow
8. Verify the rejected changes section appears above the form fields
  </verify>
  <done>Rejection feedback is prominent with alert banner on open, inline field indicators, and red highlighting on rejected fields</done>
</task>

</tasks>

<verification>
**Gap 3 (Risk Manager cannot see proposed values):**
- [ ] Risk Manager sees summary: "You have N pending changes awaiting approval"
- [ ] Inline indicator below each pending field shows: "Pending approval: currentValue -> proposedValue"
- [ ] Pending indicators only appear for non-Manager roles
- [ ] Multiple pending changes on same control all show their indicators

**Gap 4 (Rejection feedback not prominent):**
- [ ] Alert banner appears at top when opening control with rejected changes
- [ ] Alert shows count and friendly message to review and revise
- [ ] Rejected fields have red ring highlight
- [ ] Inline rejection indicator shows on each rejected field
- [ ] Rejection reason displayed inline
- [ ] "Revise" button available inline for quick resubmission
- [ ] Rejected changes section appears before form fields (not buried below)
</verification>

<success_criteria>
- Risk Manager can see all their pending proposed values inline with current values
- Alert banner immediately visible when control has rejected changes
- Rejected fields visually highlighted with red ring
- Rejection reason shown inline next to the rejected field
- Quick "Revise" action available without scrolling
- Manager role sees their separate pending changes management UI unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/16-four-eye-approval/16-07-SUMMARY.md`
</output>
