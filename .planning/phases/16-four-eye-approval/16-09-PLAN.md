---
phase: 16-four-eye-approval
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/controls/ControlDetailPanel.tsx
  - src/components/rct/ControlPanel.tsx
  - src/components/approval/DiffViewer.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can edit multiple fields without auto-submitting to approval"
    - "Draft changes remain visible in form until explicitly submitted"
    - "Send for Approval button appears when there are unsaved changes (non-Manager)"
    - "Save Changes button applies directly for Manager role"
    - "Internal metadata fields (_linkId, etc.) are hidden from diff viewer"
  artifacts:
    - path: "src/components/controls/ControlDetailPanel.tsx"
      provides: "Draft state management and explicit submission workflow"
      contains: "draftChanges"
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Draft state management and explicit submission workflow"
      contains: "draftChanges"
    - path: "src/components/approval/DiffViewer.tsx"
      provides: "Filtered diff display excluding internal metadata"
      contains: "startsWith('_')"
  key_links:
    - from: "ControlDetailPanel.tsx"
      to: "approvalStore"
      via: "createPendingChange on explicit submit"
      pattern: "handleSendForApproval.*createPendingChange"
    - from: "DiffViewer.tsx"
      to: "proposedValues filter"
      via: "filter out underscore-prefixed fields"
      pattern: "filter.*startsWith.*_"
---

<objective>
Implement explicit "Send for Approval" workflow and filter internal metadata from diff viewer.

Purpose: Fix UX issues where field changes auto-submit to approval (reverting visible values) and internal metadata (_linkId) appears in approval diffs.
Output: Draft-based editing with explicit submission button, clean diff viewer without internal fields.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-four-eye-approval/16-08-SUMMARY.md

@src/components/controls/ControlDetailPanel.tsx
@src/components/rct/ControlPanel.tsx
@src/components/approval/DiffViewer.tsx
@src/stores/approvalStore.ts
@src/hooks/useApprovalAwareUpdate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add draft state and explicit submission to ControlDetailPanel</name>
  <files>src/components/controls/ControlDetailPanel.tsx</files>
  <action>
Refactor ControlDetailPanel to use draft-based editing with explicit submission:

1. Add draft state tracking:
   ```typescript
   const [draftChanges, setDraftChanges] = useState<Record<string, unknown>>({})
   const hasDraftChanges = Object.keys(draftChanges).length > 0
   ```

2. Remove auto-submission from field handlers (handleNameBlur, handleDescriptionBlur, handleTypeChange, handleScoreChange):
   - Instead of calling updateControlWithApproval on blur/change, update draftChanges state
   - Keep localName and localDescription synced with draft state
   - Form fields should display draft value if exists, otherwise current value

3. Update field change handlers to accumulate drafts:
   ```typescript
   const handleNameChange = (newName: string) => {
     setLocalName(newName)
   }

   const handleNameBlur = () => {
     if (localName !== control.name && localName.trim()) {
       setDraftChanges(prev => ({ ...prev, name: localName.trim() }))
     }
   }
   ```

4. Add submission button in header area (after pending changes badge):
   - For non-Manager: "Send for Approval" button (amber/accent color)
   - For Manager: "Save Changes" button (green color)
   - Both buttons only visible when hasDraftChanges is true

5. Implement submission handler:
   ```typescript
   const handleSubmitChanges = () => {
     if (!hasDraftChanges) return

     if (isManager) {
       // Apply changes directly
       updateControl(control.id, draftChanges as Partial<typeof control>)
     } else {
       // Create single pending change with all draft fields
       const currentValues: Record<string, unknown> = {}
       for (const key of Object.keys(draftChanges)) {
         currentValues[key] = control[key as keyof typeof control]
       }
       createPendingChange({
         entityType: 'control',
         entityId: control.id,
         entityName: control.name,
         changeType: 'update',
         proposedValues: draftChanges,
         currentValues,
         submittedBy: role,
       })
     }
     setDraftChanges({})
   }
   ```

6. Add visual indicator when draft changes exist:
   - Show subtle border or background highlight on fields with draft changes
   - Consider adding "Unsaved changes" text near the button

7. Reset draft state when control changes (useEffect on control.id)

8. Handle dialog close:
   - If hasDraftChanges, optionally warn user or just clear drafts
   - Current approach: blur first (already exists), then clear drafts on close
  </action>
  <verify>
Test in browser:
1. As Control Owner, edit name field - change should NOT auto-submit
2. Edit multiple fields (name, description, type) - all changes stay visible
3. "Send for Approval" button appears
4. Click button - ONE pending change created with ALL field changes
5. As Manager, same flow but "Save Changes" applies directly
  </verify>
  <done>Non-manager can edit multiple fields, see draft changes, and explicitly submit all changes as one pending change. Manager can save directly.</done>
</task>

<task type="auto">
  <name>Task 2: Add draft state and explicit submission to ControlPanel</name>
  <files>src/components/rct/ControlPanel.tsx</files>
  <action>
Apply the same draft-based editing pattern to ControlPanel (RCT embedded controls and linked controls):

1. Add per-control draft state:
   ```typescript
   // Track drafts per control ID
   const [controlDrafts, setControlDrafts] = useState<Record<string, Record<string, unknown>>>({})

   const getDraftForControl = (controlId: string) => controlDrafts[controlId] || {}
   const hasDraftForControl = (controlId: string) => Object.keys(getDraftForControl(controlId)).length > 0
   ```

2. Update BlurCommitInput and BlurCommitTextarea usage:
   - On blur, instead of calling handleEmbeddedControlUpdateWithApproval, update controlDrafts
   - Display draft value if exists, otherwise current value

3. For embedded controls (row.controls):
   - Update onCommit handlers to accumulate drafts instead of submitting
   - Add "Send for Approval" / "Save Changes" button per control card (in header area)

4. For linked controls (linkedControls):
   - Same pattern: accumulate drafts, show submission button
   - Handle per-link score changes similarly (accumulate in draft with _linkId metadata)

5. Implement per-control submission:
   ```typescript
   const handleSubmitControlChanges = (controlId: string, controlName: string, isEmbedded: boolean) => {
     const drafts = getDraftForControl(controlId)
     if (Object.keys(drafts).length === 0) return

     if (isManager) {
       if (isEmbedded) {
         updateControl(row.id, controlId, drafts as Partial<Control>)
       } else {
         updateHubControl(controlId, drafts as Partial<Control>)
       }
     } else {
       // Create pending change
       const control = isEmbedded
         ? row.controls.find(c => c.id === controlId)
         : controls.find(c => c.id === controlId)
       const currentValues: Record<string, unknown> = {}
       for (const key of Object.keys(drafts)) {
         currentValues[key] = control?.[key as keyof Control]
       }
       createPendingChange({
         entityType: 'control',
         entityId: controlId,
         entityName: controlName,
         changeType: 'update',
         proposedValues: drafts,
         currentValues,
         submittedBy: role,
       })
     }

     // Clear drafts for this control
     setControlDrafts(prev => {
       const next = { ...prev }
       delete next[controlId]
       return next
     })
   }
   ```

6. Add submission button to each control card:
   - Position: In the control header, after the badges
   - Style: Compact button, amber for non-manager, green for manager
   - Only visible when that control has draft changes

7. Clear all drafts when dialog closes

Note: Remove the notification toast for auto-submission ("Change submitted for approval") since changes are now explicitly submitted.
  </action>
  <verify>
Test in browser:
1. Open ControlPanel for a risk
2. As Control Owner, edit control name - no auto-submit, change stays visible
3. Edit type, description, scores - all accumulate as drafts
4. "Send for Approval" button appears on that control card
5. Click - ONE pending change created with all edits for that control
6. As Manager, "Save Changes" applies directly
  </verify>
  <done>ControlPanel supports draft-based editing with explicit per-control submission for both embedded and linked controls.</done>
</task>

<task type="auto">
  <name>Task 3: Filter internal metadata from DiffViewer</name>
  <files>src/components/approval/DiffViewer.tsx</files>
  <action>
Filter out internal metadata fields (prefixed with underscore) from the diff display:

1. Update the fields extraction to filter out internal fields:
   ```typescript
   // Filter out internal metadata fields (start with _)
   const fields = Object.keys(proposedValues).filter(field => !field.startsWith('_'))
   ```

2. This will hide:
   - `_linkId` - internal reference for per-link score tracking
   - Any future internal metadata fields following the same convention

3. The filtering happens before rendering, so these fields won't appear in the diff at all.

4. Add a comment explaining the convention:
   ```typescript
   // Filter out internal metadata fields (prefixed with _)
   // These are used for implementation details like _linkId for per-link tracking
   // and should not be shown to users in the approval diff
   const fields = Object.keys(proposedValues).filter(field => !field.startsWith('_'))
   ```

This is a minimal, focused fix that maintains the existing component structure.
  </action>
  <verify>
Test in browser:
1. As Control Owner, change a per-link score (if approval required)
2. As Manager, view the pending change
3. Confirm _linkId does NOT appear in the diff viewer
4. Only the actual field change (link_netProbability, link_netImpact) is shown
  </verify>
  <done>DiffViewer filters out all underscore-prefixed internal metadata fields from display.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Test full editing workflow in ControlDetailPanel:
   - Edit name, description, type, scores
   - Changes visible in form (not reverted)
   - "Send for Approval" button appears
   - Submit creates ONE pending change with all fields

2. Test full editing workflow in ControlPanel:
   - Edit embedded control fields
   - Edit linked control fields
   - Per-control submission buttons work correctly

3. Verify DiffViewer filtering:
   - No _linkId or other _ prefixed fields in any diff display

4. Verify Manager direct save works in both panels

5. Build check: `npm run build` passes
</verification>

<success_criteria>
- Editing fields no longer auto-submits to approval
- Draft changes remain visible in form until explicit submission
- "Send for Approval" button appears when drafts exist (non-Manager)
- "Save Changes" button for Manager applies directly
- Single pending change created for all draft edits on submit
- Internal metadata (_linkId) hidden from diff viewer
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-four-eye-approval/16-09-SUMMARY.md`
</output>
