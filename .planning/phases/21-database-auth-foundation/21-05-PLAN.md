---
phase: 21-database-auth-foundation
plan: 05
type: execute
wave: 3
depends_on: [21-03]
files_modified:
  - src/pages/VerifyEmailPage.tsx
  - src/pages/AuthConfirmPage.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Unverified users see clear instructions to check their email (AUTH-02)"
    - "Email verification link properly confirms the user's email"
    - "After verification, user can access the application"
    - "Routes for auth pages are properly configured"
  artifacts:
    - path: "src/pages/VerifyEmailPage.tsx"
      provides: "Instructions page for unverified users"
      min_lines: 50
    - path: "src/pages/AuthConfirmPage.tsx"
      provides: "Handler for email verification links"
      min_lines: 50
    - path: "src/App.tsx"
      provides: "Updated routes including auth pages"
      contains: "path=\"signup\""
  key_links:
    - from: "src/pages/AuthConfirmPage.tsx"
      to: "@supabase/supabase-js"
      via: "verifyOtp method"
      pattern: "supabase\\.auth\\.verifyOtp"
    - from: "src/App.tsx"
      to: "All auth pages"
      via: "Route definitions"
      pattern: "<Route path="
---

<objective>
Create email verification pages and configure all auth routes.

Purpose: Complete the email verification flow (AUTH-02) and wire up all authentication pages to the router. Users who haven't verified their email need clear instructions, and the verification link must work properly.
Output: VerifyEmailPage for unverified users, AuthConfirmPage for verification links, and all routes configured.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-database-auth-foundation/21-RESEARCH.md

# Reference for existing routing
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VerifyEmailPage</name>
  <files>src/pages/VerifyEmailPage.tsx</files>
  <action>
Create page shown to users who haven't verified their email.

This page:
- Shows instructions to check their email
- Displays the email address (from location state or auth context)
- Has button to resend verification email
- Has link to go back to login

```typescript
import { useState } from 'react'
import { Link, useLocation } from 'react-router'
import { motion } from 'motion/react'
import { Mail, RefreshCw, ArrowLeft, CheckCircle } from 'lucide-react'
import { supabase } from '@/lib/supabase/client'
import { useAuth } from '@/contexts/AuthContext'

export function VerifyEmailPage() {
  const location = useLocation()
  const { user } = useAuth()
  const [isResending, setIsResending] = useState(false)
  const [resendSuccess, setResendSuccess] = useState(false)
  const [error, setError] = useState('')

  // Get email from location state or current user
  const email = (location.state as { email?: string })?.email || user?.email || ''

  const handleResend = async () => {
    if (!email) return

    setIsResending(true)
    setError('')

    const { error } = await supabase.auth.resend({
      type: 'signup',
      email,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/confirm`,
      },
    })

    setIsResending(false)

    if (error) {
      setError(error.message)
      return
    }

    setResendSuccess(true)
  }

  return (
    // Similar styling to LoginPage
    // Centered card with:
    // - Mail icon
    // - "Verify your email" heading
    // - "We sent a verification link to {email}"
    // - "Click the link in your email to verify your account"
    // - Resend button (with success state)
    // - Link back to login
  )
}
```

Design should match the LoginPage style (gradient background, card, animations).
  </action>
  <verify>VerifyEmailPage.tsx exists with resend functionality</verify>
  <done>VerifyEmailPage shows instructions and allows resending verification email</done>
</task>

<task type="auto">
  <name>Task 2: Create AuthConfirmPage</name>
  <files>src/pages/AuthConfirmPage.tsx</files>
  <action>
Create page that handles email verification links from Supabase.

When user clicks verification link in email, they land on this page with tokens in URL.

Following RESEARCH.md pattern:
```typescript
import { useEffect, useState } from 'react'
import { useNavigate, useSearchParams } from 'react-router'
import { motion } from 'motion/react'
import { CheckCircle, XCircle, Loader2 } from 'lucide-react'
import { supabase } from '@/lib/supabase/client'

export function AuthConfirmPage() {
  const [searchParams] = useSearchParams()
  const [status, setStatus] = useState<'verifying' | 'success' | 'error'>('verifying')
  const [error, setError] = useState<string | null>(null)
  const navigate = useNavigate()

  useEffect(() => {
    const verifyEmail = async () => {
      // Supabase email links can use different formats
      // Check for token_hash (new format) or access_token (PKCE flow)
      const tokenHash = searchParams.get('token_hash')
      const type = searchParams.get('type')

      if (tokenHash && type === 'email') {
        // Email verification via token_hash
        const { error } = await supabase.auth.verifyOtp({
          token_hash: tokenHash,
          type: 'email',
        })

        if (error) {
          setStatus('error')
          setError(error.message)
          return
        }

        setStatus('success')
        // Redirect to app after short delay
        setTimeout(() => navigate('/', { replace: true }), 2000)
        return
      }

      // If no token_hash, Supabase might handle it automatically via URL
      // Check if we have an active session
      const { data: { session } } = await supabase.auth.getSession()
      if (session?.user?.email_confirmed_at) {
        setStatus('success')
        setTimeout(() => navigate('/', { replace: true }), 2000)
        return
      }

      // If nothing worked, show error
      setStatus('error')
      setError('Invalid or expired verification link')
    }

    verifyEmail()
  }, [searchParams, navigate])

  return (
    // Similar layout to LoginPage
    // Show:
    // - verifying: spinner + "Verifying your email..."
    // - success: checkmark + "Email verified!" + "Redirecting..."
    // - error: X icon + error message + link to resend
  )
}
```
  </action>
  <verify>AuthConfirmPage.tsx handles verifyOtp flow</verify>
  <done>AuthConfirmPage verifies email and redirects to app on success</done>
</task>

<task type="auto">
  <name>Task 3: Configure all auth routes in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Update App.tsx to add routes for all auth pages.

Add imports for new pages:
```typescript
import { SignupPage } from './pages/SignupPage'
import { ForgotPasswordPage } from './pages/ForgotPasswordPage'
import { ResetPasswordPage } from './pages/ResetPasswordPage'
import { VerifyEmailPage } from './pages/VerifyEmailPage'
import { AuthConfirmPage } from './pages/AuthConfirmPage'
```

Add routes OUTSIDE the ProtectedRoute (these are public):
```typescript
<Routes>
  {/* Public auth routes */}
  <Route path="login" element={<LoginPage />} />
  <Route path="signup" element={<SignupPage />} />
  <Route path="forgot-password" element={<ForgotPasswordPage />} />
  <Route path="verify-email" element={<VerifyEmailPage />} />

  {/* Auth callback routes */}
  <Route path="auth/confirm" element={<AuthConfirmPage />} />
  <Route path="auth/reset-password" element={<ResetPasswordPage />} />

  {/* Protected routes */}
  <Route element={<ProtectedRoute />}>
    {/* ... existing protected routes ... */}
  </Route>
</Routes>
```

Route summary:
- `/login` - Login form
- `/signup` - Registration form
- `/forgot-password` - Request password reset
- `/verify-email` - Instructions for unverified users
- `/auth/confirm` - Email verification link handler
- `/auth/reset-password` - Set new password (from reset email)
  </action>
  <verify>App.tsx has routes for all six auth pages</verify>
  <done>All auth routes configured: login, signup, forgot-password, verify-email, auth/confirm, auth/reset-password</done>
</task>

</tasks>

<verification>
- [ ] VerifyEmailPage shows email address and has resend button
- [ ] AuthConfirmPage handles verifyOtp and redirects on success
- [ ] App.tsx imports all auth pages
- [ ] All six auth routes are defined
- [ ] Auth routes are OUTSIDE ProtectedRoute
- [ ] auth/confirm and auth/reset-password routes exist for email callbacks
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
Complete email verification flow works: user signs up, receives email, clicks link, gets verified, can access app.
</success_criteria>

<output>
After completion, create `.planning/phases/21-database-auth-foundation/21-05-SUMMARY.md`
</output>
