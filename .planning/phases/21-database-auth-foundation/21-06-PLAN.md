---
phase: 21-database-auth-foundation
plan: 06
type: execute
wave: 4
depends_on: [21-02, 21-03]
files_modified:
  - src/hooks/useAuthEvents.ts
  - src/contexts/AuthContext.tsx
  - supabase/migrations/00006_app_user_role.sql
autonomous: false
user_setup:
  - service: supabase
    why: "Apply database migrations"
    dashboard_config:
      - task: "Run migrations via SQL Editor or supabase db push"
        location: "Supabase Dashboard -> SQL Editor -> paste migration files"

must_haves:
  truths:
    - "Authentication events are logged to auth_events table (SEC-02)"
    - "Login, logout, signup, password reset events are captured"
    - "app_user role exists without BYPASSRLS permission (DB-04)"
    - "Rate limiting is configured for auth endpoints (SEC-03)"
  artifacts:
    - path: "src/hooks/useAuthEvents.ts"
      provides: "Hook for logging auth events"
      exports: ["useAuthEvents"]
    - path: "supabase/migrations/00006_app_user_role.sql"
      provides: "Restricted database role for app queries"
      contains: "CREATE ROLE app_user"
  key_links:
    - from: "src/contexts/AuthContext.tsx"
      to: "src/hooks/useAuthEvents.ts"
      via: "Auth event logging"
      pattern: "logAuthEvent"
    - from: "src/hooks/useAuthEvents.ts"
      to: "public.auth_events"
      via: "Supabase insert"
      pattern: "auth_events"
---

<objective>
Implement security features: auth event logging, restricted database role, and configure rate limiting.

Purpose: Meet security requirements SEC-02 (auth event logging), SEC-03 (rate limiting), and DB-04 (restricted role). These are compliance essentials for enterprise deployment.
Output: Auth events logged to database, app_user role created, rate limiting verified.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-database-auth-foundation/21-RESEARCH.md

# Need to update AuthContext to log events
@src/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAuthEvents hook for logging</name>
  <files>src/hooks/useAuthEvents.ts</files>
  <action>
Create hook to log authentication events to the auth_events table.

SEC-02 requires logging: login, logout, login_failed, signup, password_reset_request, password_reset_complete, email_verified.

```typescript
import { supabase } from '@/lib/supabase/client'
import { useAuth } from '@/contexts/AuthContext'

type AuthEventType =
  | 'login'
  | 'logout'
  | 'login_failed'
  | 'signup'
  | 'password_reset_request'
  | 'password_reset_complete'
  | 'email_verified'

interface LogAuthEventParams {
  eventType: AuthEventType
  email?: string
  metadata?: Record<string, unknown>
}

export function useAuthEvents() {
  const { tenantId, user } = useAuth()

  const logAuthEvent = async ({ eventType, email, metadata = {} }: LogAuthEventParams) => {
    try {
      // Get browser info
      const userAgent = navigator.userAgent

      await supabase.from('auth_events').insert({
        tenant_id: tenantId,
        user_id: user?.id || null,
        event_type: eventType,
        email: email || user?.email || null,
        user_agent: userAgent,
        // Note: IP address not available client-side, would need Edge Function
        ip_address: null,
        metadata,
      })
    } catch (error) {
      // Don't throw - logging should not break auth flow
      console.error('Failed to log auth event:', error)
    }
  }

  return { logAuthEvent }
}

// Standalone function for use outside React components
export async function logAuthEventStandalone({
  eventType,
  email,
  tenantId,
  userId,
  metadata = {},
}: {
  eventType: AuthEventType
  email?: string
  tenantId?: string | null
  userId?: string | null
  metadata?: Record<string, unknown>
}) {
  try {
    await supabase.from('auth_events').insert({
      tenant_id: tenantId || null,
      user_id: userId || null,
      event_type: eventType,
      email: email || null,
      user_agent: navigator.userAgent,
      ip_address: null,
      metadata,
    })
  } catch (error) {
    console.error('Failed to log auth event:', error)
  }
}
```

Note: IP address logging requires server-side (Edge Function). For now, log null. Can enhance in Phase 25 (Production Hardening) if compliance requires it.
  </action>
  <verify>src/hooks/useAuthEvents.ts exports logAuthEvent function</verify>
  <done>useAuthEvents hook created for logging auth events to database</done>
</task>

<task type="auto">
  <name>Task 2: Integrate auth event logging into AuthContext</name>
  <files>src/contexts/AuthContext.tsx</files>
  <action>
Update AuthContext to log auth events on key actions.

Add logging calls to:
- signIn: log 'login' on success, 'login_failed' on error
- signUp: log 'signup' on success
- signOut: log 'logout'
- resetPassword: log 'password_reset_request'
- updatePassword: log 'password_reset_complete'

Also listen to onAuthStateChange for email verification:
```typescript
const { data: { subscription } } = supabase.auth.onAuthStateChange(
  async (event, session) => {
    setSession(session)

    // Log auth events
    if (event === 'SIGNED_IN') {
      // Note: Don't log here - handled by signIn method
    } else if (event === 'SIGNED_OUT') {
      // Note: Don't log here - handled by signOut method
    } else if (event === 'USER_UPDATED' && session?.user?.email_confirmed_at) {
      // Email was just verified
      await logAuthEventStandalone({
        eventType: 'email_verified',
        email: session.user.email,
        tenantId: session.user.app_metadata?.tenant_id,
        userId: session.user.id,
      })
    }
  }
)
```

Update signIn:
```typescript
const signIn = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })

  if (error) {
    // Log failed login attempt
    await logAuthEventStandalone({
      eventType: 'login_failed',
      email,
      metadata: { error: error.message },
    })
    return { error }
  }

  // Log successful login
  await logAuthEventStandalone({
    eventType: 'login',
    email,
    tenantId: data.user?.app_metadata?.tenant_id,
    userId: data.user?.id,
  })

  return { error: null }
}
```

Similar pattern for signUp, signOut, resetPassword, updatePassword.
  </action>
  <verify>AuthContext calls logAuthEventStandalone on auth actions</verify>
  <done>Auth events (login, logout, signup, password_reset, email_verified) are logged</done>
</task>

<task type="auto">
  <name>Task 3: Create app_user role migration</name>
  <files>supabase/migrations/00006_app_user_role.sql</files>
  <action>
Create migration for DB-04: restricted app_user role without BYPASSRLS.

This role will be used for application queries to ensure RLS is always enforced.

```sql
-- Create restricted role for application queries (DB-04)
-- This role does NOT have BYPASSRLS, ensuring RLS is always enforced

-- Create the role if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'app_user') THEN
    CREATE ROLE app_user NOLOGIN;
  END IF;
END
$$;

-- Grant minimal permissions
GRANT USAGE ON SCHEMA public TO app_user;

-- Grant SELECT, INSERT, UPDATE, DELETE on all existing tables
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;

-- Grant the same for future tables
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;

-- Grant USAGE on sequences (for auto-generated IDs)
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE ON SEQUENCES TO app_user;

-- IMPORTANT: Do NOT grant BYPASSRLS
-- The 'authenticated' role inherits from app_user but RLS is enforced

COMMENT ON ROLE app_user IS 'Application role with RLS enforced - no BYPASSRLS permission';
```

Note: Supabase's 'authenticated' role is used for logged-in users. This app_user role provides the base permissions. RLS policies use `TO authenticated` which works correctly.
  </action>
  <verify>00006_app_user_role.sql exists with CREATE ROLE statement</verify>
  <done>app_user role migration created without BYPASSRLS permission</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-built>Database migrations and auth event logging ready</what-built>
  <action>
Apply all migrations to Supabase:

Option 1 - Via SQL Editor (simplest):
1. Go to Supabase Dashboard -> SQL Editor
2. Run each migration file in order:
   - 00001_tenants.sql
   - 00002_profiles.sql
   - 00003_rls_helper_functions.sql
   - 00004_audit_log.sql
   - 00005_auth_events.sql
   - 00006_app_user_role.sql

Option 2 - Via Supabase CLI (if linked):
```bash
supabase db push
```

After migrations:
1. Verify tables exist in Database -> Tables
2. Verify RLS is enabled (lock icon on tables)
3. Verify auth.tenant_id() function exists in Database -> Functions

Also verify rate limiting (SEC-03):
1. Go to Authentication -> Rate Limits
2. Verify default rate limits are in place (Supabase enables by default)
3. For production, consider stricter limits in Settings
  </action>
  <how-to-verify>
1. In Supabase Dashboard -> Database -> Tables: see tenants, profiles, audit_log, auth_events
2. Each table (except tenants) shows lock icon indicating RLS enabled
3. Database -> Functions shows auth.tenant_id() and auth.user_role()
4. Authentication -> Rate Limits shows rate limiting enabled
  </how-to-verify>
  <resume-signal>Type "migrations applied" when all tables and functions are visible in Supabase dashboard</resume-signal>
</task>

</tasks>

<verification>
- [ ] useAuthEvents hook exists with logAuthEvent function
- [ ] AuthContext logs events on signIn, signUp, signOut, resetPassword, updatePassword
- [ ] 00006_app_user_role.sql creates role without BYPASSRLS
- [ ] All 6 migrations applied to Supabase
- [ ] Tables visible in dashboard: tenants, profiles, audit_log, auth_events
- [ ] RLS enabled on profiles, audit_log, auth_events
- [ ] Functions exist: auth.tenant_id(), auth.user_role()
- [ ] Rate limiting enabled (SEC-03 - Supabase default)
</verification>

<success_criteria>
Security infrastructure complete: auth events are logged (SEC-02), database has restricted role (DB-04), rate limiting is active (SEC-03).
</success_criteria>

<output>
After completion, create `.planning/phases/21-database-auth-foundation/21-06-SUMMARY.md`
</output>
