---
phase: 21-database-auth-foundation
plan: 07
type: execute
wave: 5
depends_on: [21-04, 21-05, 21-06]
files_modified:
  - supabase/migrations/00007_cors_config.sql
  - src/lib/supabase/types.ts
autonomous: false

must_haves:
  truths:
    - "User can complete full signup -> verify email -> login flow"
    - "User can complete forgot password -> reset password flow"
    - "Session persists across browser refresh (AUTH-04)"
    - "Protected routes redirect unauthenticated users to login"
    - "Database types are generated from schema"
  artifacts:
    - path: "src/lib/supabase/types.ts"
      provides: "Generated database types"
      contains: "public.tenants"
  key_links:
    - from: "Full auth flow"
      to: "All auth pages"
      via: "User journey"
      pattern: "signup -> verify -> login"
---

<objective>
Configure CORS, generate database types, and verify complete authentication flow.

Purpose: Finalize Phase 21 by configuring CORS (SEC-05), generating TypeScript types from schema, and verifying the complete authentication flow works end-to-end.
Output: CORS configured, types generated, full auth flow verified working.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-database-auth-foundation/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document CORS configuration</name>
  <files>supabase/migrations/00007_cors_config.sql</files>
  <action>
CORS for Supabase is configured via dashboard, not SQL. Create a documentation migration file.

SEC-05 requires restricting API access to allowed origins.

Create `supabase/migrations/00007_cors_config.sql`:
```sql
-- CORS Configuration (SEC-05)
-- Note: CORS is configured via Supabase Dashboard, not SQL
--
-- Required Configuration:
-- 1. Go to Supabase Dashboard -> Settings -> API
-- 2. Under "CORS Allowed Origins", add:
--    - http://localhost:5173 (development)
--    - https://your-production-domain.com (production)
--
-- For production deployment:
-- - Remove localhost origins
-- - Add only the specific production domain
-- - Do NOT use wildcard (*) in production
--
-- Supabase PostgREST automatically handles CORS headers based on this config.
-- See: https://supabase.com/docs/guides/api/cors

-- This file serves as documentation only.
-- No SQL execution needed.

SELECT 'CORS configuration documented - configure via Supabase Dashboard' as note;
```

The actual CORS config will be done via dashboard checkpoint.
  </action>
  <verify>00007_cors_config.sql exists with documentation</verify>
  <done>CORS configuration documented in migration file</done>
</task>

<task type="auto">
  <name>Task 2: Generate database types</name>
  <files>src/lib/supabase/types.ts</files>
  <action>
Generate TypeScript types from the Supabase schema.

Two approaches:

**Option A - Via Supabase CLI (preferred):**
```bash
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > src/lib/supabase/types.ts
```

**Option B - Manual type definition (if CLI not linked):**
Create types.ts based on the schema we created:

```typescript
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export interface Database {
  public: {
    Tables: {
      tenants: {
        Row: {
          id: string
          name: string
          slug: string
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          name: string
          slug: string
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          name?: string
          slug?: string
          created_at?: string
          updated_at?: string
        }
      }
      profiles: {
        Row: {
          id: string
          tenant_id: string
          full_name: string | null
          role: 'director' | 'manager' | 'risk-manager' | 'control-owner' | 'control-tester'
          is_active: boolean
          created_at: string
          updated_at: string
        }
        Insert: {
          id: string
          tenant_id: string
          full_name?: string | null
          role?: 'director' | 'manager' | 'risk-manager' | 'control-owner' | 'control-tester'
          is_active?: boolean
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          tenant_id?: string
          full_name?: string | null
          role?: 'director' | 'manager' | 'risk-manager' | 'control-owner' | 'control-tester'
          is_active?: boolean
          created_at?: string
          updated_at?: string
        }
      }
      audit_log: {
        Row: {
          id: string
          tenant_id: string
          entity_type: string
          entity_id: string | null
          entity_name: string | null
          change_type: 'create' | 'update' | 'delete'
          old_data: Json | null
          new_data: Json | null
          user_id: string | null
          user_email: string | null
          created_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          entity_type: string
          entity_id?: string | null
          entity_name?: string | null
          change_type: 'create' | 'update' | 'delete'
          old_data?: Json | null
          new_data?: Json | null
          user_id?: string | null
          user_email?: string | null
          created_at?: string
        }
        Update: {
          id?: string
          tenant_id?: string
          entity_type?: string
          entity_id?: string | null
          entity_name?: string | null
          change_type?: 'create' | 'update' | 'delete'
          old_data?: Json | null
          new_data?: Json | null
          user_id?: string | null
          user_email?: string | null
          created_at?: string
        }
      }
      auth_events: {
        Row: {
          id: string
          tenant_id: string | null
          user_id: string | null
          event_type: 'login' | 'logout' | 'login_failed' | 'signup' | 'password_reset_request' | 'password_reset_complete' | 'email_verified'
          email: string | null
          ip_address: string | null
          user_agent: string | null
          metadata: Json
          created_at: string
        }
        Insert: {
          id?: string
          tenant_id?: string | null
          user_id?: string | null
          event_type: 'login' | 'logout' | 'login_failed' | 'signup' | 'password_reset_request' | 'password_reset_complete' | 'email_verified'
          email?: string | null
          ip_address?: string | null
          user_agent?: string | null
          metadata?: Json
          created_at?: string
        }
        Update: {
          id?: string
          tenant_id?: string | null
          user_id?: string | null
          event_type?: 'login' | 'logout' | 'login_failed' | 'signup' | 'password_reset_request' | 'password_reset_complete' | 'email_verified'
          email?: string | null
          ip_address?: string | null
          user_agent?: string | null
          metadata?: Json
          created_at?: string
        }
      }
    }
    Views: Record<string, never>
    Functions: {
      tenant_id: {
        Args: Record<string, never>
        Returns: string | null
      }
      user_role: {
        Args: Record<string, never>
        Returns: string | null
      }
    }
  }
}
```

Update the Supabase client to use the types:
```typescript
// src/lib/supabase/client.ts
import type { Database } from './types'

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey)
```
  </action>
  <verify>types.ts has Database interface with Tables for tenants, profiles, audit_log, auth_events</verify>
  <done>Database types generated and client is typed</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication system with database, context, UI pages, event logging</what-built>
  <how-to-verify>
**Test the complete auth flow:**

1. **Configure CORS (SEC-05):**
   - Go to Supabase Dashboard -> Settings -> API
   - Add `http://localhost:5173` to CORS Allowed Origins
   - Save

2. **Start the app:**
   ```bash
   npm run dev
   ```

3. **Test Signup (AUTH-01):**
   - Navigate to http://localhost:5173/signup
   - Enter email and password (min 8 chars)
   - Click "Create Account"
   - Should see "Check your email" message

4. **Test Email Verification (AUTH-02):**
   - Check email inbox for verification link
   - Click the link
   - Should land on /auth/confirm and redirect to app

5. **Test Login (AUTH-01):**
   - Navigate to /login
   - Enter credentials
   - Should redirect to /taxonomy

6. **Test Session Persistence (AUTH-04):**
   - Refresh the browser
   - Should still be logged in (not redirected to /login)

7. **Test Password Reset (AUTH-03):**
   - Log out
   - Navigate to /forgot-password
   - Enter email, click "Send Reset Link"
   - Check email for reset link
   - Click link, set new password
   - Log in with new password

8. **Test Protected Routes:**
   - Log out
   - Try to navigate to /taxonomy
   - Should redirect to /login

9. **Verify Auth Events (SEC-02):**
   - Go to Supabase Dashboard -> Table Editor -> auth_events
   - Should see login, logout events logged

**Expected Results:**
- All auth flows complete without errors
- Session persists across refresh
- Auth events appear in database
- CORS allows requests from localhost
  </how-to-verify>
  <resume-signal>Type "auth verified" when all flows work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] CORS configured for localhost:5173 in Supabase dashboard
- [ ] Database types generated with all tables
- [ ] Signup flow works (shows email verification message)
- [ ] Email verification link works
- [ ] Login flow works
- [ ] Session persists across browser refresh
- [ ] Password reset flow works
- [ ] Protected routes redirect when unauthenticated
- [ ] Auth events logged to auth_events table
- [ ] No console errors during auth flows
</verification>

<success_criteria>
Phase 21 complete: Users can securely log in (AUTH-01), verify email (AUTH-02), reset password (AUTH-03), maintain sessions (AUTH-04), with all data isolated by tenant (DB-01, DB-02) and security events logged (SEC-01, SEC-02, SEC-03, SEC-05).
</success_criteria>

<output>
After completion, create `.planning/phases/21-database-auth-foundation/21-07-SUMMARY.md`
</output>
