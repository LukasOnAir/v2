---
phase: 22-authorization-user-management
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - supabase/functions/send-invitation/index.ts
  - supabase/functions/accept-invitation/index.ts
  - src/lib/supabase/types.ts
autonomous: true
user_setup:
  - service: resend
    why: "Send invitation emails"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
    dashboard_config:
      - task: "Verify domain or use sandbox (onboarding@resend.dev)"
        location: "Resend Dashboard -> Domains"

must_haves:
  truths:
    - "send-invitation Edge Function creates invitation record and sends email"
    - "accept-invitation Edge Function validates token, creates user, creates profile"
    - "Expired tokens (>7 days) are rejected"
    - "Already-accepted tokens are rejected"
    - "New user gets role in app_metadata from invitation"
  artifacts:
    - path: "supabase/functions/send-invitation/index.ts"
      provides: "Edge Function to send invitation emails"
      contains: "resend"
    - path: "supabase/functions/accept-invitation/index.ts"
      provides: "Edge Function to accept invitation and create user"
      contains: "createUser"
    - path: "src/lib/supabase/types.ts"
      provides: "TypeScript types for invitation"
      contains: "PendingInvitation"
  key_links:
    - from: "send-invitation"
      to: "pending_invitations"
      via: "supabase.from('pending_invitations').insert"
      pattern: "from.*pending_invitations.*insert"
    - from: "accept-invitation"
      to: "auth.admin.createUser"
      via: "Supabase Auth Admin API"
      pattern: "auth.admin.createUser"
---

<objective>
Create Edge Functions for the invitation workflow: sending invitations and accepting them.

Purpose: Implement USER-01 (invite by email), USER-02 (role assignment on invite), and USER-03 (7-day expiry) via secure server-side functions that can access Resend API and Supabase Admin.

Output: Two Supabase Edge Functions and updated TypeScript types for the invitation system.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-authorization-user-management/22-RESEARCH.md
@.planning/phases/22-authorization-user-management/22-01-SUMMARY.md

# Types to extend
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send-invitation Edge Function</name>
  <files>supabase/functions/send-invitation/index.ts</files>
  <action>
Create the send-invitation Edge Function that:
1. Receives { email, role } from authenticated Director
2. Extracts tenantId and invitedBy from the JWT
3. Inserts record into pending_invitations table
4. Sends invitation email via Resend
5. Returns success/error response

Implementation (Deno/Edge runtime):

```typescript
// supabase/functions/send-invitation/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { email, role } = await req.json()

    // Validate input
    if (!email || !role) {
      return new Response(
        JSON.stringify({ error: 'Email and role are required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Validate role is invitable (not director)
    const validRoles = ['manager', 'risk-manager', 'control-owner', 'control-tester']
    if (!validRoles.includes(role)) {
      return new Response(
        JSON.stringify({ error: 'Invalid role' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Get the JWT from Authorization header
    const authHeader = req.headers.get('Authorization')
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: 'Missing authorization header' }),
        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Create Supabase client with user's JWT (for RLS)
    const supabaseUser = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_ANON_KEY')!,
      { global: { headers: { Authorization: authHeader } } }
    )

    // Get current user info from JWT
    const { data: { user }, error: userError } = await supabaseUser.auth.getUser()
    if (userError || !user) {
      return new Response(
        JSON.stringify({ error: 'Unauthorized' }),
        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    const tenantId = user.app_metadata?.tenant_id
    const userRole = user.app_metadata?.role

    // Verify caller is Director
    if (userRole !== 'director') {
      return new Response(
        JSON.stringify({ error: 'Only Directors can invite users' }),
        { status: 403, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    if (!tenantId) {
      return new Response(
        JSON.stringify({ error: 'User has no tenant' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Insert invitation record (RLS will verify Director role)
    const { data: invitation, error: insertError } = await supabaseUser
      .from('pending_invitations')
      .insert({
        tenant_id: tenantId,
        email: email.toLowerCase().trim(),
        role,
        invited_by: user.id,
      })
      .select()
      .single()

    if (insertError) {
      // Handle duplicate invitation
      if (insertError.code === '23505') {
        return new Response(
          JSON.stringify({ error: 'User already has a pending invitation' }),
          { status: 409, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        )
      }
      throw insertError
    }

    // Send email via Resend
    const resendApiKey = Deno.env.get('RESEND_API_KEY')
    if (!resendApiKey) {
      console.error('RESEND_API_KEY not configured')
      // Still return success - invitation created, email will be sent when configured
      return new Response(
        JSON.stringify({
          success: true,
          invitationId: invitation.id,
          emailSent: false,
          message: 'Invitation created but email service not configured'
        }),
        { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    const appUrl = Deno.env.get('APP_URL') || 'http://localhost:5173'
    const inviteUrl = `${appUrl}/accept-invite?token=${invitation.token}`
    const roleName = role.replace('-', ' ')

    const emailResponse = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${resendApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        from: Deno.env.get('EMAIL_FROM') || 'RiskGuard <onboarding@resend.dev>',
        to: [email],
        subject: 'You have been invited to RiskGuard',
        html: `
          <!DOCTYPE html>
          <html>
          <body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <h2 style="color: #1a1a2e;">You're invited to join RiskGuard</h2>
            <p>You have been invited to join as a <strong>${roleName}</strong>.</p>
            <p>This invitation expires in 7 days.</p>
            <p style="margin: 30px 0;">
              <a href="${inviteUrl}"
                 style="background-color: #f97316; color: white; padding: 12px 24px;
                        text-decoration: none; border-radius: 6px; font-weight: bold;">
                Accept Invitation
              </a>
            </p>
            <p style="color: #666; font-size: 14px;">
              If you didn't expect this invitation, you can safely ignore this email.
            </p>
          </body>
          </html>
        `,
      }),
    })

    const emailSent = emailResponse.ok

    return new Response(
      JSON.stringify({
        success: true,
        invitationId: invitation.id,
        emailSent,
      }),
      { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    console.error('Error in send-invitation:', error)
    return new Response(
      JSON.stringify({ error: 'Internal server error' }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})
```

Create parent directory if needed: supabase/functions/send-invitation/
  </action>
  <verify>
File exists at supabase/functions/send-invitation/index.ts with:
- CORS headers handling
- Role validation (rejects 'director')
- JWT extraction for tenantId and role check
- Insert into pending_invitations
- Resend API call for email
- Error handling for duplicate invitations
  </verify>
  <done>send-invitation Edge Function ready to create invitations and send emails</done>
</task>

<task type="auto">
  <name>Task 2: Create accept-invitation Edge Function</name>
  <files>supabase/functions/accept-invitation/index.ts</files>
  <action>
Create the accept-invitation Edge Function that:
1. Receives { token, password, fullName } from unauthenticated user
2. Validates token exists, not expired, not already accepted
3. Creates user in auth.users with app_metadata (tenant_id, role)
4. Creates profile row with role and tenant
5. Marks invitation as accepted
6. Returns success so frontend can redirect to login

Implementation:

```typescript
// supabase/functions/accept-invitation/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { token, password, fullName } = await req.json()

    // Validate input
    if (!token || !password) {
      return new Response(
        JSON.stringify({ error: 'Token and password are required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    if (password.length < 8) {
      return new Response(
        JSON.stringify({ error: 'Password must be at least 8 characters' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Create Supabase admin client (service role for user creation)
    const supabaseAdmin = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    )

    // 1. Find and validate invitation
    // Use FOR UPDATE to lock the row and prevent race conditions (Pitfall 2)
    const { data: invitation, error: findError } = await supabaseAdmin
      .from('pending_invitations')
      .select('*')
      .eq('token', token)
      .is('accepted_at', null)
      .gt('expires_at', new Date().toISOString())
      .single()

    if (findError || !invitation) {
      return new Response(
        JSON.stringify({ error: 'Invalid or expired invitation' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 2. Check if user already exists with this email
    const { data: existingUsers } = await supabaseAdmin.auth.admin.listUsers()
    const existingUser = existingUsers?.users?.find(
      u => u.email?.toLowerCase() === invitation.email.toLowerCase()
    )

    if (existingUser) {
      return new Response(
        JSON.stringify({ error: 'An account with this email already exists' }),
        { status: 409, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 3. Create user in auth.users with app_metadata
    // CRITICAL: Set both tenant_id and role in app_metadata (Pitfall 4)
    const { data: authData, error: createError } = await supabaseAdmin.auth.admin.createUser({
      email: invitation.email,
      password,
      email_confirm: true, // Pre-verified since they clicked invite link
      app_metadata: {
        tenant_id: invitation.tenant_id,
        role: invitation.role,
      },
    })

    if (createError) {
      console.error('Error creating user:', createError)
      return new Response(
        JSON.stringify({ error: createError.message }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 4. Create profile row
    const { error: profileError } = await supabaseAdmin
      .from('profiles')
      .insert({
        id: authData.user.id,
        tenant_id: invitation.tenant_id,
        role: invitation.role,
        full_name: fullName?.trim() || null,
        is_active: true,
      })

    if (profileError) {
      console.error('Error creating profile:', profileError)
      // Rollback: delete the auth user we just created
      await supabaseAdmin.auth.admin.deleteUser(authData.user.id)
      return new Response(
        JSON.stringify({ error: 'Failed to create user profile' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 5. Mark invitation as accepted
    const { error: updateError } = await supabaseAdmin
      .from('pending_invitations')
      .update({ accepted_at: new Date().toISOString() })
      .eq('id', invitation.id)

    if (updateError) {
      // Non-critical - user is created, log and continue
      console.error('Error marking invitation accepted:', updateError)
    }

    return new Response(
      JSON.stringify({
        success: true,
        message: 'Account created successfully. You can now log in.',
      }),
      { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    console.error('Error in accept-invitation:', error)
    return new Response(
      JSON.stringify({ error: 'Internal server error' }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})
```

Create parent directory if needed: supabase/functions/accept-invitation/
  </action>
  <verify>
File exists at supabase/functions/accept-invitation/index.ts with:
- CORS headers handling
- Token validation (not null, not expired, not accepted)
- Check for existing user with same email
- auth.admin.createUser with app_metadata (tenant_id, role)
- Profile creation with rollback on failure
- Mark invitation as accepted
  </verify>
  <done>accept-invitation Edge Function ready to validate tokens and create user accounts</done>
</task>

<task type="auto">
  <name>Task 3: Add invitation types to TypeScript types</name>
  <files>src/lib/supabase/types.ts</files>
  <action>
Update the existing types.ts file to add PendingInvitation type and related types.

Add the following types (keep existing content):

```typescript
// Add to existing types.ts file

/**
 * Pending invitation for user to join tenant
 */
export interface PendingInvitation {
  id: string
  tenant_id: string
  email: string
  role: 'manager' | 'risk-manager' | 'control-owner' | 'control-tester'
  token: string
  invited_by: string
  expires_at: string
  accepted_at: string | null
  created_at: string
}

/**
 * Request payload for sending invitation
 */
export interface SendInvitationRequest {
  email: string
  role: 'manager' | 'risk-manager' | 'control-owner' | 'control-tester'
}

/**
 * Response from send-invitation Edge Function
 */
export interface SendInvitationResponse {
  success: boolean
  invitationId?: string
  emailSent?: boolean
  error?: string
  message?: string
}

/**
 * Request payload for accepting invitation
 */
export interface AcceptInvitationRequest {
  token: string
  password: string
  fullName?: string
}

/**
 * Response from accept-invitation Edge Function
 */
export interface AcceptInvitationResponse {
  success: boolean
  message?: string
  error?: string
}
```

Place these after existing type definitions but before any type aliases at the end of the file.
  </action>
  <verify>
File updated at src/lib/supabase/types.ts with:
- PendingInvitation interface
- SendInvitationRequest interface
- SendInvitationResponse interface
- AcceptInvitationRequest interface
- AcceptInvitationResponse interface
  </verify>
  <done>TypeScript types for invitation system ready for use in components and hooks</done>
</task>

</tasks>

<verification>
Both Edge Functions handle CORS preflight requests.
send-invitation validates role is not 'director'.
accept-invitation uses service role key for admin operations.
accept-invitation sets app_metadata with tenant_id AND role.
Profile creation failure triggers auth user rollback.
Types are properly exported from types.ts.
</verification>

<success_criteria>
1. supabase/functions/send-invitation/index.ts exists with Resend integration
2. supabase/functions/accept-invitation/index.ts exists with user creation flow
3. src/lib/supabase/types.ts includes PendingInvitation and related types
4. Both functions have CORS handling for browser calls
5. accept-invitation has rollback logic for profile creation failure
</success_criteria>

<output>
After completion, create `.planning/phases/22-authorization-user-management/22-03-SUMMARY.md`
</output>
