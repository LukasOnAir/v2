---
phase: 22-authorization-user-management
plan: 04
type: execute
wave: 3
depends_on: ["22-02", "22-03"]
files_modified:
  - src/pages/UserManagementPage.tsx
  - src/components/admin/InviteUserDialog.tsx
  - src/components/admin/UserTable.tsx
  - src/hooks/useUserManagement.ts
  - src/App.tsx
  - src/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Director sees User Management in sidebar navigation"
    - "Director can view list of users in their tenant"
    - "Director can invite new user with email and role selection"
    - "Director can deactivate/reactivate users (toggle is_active)"
    - "Non-Directors do not see User Management option"
  artifacts:
    - path: "src/pages/UserManagementPage.tsx"
      provides: "User management page for Directors"
      contains: "usePermissions"
      min_lines: 50
    - path: "src/components/admin/InviteUserDialog.tsx"
      provides: "Modal dialog for inviting users"
      contains: "send-invitation"
    - path: "src/components/admin/UserTable.tsx"
      provides: "Table displaying tenant users"
      contains: "is_active"
    - path: "src/hooks/useUserManagement.ts"
      provides: "Hooks for user CRUD operations"
      contains: "toggleUserActive"
  key_links:
    - from: "src/pages/UserManagementPage.tsx"
      to: "src/hooks/useUserManagement.ts"
      via: "hook import"
      pattern: "import.*useUserManagement"
    - from: "src/components/admin/InviteUserDialog.tsx"
      to: "supabase/functions/send-invitation"
      via: "fetch call"
      pattern: "functions/send-invitation"
    - from: "src/components/layout/Sidebar.tsx"
      to: "src/hooks/usePermissions.ts"
      via: "canViewUserManagement check"
      pattern: "canViewUserManagement"
---

<objective>
Build the Director's user management interface for inviting and managing users.

Purpose: Implement USER-01 (invite by email), USER-02 (role assignment), USER-04 (deactivate users) via a dedicated admin page that only Directors can access. This fulfills the "Director can manage their organization's users" success criteria.

Output: User Management page with invite dialog, user table, and supporting hooks. Plus sidebar navigation update.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-authorization-user-management/22-RESEARCH.md
@.planning/phases/22-authorization-user-management/22-02-SUMMARY.md
@.planning/phases/22-authorization-user-management/22-03-SUMMARY.md

# Existing patterns to follow
@src/pages/AuditPage.tsx
@src/components/layout/Sidebar.tsx
@src/App.tsx
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUserManagement hook</name>
  <files>src/hooks/useUserManagement.ts</files>
  <action>
Create a hook that provides user management functionality for Directors.

```typescript
// src/hooks/useUserManagement.ts
import { useState, useEffect, useCallback } from 'react'
import { supabase } from '@/lib/supabase/client'
import { useAuth } from '@/contexts/AuthContext'
import type {
  Profile,
  PendingInvitation,
  SendInvitationRequest,
  SendInvitationResponse,
} from '@/lib/supabase/types'

interface UseUserManagementReturn {
  // Data
  users: Profile[]
  pendingInvitations: PendingInvitation[]
  isLoading: boolean
  error: string | null

  // Actions
  inviteUser: (data: SendInvitationRequest) => Promise<SendInvitationResponse>
  toggleUserActive: (userId: string, currentStatus: boolean) => Promise<void>
  cancelInvitation: (invitationId: string) => Promise<void>
  refreshUsers: () => Promise<void>
}

export function useUserManagement(): UseUserManagementReturn {
  const { tenantId, session } = useAuth()
  const [users, setUsers] = useState<Profile[]>([])
  const [pendingInvitations, setPendingInvitations] = useState<PendingInvitation[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  // Fetch users and pending invitations
  const refreshUsers = useCallback(async () => {
    if (!tenantId) return

    setIsLoading(true)
    setError(null)

    try {
      // Fetch active and inactive users
      const { data: profilesData, error: profilesError } = await supabase
        .from('profiles')
        .select('*')
        .eq('tenant_id', tenantId)
        .order('created_at', { ascending: false })

      if (profilesError) throw profilesError
      setUsers(profilesData || [])

      // Fetch pending invitations (not yet accepted, not expired)
      const { data: invitationsData, error: invitationsError } = await supabase
        .from('pending_invitations')
        .select('*')
        .eq('tenant_id', tenantId)
        .is('accepted_at', null)
        .gt('expires_at', new Date().toISOString())
        .order('created_at', { ascending: false })

      if (invitationsError) throw invitationsError
      setPendingInvitations(invitationsData || [])
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load users')
    } finally {
      setIsLoading(false)
    }
  }, [tenantId])

  // Load on mount and when tenantId changes
  useEffect(() => {
    refreshUsers()
  }, [refreshUsers])

  // Invite a new user
  const inviteUser = async (data: SendInvitationRequest): Promise<SendInvitationResponse> => {
    if (!session?.access_token) {
      return { success: false, error: 'Not authenticated' }
    }

    try {
      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/send-invitation`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
          },
          body: JSON.stringify(data),
        }
      )

      const result: SendInvitationResponse = await response.json()

      if (result.success) {
        // Refresh list to show new pending invitation
        await refreshUsers()
      }

      return result
    } catch (err) {
      return {
        success: false,
        error: err instanceof Error ? err.message : 'Failed to send invitation',
      }
    }
  }

  // Toggle user active status
  const toggleUserActive = async (userId: string, currentStatus: boolean): Promise<void> => {
    const { error: updateError } = await supabase
      .from('profiles')
      .update({ is_active: !currentStatus, updated_at: new Date().toISOString() })
      .eq('id', userId)

    if (updateError) {
      throw new Error(updateError.message)
    }

    // Update local state
    setUsers(prev =>
      prev.map(u => (u.id === userId ? { ...u, is_active: !currentStatus } : u))
    )
  }

  // Cancel a pending invitation
  const cancelInvitation = async (invitationId: string): Promise<void> => {
    const { error: deleteError } = await supabase
      .from('pending_invitations')
      .delete()
      .eq('id', invitationId)

    if (deleteError) {
      throw new Error(deleteError.message)
    }

    // Update local state
    setPendingInvitations(prev => prev.filter(i => i.id !== invitationId))
  }

  return {
    users,
    pendingInvitations,
    isLoading,
    error,
    inviteUser,
    toggleUserActive,
    cancelInvitation,
    refreshUsers,
  }
}
```
  </action>
  <verify>
File exists at src/hooks/useUserManagement.ts with:
- useUserManagement function export
- inviteUser calls /functions/v1/send-invitation
- toggleUserActive updates profiles.is_active
- cancelInvitation deletes from pending_invitations
- Uses useAuth for tenantId and session
  </verify>
  <done>useUserManagement hook provides CRUD operations for user management</done>
</task>

<task type="auto">
  <name>Task 2: Create InviteUserDialog and UserTable components</name>
  <files>src/components/admin/InviteUserDialog.tsx, src/components/admin/UserTable.tsx</files>
  <action>
Create two components: InviteUserDialog for the invite modal and UserTable for displaying users.

**InviteUserDialog.tsx:**

```typescript
// src/components/admin/InviteUserDialog.tsx
import { useState } from 'react'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { toast } from 'sonner'
import { INVITABLE_ROLES, ROLE_LABELS, type Role } from '@/lib/permissions'
import type { SendInvitationRequest, SendInvitationResponse } from '@/lib/supabase/types'

interface InviteUserDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onInvite: (data: SendInvitationRequest) => Promise<SendInvitationResponse>
}

export function InviteUserDialog({ open, onOpenChange, onInvite }: InviteUserDialogProps) {
  const [email, setEmail] = useState('')
  const [role, setRole] = useState<Role | ''>('')
  const [isSubmitting, setIsSubmitting] = useState(false)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!email || !role) {
      toast.error('Please fill in all fields')
      return
    }

    // Basic email validation
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      toast.error('Please enter a valid email address')
      return
    }

    setIsSubmitting(true)

    try {
      const result = await onInvite({
        email: email.toLowerCase().trim(),
        role: role as SendInvitationRequest['role'],
      })

      if (result.success) {
        toast.success(
          result.emailSent
            ? 'Invitation sent successfully'
            : 'Invitation created (email will be sent when configured)'
        )
        setEmail('')
        setRole('')
        onOpenChange(false)
      } else {
        toast.error(result.error || 'Failed to send invitation')
      }
    } catch (err) {
      toast.error('An error occurred while sending the invitation')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Invite User</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit}>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email address</Label>
              <Input
                id="email"
                type="email"
                placeholder="user@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={isSubmitting}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="role">Role</Label>
              <Select value={role} onValueChange={(v) => setRole(v as Role)}>
                <SelectTrigger>
                  <SelectValue placeholder="Select a role" />
                </SelectTrigger>
                <SelectContent>
                  {INVITABLE_ROLES.map((r) => (
                    <SelectItem key={r} value={r}>
                      {ROLE_LABELS[r]}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>
          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
              disabled={isSubmitting}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? 'Sending...' : 'Send Invitation'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

**UserTable.tsx:**

```typescript
// src/components/admin/UserTable.tsx
import { useState } from 'react'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { toast } from 'sonner'
import { UserX, UserCheck, Trash2, Clock, Mail } from 'lucide-react'
import { ROLE_LABELS, type Role } from '@/lib/permissions'
import type { Profile, PendingInvitation } from '@/lib/supabase/types'
import { useAuth } from '@/contexts/AuthContext'

interface UserTableProps {
  users: Profile[]
  pendingInvitations: PendingInvitation[]
  onToggleActive: (userId: string, currentStatus: boolean) => Promise<void>
  onCancelInvitation: (invitationId: string) => Promise<void>
}

export function UserTable({
  users,
  pendingInvitations,
  onToggleActive,
  onCancelInvitation,
}: UserTableProps) {
  const { user } = useAuth()
  const [loadingId, setLoadingId] = useState<string | null>(null)

  const handleToggleActive = async (userId: string, currentStatus: boolean) => {
    setLoadingId(userId)
    try {
      await onToggleActive(userId, currentStatus)
      toast.success(currentStatus ? 'User deactivated' : 'User reactivated')
    } catch (err) {
      toast.error('Failed to update user status')
    } finally {
      setLoadingId(null)
    }
  }

  const handleCancelInvitation = async (invitationId: string) => {
    setLoadingId(invitationId)
    try {
      await onCancelInvitation(invitationId)
      toast.success('Invitation cancelled')
    } catch (err) {
      toast.error('Failed to cancel invitation')
    } finally {
      setLoadingId(null)
    }
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    })
  }

  return (
    <div className="space-y-6">
      {/* Active Users */}
      <div>
        <h3 className="text-lg font-medium mb-4">Users</h3>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Name</TableHead>
              <TableHead>Email</TableHead>
              <TableHead>Role</TableHead>
              <TableHead>Status</TableHead>
              <TableHead>Joined</TableHead>
              <TableHead className="text-right">Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {users.map((profile) => (
              <TableRow key={profile.id}>
                <TableCell className="font-medium">
                  {profile.full_name || 'No name'}
                  {profile.id === user?.id && (
                    <Badge variant="outline" className="ml-2">You</Badge>
                  )}
                </TableCell>
                <TableCell>{profile.email || '-'}</TableCell>
                <TableCell>
                  <Badge variant="secondary">
                    {ROLE_LABELS[profile.role as Role] || profile.role}
                  </Badge>
                </TableCell>
                <TableCell>
                  {profile.is_active ? (
                    <Badge className="bg-green-500/20 text-green-400 hover:bg-green-500/30">
                      Active
                    </Badge>
                  ) : (
                    <Badge className="bg-red-500/20 text-red-400 hover:bg-red-500/30">
                      Inactive
                    </Badge>
                  )}
                </TableCell>
                <TableCell>{formatDate(profile.created_at)}</TableCell>
                <TableCell className="text-right">
                  {profile.id !== user?.id && (
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleToggleActive(profile.id, profile.is_active)}
                      disabled={loadingId === profile.id}
                    >
                      {profile.is_active ? (
                        <>
                          <UserX className="h-4 w-4 mr-1" />
                          Deactivate
                        </>
                      ) : (
                        <>
                          <UserCheck className="h-4 w-4 mr-1" />
                          Reactivate
                        </>
                      )}
                    </Button>
                  )}
                </TableCell>
              </TableRow>
            ))}
            {users.length === 0 && (
              <TableRow>
                <TableCell colSpan={6} className="text-center text-muted-foreground">
                  No users found
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pending Invitations */}
      {pendingInvitations.length > 0 && (
        <div>
          <h3 className="text-lg font-medium mb-4 flex items-center gap-2">
            <Clock className="h-5 w-5" />
            Pending Invitations
          </h3>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Email</TableHead>
                <TableHead>Role</TableHead>
                <TableHead>Expires</TableHead>
                <TableHead className="text-right">Actions</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {pendingInvitations.map((invitation) => (
                <TableRow key={invitation.id}>
                  <TableCell className="font-medium flex items-center gap-2">
                    <Mail className="h-4 w-4 text-muted-foreground" />
                    {invitation.email}
                  </TableCell>
                  <TableCell>
                    <Badge variant="secondary">
                      {ROLE_LABELS[invitation.role as Role] || invitation.role}
                    </Badge>
                  </TableCell>
                  <TableCell>{formatDate(invitation.expires_at)}</TableCell>
                  <TableCell className="text-right">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleCancelInvitation(invitation.id)}
                      disabled={loadingId === invitation.id}
                    >
                      <Trash2 className="h-4 w-4 mr-1" />
                      Cancel
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      )}
    </div>
  )
}
```

Create parent directory if needed: src/components/admin/
  </action>
  <verify>
Files exist at src/components/admin/InviteUserDialog.tsx and src/components/admin/UserTable.tsx with:
- InviteUserDialog has email input, role selector, submit handler
- UserTable displays users with deactivate/reactivate buttons
- UserTable displays pending invitations with cancel button
- Both use ROLE_LABELS from permissions.ts
- UserTable prevents self-deactivation (id !== user?.id check)
  </verify>
  <done>InviteUserDialog and UserTable components ready for Director user management</done>
</task>

<task type="auto">
  <name>Task 3: Create UserManagementPage and wire routing</name>
  <files>src/pages/UserManagementPage.tsx, src/App.tsx, src/components/layout/Sidebar.tsx</files>
  <action>
Create the UserManagementPage and add it to routing and sidebar navigation.

**UserManagementPage.tsx:**

```typescript
// src/pages/UserManagementPage.tsx
import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { UserPlus, Users } from 'lucide-react'
import { usePermissions } from '@/hooks/usePermissions'
import { useUserManagement } from '@/hooks/useUserManagement'
import { InviteUserDialog } from '@/components/admin/InviteUserDialog'
import { UserTable } from '@/components/admin/UserTable'
import { Navigate } from 'react-router'

export function UserManagementPage() {
  const { canViewUserManagement } = usePermissions()
  const {
    users,
    pendingInvitations,
    isLoading,
    error,
    inviteUser,
    toggleUserActive,
    cancelInvitation,
  } = useUserManagement()
  const [showInviteDialog, setShowInviteDialog] = useState(false)

  // Redirect non-Directors
  if (!canViewUserManagement) {
    return <Navigate to="/" replace />
  }

  return (
    <div className="container mx-auto py-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-3">
            <Users className="h-8 w-8" />
            User Management
          </h1>
          <p className="text-muted-foreground mt-1">
            Manage users in your organization
          </p>
        </div>
        <Button onClick={() => setShowInviteDialog(true)}>
          <UserPlus className="h-4 w-4 mr-2" />
          Invite User
        </Button>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Organization Users</CardTitle>
          <CardDescription>
            View and manage all users in your organization. You can invite new users,
            deactivate accounts, and manage pending invitations.
          </CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="flex items-center justify-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary" />
            </div>
          ) : error ? (
            <div className="text-center py-8 text-red-500">
              Error: {error}
            </div>
          ) : (
            <UserTable
              users={users}
              pendingInvitations={pendingInvitations}
              onToggleActive={toggleUserActive}
              onCancelInvitation={cancelInvitation}
            />
          )}
        </CardContent>
      </Card>

      <InviteUserDialog
        open={showInviteDialog}
        onOpenChange={setShowInviteDialog}
        onInvite={inviteUser}
      />
    </div>
  )
}
```

**Update App.tsx** - Add the route inside the protected Layout routes:

Add import at top:
```typescript
import { UserManagementPage } from './pages/UserManagementPage'
```

Add route inside the Layout route group (after knowledge-base route):
```typescript
<Route path="users" element={<UserManagementPage />} />
```

**Update Sidebar.tsx** - Add User Management link for Directors:

Import usePermissions at top (if not already imported):
```typescript
import { usePermissions } from '@/hooks/usePermissions'
```

Add Users icon import from lucide-react:
```typescript
import { Users } from 'lucide-react'
```

Inside the Sidebar component, get canViewUserManagement:
```typescript
const { canViewUserManagement, ...otherPermissions } = usePermissions()
```

Add the User Management nav item conditionally (recommend placing it at the bottom of the nav list, before any settings):
```typescript
{canViewUserManagement && (
  <NavLink to="/users" className={/* existing className pattern */}>
    <Users className="h-5 w-5" />
    <span>User Management</span>
  </NavLink>
)}
```

Follow the existing NavLink pattern in the file for styling.
  </action>
  <verify>
- src/pages/UserManagementPage.tsx exists with useUserManagement hook usage
- src/App.tsx has route for /users pointing to UserManagementPage
- src/components/layout/Sidebar.tsx has conditional User Management link
- Page redirects non-Directors to home
- Invite button opens dialog
  </verify>
  <done>UserManagementPage accessible at /users with sidebar navigation for Directors only</done>
</task>

</tasks>

<verification>
All components use existing UI patterns (Card, Table, Dialog, Button from shadcn/ui).
useUserManagement hook calls the send-invitation Edge Function.
UserTable prevents Directors from deactivating themselves.
Sidebar only shows User Management for Directors.
Page redirects non-Directors.
</verification>

<success_criteria>
1. Director can navigate to /users via sidebar
2. Director sees list of users with their roles and status
3. Director can click "Invite User" and fill email + role in dialog
4. Director can deactivate/reactivate users (not themselves)
5. Director can cancel pending invitations
6. Non-Directors are redirected away from /users
7. Pending invitations display with expiry date
</success_criteria>

<output>
After completion, create `.planning/phases/22-authorization-user-management/22-04-SUMMARY.md`
</output>
