---
phase: 22-authorization-user-management
plan: 05
type: execute
wave: 3
depends_on: ["22-02", "22-03"]
files_modified:
  - src/pages/AcceptInvitePage.tsx
  - src/pages/ProfilePage.tsx
  - src/hooks/useProfileUpdate.ts
  - src/App.tsx
  - src/components/layout/Header.tsx
autonomous: true

must_haves:
  truths:
    - "Invited user can visit /accept-invite with token and create account"
    - "Invalid/expired tokens show error message"
    - "Successful acceptance redirects to login page"
    - "Authenticated user can access profile page to update name"
    - "Authenticated user can change password from profile page"
  artifacts:
    - path: "src/pages/AcceptInvitePage.tsx"
      provides: "Public page for accepting invitations"
      contains: "accept-invitation"
      min_lines: 80
    - path: "src/pages/ProfilePage.tsx"
      provides: "User profile edit page"
      contains: "useProfileUpdate"
      min_lines: 60
    - path: "src/hooks/useProfileUpdate.ts"
      provides: "Hook for profile update operations"
      contains: "updatePassword"
  key_links:
    - from: "src/pages/AcceptInvitePage.tsx"
      to: "supabase/functions/accept-invitation"
      via: "fetch call"
      pattern: "functions/accept-invitation"
    - from: "src/pages/ProfilePage.tsx"
      to: "src/hooks/useProfileUpdate.ts"
      via: "hook import"
      pattern: "import.*useProfileUpdate"
    - from: "src/components/layout/Header.tsx"
      to: "/profile"
      via: "navigation link"
      pattern: "to.*profile"
---

<objective>
Create the invitation acceptance page and user profile management page.

Purpose: Complete the invitation flow (USER-03 expiry handling) and enable users to update their own profile (USER-05). This fulfills "Invited user receives email with join link" and "User can update their own profile" success criteria.

Output: AcceptInvitePage for public invitation acceptance, ProfilePage for self-service profile updates, and Header update with profile link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-authorization-user-management/22-RESEARCH.md
@.planning/phases/22-authorization-user-management/22-02-SUMMARY.md
@.planning/phases/22-authorization-user-management/22-03-SUMMARY.md

# Existing patterns
@src/pages/SignupPage.tsx
@src/pages/ResetPasswordPage.tsx
@src/contexts/AuthContext.tsx
@src/components/layout/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useProfileUpdate hook</name>
  <files>src/hooks/useProfileUpdate.ts</files>
  <action>
Create a hook for users to update their own profile (name) and password.

```typescript
// src/hooks/useProfileUpdate.ts
import { useState } from 'react'
import { supabase } from '@/lib/supabase/client'
import { useAuth } from '@/contexts/AuthContext'

interface UseProfileUpdateReturn {
  isUpdating: boolean
  updateName: (fullName: string) => Promise<{ success: boolean; error?: string }>
  updatePassword: (newPassword: string) => Promise<{ success: boolean; error?: string }>
}

export function useProfileUpdate(): UseProfileUpdateReturn {
  const { user } = useAuth()
  const [isUpdating, setIsUpdating] = useState(false)

  const updateName = async (fullName: string): Promise<{ success: boolean; error?: string }> => {
    if (!user) {
      return { success: false, error: 'Not authenticated' }
    }

    setIsUpdating(true)

    try {
      const { error } = await supabase
        .from('profiles')
        .update({
          full_name: fullName.trim(),
          updated_at: new Date().toISOString(),
        })
        .eq('id', user.id)

      if (error) {
        return { success: false, error: error.message }
      }

      return { success: true }
    } catch (err) {
      return {
        success: false,
        error: err instanceof Error ? err.message : 'Failed to update name',
      }
    } finally {
      setIsUpdating(false)
    }
  }

  const updatePassword = async (newPassword: string): Promise<{ success: boolean; error?: string }> => {
    if (!user) {
      return { success: false, error: 'Not authenticated' }
    }

    if (newPassword.length < 8) {
      return { success: false, error: 'Password must be at least 8 characters' }
    }

    setIsUpdating(true)

    try {
      const { error } = await supabase.auth.updateUser({ password: newPassword })

      if (error) {
        return { success: false, error: error.message }
      }

      return { success: true }
    } catch (err) {
      return {
        success: false,
        error: err instanceof Error ? err.message : 'Failed to update password',
      }
    } finally {
      setIsUpdating(false)
    }
  }

  return {
    isUpdating,
    updateName,
    updatePassword,
  }
}
```
  </action>
  <verify>
File exists at src/hooks/useProfileUpdate.ts with:
- updateName function that updates profiles table
- updatePassword function that uses supabase.auth.updateUser
- isUpdating loading state
- Both return { success, error } objects
  </verify>
  <done>useProfileUpdate hook ready for profile page</done>
</task>

<task type="auto">
  <name>Task 2: Create AcceptInvitePage</name>
  <files>src/pages/AcceptInvitePage.tsx</files>
  <action>
Create a public page for accepting invitations. This page:
1. Reads token from URL query param
2. Shows form for password and optional name
3. Calls accept-invitation Edge Function
4. Redirects to login on success

```typescript
// src/pages/AcceptInvitePage.tsx
import { useState, useEffect } from 'react'
import { useSearchParams, useNavigate, Link } from 'react-router'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { toast } from 'sonner'
import { Shield, AlertCircle, CheckCircle } from 'lucide-react'
import type { AcceptInvitationRequest, AcceptInvitationResponse } from '@/lib/supabase/types'

export function AcceptInvitePage() {
  const [searchParams] = useSearchParams()
  const navigate = useNavigate()
  const token = searchParams.get('token')

  const [fullName, setFullName] = useState('')
  const [password, setPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)

  // Validate token exists
  useEffect(() => {
    if (!token) {
      setError('Invalid invitation link. Please check your email for the correct link.')
    }
  }, [token])

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)

    if (!token) {
      setError('Invalid invitation link')
      return
    }

    if (password.length < 8) {
      setError('Password must be at least 8 characters')
      return
    }

    if (password !== confirmPassword) {
      setError('Passwords do not match')
      return
    }

    setIsSubmitting(true)

    try {
      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/accept-invitation`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            token,
            password,
            fullName: fullName.trim() || undefined,
          } as AcceptInvitationRequest),
        }
      )

      const result: AcceptInvitationResponse = await response.json()

      if (result.success) {
        setSuccess(true)
        toast.success('Account created successfully!')
        // Redirect to login after short delay
        setTimeout(() => {
          navigate('/login', { state: { message: 'Account created. Please log in.' } })
        }, 2000)
      } else {
        setError(result.error || 'Failed to accept invitation')
      }
    } catch (err) {
      setError('An error occurred. Please try again.')
    } finally {
      setIsSubmitting(false)
    }
  }

  // Success state
  if (success) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background p-4">
        <Card className="w-full max-w-md">
          <CardHeader className="text-center">
            <CheckCircle className="h-12 w-12 text-green-500 mx-auto mb-4" />
            <CardTitle>Account Created!</CardTitle>
            <CardDescription>
              Your account has been created successfully. Redirecting to login...
            </CardDescription>
          </CardHeader>
          <CardContent className="text-center">
            <Link to="/login">
              <Button variant="link">Go to Login</Button>
            </Link>
          </CardContent>
        </Card>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-background p-4">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <Shield className="h-12 w-12 text-primary mx-auto mb-4" />
          <CardTitle>Accept Invitation</CardTitle>
          <CardDescription>
            Complete your account setup to join RiskGuard
          </CardDescription>
        </CardHeader>
        <CardContent>
          {error && (
            <Alert variant="destructive" className="mb-4">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          {!token ? (
            <div className="text-center">
              <p className="text-muted-foreground mb-4">
                This invitation link appears to be invalid or has expired.
              </p>
              <Link to="/login">
                <Button variant="outline">Go to Login</Button>
              </Link>
            </div>
          ) : (
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="fullName">Full Name (optional)</Label>
                <Input
                  id="fullName"
                  type="text"
                  placeholder="John Doe"
                  value={fullName}
                  onChange={(e) => setFullName(e.target.value)}
                  disabled={isSubmitting}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="password">Password</Label>
                <Input
                  id="password"
                  type="password"
                  placeholder="Minimum 8 characters"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  disabled={isSubmitting}
                  required
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="confirmPassword">Confirm Password</Label>
                <Input
                  id="confirmPassword"
                  type="password"
                  placeholder="Confirm your password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  disabled={isSubmitting}
                  required
                />
              </div>

              <Button type="submit" className="w-full" disabled={isSubmitting}>
                {isSubmitting ? 'Creating Account...' : 'Create Account'}
              </Button>

              <p className="text-center text-sm text-muted-foreground">
                Already have an account?{' '}
                <Link to="/login" className="text-primary hover:underline">
                  Log in
                </Link>
              </p>
            </form>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```
  </action>
  <verify>
File exists at src/pages/AcceptInvitePage.tsx with:
- Reads token from useSearchParams
- Shows error if no token
- Password and confirm password fields
- Calls /functions/v1/accept-invitation
- Shows success state and redirects to login
  </verify>
  <done>AcceptInvitePage handles invitation acceptance flow</done>
</task>

<task type="auto">
  <name>Task 3: Create ProfilePage and update routing/navigation</name>
  <files>src/pages/ProfilePage.tsx, src/App.tsx, src/components/layout/Header.tsx</files>
  <action>
Create the profile page and add navigation.

**ProfilePage.tsx:**

```typescript
// src/pages/ProfilePage.tsx
import { useState, useEffect } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Separator } from '@/components/ui/separator'
import { toast } from 'sonner'
import { User, Lock } from 'lucide-react'
import { useAuth } from '@/contexts/AuthContext'
import { useProfileUpdate } from '@/hooks/useProfileUpdate'
import { supabase } from '@/lib/supabase/client'
import { ROLE_LABELS, type Role } from '@/lib/permissions'

export function ProfilePage() {
  const { user, role } = useAuth()
  const { isUpdating, updateName, updatePassword } = useProfileUpdate()

  const [fullName, setFullName] = useState('')
  const [newPassword, setNewPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')

  // Load current profile data
  useEffect(() => {
    if (!user) return

    const loadProfile = async () => {
      const { data } = await supabase
        .from('profiles')
        .select('full_name')
        .eq('id', user.id)
        .single()

      if (data) {
        setFullName(data.full_name || '')
      }
    }

    loadProfile()
  }, [user])

  const handleUpdateName = async (e: React.FormEvent) => {
    e.preventDefault()

    const result = await updateName(fullName)

    if (result.success) {
      toast.success('Name updated successfully')
    } else {
      toast.error(result.error || 'Failed to update name')
    }
  }

  const handleUpdatePassword = async (e: React.FormEvent) => {
    e.preventDefault()

    if (newPassword !== confirmPassword) {
      toast.error('Passwords do not match')
      return
    }

    if (newPassword.length < 8) {
      toast.error('Password must be at least 8 characters')
      return
    }

    const result = await updatePassword(newPassword)

    if (result.success) {
      toast.success('Password updated successfully')
      setNewPassword('')
      setConfirmPassword('')
    } else {
      toast.error(result.error || 'Failed to update password')
    }
  }

  return (
    <div className="container mx-auto py-6 max-w-2xl space-y-6">
      <div>
        <h1 className="text-3xl font-bold flex items-center gap-3">
          <User className="h-8 w-8" />
          My Profile
        </h1>
        <p className="text-muted-foreground mt-1">
          Manage your account settings
        </p>
      </div>

      {/* Account Info */}
      <Card>
        <CardHeader>
          <CardTitle>Account Information</CardTitle>
          <CardDescription>
            Your account details (some fields cannot be changed)
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label className="text-muted-foreground">Email</Label>
            <p className="mt-1">{user?.email}</p>
          </div>
          <div>
            <Label className="text-muted-foreground">Role</Label>
            <p className="mt-1">{role ? ROLE_LABELS[role as Role] : 'Unknown'}</p>
          </div>
        </CardContent>
      </Card>

      {/* Update Name */}
      <Card>
        <CardHeader>
          <CardTitle>Profile</CardTitle>
          <CardDescription>
            Update your display name
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleUpdateName} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="fullName">Full Name</Label>
              <Input
                id="fullName"
                type="text"
                placeholder="Your full name"
                value={fullName}
                onChange={(e) => setFullName(e.target.value)}
                disabled={isUpdating}
              />
            </div>
            <Button type="submit" disabled={isUpdating}>
              {isUpdating ? 'Saving...' : 'Save Name'}
            </Button>
          </form>
        </CardContent>
      </Card>

      {/* Change Password */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Lock className="h-5 w-5" />
            Change Password
          </CardTitle>
          <CardDescription>
            Update your password
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleUpdatePassword} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="newPassword">New Password</Label>
              <Input
                id="newPassword"
                type="password"
                placeholder="Minimum 8 characters"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                disabled={isUpdating}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="confirmPassword">Confirm New Password</Label>
              <Input
                id="confirmPassword"
                type="password"
                placeholder="Confirm new password"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                disabled={isUpdating}
              />
            </div>
            <Button type="submit" disabled={isUpdating || !newPassword}>
              {isUpdating ? 'Updating...' : 'Update Password'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

**Update App.tsx:**

Add import:
```typescript
import { ProfilePage } from './pages/ProfilePage'
import { AcceptInvitePage } from './pages/AcceptInvitePage'
```

Add public route for accept-invite (outside ProtectedRoute, near other auth routes):
```typescript
<Route path="accept-invite" element={<AcceptInvitePage />} />
```

Add protected route for profile (inside Layout routes):
```typescript
<Route path="profile" element={<ProfilePage />} />
```

**Update Header.tsx:**

Add a profile link in the user menu. Look for the existing user dropdown or avatar area. Add a link to /profile.

If there's a dropdown menu, add:
```typescript
<Link to="/profile" className="...">
  <User className="h-4 w-4 mr-2" />
  Profile
</Link>
```

If there's no user menu, add a simple link near the user area.

Also ensure User icon is imported from lucide-react.
  </action>
  <verify>
- src/pages/ProfilePage.tsx exists with name and password update forms
- src/pages/AcceptInvitePage.tsx exists (created in Task 2)
- src/App.tsx has /accept-invite route (public) and /profile route (protected)
- src/components/layout/Header.tsx has link to /profile
  </verify>
  <done>ProfilePage and AcceptInvitePage complete the user management flows</done>
</task>

</tasks>

<verification>
AcceptInvitePage is a public route (no auth required).
ProfilePage is a protected route (requires auth).
Both pages follow existing styling patterns.
Password validation requires 8+ characters.
Profile page shows read-only email and role.
Header has accessible profile link.
</verification>

<success_criteria>
1. /accept-invite?token=xxx shows account creation form
2. Invalid/missing token shows error message
3. Successful acceptance creates account and redirects to login
4. /profile shows current user's name and email
5. User can update their name from profile page
6. User can change password from profile page
7. Header has link to profile page
</success_criteria>

<output>
After completion, create `.planning/phases/22-authorization-user-management/22-05-SUMMARY.md`
</output>
