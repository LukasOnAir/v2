---
phase: 23-email-scheduling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/send-email/index.ts
  - supabase/config.toml
autonomous: true
user_setup:
  - service: supabase
    why: "Configure Send Email Hook in Supabase Dashboard"
    dashboard_config:
      - task: "Enable Send Email Hook pointing to send-email Edge Function"
        location: "Supabase Dashboard -> Authentication -> Hooks -> Send Email"

must_haves:
  truths:
    - "User receives branded email when resetting password"
    - "User receives branded email when verifying email address"
    - "New user receives welcome email after completing signup"
  artifacts:
    - path: "supabase/functions/send-email/index.ts"
      provides: "Send Email Hook handler for Supabase Auth emails"
      min_lines: 100
      exports: ["serve"]
    - path: "supabase/config.toml"
      provides: "Edge Function configuration"
      contains: "[functions.send-email]"
  key_links:
    - from: "Supabase Auth"
      to: "supabase/functions/send-email/index.ts"
      via: "Send Email Hook webhook"
      pattern: "email_action_type"
    - from: "supabase/functions/send-email/index.ts"
      to: "Resend API"
      via: "fetch to api.resend.com"
      pattern: "api\\.resend\\.com/emails"
---

<objective>
Implement Supabase Send Email Hook to route all authentication emails (password reset, email verification, email change) through Resend for consistent branding, plus send welcome email after signup.

Purpose: Replace Supabase's default SMTP with branded emails via Resend, fulfilling EMAIL-02, EMAIL-03 and EMAIL-04 requirements.

Output: Edge Function `send-email` that intercepts Supabase Auth email events and sends via Resend API.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-email-scheduling/23-RESEARCH.md

# Existing patterns
@supabase/functions/send-invitation/index.ts
@supabase/config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send-email Edge Function with Welcome Email</name>
  <files>supabase/functions/send-email/index.ts</files>
  <action>
Create the Send Email Hook handler following the existing send-invitation pattern:

1. Import dependencies (serve from Deno, standardwebhooks for signature verification)
2. Define email templates for each action type:
   - `signup`: Email verification with token_hash and redirect_to
   - `recovery`: Password reset with token_hash and redirect_to
   - `email_change`: Email change confirmation
3. Extract and verify webhook payload using standardwebhooks (import from esm.sh)
4. Get the hook secret from environment: `SEND_EMAIL_HOOK_SECRET`
5. Parse email_data from payload to get: email_action_type, token, token_hash, redirect_to
6. Build appropriate confirmation URL using APP_URL env var
7. Select template based on email_action_type
8. Send via Resend API (same pattern as send-invitation)
9. Return 200 on success (CRITICAL: always return 200 to not block auth flow)
10. Log errors but don't fail the request (auth flow must continue)

**EMAIL-02 Welcome Email Implementation:**
After sending the signup verification email, ALSO send a welcome email:
- Subject: "Welcome to RiskGuard"
- Content: Thank user for joining, explain next steps, link to app
- This is sent immediately after verification email (user will see both in inbox)
- Template should include:
  - Welcome message with user's name (from user_metadata if available)
  - Brief explanation of RiskGuard
  - "Once you verify your email, you can access your dashboard"
  - Orange CTA button linking to app

Template style should match send-invitation (same colors, fonts, button style).

Use APP_URL for building confirmation links. The link format should be:
- Signup: `${APP_URL}/auth/confirm?token_hash=${token_hash}&type=signup`
- Recovery: `${APP_URL}/auth/confirm?token_hash=${token_hash}&type=recovery`

Import standardwebhooks for webhook verification:
```typescript
import { Webhook } from 'https://esm.sh/standardwebhooks@1.0.0'
```
  </action>
  <verify>
1. File exists at supabase/functions/send-email/index.ts
2. Contains Webhook import from standardwebhooks
3. Contains email templates for signup, recovery, email_change
4. Contains welcome email template for EMAIL-02
5. Contains Resend API call pattern (sends 2 emails for signup: verification + welcome)
6. Returns 200 response
  </verify>
  <done>
Edge Function code complete with:
- Webhook signature verification
- Four email templates (signup verification, welcome, recovery, email_change)
- Resend API integration
- Always-200 response pattern
- Welcome email sent after signup (EMAIL-02)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Edge Function and Deploy</name>
  <files>supabase/config.toml</files>
  <action>
1. Add configuration for send-email function to supabase/config.toml:
```toml
[functions.send-email]
verify_jwt = false
```

2. Deploy the function to Supabase:
```bash
npx supabase functions deploy send-email --no-verify-jwt
```

Note: verify_jwt = false because the hook uses webhook signature verification instead of JWT.

After deployment, note the function URL for dashboard configuration (handled by user_setup).
  </action>
  <verify>
1. supabase/config.toml contains [functions.send-email] section
2. `npx supabase functions list` shows send-email function
  </verify>
  <done>
Function deployed and configured. User must configure Send Email Hook in Supabase Dashboard to complete integration.
  </done>
</task>

</tasks>

<verification>
- [ ] supabase/functions/send-email/index.ts exists and contains webhook verification
- [ ] supabase/config.toml has [functions.send-email] section
- [ ] Function deploys without errors
- [ ] Code handles all three email types (signup, recovery, email_change)
- [ ] Welcome email template included for signup action (EMAIL-02)
</verification>

<success_criteria>
- Send Email Hook Edge Function created with Resend integration
- Function deployed to Supabase
- Template styling matches existing invitation emails
- Always returns 200 to not block auth flow
- Welcome email sent after signup fulfills EMAIL-02
</success_criteria>

<output>
After completion, create `.planning/phases/23-email-scheduling/23-01-SUMMARY.md`

Document:
- Function URL for dashboard configuration
- Environment variables needed (SEND_EMAIL_HOOK_SECRET, APP_URL, RESEND_API_KEY)
- Dashboard configuration steps for user
- Welcome email behavior (sent with verification email)
</output>
