---
phase: 23-email-scheduling
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/send-notification/index.ts
  - supabase/config.toml
autonomous: true

must_haves:
  truths:
    - "Manager receives email when change request is submitted for approval"
    - "Submitter receives email when their change is approved or rejected"
    - "Control Tester receives email when assigned to a test"
  artifacts:
    - path: "supabase/functions/send-notification/index.ts"
      provides: "Triggered notification handler for approval and assignment events"
      min_lines: 120
      exports: ["serve"]
    - path: "supabase/config.toml"
      provides: "Edge Function configuration"
      contains: "[functions.send-notification]"
  key_links:
    - from: "Frontend approval flow"
      to: "supabase/functions/send-notification/index.ts"
      via: "POST request with type parameter"
      pattern: "type.*approval-request|approval-result|test-assigned"
    - from: "supabase/functions/send-notification/index.ts"
      to: "Resend API"
      via: "fetch to api.resend.com"
      pattern: "api\\.resend\\.com/emails"
---

<objective>
Create Edge Function for triggered business notifications: approval requests to managers, approval results to submitters, and test assignments to testers.

Purpose: Fulfill EMAIL-05, EMAIL-06, EMAIL-07 requirements by sending immediate notifications when business events occur.

Output: Edge Function `send-notification` with type-based routing and email templates for each notification type.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-email-scheduling/23-RESEARCH.md

# Existing patterns
@supabase/functions/send-invitation/index.ts
@src/types/approval.ts
@src/stores/approvalStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send-notification Edge Function</name>
  <files>supabase/functions/send-notification/index.ts</files>
  <action>
Create the triggered notification handler following send-invitation patterns:

1. Define notification types with templates:
   - `approval-request`: Sent to Manager when pending change created
     - Subject: "Approval Required: [entityName]"
     - Body: Shows entity type, change type, submitter name, link to approval queue
   - `approval-result`: Sent to submitter when change approved/rejected
     - Subject: "Change [Approved/Rejected]: [entityName]"
     - Body: Shows result, reviewer name, rejection reason if rejected
   - `test-assigned`: Sent to Control Tester when assigned
     - Subject: "Control Test Assigned: [controlName]"
     - Body: Shows control name, due date, link to tester dashboard

2. Request payload structure:
```typescript
interface NotificationRequest {
  type: 'approval-request' | 'approval-result' | 'test-assigned'
  recipientId: string  // User ID to send to
  data: {
    // For approval-request:
    entityType?: string
    entityName?: string
    changeType?: string
    submitterName?: string
    // For approval-result:
    result?: 'approved' | 'rejected'
    reviewerName?: string
    rejectionReason?: string
    // For test-assigned:
    controlName?: string
    dueDate?: string  // ISO date string
  }
}
```

3. JWT verification: Extract user JWT from Authorization header
   - Verify caller is authenticated
   - Use service role to look up recipient email from auth.admin.getUserById

4. Recipient email lookup:
   - Use supabaseAdmin.auth.admin.getUserById(recipientId)
   - Get full_name from profiles table for personalization

5. Template styling: Match existing invitation email style (orange CTA button, Arial font, etc.)

6. Graceful degradation: If RESEND_API_KEY not configured, return success with emailSent: false

7. Error handling: Return 200 with error details (don't expose internal errors to client)
  </action>
  <verify>
1. File exists at supabase/functions/send-notification/index.ts
2. Contains all three notification types with templates
3. Contains JWT verification logic
4. Contains Resend API integration
5. Contains recipient email lookup via admin API
  </verify>
  <done>
Edge Function created with:
- Three notification types (approval-request, approval-result, test-assigned)
- JWT authentication for callers
- Recipient email lookup via admin API
- Consistent email template styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure and Deploy send-notification</name>
  <files>supabase/config.toml</files>
  <action>
1. Add configuration for send-notification function to supabase/config.toml:
```toml
[functions.send-notification]
verify_jwt = false
```

Note: verify_jwt = false because we manually verify the JWT in the function code to get user context.

2. Deploy the function:
```bash
npx supabase functions deploy send-notification --no-verify-jwt
```

3. Test the function is reachable:
```bash
curl -X POST https://[project-ref].supabase.co/functions/v1/send-notification \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer [user-jwt]" \
  -d '{"type":"approval-request","recipientId":"[manager-id]","data":{"entityName":"Test"}}'
```
  </action>
  <verify>
1. supabase/config.toml contains [functions.send-notification] section
2. `npx supabase functions list` shows send-notification function
3. Function responds to HTTP requests (may return auth error without valid JWT, but should not 500)
  </verify>
  <done>
Function deployed and ready for frontend integration. Frontend will call this when:
- Creating pending changes (EMAIL-05)
- Approving/rejecting changes (EMAIL-06)
- Assigning tester to control (EMAIL-07)
  </done>
</task>

</tasks>

<verification>
- [ ] supabase/functions/send-notification/index.ts exists with all notification types
- [ ] supabase/config.toml has [functions.send-notification] section
- [ ] Function deploys without errors
- [ ] Function handles missing RESEND_API_KEY gracefully
</verification>

<success_criteria>
- Send Notification Edge Function handles all three notification types
- Templates match existing email styling
- JWT verification prevents unauthorized access
- Recipient email lookup works via admin API
</success_criteria>

<output>
After completion, create `.planning/phases/23-email-scheduling/23-02-SUMMARY.md`

Document:
- API endpoint and request format for each notification type
- How frontend should integrate (which events trigger which notifications)
- Required environment variables
</output>
