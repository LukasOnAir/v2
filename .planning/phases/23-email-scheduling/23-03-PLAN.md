---
phase: 23-email-scheduling
plan: 03
type: execute
wave: 2
depends_on: [23-02]
files_modified:
  - supabase/functions/process-reminders/index.ts
  - supabase/migrations/00011_scheduled_jobs.sql
  - supabase/config.toml
  - vercel.json
autonomous: true
user_setup:
  - service: supabase
    why: "Store secrets in Supabase Vault for pg_cron access"
    dashboard_config:
      - task: "Run Vault secret creation SQL in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"
        notes: "Execute the vault.create_secret calls from migration file"

must_haves:
  truths:
    - "Users receive reminder emails 7 days before their assigned test is due"
    - "Users receive alert emails when their assigned test is overdue"
    - "Remediation owners receive reminder emails 7 days before deadline"
  artifacts:
    - path: "supabase/functions/process-reminders/index.ts"
      provides: "Scheduled reminder batch processor"
      min_lines: 100
      exports: ["serve"]
    - path: "supabase/migrations/00011_scheduled_jobs.sql"
      provides: "pg_cron job setup and Vault secrets"
      contains: "cron.schedule"
    - path: "supabase/config.toml"
      provides: "Edge Function configuration"
      contains: "[functions.process-reminders]"
    - path: "vercel.json"
      provides: "Vercel cron backup scheduler"
      contains: "crons"
  key_links:
    - from: "pg_cron (00011_scheduled_jobs.sql)"
      to: "supabase/functions/process-reminders/index.ts"
      via: "pg_net HTTP POST"
      pattern: "net\\.http_post"
    - from: "vercel.json crons"
      to: "api/cron/reminders route"
      via: "Vercel Cron trigger"
      pattern: "crons.*schedule"
    - from: "supabase/functions/process-reminders/index.ts"
      to: "supabase/functions/send-notification/index.ts"
      via: "Internal function call or direct Resend"
      pattern: "send.*notification|resend"
---

<objective>
Set up pg_cron infrastructure for scheduled email reminders (test due, overdue, remediation deadline) with Edge Function batch processor and Vercel cron backup.

Purpose: Fulfill SCHED-01, SCHED-02, SCHED-03, SCHED-04 requirements by creating the scheduling infrastructure with redundancy. Note: Full functionality requires controls/tests/remediations in database (currently localStorage).

Output: pg_cron job that calls process-reminders Edge Function daily, with Vercel cron as backup scheduler, and stub queries ready for database data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-email-scheduling/23-RESEARCH.md
@.planning/phases/23-email-scheduling/23-02-SUMMARY.md

# Data structures
@src/types/rct.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create process-reminders Edge Function</name>
  <files>supabase/functions/process-reminders/index.ts</files>
  <action>
Create the scheduled reminder processor:

1. Authentication: Verify request has service role key (from pg_cron via Vault) OR valid cron secret header (from Vercel):
```typescript
const authHeader = req.headers.get('Authorization')
const cronSecret = req.headers.get('x-cron-secret')
const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
const expectedCronSecret = Deno.env.get('CRON_SECRET')

const isAuthorized =
  authHeader?.includes(serviceRoleKey) ||
  (cronSecret && cronSecret === expectedCronSecret)

if (!isAuthorized) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 })
}
```

2. Define reminder types to process:
```typescript
type ReminderType = 'test-due-7days' | 'test-overdue' | 'remediation-due-7days'
```

3. For each reminder type, create STUB queries that will work once data is in database:

**Test Due in 7 Days (SCHED-01):**
```sql
-- STUB: Requires controls table in database
-- SELECT c.id, c.name, c.next_test_date, c.assigned_tester_id, p.full_name, au.email
-- FROM controls c
-- JOIN profiles p ON c.assigned_tester_id = p.id
-- JOIN auth.users au ON p.id = au.id
-- WHERE c.next_test_date = CURRENT_DATE + INTERVAL '7 days'
--   AND c.assigned_tester_id IS NOT NULL
--   AND p.is_active = true
```

**Test Overdue (SCHED-02):**
```sql
-- STUB: Requires controls table in database
-- SELECT c.id, c.name, c.next_test_date, c.assigned_tester_id, p.full_name, au.email
-- FROM controls c
-- JOIN profiles p ON c.assigned_tester_id = p.id
-- JOIN auth.users au ON p.id = au.id
-- WHERE c.next_test_date < CURRENT_DATE
--   AND c.assigned_tester_id IS NOT NULL
--   AND p.is_active = true
```

**Remediation Due in 7 Days (SCHED-03):**
```sql
-- STUB: Requires remediation_plans table in database
-- SELECT r.id, r.title, r.deadline, r.owner_id, p.full_name, au.email
-- FROM remediation_plans r
-- JOIN profiles p ON r.owner_id = p.id
-- JOIN auth.users au ON p.id = au.id
-- WHERE r.deadline = CURRENT_DATE + INTERVAL '7 days'
--   AND r.status NOT IN ('resolved', 'closed')
--   AND p.is_active = true
```

4. For now, return success with a message that data source is not yet configured:
```typescript
return new Response(JSON.stringify({
  success: true,
  message: 'Scheduled reminder infrastructure ready. Controls/remediations not yet in database.',
  processed: { 'test-due-7days': 0, 'test-overdue': 0, 'remediation-due-7days': 0 }
}))
```

5. Add logging for when the function runs (for debugging cron schedule)

6. Batch processing pattern (ready for when data exists):
```typescript
const BATCH_SIZE = 50
// Process in batches to avoid timeouts
// For each batch, call send-notification or Resend directly
```
  </action>
  <verify>
1. File exists at supabase/functions/process-reminders/index.ts
2. Contains dual authentication check (service role OR cron secret)
3. Contains stub SQL queries as comments for all three reminder types
4. Contains batch processing pattern structure
5. Returns meaningful response about infrastructure readiness
  </verify>
  <done>
Edge Function created with:
- Dual authentication (pg_cron service role OR Vercel cron secret)
- Stub queries for all three reminder types (ready for database tables)
- Batch processing pattern
- Logging for debugging
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pg_cron Migration</name>
  <files>supabase/migrations/00011_scheduled_jobs.sql</files>
  <action>
Create migration to set up pg_cron job:

1. Enable required extensions (if not already):
```sql
-- pg_cron and pg_net should already be enabled in Supabase
-- This is a no-op if already enabled
CREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA pg_catalog;
CREATE EXTENSION IF NOT EXISTS pg_net WITH SCHEMA extensions;
```

2. Document Vault secret creation (must be run manually in SQL Editor):
```sql
-- IMPORTANT: Run these commands manually in Supabase SQL Editor
-- They cannot be run in migrations due to Vault permissions

-- Store the project URL
-- SELECT vault.create_secret('https://[PROJECT_REF].supabase.co', 'project_url');

-- Store the service role key (from Supabase Dashboard -> Settings -> API)
-- SELECT vault.create_secret('[SERVICE_ROLE_KEY]', 'service_role_key');
```

3. Create the cron job to run daily at 8 AM UTC:
```sql
SELECT cron.schedule(
  'process-daily-reminders',
  '0 8 * * *',
  $$
  SELECT net.http_post(
    url := (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'project_url') || '/functions/v1/process-reminders',
    headers := jsonb_build_object(
      'Authorization', 'Bearer ' || (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'service_role_key'),
      'Content-Type', 'application/json'
    ),
    body := jsonb_build_object('trigger', 'daily-reminder', 'timestamp', NOW()::text)
  );
  $$
);
```

4. Add comment explaining the job:
```sql
COMMENT ON SCHEMA cron IS 'pg_cron scheduled jobs for RiskGuard email reminders';
```
  </action>
  <verify>
1. File exists at supabase/migrations/00011_scheduled_jobs.sql
2. Contains pg_cron and pg_net extension creation
3. Contains cron.schedule call with daily timing
4. Contains documentation for Vault secret creation
5. Uses vault.decrypted_secrets for secure secret access
  </verify>
  <done>
Migration created with:
- Extension enablement
- Vault secret documentation
- Daily cron job at 8 AM UTC
- Secure secret handling via Vault
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Vercel Cron Backup (SCHED-04)</name>
  <files>vercel.json</files>
  <action>
Create or update vercel.json to add cron backup scheduler:

1. Check if vercel.json exists. If not, create it. If exists, add crons section.

2. Add cron configuration:
```json
{
  "crons": [
    {
      "path": "/api/cron/reminders",
      "schedule": "0 8 * * *"
    }
  ]
}
```

3. Create the API route at `src/pages/api/cron/reminders.ts` (or appropriate location based on project structure):
```typescript
import type { VercelRequest, VercelResponse } from '@vercel/node'

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // Verify cron secret to prevent unauthorized access
  const cronSecret = req.headers['x-cron-secret']
  if (cronSecret !== process.env.CRON_SECRET) {
    return res.status(401).json({ error: 'Unauthorized' })
  }

  // Call the Supabase Edge Function
  const response = await fetch(
    `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/process-reminders`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-cron-secret': process.env.CRON_SECRET || '',
      },
      body: JSON.stringify({ trigger: 'vercel-cron', timestamp: new Date().toISOString() }),
    }
  )

  const result = await response.json()
  return res.status(200).json({ source: 'vercel-cron', result })
}
```

Note: Vercel cron only runs on production deploys, so pg_cron is the primary scheduler. This is a backup for redundancy.

4. Add CRON_SECRET to environment variables documentation (generate a random UUID).
  </action>
  <verify>
1. vercel.json exists with crons section
2. Cron schedule is "0 8 * * *" (daily at 8 AM UTC)
3. API route exists at /api/cron/reminders
4. Route verifies CRON_SECRET header
  </verify>
  <done>
Vercel cron backup configured:
- vercel.json with daily cron schedule
- API route that calls process-reminders Edge Function
- Secret-based authentication for security
- Provides redundancy if pg_cron fails
  </done>
</task>

<task type="auto">
  <name>Task 4: Configure and Deploy</name>
  <files>supabase/config.toml</files>
  <action>
1. Add configuration for process-reminders function:
```toml
[functions.process-reminders]
verify_jwt = false
```

2. Deploy the function:
```bash
npx supabase functions deploy process-reminders --no-verify-jwt
```

3. Apply the migration:
```bash
npx supabase db push
```

Note: The cron job will start running, but will do nothing until Vault secrets are configured and database tables exist.

4. Verify cron job was created:
```sql
SELECT * FROM cron.job WHERE jobname = 'process-daily-reminders';
```
  </action>
  <verify>
1. supabase/config.toml contains [functions.process-reminders] section
2. Function deploys without errors
3. Migration applies successfully
4. Cron job exists in cron.job table
  </verify>
  <done>
Scheduling infrastructure complete:
- Edge Function deployed
- pg_cron job created (primary)
- Vercel cron configured (backup)
- Ready for Vault secret configuration
- Ready for database tables (controls, remediation_plans)
  </done>
</task>

</tasks>

<verification>
- [ ] supabase/functions/process-reminders/index.ts exists with stub queries
- [ ] supabase/migrations/00011_scheduled_jobs.sql exists with cron setup
- [ ] supabase/config.toml has [functions.process-reminders] section
- [ ] vercel.json has crons section with daily schedule
- [ ] API route for Vercel cron exists
- [ ] Function deploys without errors
- [ ] Migration applies without errors
- [ ] Cron job visible in cron.job table
</verification>

<success_criteria>
- pg_cron infrastructure set up and running daily at 8 AM UTC (primary)
- Vercel cron configured as backup scheduler (SCHED-04)
- Edge Function ready to process reminders when database tables exist
- Vault secret creation documented for user
- Stub queries ready for controls/remediation_plans tables
</success_criteria>

<output>
After completion, create `.planning/phases/23-email-scheduling/23-03-SUMMARY.md`

Document:
- Cron job schedule and name
- Vault secrets required and how to create them
- Vercel cron backup configuration
- CRON_SECRET environment variable needed
- Stub queries that need database tables
- What needs to happen for full functionality (database migration for controls)
</output>
