---
phase: 23-email-scheduling
plan: 04
type: execute
wave: 2
depends_on: [23-01, 23-02]
files_modified:
  - supabase/migrations/00012_email_preferences.sql
  - src/lib/supabase/types.ts
  - src/pages/ProfilePage.tsx
  - supabase/functions/send-notification/index.ts
autonomous: false
user_setup:
  - service: resend
    why: "Verify domain for email deliverability"
    dashboard_config:
      - task: "Add and verify sending domain"
        location: "Resend Dashboard -> Domains -> Add Domain"
        notes: "Add DNS records (SPF, DKIM) provided by Resend to your domain DNS"
  - service: dns
    why: "Add SPF/DKIM/DMARC records for email authentication"
    dashboard_config:
      - task: "Add SPF record from Resend"
        location: "DNS Provider (Cloudflare, Route 53, etc.)"
      - task: "Add DKIM record from Resend"
        location: "DNS Provider"
      - task: "Add DMARC record (optional but recommended)"
        location: "DNS Provider"
        notes: "v=DMARC1; p=none; rua=mailto:dmarc@yourdomain.com"

must_haves:
  truths:
    - "User can opt out of test reminder emails from their profile"
    - "Email preferences are stored in database and respected by notification functions"
    - "Domain is verified with Resend for production email delivery"
    - "Users who opt out do not receive reminder/approval notifications"
  artifacts:
    - path: "supabase/migrations/00012_email_preferences.sql"
      provides: "Email preferences column on profiles table"
      contains: "email_preferences"
    - path: "src/pages/ProfilePage.tsx"
      provides: "Email preferences toggle in user profile"
      contains: "email_preferences"
    - path: "src/lib/supabase/types.ts"
      provides: "Updated Profile type with email_preferences"
      contains: "email_preferences"
    - path: "supabase/functions/send-notification/index.ts"
      provides: "Updated to check email preferences before sending"
      contains: "email_preferences"
  key_links:
    - from: "src/pages/ProfilePage.tsx"
      to: "profiles.email_preferences"
      via: "Supabase update"
      pattern: "email_preferences"
    - from: "supabase/functions/send-notification/index.ts"
      to: "profiles.email_preferences"
      via: "Check before sending"
      pattern: "email_preferences"
---

<objective>
Add email preferences to user profiles (opt-out for reminders) and update send-notification to respect them. Also guide domain verification for production email deliverability.

Purpose: Fulfill SEC-06 (SPF/DKIM/DMARC) and allow users to manage notification preferences. Ensures email deliverability in production and respects user opt-out choices.

Output: Email preferences in database with profile UI toggle, send-notification checking preferences, plus domain verification checkpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-email-scheduling/23-RESEARCH.md
@.planning/phases/23-email-scheduling/23-01-SUMMARY.md
@.planning/phases/23-email-scheduling/23-02-SUMMARY.md

# Existing patterns
@supabase/migrations/00003_profiles.sql
@src/pages/ProfilePage.tsx
@src/lib/supabase/types.ts
@supabase/functions/send-notification/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Email Preferences to Database</name>
  <files>supabase/migrations/00012_email_preferences.sql, src/lib/supabase/types.ts</files>
  <action>
1. Create migration to add email_preferences column to profiles:

```sql
-- Add email preferences JSONB column to profiles
-- Defaults to all notifications enabled
ALTER TABLE public.profiles
ADD COLUMN email_preferences JSONB DEFAULT '{"test_reminders": true, "approval_notifications": true}'::jsonb;

-- Add comment
COMMENT ON COLUMN public.profiles.email_preferences IS 'User email notification preferences';
```

2. Update src/lib/supabase/types.ts to include email_preferences in Profile type:

Find the Profile type/interface and add:
```typescript
email_preferences: {
  test_reminders: boolean
  approval_notifications: boolean
} | null
```

Note: JSONB allows future extensibility for additional preference types.

3. Apply the migration:
```bash
npx supabase db push
```
  </action>
  <verify>
1. Migration file exists at supabase/migrations/00012_email_preferences.sql
2. Migration applies without errors
3. src/lib/supabase/types.ts includes email_preferences in Profile type
4. Column exists on profiles table: `SELECT email_preferences FROM profiles LIMIT 1;`
  </verify>
  <done>
Database schema updated with email_preferences column and TypeScript types updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Email Preferences UI to ProfilePage</name>
  <files>src/pages/ProfilePage.tsx</files>
  <action>
Add email preferences section to ProfilePage:

1. Read ProfilePage.tsx to understand existing structure
2. Add a new section for "Email Preferences" below the existing sections
3. Add toggle switches for:
   - Test Reminders (test_reminders): "Receive reminders about upcoming and overdue control tests"
   - Approval Notifications (approval_notifications): "Receive notifications about approval requests and results"

4. Use the same styling patterns as existing profile form sections
5. Add state management for email preferences
6. Add save handler that updates profiles table via Supabase

UI structure:
```tsx
<section>
  <h3>Email Preferences</h3>
  <div className="space-y-4">
    <label className="flex items-center gap-3">
      <input
        type="checkbox"
        checked={emailPreferences.test_reminders}
        onChange={(e) => updateEmailPreference('test_reminders', e.target.checked)}
        className="...existing checkbox styling..."
      />
      <div>
        <span>Test Reminders</span>
        <p className="text-sm text-gray-500">
          Receive reminders about upcoming and overdue control tests
        </p>
      </div>
    </label>
    {/* Similar for approval_notifications */}
  </div>
</section>
```

5. Save preferences on change (debounced or with save button).
  </action>
  <verify>
1. ProfilePage.tsx contains email preferences section
2. Two toggle options visible (test_reminders, approval_notifications)
3. Changes persist to database when toggled
4. Page loads with saved preferences from database
  </verify>
  <done>
ProfilePage updated with email preferences toggles that persist to database.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update send-notification to Check Email Preferences</name>
  <files>supabase/functions/send-notification/index.ts</files>
  <action>
Update the send-notification Edge Function to query and respect email preferences before sending:

1. After looking up the recipient from profiles table, also fetch their email_preferences:
```typescript
const { data: profile } = await supabaseAdmin
  .from('profiles')
  .select('id, full_name, email_preferences')
  .eq('id', recipientId)
  .single()
```

2. Add preference checking logic before sending:
```typescript
// Map notification type to preference key
const preferenceMap: Record<NotificationType, keyof EmailPreferences> = {
  'approval-request': 'approval_notifications',
  'approval-result': 'approval_notifications',
  'test-assigned': 'test_reminders',
}

const preferenceKey = preferenceMap[type]
const preferences = profile?.email_preferences ?? { test_reminders: true, approval_notifications: true }

// Check if user has opted out
if (preferenceKey && preferences[preferenceKey] === false) {
  return new Response(JSON.stringify({
    success: true,
    emailSent: false,
    reason: 'User has opted out of this notification type'
  }), { status: 200 })
}
```

3. Update the types at the top of the function:
```typescript
interface EmailPreferences {
  test_reminders: boolean
  approval_notifications: boolean
}
```

4. Log when emails are skipped due to preferences (for debugging)

5. Continue with normal email sending if user has not opted out
  </action>
  <verify>
1. send-notification/index.ts fetches email_preferences from profiles
2. Contains preferenceMap linking notification types to preference keys
3. Returns early with emailSent: false when user has opted out
4. Default behavior (no preferences set) is to send the email
  </verify>
  <done>
send-notification updated to:
- Query email_preferences from profiles
- Skip sending if user has opted out of notification type
- Return success with emailSent: false when skipped
- Default to sending if no preferences set
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
1. Email preferences database column and TypeScript types
2. Profile page UI with email preference toggles
3. send-notification function respects preferences
4. Preferences persist to Supabase database
  </what-built>
  <how-to-verify>
1. Navigate to Profile page in the application
2. Find the "Email Preferences" section
3. Toggle "Test Reminders" off
4. Refresh the page - verify toggle remains off
5. Toggle "Approval Notifications" off
6. Check database directly: `SELECT email_preferences FROM profiles WHERE id = '[your-user-id]';`
7. Verify JSON shows both preferences as false
8. Test notification behavior:
   - With preferences OFF, trigger a test assignment (should NOT send email)
   - With preferences ON, trigger a test assignment (should send email)
  </how-to-verify>
  <resume-signal>Type "preferences-verified" to continue, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] supabase/migrations/00012_email_preferences.sql exists and applies
- [ ] src/lib/supabase/types.ts has email_preferences in Profile type
- [ ] ProfilePage.tsx has Email Preferences section with toggles
- [ ] send-notification/index.ts checks email_preferences before sending
- [ ] Preferences persist to database
- [ ] Opted-out users do not receive notifications
- [ ] User verified functionality works
</verification>

<success_criteria>
- Email preferences column added to profiles table
- ProfilePage shows email preference toggles
- Preferences save to database and load on page refresh
- send-notification respects user preferences (skips sending when opted out)
- User has verified the functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/23-email-scheduling/23-04-SUMMARY.md`

Document:
- Email preference fields and their meaning
- How send-notification checks preferences before sending
- Preference key mapping (which notification types respect which preference)
- Domain verification status (from user_setup)
- Any DNS records that need to be added
</output>
