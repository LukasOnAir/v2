---
phase: 24-demo-seeders-deployment
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/accept-invitation/index.ts
  - supabase/functions/send-invitation/index.ts
  - supabase/functions/send-notification/index.ts
autonomous: true

must_haves:
  truths:
    - "All Edge Functions validate input with Zod before processing"
    - "Invalid requests return 400 with structured error details"
    - "Valid requests proceed to business logic unchanged"
    - "Validation errors include field-level details"
  artifacts:
    - path: "supabase/functions/accept-invitation/index.ts"
      provides: "Invitation acceptance with Zod validation"
      contains: "z.object"
    - path: "supabase/functions/send-invitation/index.ts"
      provides: "Invitation sending with Zod validation"
      contains: "z.object"
    - path: "supabase/functions/send-notification/index.ts"
      provides: "Notification sending with Zod validation"
      contains: "z.object"
  key_links:
    - from: "Edge Functions"
      to: "Zod"
      via: "Deno import"
      pattern: "https://deno.land/x/zod"
---

<objective>
Add Zod server-side validation to Edge Functions for SEC-04 compliance.

Purpose: Edge Functions bypass RLS and accept untrusted input. Server-side validation prevents malformed data from reaching business logic or database. This satisfies SEC-04 (validate all inputs server-side before database operations).

Output: Updated Edge Functions with Zod schema validation at request entry point.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-demo-seeders-deployment/24-RESEARCH.md

# Edge Functions to update
@supabase/functions/accept-invitation/index.ts
@supabase/functions/send-invitation/index.ts
@supabase/functions/send-notification/index.ts

# Note: send-email and process-reminders are triggered by Supabase hooks/cron, not user input
# They don't need user input validation (internal triggers only)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Zod validation to accept-invitation</name>
  <files>supabase/functions/accept-invitation/index.ts</files>
  <action>
Add Zod schema validation to accept-invitation Edge Function.

1. Add Zod import at top:
   ```typescript
   import { z } from 'https://deno.land/x/zod@v3.22.4/mod.ts'
   ```

2. Define request schema after imports:
   ```typescript
   const AcceptInvitationSchema = z.object({
     token: z.string().uuid('Invalid invitation token format'),
     password: z.string().min(8, 'Password must be at least 8 characters'),
     fullName: z.string().max(100).optional(),
   })
   ```

3. Replace manual validation (lines 17-32) with Zod validation:
   ```typescript
   const body = await req.json()
   const parseResult = AcceptInvitationSchema.safeParse(body)

   if (!parseResult.success) {
     return new Response(
       JSON.stringify({
         error: 'Invalid request',
         details: parseResult.error.flatten().fieldErrors,
       }),
       { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
     )
   }

   const { token, password, fullName } = parseResult.data
   ```

4. Remove the duplicate manual validation for password length (already in schema).

5. Keep all business logic after validation unchanged.
  </action>
  <verify>
Test validation:
```bash
# Invalid token format
curl -X POST https://<project>.supabase.co/functions/v1/accept-invitation \
  -H "Content-Type: application/json" \
  -d '{"token": "not-a-uuid", "password": "validpass123"}'
# Should return 400 with fieldErrors.token

# Short password
curl -X POST https://<project>.supabase.co/functions/v1/accept-invitation \
  -H "Content-Type: application/json" \
  -d '{"token": "550e8400-e29b-41d4-a716-446655440000", "password": "short"}'
# Should return 400 with fieldErrors.password

# Valid format (will fail on business logic, not validation)
curl -X POST https://<project>.supabase.co/functions/v1/accept-invitation \
  -H "Content-Type: application/json" \
  -d '{"token": "550e8400-e29b-41d4-a716-446655440000", "password": "validpass123"}'
# Should return 400 "Invalid or expired invitation" (validation passed, business logic failed)
```
  </verify>
  <done>accept-invitation validates input with Zod, returns structured errors</done>
</task>

<task type="auto">
  <name>Task 2: Add Zod validation to send-invitation and send-notification</name>
  <files>
supabase/functions/send-invitation/index.ts
supabase/functions/send-notification/index.ts
  </files>
  <action>
Add Zod validation to remaining user-facing Edge Functions.

**send-invitation/index.ts:**

1. Add Zod import:
   ```typescript
   import { z } from 'https://deno.land/x/zod@v3.22.4/mod.ts'
   ```

2. Define schema (check existing code for expected fields):
   ```typescript
   const SendInvitationSchema = z.object({
     email: z.string().email('Invalid email format'),
     role: z.enum(['manager', 'risk-manager', 'control-owner', 'control-tester'], {
       errorMap: () => ({ message: 'Invalid role' }),
     }),
   })
   ```
   Note: Director role excluded per 22-01 decision.

3. Add validation after CORS check, before business logic:
   ```typescript
   const body = await req.json()
   const parseResult = SendInvitationSchema.safeParse(body)

   if (!parseResult.success) {
     return new Response(
       JSON.stringify({
         error: 'Invalid request',
         details: parseResult.error.flatten().fieldErrors,
       }),
       { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
     )
   }

   const { email, role } = parseResult.data
   ```

4. Remove any existing manual validation that Zod now handles.

**send-notification/index.ts:**

1. Add Zod import.

2. Define schema based on notification types (check existing code):
   ```typescript
   const NotificationSchema = z.object({
     type: z.enum(['approval_request', 'approval_result', 'test_assigned']),
     recipientId: z.string().uuid('Invalid recipient ID'),
     // Additional fields depend on type - use discriminated union if needed
     payload: z.record(z.unknown()).optional(),
   })
   ```
   Note: Adjust schema based on actual notification payload structure in existing code.

3. Add validation after CORS check.

4. Keep all existing business logic.
  </action>
  <verify>
Test send-invitation validation:
```bash
# Invalid email
curl -X POST https://<project>.supabase.co/functions/v1/send-invitation \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <jwt>" \
  -d '{"email": "not-an-email", "role": "manager"}'
# Should return 400 with fieldErrors.email

# Invalid role
curl -X POST https://<project>.supabase.co/functions/v1/send-invitation \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <jwt>" \
  -d '{"email": "valid@example.com", "role": "director"}'
# Should return 400 with fieldErrors.role
```

Verify send-notification has validation (internal testing or code review).
  </verify>
  <done>send-invitation and send-notification validate input with Zod</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Verify Zod imports in all 3 Edge Functions:
   ```bash
   grep -l "deno.land/x/zod" supabase/functions/*/index.ts
   ```
   Should show: accept-invitation, send-invitation, send-notification

2. Verify schema definitions exist:
   ```bash
   grep -l "z.object" supabase/functions/*/index.ts
   ```
   Should show same 3 files

3. Verify error responses include structured details (check code for `fieldErrors`)

4. Optional: Deploy and test with invalid payloads to confirm 400 responses
</verification>

<success_criteria>
- All 3 user-facing Edge Functions have Zod validation
- Invalid requests return 400 with `error` and `details` fields
- Validation happens before any database operations
- Existing business logic unchanged
- SEC-04 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/24-demo-seeders-deployment/24-03-SUMMARY.md`
</output>
