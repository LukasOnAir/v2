---
phase: 24-demo-seeders-deployment
plan: 04
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - supabase/functions/seed-demo-data/index.ts
  - src/components/admin/PresetSelector.tsx
  - src/pages/TenantSetupPage.tsx
autonomous: true

must_haves:
  truths:
    - "Director can select a preset during tenant initialization"
    - "Edge Function accepts preset name and tenant_id, inserts demo data"
    - "Demo data is correctly associated with the tenant (tenant_id on all rows)"
    - "Empty preset results in no data insertion"
    - "Invalid preset names return 400 error"
  artifacts:
    - path: "supabase/functions/seed-demo-data/index.ts"
      provides: "Edge Function to seed demo data for a tenant"
      exports: ["serve handler"]
    - path: "src/components/admin/PresetSelector.tsx"
      provides: "UI component for selecting demo preset"
      exports: ["PresetSelector"]
    - path: "src/pages/TenantSetupPage.tsx"
      provides: "Page for initial tenant setup including preset selection"
      exports: ["TenantSetupPage"]
  key_links:
    - from: "seed-demo-data/index.ts"
      to: "presets/*.ts"
      via: "dynamic import"
      pattern: "import.*Preset.*from.*presets"
    - from: "PresetSelector.tsx"
      to: "seed-demo-data"
      via: "supabase.functions.invoke"
      pattern: "supabase\\.functions\\.invoke.*seed-demo-data"
    - from: "TenantSetupPage.tsx"
      to: "PresetSelector.tsx"
      via: "component import"
      pattern: "import.*PresetSelector"
---

<objective>
Create the seed-demo-data Edge Function and preset selection UI.

Purpose: Enable Directors to populate their tenant with industry-specific demo data during initial setup. This powers sales demos where prospects see realistic data relevant to their industry.

Output: Edge Function that inserts demo data, UI component for preset selection, and a tenant setup page integrating both.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-demo-seeders-deployment/24-RESEARCH.md
@.planning/phases/24-demo-seeders-deployment/24-01-SUMMARY.md

# Preset data modules created in Plan 01
# supabase/functions/seed-demo-data/presets/types.ts
# supabase/functions/seed-demo-data/presets/*.ts

# Edge Function patterns
@supabase/functions/accept-invitation/index.ts

# Existing stores to update (for inserting demo data into stores if needed)
@src/stores/taxonomyStore.ts
@src/stores/rctStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create seed-demo-data Edge Function</name>
  <files>supabase/functions/seed-demo-data/index.ts</files>
  <action>
Create the main Edge Function that seeds demo data for a tenant.

1. Import dependencies:
   ```typescript
   import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
   import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
   import { z } from 'https://deno.land/x/zod@v3.22.4/mod.ts'
   ```

2. Import preset data (static imports since Deno doesn't support dynamic import well):
   ```typescript
   import { emptyPreset } from './presets/empty.ts'
   import { casinoPreset } from './presets/casino.ts'
   import { bankPreset } from './presets/bank.ts'
   import { insurerPreset } from './presets/insurer.ts'
   import { genericPreset } from './presets/generic.ts'
   import type { PresetData, SeedTaxonomyItem, SeedControl } from './presets/types.ts'

   const PRESETS: Record<string, PresetData> = {
     empty: emptyPreset,
     casino: casinoPreset,
     bank: bankPreset,
     insurer: insurerPreset,
     generic: genericPreset,
   }
   ```

3. Define request schema:
   ```typescript
   const SeedRequestSchema = z.object({
     preset: z.enum(['empty', 'casino', 'bank', 'insurer', 'generic']),
     tenantId: z.string().uuid(),
   })
   ```

4. CORS headers (same pattern as accept-invitation).

5. Main handler:
   - Validate request with Zod
   - Verify caller is Director of the specified tenant (check JWT claims)
   - Load preset data
   - If preset is 'empty', return success immediately
   - Generate UUIDs for taxonomy items using crypto.randomUUID()
   - Insert risk taxonomy (hierarchical structure - build flat insert with parent_id references)
   - Insert process taxonomy
   - Generate RCT rows from rctPairings (match paths to inserted taxonomy IDs)
   - Insert controls linked to RCT rows
   - Return success with count of items created

6. Helper functions:
   ```typescript
   function generateHierarchicalIds(items: SeedTaxonomyItem[], prefix = ''): Array<{id: string, hierarchicalId: string, ...}>
   // Similar to existing generateHierarchicalIds utility
   ```

7. Error handling:
   - Wrap in try/catch
   - Return structured errors
   - Use transaction if possible (Supabase doesn't have explicit transactions via JS, but can use RPC if needed)

Note: The data model uses localStorage stores currently. For this phase, the Edge Function should insert into the Supabase database tables that will be created. If tables don't exist yet (Phase 25 might add them), stub the inserts with console.log and comments indicating future database structure.

Actually, reviewing the codebase: data is stored in localStorage via Zustand stores. The seeder should work with whatever persistence layer exists. For now, since there's no database tables for risks/processes/controls yet, the Edge Function should return the preset data as JSON for the frontend to load into stores.

Revised approach:
- Edge Function validates request and returns preset data
- Frontend receives data and loads into Zustand stores
- This avoids database schema dependency
  </action>
  <verify>
1. Deploy function: `supabase functions deploy seed-demo-data`
2. Test with valid request:
   ```bash
   curl -X POST https://<project>.supabase.co/functions/v1/seed-demo-data \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer <jwt>" \
     -d '{"preset": "casino", "tenantId": "<uuid>"}'
   ```
3. Should return JSON with risks, processes, controls arrays
4. Test with invalid preset:
   ```bash
   curl -X POST ... -d '{"preset": "invalid", "tenantId": "<uuid>"}'
   ```
5. Should return 400 with validation error
  </verify>
  <done>seed-demo-data Edge Function returns preset data based on selection</done>
</task>

<task type="auto">
  <name>Task 2: Create PresetSelector and TenantSetupPage</name>
  <files>
src/components/admin/PresetSelector.tsx
src/pages/TenantSetupPage.tsx
  </files>
  <action>
Create UI for preset selection and tenant setup.

**PresetSelector.tsx:**
```typescript
// src/components/admin/PresetSelector.tsx
import { useState } from 'react'
import { Building2, Landmark, Shield, Briefcase, FolderX } from 'lucide-react'
import { clsx } from 'clsx'

interface PresetOption {
  id: string
  name: string
  description: string
  icon: React.ElementType
  industries: string[]
}

const PRESET_OPTIONS: PresetOption[] = [
  {
    id: 'casino',
    name: 'Casino',
    description: 'Gaming operations, AML/KYC compliance, surveillance',
    icon: Building2,
    industries: ['Casino', 'Gaming', 'Entertainment'],
  },
  {
    id: 'bank',
    name: 'Financial Services',
    description: 'Credit risk, market risk, regulatory compliance',
    icon: Landmark,
    industries: ['Banking', 'Investment', 'FinTech'],
  },
  {
    id: 'insurer',
    name: 'Insurance',
    description: 'Underwriting, claims, investment risk management',
    icon: Shield,
    industries: ['Insurance', 'Reinsurance', 'Healthcare'],
  },
  {
    id: 'generic',
    name: 'General ERM',
    description: 'Standard enterprise risk management framework',
    icon: Briefcase,
    industries: ['Manufacturing', 'Retail', 'Services'],
  },
  {
    id: 'empty',
    name: 'Start Empty',
    description: 'Begin with a blank slate and build your own framework',
    icon: FolderX,
    industries: [],
  },
]

interface PresetSelectorProps {
  selectedPreset: string | null
  onSelect: (presetId: string) => void
  disabled?: boolean
}

export function PresetSelector({ selectedPreset, onSelect, disabled }: PresetSelectorProps) {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {PRESET_OPTIONS.map((preset) => {
        const Icon = preset.icon
        const isSelected = selectedPreset === preset.id

        return (
          <button
            key={preset.id}
            onClick={() => onSelect(preset.id)}
            disabled={disabled}
            className={clsx(
              'p-4 rounded-lg border text-left transition-all',
              'hover:border-accent-400 hover:bg-surface-elevated',
              isSelected
                ? 'border-accent-500 bg-accent-500/10'
                : 'border-surface-border bg-surface-overlay',
              disabled && 'opacity-50 cursor-not-allowed'
            )}
          >
            <div className="flex items-start gap-3">
              <div className={clsx(
                'p-2 rounded-lg',
                isSelected ? 'bg-accent-500/20 text-accent-400' : 'bg-surface-elevated text-text-muted'
              )}>
                <Icon size={24} />
              </div>
              <div className="flex-1 min-w-0">
                <h3 className="font-medium text-text-primary">{preset.name}</h3>
                <p className="text-sm text-text-secondary mt-1">{preset.description}</p>
                {preset.industries.length > 0 && (
                  <div className="flex flex-wrap gap-1 mt-2">
                    {preset.industries.map((industry) => (
                      <span
                        key={industry}
                        className="text-xs px-2 py-0.5 rounded bg-surface-elevated text-text-muted"
                      >
                        {industry}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </button>
        )
      })}
    </div>
  )
}
```

**TenantSetupPage.tsx:**
Create a page that shows after first login for Directors to initialize their tenant.

```typescript
// src/pages/TenantSetupPage.tsx
import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { Loader2 } from 'lucide-react'
import { PresetSelector } from '@/components/admin/PresetSelector'
import { useTaxonomyStore } from '@/stores/taxonomyStore'
import { useRCTStore } from '@/stores/rctStore'
import { useControlsStore } from '@/stores/controlsStore'
import { supabase } from '@/lib/supabase'
import { useAuth } from '@/hooks/useAuth'

export function TenantSetupPage() {
  const navigate = useNavigate()
  const { user, tenantId } = useAuth()
  const [selectedPreset, setSelectedPreset] = useState<string | null>(null)
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const setRisks = useTaxonomyStore((state) => state.setRisks)
  const setProcesses = useTaxonomyStore((state) => state.setProcesses)
  const setRows = useRCTStore((state) => state.setRows)
  // const addControl = useControlsStore(...) - for controls

  const handleSetup = async () => {
    if (!selectedPreset || !tenantId) return

    setIsLoading(true)
    setError(null)

    try {
      const { data, error: fnError } = await supabase.functions.invoke('seed-demo-data', {
        body: { preset: selectedPreset, tenantId },
      })

      if (fnError) throw fnError

      if (selectedPreset !== 'empty' && data) {
        // Load data into stores
        if (data.risks) setRisks(data.risks)
        if (data.processes) setProcesses(data.processes)
        if (data.rows) setRows(data.rows)
        // Load controls if present
      }

      // Navigate to dashboard
      navigate('/dashboard')
    } catch (err) {
      console.error('Setup error:', err)
      setError(err instanceof Error ? err.message : 'Failed to initialize tenant')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="min-h-screen bg-surface-base flex items-center justify-center p-4">
      <div className="max-w-3xl w-full">
        <div className="text-center mb-8">
          <h1 className="text-2xl font-bold text-text-primary">Welcome to RiskGuard</h1>
          <p className="text-text-secondary mt-2">
            Choose a starting template for your risk management framework
          </p>
        </div>

        <PresetSelector
          selectedPreset={selectedPreset}
          onSelect={setSelectedPreset}
          disabled={isLoading}
        />

        {error && (
          <div className="mt-4 p-3 rounded bg-red-500/10 border border-red-500/50 text-red-400 text-sm">
            {error}
          </div>
        )}

        <div className="mt-8 flex justify-center">
          <button
            onClick={handleSetup}
            disabled={!selectedPreset || isLoading}
            className={clsx(
              'px-6 py-3 rounded-lg font-medium transition-colors',
              'bg-accent-500 text-white hover:bg-accent-600',
              'disabled:opacity-50 disabled:cursor-not-allowed',
              'flex items-center gap-2'
            )}
          >
            {isLoading && <Loader2 size={20} className="animate-spin" />}
            {isLoading ? 'Setting up...' : 'Continue'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

Add route to router (note location for executor to add).
Add clsx import if not present.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to `/tenant-setup` (or integrate into routing)
3. Verify:
   - All 5 preset options displayed
   - Selection highlights correctly
   - Continue button disabled until selection made
   - Loading state shows during API call
4. Select a preset and click Continue:
   - Should call Edge Function
   - Should load data into stores (check React DevTools or localStorage)
   - Should navigate to dashboard
  </verify>
  <done>PresetSelector component and TenantSetupPage exist and wire to Edge Function</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Edge Function exists and is deployable:
   ```bash
   ls supabase/functions/seed-demo-data/index.ts
   ```

2. UI components exist:
   ```bash
   ls src/components/admin/PresetSelector.tsx
   ls src/pages/TenantSetupPage.tsx
   ```

3. End-to-end flow:
   - Navigate to tenant setup
   - Select "Casino" preset
   - Click Continue
   - Verify taxonomy stores populated with casino data
   - Navigate to Risk Taxonomy page - should show casino risks
</verification>

<success_criteria>
- seed-demo-data Edge Function accepts preset and tenantId, returns preset data
- PresetSelector displays 5 options with visual feedback
- TenantSetupPage integrates selector and loads data into stores
- Empty preset results in no data loaded
- All 5 presets work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/24-demo-seeders-deployment/24-04-SUMMARY.md`
</output>
