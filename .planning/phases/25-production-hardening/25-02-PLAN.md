---
phase: 25-production-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/logging/logger.ts
  - supabase/functions/send-notification/index.ts
  - supabase/functions/send-invitation/index.ts
  - supabase/functions/send-email/index.ts
  - supabase/functions/process-reminders/index.ts
  - supabase/functions/accept-invitation/index.ts
  - supabase/functions/seed-demo-data/index.ts
autonomous: true

must_haves:
  truths:
    - "All Edge Functions log with structured JSON output"
    - "Log entries include timestamp, level, function name, and request ID"
    - "Errors include error name, message, and stack trace in structured format"
    - "Frontend logger available for consistent logging patterns"
  artifacts:
    - path: "src/lib/logging/logger.ts"
      provides: "Structured logging utility for frontend"
      exports: ["logger", "log"]
    - path: "supabase/functions/send-notification/index.ts"
      provides: "Notification function with structured logging"
      contains: "logStructured"
  key_links:
    - from: "supabase/functions/*/index.ts"
      to: "console.log/error"
      via: "logStructured wrapper"
      pattern: "logStructured.*level.*message"
---

<objective>
Implement structured logging for consistent, parseable log output across frontend and Edge Functions.

Purpose: Enable easier log filtering and analysis in Vercel/Supabase dashboards by using JSON-formatted logs with consistent structure.
Output: Logger utility and updated Edge Functions with structured logging patterns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-production-hardening/25-RESEARCH.md
@supabase/functions/send-notification/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create frontend logger utility</name>
  <files>
    - src/lib/logging/logger.ts
  </files>
  <action>
    1. Create src/lib/logging/ directory

    2. Create logger.ts with:
       ```typescript
       type LogLevel = 'debug' | 'info' | 'warn' | 'error'

       interface LogEntry {
         level: LogLevel
         message: string
         timestamp: string
         context?: Record<string, unknown>
         error?: {
           name: string
           message: string
           stack?: string
         }
       }

       export function log(
         level: LogLevel,
         message: string,
         context?: Record<string, unknown>,
         error?: Error
       ) {
         const entry: LogEntry = {
           level,
           message,
           timestamp: new Date().toISOString(),
           context,
         }

         if (error) {
           entry.error = {
             name: error.name,
             message: error.message,
             stack: error.stack,
           }
         }

         // In production, structured JSON for log aggregation
         // In development, formatted for readability
         if (import.meta.env.PROD) {
           console[level](JSON.stringify(entry))
         } else {
           console[level](`[${level.toUpperCase()}] ${message}`, context || '', error || '')
         }
       }

       export const logger = {
         debug: (msg: string, ctx?: Record<string, unknown>) => log('debug', msg, ctx),
         info: (msg: string, ctx?: Record<string, unknown>) => log('info', msg, ctx),
         warn: (msg: string, ctx?: Record<string, unknown>) => log('warn', msg, ctx),
         error: (msg: string, ctx?: Record<string, unknown>, err?: Error) => log('error', msg, ctx, err),
       }
       ```

    This utility is for frontend use. Edge Functions will have an inline version since they run in Deno.
  </action>
  <verify>
    - File src/lib/logging/logger.ts exists
    - `npm run build` succeeds
    - Exports logger object with debug/info/warn/error methods
  </verify>
  <done>
    Frontend logger utility exists with structured JSON output in production and readable output in development.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add structured logging to all Edge Functions</name>
  <files>
    - supabase/functions/send-notification/index.ts
    - supabase/functions/send-invitation/index.ts
    - supabase/functions/send-email/index.ts
    - supabase/functions/process-reminders/index.ts
    - supabase/functions/accept-invitation/index.ts
    - supabase/functions/seed-demo-data/index.ts
  </files>
  <action>
    For EACH Edge Function, add a structured logging helper at the top and replace console.log/error calls:

    1. Add this helper function after imports:
       ```typescript
       function logStructured(
         level: 'debug' | 'info' | 'warn' | 'error',
         message: string,
         context?: Record<string, unknown>
       ) {
         const entry = {
           level,
           message,
           timestamp: new Date().toISOString(),
           function: 'FUNCTION_NAME', // Replace with actual function name
           ...context,
         }
         console[level](JSON.stringify(entry))
       }
       ```

    2. In the serve() handler, generate a requestId at the start:
       ```typescript
       const requestId = crypto.randomUUID()
       ```

    3. Replace existing console.log/console.error calls:
       - `console.log('DEBUG: something', value)` becomes:
         `logStructured('info', 'something', { requestId, value })`
       - `console.error('Error:', error)` becomes:
         `logStructured('error', 'Request failed', { requestId, error: error instanceof Error ? error.message : 'Unknown' })`

    4. Add request start/end logging:
       - At function start: `logStructured('info', 'Function invoked', { requestId, method: req.method })`
       - Before return: `logStructured('info', 'Request completed', { requestId, status: 200 })`

    5. Keep the existing behavior - don't change the logic, only the logging format.

    Function names to use:
    - send-notification
    - send-invitation
    - send-email
    - process-reminders
    - accept-invitation
    - seed-demo-data

    IMPORTANT: Be careful not to log sensitive data like:
    - Full email addresses (use first 3 chars + '***@...')
    - JWT tokens
    - Passwords
    - Full request bodies (pick specific safe fields)
  </action>
  <verify>
    - Each Edge Function has logStructured helper
    - Each Edge Function generates requestId
    - No console.log('DEBUG: ...') patterns remain
    - `npm run build` still succeeds (frontend)
    - Supabase functions deploy without syntax errors: `npx supabase functions deploy --dry-run` (if available)
  </verify>
  <done>
    All 6 Edge Functions use structured JSON logging with request IDs for traceability.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npm run build` succeeds
2. Each Edge Function file has logStructured function
3. Each Edge Function generates requestId at request start
4. Log format is JSON with: level, message, timestamp, function, requestId
5. No sensitive data (emails, tokens) logged in full
</verification>

<success_criteria>
- Frontend logger utility at src/lib/logging/logger.ts
- All 6 Edge Functions have structured logging
- Request IDs enable tracing requests across log entries
- Log entries are valid JSON (parseable)
- No sensitive data exposure in logs
</success_criteria>

<output>
After completion, create `.planning/phases/25-production-hardening/25-02-SUMMARY.md`
</output>
