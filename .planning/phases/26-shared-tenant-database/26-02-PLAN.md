---
phase: 26-shared-tenant-database
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00018_control_tests.sql
  - supabase/migrations/00019_remediation_plans.sql
  - supabase/migrations/00020_custom_columns.sql
  - supabase/migrations/00021_tickets.sql
  - supabase/migrations/00022_comments.sql
  - supabase/migrations/00023_pending_changes.sql
  - supabase/migrations/00024_approval_settings.sql
  - supabase/migrations/00025_score_labels.sql
autonomous: true

must_haves:
  truths:
    - "control_tests table exists with RLS policy for tenant isolation"
    - "remediation_plans table exists with RLS policy for tenant isolation"
    - "tickets table exists with RLS policy for tenant isolation"
    - "comments table exists with RLS policy for tenant isolation"
    - "pending_changes table exists with RLS policy for tenant isolation"
  artifacts:
    - path: "supabase/migrations/00018_control_tests.sql"
      provides: "Control test records"
      contains: "CREATE TABLE public.control_tests"
    - path: "supabase/migrations/00019_remediation_plans.sql"
      provides: "Remediation plans for failed tests"
      contains: "CREATE TABLE public.remediation_plans"
    - path: "supabase/migrations/00021_tickets.sql"
      provides: "Task management tickets"
      contains: "CREATE TABLE public.tickets"
    - path: "supabase/migrations/00022_comments.sql"
      provides: "Threaded comments on entities"
      contains: "CREATE TABLE public.comments"
    - path: "supabase/migrations/00023_pending_changes.sql"
      provides: "Four-eye approval workflow"
      contains: "CREATE TABLE public.pending_changes"
  key_links:
    - from: "supabase/migrations/00018_control_tests.sql"
      to: "public.controls"
      via: "foreign key reference"
      pattern: "REFERENCES public\\.controls"
---

<objective>
Create the remaining database schema migrations for control tests, remediation plans, custom columns, tickets, comments, pending changes, approval settings, and score labels.

Purpose: These tables support the complete application functionality - testing workflow, remediation tracking, task management, collaboration, and four-eye approval. They can be created in parallel with Plan 01 as they reference tables that will exist after Plan 01 runs.

Output: 8 SQL migration files that complete the database schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-shared-tenant-database/26-RESEARCH.md

# Existing migrations
@supabase/migrations/00002_rls_helper_functions.sql
@supabase/migrations/00003_profiles.sql

# Type definitions for schema alignment
@src/types/rct.ts
@src/types/tickets.ts
@src/types/collaboration.ts
@src/types/approval.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create control_tests, remediation_plans, and custom_columns migrations</name>
  <files>
    supabase/migrations/00018_control_tests.sql
    supabase/migrations/00019_remediation_plans.sql
    supabase/migrations/00020_custom_columns.sql
  </files>
  <action>
Create three migration files following schemas from 26-RESEARCH.md:

**00018_control_tests.sql:**
- Test execution records
- Columns from ControlTest type: id, tenant_id, control_id (FK), rct_row_id (FK nullable), tester_id (FK to profiles nullable), tester_name, test_date, result (CHECK 'pass','fail','partial','not-tested'), effectiveness (1-5), evidence, findings, recommendations, created_at
- RLS policy with tenant isolation using (SELECT public.tenant_id())
- Indexes on tenant_id, control_id, test_date DESC

**00019_remediation_plans.sql:**
- Action plans for failed tests
- Columns from RemediationPlan type: id, tenant_id, control_test_id (FK), control_id (FK), rct_row_id (FK nullable), title, description, owner, deadline, status (CHECK 'open','in-progress','resolved','closed'), priority (CHECK 'critical','high','medium','low'), action_items (JSONB array), notes, created_date, resolved_date, closed_date, created_at, updated_at
- RLS policy with tenant isolation
- Indexes on tenant_id, status, deadline

**00020_custom_columns.sql:**
- User-defined column definitions for RCT
- Columns from CustomColumn type: id, tenant_id, name, type (CHECK 'text','number','dropdown','date','formula'), options (TEXT[]), formula, width, sort_order, created_at
- RLS policy with tenant isolation
- Index on tenant_id

Add proper COMMENT statements for documentation. Use ON DELETE SET NULL for optional FKs and ON DELETE CASCADE for required FKs.
  </action>
  <verify>Run `npx supabase migration list` to verify 00018-00020 are listed. Run `npx supabase db push --dry-run` to validate syntax.</verify>
  <done>control_tests, remediation_plans, and custom_columns migrations created with proper schema, RLS, and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create tickets and ticket_entity_links migrations</name>
  <files>
    supabase/migrations/00021_tickets.sql
  </files>
  <action>
Create migration for tickets system following 26-RESEARCH.md schema and src/types/tickets.ts:

**00021_tickets.sql:**
Create tickets table:
- Columns from Ticket type: id, tenant_id, title, description, category, status (CHECK 'todo','in-progress','done'), priority (CHECK 'critical','high','medium','low'), owner, deadline, notes, recurrence (JSONB with interval, customDays, nextDue), done_date, archived (BOOLEAN DEFAULT FALSE), created_at
- RLS policy with tenant isolation
- Indexes on tenant_id, status, deadline

Create ticket_entity_links table in same migration:
- Junction table for tickets to various entities
- Columns: id, tenant_id, ticket_id (FK to tickets ON DELETE CASCADE), entity_type (CHECK 'control','risk','process','rctRow','remediationPlan'), entity_id (UUID), entity_name, created_at
- UNIQUE constraint on (ticket_id, entity_type, entity_id)
- RLS policy with tenant isolation
- Indexes on tenant_id, ticket_id, and (entity_type, entity_id)

Note: entity_id is UUID but not FK because it can reference multiple tables. Application code ensures referential integrity.
  </action>
  <verify>Run `npx supabase db push --dry-run` to validate syntax for tickets and ticket_entity_links tables.</verify>
  <done>tickets and ticket_entity_links tables created with proper schema, RLS, and indexes</done>
</task>

<task type="auto">
  <name>Task 3: Create comments, pending_changes, approval_settings, and score_labels migrations</name>
  <files>
    supabase/migrations/00022_comments.sql
    supabase/migrations/00023_pending_changes.sql
    supabase/migrations/00024_approval_settings.sql
    supabase/migrations/00025_score_labels.sql
  </files>
  <action>
Create four migration files:

**00022_comments.sql:**
- Threaded comments on entities
- Columns from Comment type: id, tenant_id, entity_type (CHECK 'risk','process','control','rctRow'), entity_id (UUID), parent_id (FK to self ON DELETE CASCADE for threaded replies), content, author_id (FK to profiles nullable), author_role, is_edited (BOOLEAN DEFAULT FALSE), created_at, updated_at
- RLS policy with tenant isolation
- Indexes on tenant_id, (entity_type, entity_id), parent_id

**00023_pending_changes.sql:**
- Four-eye approval workflow
- Columns from PendingChange type: id, tenant_id, entity_type (CHECK 'control','risk','process'), entity_id (UUID), entity_name, change_type (CHECK 'create','update','delete'), current_values (JSONB), proposed_values (JSONB), status (CHECK 'pending','approved','rejected'), submitted_by, submitted_at, reviewed_by, reviewed_at, rejection_reason, version (INT DEFAULT 1), created_at
- RLS policy with tenant isolation
- Indexes on tenant_id, status, (entity_type, entity_id)

**00024_approval_settings.sql:**
- Per-tenant approval configuration
- Columns from ApprovalSettings type: id, tenant_id (UNIQUE), global_enabled (BOOLEAN DEFAULT FALSE), require_for_new_controls, require_for_new_risks, require_for_new_processes (all BOOLEAN DEFAULT FALSE), entity_overrides (JSONB DEFAULT '{}'), created_at, updated_at
- RLS policy with tenant isolation
- Grant SELECT, INSERT, UPDATE (no DELETE - one row per tenant)

**00025_score_labels.sql:**
- Custom probability/impact labels
- Columns from ScoreLabel type: id, tenant_id, type (CHECK 'probability','impact'), score (INT 1-5), label, description, created_at
- UNIQUE constraint on (tenant_id, type, score)
- RLS policy with tenant isolation
- Index on tenant_id

Add COMMENT statements for documentation.
  </action>
  <verify>Run `npx supabase db push --dry-run` to validate all migration syntax.</verify>
  <done>comments, pending_changes, approval_settings, and score_labels migrations created</done>
</task>

</tasks>

<verification>
- [ ] All 8 migration files exist (00018-00025)
- [ ] `npx supabase db push --dry-run` validates all migrations
- [ ] CHECK constraints match TypeScript union types exactly
- [ ] JSONB columns have appropriate DEFAULT values
- [ ] Foreign keys have correct ON DELETE behavior (CASCADE vs SET NULL)
- [ ] All tables have RLS enabled with tenant isolation policy
</verification>

<success_criteria>
- 8 migration files created (00018-00025)
- All CHECK constraints align with TypeScript types
- JSONB columns for flexible data (action_items, recurrence, entity_overrides)
- Proper indexing strategy for query patterns
</success_criteria>

<output>
After completion, create `.planning/phases/26-shared-tenant-database/26-02-SUMMARY.md`
</output>
