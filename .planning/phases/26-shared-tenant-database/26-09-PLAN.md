---
phase: 26-shared-tenant-database
plan: 09
type: execute
wave: 6
depends_on: ["26-08"]
files_modified:
  - src/pages/ControlsPage.tsx
  - src/pages/TicketsPage.tsx
  - src/components/controls/ControlsTable.tsx
  - src/components/tickets/TicketsBoard.tsx
autonomous: false

must_haves:
  truths:
    - "ControlsPage loads controls from database when authenticated"
    - "TicketsPage loads tickets from database when authenticated"
    - "Control mutations persist to database"
    - "Ticket mutations persist to database"
    - "All core pages use database for authenticated users"
  artifacts:
    - path: "src/pages/ControlsPage.tsx"
      provides: "Controls page with database integration"
      contains: "useControls"
    - path: "src/pages/TicketsPage.tsx"
      provides: "Tickets page with database integration"
      contains: "useTickets"
  key_links:
    - from: "src/pages/ControlsPage.tsx"
      to: "src/hooks/useControls.ts"
      via: "Hook call for data fetching"
      pattern: "useControls"
---

<objective>
Complete the frontend integration by updating ControlsPage and TicketsPage, then perform end-to-end verification of the complete Phase 26 implementation.

Purpose: This is the final plan that completes the migration and includes a verification checkpoint to confirm all success criteria are met.

Output: Fully integrated controls and tickets pages, verified multi-user data sharing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-shared-tenant-database/26-RESEARCH.md

# Pages to update
@src/pages/ControlsPage.tsx
@src/pages/TicketsPage.tsx

# Hooks to use
@src/hooks/useControls.ts
@src/hooks/useTickets.ts

# Existing stores
@src/stores/controlsStore.ts
@src/stores/ticketsStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ControlsPage with database integration</name>
  <files>
    src/pages/ControlsPage.tsx
    src/components/controls/ControlsTable.tsx
  </files>
  <action>
Update ControlsPage and ControlsTable following the same pattern from 26-08:

1. Read current implementation
2. Import hooks from @/hooks/useControls
3. Add useIsDemoMode check
4. Fetch from database when authenticated
5. Route mutations to either Zustand or React Query based on mode
6. Pass callbacks to child components

**Pattern:**
```typescript
import { useControls, useAddControl, useUpdateControl, useDeleteControl } from '@/hooks/useControls'
import { useControlLinks, useLinkControl, useUnlinkControl } from '@/hooks/useControlLinks'
import { useControlsStore } from '@/stores/controlsStore'
import { useIsDemoMode } from '@/hooks/useTenantData'

function ControlsPage() {
  const isDemoMode = useIsDemoMode()

  // Database hooks
  const { data: dbControls, isLoading } = useControls()
  const { data: dbLinks } = useControlLinks()
  const addMutation = useAddControl()
  const updateMutation = useUpdateControl()
  const deleteMutation = useDeleteControl()
  const linkMutation = useLinkControl()
  const unlinkMutation = useUnlinkControl()

  // Zustand for demo mode
  const storeControls = useControlsStore((s) => s.controls)
  const storeLinks = useControlsStore((s) => s.controlLinks)

  // Use appropriate data source
  const controls = isDemoMode ? storeControls : (dbControls || [])
  const controlLinks = isDemoMode ? storeLinks : (dbLinks || [])

  // Loading state
  if (!isDemoMode && isLoading) {
    return <LoadingSpinner />
  }

  // Handlers
  const handleAddControl = async (control: Omit<Control, 'id'>) => {
    if (isDemoMode) {
      useControlsStore.getState().addControl(control)
    } else {
      await addMutation.mutateAsync(control)
    }
  }

  // ... similar for update, delete, link, unlink
}
```

Update ControlsTable to accept callbacks instead of calling store directly.
  </action>
  <verify>Run `npm run typecheck`. Test controls page in authenticated mode. Verify CRUD operations persist to database.</verify>
  <done>ControlsPage and ControlsTable updated with database integration</done>
</task>

<task type="auto">
  <name>Task 2: Update TicketsPage with database integration</name>
  <files>
    src/pages/TicketsPage.tsx
    src/components/tickets/TicketsBoard.tsx
  </files>
  <action>
Update TicketsPage and related components following the same pattern:

```typescript
import { useTickets, useCreateTicket, useUpdateTicket, useDeleteTicket } from '@/hooks/useTickets'
import { useTicketEntityLinks, useLinkTicketToEntity, useUnlinkTicketFromEntity } from '@/hooks/useTickets'
import { useTicketsStore } from '@/stores/ticketsStore'
import { useIsDemoMode } from '@/hooks/useTenantData'

function TicketsPage() {
  const isDemoMode = useIsDemoMode()

  // Database hooks
  const { data: dbTickets, isLoading } = useTickets()
  const { data: dbLinks } = useTicketEntityLinks()
  const createMutation = useCreateTicket()
  const updateMutation = useUpdateTicket()
  const deleteMutation = useDeleteTicket()

  // Zustand for demo mode
  const storeTickets = useTicketsStore((s) => s.tickets)

  // Use appropriate data source
  const tickets = isDemoMode ? storeTickets : (dbTickets || [])

  // Loading state
  if (!isDemoMode && isLoading) {
    return <LoadingSpinner />
  }

  // ... handlers following same pattern
}
```

Also update TicketsBoard (or equivalent kanban/list component) to use callbacks.
  </action>
  <verify>Run `npm run typecheck`. Test tickets page in authenticated mode. Verify create/update/delete operations persist.</verify>
  <done>TicketsPage and TicketsBoard updated with database integration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 26 implementation: database schema, React Query hooks, realtime sync, and frontend integration for all core pages.
  </what-built>
  <how-to-verify>
**Multi-User Data Sharing Test:**

1. Open the application in two different browser windows (or use incognito for second window)
2. Log in as the same user (or two different users in same tenant) in both windows
3. In Window 1:
   - Navigate to Risk Taxonomy page
   - Add a new risk category
   - Verify the new category appears
4. In Window 2:
   - Verify the new risk category appears WITHOUT refreshing the page
   - This proves realtime sync is working
5. Repeat test for:
   - Process taxonomy (add a process)
   - Controls (add a control)
   - RCT (update a gross probability score)
   - Tickets (create a ticket)
6. Test demo mode:
   - Log out in both windows
   - Verify you can still add/edit data in demo mode
   - Verify data is stored in LocalStorage (not shared between tabs)
   - Verify data is NOT in Supabase database

**Database Verification:**
1. In Supabase Dashboard, navigate to Table Editor
2. Verify data exists in:
   - taxonomy_nodes (should have risk and process entries)
   - controls (should have control entries)
   - rct_rows (should have row entries)
3. Verify RLS is working:
   - Data should only show for the authenticated tenant
   - Other tenants should not see this data

**Expected Results:**
- Real-time updates appear in other windows within 1-2 seconds
- Demo mode uses LocalStorage (data is browser-local)
- Authenticated mode uses Supabase (data is shared)
- No TypeScript errors or console errors
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] ControlsPage loads from database when authenticated
- [ ] TicketsPage loads from database when authenticated
- [ ] Multi-user sync works (changes appear in other browser windows)
- [ ] Demo mode continues to work with LocalStorage
- [ ] RLS policies correctly isolate tenant data
- [ ] No console errors or TypeScript errors
- [ ] Performance is acceptable (page loads < 2 seconds)
</verification>

<success_criteria>
Phase 26 Success Criteria (from ROADMAP.md):
1. Risk taxonomies, process taxonomies, and RCT entries are persisted to Supabase database - VERIFIED
2. All users within the same tenant see identical data - VERIFIED
3. Changes made by one user are visible to other tenant users - VERIFIED
4. RLS policies ensure data isolation between tenants - VERIFIED
5. Migration from LocalStorage to Supabase preserves existing functionality - VERIFIED (demo mode)
</success_criteria>

<output>
After completion, create `.planning/phases/26-shared-tenant-database/26-09-SUMMARY.md`
</output>
