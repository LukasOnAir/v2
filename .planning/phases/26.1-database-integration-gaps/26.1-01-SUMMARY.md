---
phase: 26.1-database-integration-gaps
plan: 01
subsystem: database
tags: [react-query, supabase, rct, upsert, mutations]

# Dependency graph
requires:
  - phase: 26-04
    provides: useBulkCreateRCTRows hook and toRCTRow transformer
provides:
  - useBulkUpsertRCTRows hook for preserving existing RCT data on regenerate
  - RCTTable updated to use upsert mutation in authenticated mode
affects: [26-04, rct-regeneration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Upsert pattern: query existing, filter new, insert only new"
    - "Preserve data by not deleting orphaned rows"

key-files:
  created: []
  modified:
    - src/hooks/useRCTRows.ts
    - src/components/rct/RCTTable.tsx

key-decisions:
  - "Upsert preserves existing row data - no DELETE for orphaned rows"
  - "Toast feedback distinguishes new rows added vs already up-to-date"

patterns-established:
  - "Bulk upsert pattern: fetch existing, build Set of keys, filter new only"

# Metrics
duration: 6min
completed: 2026-01-27
---

# Phase 26.1 Plan 01: RCT Regenerate Upsert Summary

**useBulkUpsertRCTRows hook that preserves existing row data when taxonomy changes, with toast feedback**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-27T14:37:16Z
- **Completed:** 2026-01-27T14:43:32Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Created useBulkUpsertRCTRows hook that queries existing rows and only inserts new combinations
- Updated RCTTable handleGenerateRows to use upsert mutation in authenticated mode
- Existing row scores and customValues preserved on regenerate
- Toast feedback shows "Added N new row(s)" or "RCT is up to date"

## Task Commits

Each task was committed atomically:

1. **Task 1: Create useBulkUpsertRCTRows hook** - `d09f1ec` (feat)
2. **Task 2: Update RCTTable to use upsert for regenerate** - `f20448f` (feat)

## Files Created/Modified

- `src/hooks/useRCTRows.ts` - Added useBulkUpsertRCTRows hook after existing useBulkCreateRCTRows
- `src/components/rct/RCTTable.tsx` - Replaced useBulkCreateRCTRows with useBulkUpsertRCTRows in import and hook usage

## Decisions Made

- **Upsert preserves existing data:** The hook queries existing rows to find which risk:process combinations already exist, then only inserts rows for new combinations. Orphaned rows (combinations no longer in taxonomy) are NOT deleted - this preserves any existing scores and customValues.
- **Toast feedback pattern:** Different messages for "rows added" vs "already up-to-date" to give clear user feedback on what happened.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- RCT regeneration now correctly preserves existing data
- Ready for continued database integration gap fixes
- No blockers

---
*Phase: 26.1-database-integration-gaps*
*Completed: 2026-01-27*
