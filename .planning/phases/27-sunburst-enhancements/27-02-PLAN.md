---
phase: 27-sunburst-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/components/sunburst/SunburstChart.tsx
  - src/stores/sunburstStore.ts
autonomous: true

must_haves:
  truths:
    - "Sunburst arcs unfold/expand outward on page load"
    - "Center circle and text appear after sunburst animation completes"
    - "Animation plays only on initial render, not on every state change"
  artifacts:
    - path: "src/components/sunburst/SunburstChart.tsx"
      provides: "Opening animation logic with D3 interpolation"
      contains: "animationProgress"
    - path: "src/stores/sunburstStore.ts"
      provides: "Animation complete state for coordination"
      contains: "animationComplete"
  key_links:
    - from: "SunburstChart.tsx"
      to: "requestAnimationFrame"
      via: "animation loop"
      pattern: "requestAnimationFrame.*animate"
    - from: "SunburstChart.tsx"
      to: "sunburstStore"
      via: "setAnimationComplete callback"
      pattern: "setAnimationComplete\\(true\\)"
---

<objective>
Add opening animation for sunburst arcs and sequenced center reveal

Purpose: Create a polished visual experience where the sunburst "unfolds" from the center outward on page load, followed by the center circle and score text revealing with a downward animation.

Output: Animated sunburst entrance that enhances user experience without impacting performance or interaction.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-sunburst-enhancements/27-RESEARCH.md
@.planning/phases/27-sunburst-enhancements/27-01-SUMMARY.md
@src/components/sunburst/SunburstChart.tsx
@src/stores/sunburstStore.ts
@src/pages/VerifyEmailPage.tsx (Framer Motion patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sunburst opening animation</name>
  <files>src/components/sunburst/SunburstChart.tsx, src/stores/sunburstStore.ts</files>
  <action>
Implement D3-based opening animation where arcs expand from innerRadius outward.

1. In sunburstStore.ts, add animation state (NOT persisted):
   ```typescript
   // In interface
   animationComplete: boolean
   setAnimationComplete: (complete: boolean) => void

   // In create
   animationComplete: false,
   setAnimationComplete: (complete) => set((state) => {
     state.animationComplete = complete
   }),
   ```
   Add to partialize exclusions (should not persist).

2. In SunburstChart.tsx, add animation state and refs:
   ```typescript
   const [animationProgress, setAnimationProgress] = useState(0)
   const animationFrameRef = useRef<number | null>(null)
   const hasAnimatedRef = useRef(false)
   const { animationComplete, setAnimationComplete } = useSunburstStore()
   ```

3. Add animation effect that runs once when partitionedRoot is first available:
   ```typescript
   useEffect(() => {
     // Only animate once per mount
     if (hasAnimatedRef.current || !partitionedRoot) return
     hasAnimatedRef.current = true

     const duration = 800 // ms
     const start = performance.now()

     const animate = (now: number) => {
       const elapsed = now - start
       const progress = Math.min(elapsed / duration, 1)
       // easeOutCubic for smooth deceleration
       const eased = 1 - Math.pow(1 - progress, 3)
       setAnimationProgress(eased)

       if (progress < 1) {
         animationFrameRef.current = requestAnimationFrame(animate)
       } else {
         setAnimationComplete(true)
       }
     }

     requestAnimationFrame(animate)

     return () => {
       if (animationFrameRef.current) {
         cancelAnimationFrame(animationFrameRef.current)
       }
     }
   }, [partitionedRoot, setAnimationComplete])
   ```

4. Modify arc rendering to use animated y0/y1:
   In the visibleNodes map, when creating pathData, interpolate y0 and y1 from innerRadius to final values:
   ```typescript
   const animatedY0 = innerRadius + (arcData.y0 - innerRadius) * animationProgress
   const animatedY1 = innerRadius + (arcData.y1 - innerRadius) * animationProgress

   const pathData = arcGenerator({
     ...node,
     x0: arcData.x0,
     x1: arcData.x1,
     y0: animatedY0,
     y1: animatedY1,
   } as HierarchyRectangularNode<SunburstNode>)
   ```

5. Ensure animation only happens on first render, not on data/state changes:
   - hasAnimatedRef persists across re-renders
   - If user navigates away and back, animation replays (acceptable)
  </action>
  <verify>
- Build passes: `npm run build`
- Navigate to sunburst page - arcs should expand outward smoothly over ~800ms
- Changing view mode or levels should NOT replay animation
- Page refresh replays animation (expected)
  </verify>
  <done>Sunburst arcs animate from center outward on initial page load with smooth easing</done>
</task>

<task type="auto">
  <name>Task 2: Add center circle and text reveal animation</name>
  <files>src/components/sunburst/SunburstChart.tsx</files>
  <action>
Add sequenced animation for center circle and text that plays after sunburst animation completes.

1. Import motion from motion/react:
   ```typescript
   import { motion } from 'motion/react'
   ```

2. Wrap center circle in motion.circle with delayed entrance:
   ```typescript
   <motion.circle
     r={innerRadius}
     fill={centerBgColor}
     className={currentCenterId ? 'cursor-pointer hover:opacity-80' : ''}
     onClick={handleCenterClick}
     initial={{ scale: 0.8, opacity: 0 }}
     animate={{
       scale: animationComplete ? 1 : 0.8,
       opacity: animationComplete ? 1 : 0
     }}
     transition={{ duration: 0.4, ease: 'easeOut' }}
   />
   ```

3. Wrap center text in motion.text with downward reveal:
   ```typescript
   <motion.text
     textAnchor="middle"
     className="pointer-events-none"
     style={{ fill: centerTextColor }}
     initial={{ opacity: 0, y: -15 }}
     animate={{
       opacity: animationComplete ? 1 : 0,
       y: animationComplete ? 0 : -15
     }}
     transition={{ duration: 0.4, delay: 0.1, ease: 'easeOut' }}
   >
     {/* tspans unchanged */}
   </motion.text>
   ```

4. The animation sequence:
   - 0-800ms: Arcs expand outward (D3 animation)
   - 800ms: setAnimationComplete(true) triggers
   - 800-1200ms: Center circle scales in
   - 900-1300ms: Center text slides down and fades in

5. Ensure SVG supports motion components:
   - motion.circle and motion.text work directly in SVG
   - transformOrigin may need adjustment for SVG coordinate system
  </action>
  <verify>
- Build passes: `npm run build`
- Navigate to sunburst page:
  1. Arcs expand outward (800ms)
  2. Center circle appears with scale animation
  3. Center text reveals with downward motion
- Sequence looks smooth and coordinated
- No janky transitions or flicker
  </verify>
  <done>Center circle and text animate in after sunburst arcs complete, with downward reveal motion</done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Full animation sequence plays on page load:
   - Arcs expand from center (0-800ms)
   - Center circle appears (800-1200ms)
   - Center text slides down (900-1300ms)
3. Animation does NOT replay when:
   - Changing view mode
   - Toggling levels
   - Toggling hideNoData
4. Animation DOES replay on:
   - Page refresh
   - Navigate away and back
5. No console errors about unmounted components or animation cleanup
</verification>

<success_criteria>
- Sunburst opens with smooth expanding animation on page load
- Center elements reveal sequentially after arcs complete
- Animation timing feels polished (not too fast, not too slow)
- No performance issues or jank during animation
- Animation state properly cleaned up on unmount
</success_criteria>

<output>
After completion, create `.planning/phases/27-sunburst-enhancements/27-02-SUMMARY.md`
</output>
