---
phase: 27-sunburst-enhancements
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/pages/SunburstPage.tsx
  - src/components/sunburst/SunburstChart.tsx
  - src/components/sunburst/SunburstLegend.tsx
autonomous: true

must_haves:
  truths:
    - "Center text shows 'AVG' when aggregationMode is 'weighted' and at root view"
    - "Center text shows 'MAX' when aggregationMode is 'max' and at root view"
    - "Legend appears inside the sunburst container box, positioned top-right"
    - "When zoomed into a node, center still shows node name (existing behavior)"
  artifacts:
    - path: "src/components/sunburst/SunburstChart.tsx"
      provides: "Dynamic center label based on aggregation mode"
      contains: "aggregationMode === 'max'"
    - path: "src/pages/SunburstPage.tsx"
      provides: "Repositioned legend inside chart container"
      contains: "absolute top-2 right-2"
    - path: "src/components/sunburst/SunburstLegend.tsx"
      provides: "Compact legend styling for overlay position"
      contains: "compact"
  key_links:
    - from: "SunburstChart.tsx"
      to: "sunburstStore.aggregationMode"
      via: "center label logic"
      pattern: "aggregationMode.*AVG|MAX"
    - from: "SunburstPage.tsx"
      to: "SunburstLegend"
      via: "absolute positioning inside relative container"
      pattern: "relative.*absolute"
---

<objective>
Update center text to show AVG/MAX and reposition legend inside sunburst box

Purpose: Improve clarity by showing the aggregation method in the center when at root view, and create a more compact layout by moving the legend inside the sunburst container.

Output: Center text displays "AVG" or "MAX" based on settings; legend overlays top-right of sunburst box.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-sunburst-enhancements/27-RESEARCH.md
@.planning/phases/27-sunburst-enhancements/27-01-SUMMARY.md
@src/components/sunburst/SunburstChart.tsx
@src/pages/SunburstPage.tsx
@src/components/sunburst/SunburstLegend.tsx
@src/stores/sunburstStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update center text to show AVG/MAX</name>
  <files>src/components/sunburst/SunburstChart.tsx</files>
  <action>
Modify center label to display aggregation mode indicator when at root view.

1. Get aggregationMode from store (already available via useSunburstStore):
   ```typescript
   const { aggregationMode, /* existing destructuring */ } = useSunburstStore()
   ```

2. Update centerLabel useMemo to include aggregation indicator:
   ```typescript
   const centerLabel = useMemo(() => {
     if (!currentCenterNode) return { name: 'No Data', score: null }

     // When at root view (not zoomed), show aggregation mode
     if (currentCenterNode.depth === 0 || !currentCenterId) {
       const modeLabel = aggregationMode === 'max' ? 'MAX' : 'AVG'
       return {
         name: modeLabel,
         score: currentCenterNode.data.value,
       }
     }

     // When zoomed into a node, show node name
     return {
       name: currentCenterNode.data.name,
       score: currentCenterNode.data.value,
     }
   }, [currentCenterNode, currentCenterId, aggregationMode])
   ```

3. The center text rendering already truncates names > 15 chars, but "AVG" and "MAX" are short so no changes needed there.

4. Add aggregationMode to dependencies if not already tracked.
  </action>
  <verify>
- Build passes: `npm run build`
- At root view with aggregationMode 'weighted': center shows "AVG"
- At root view with aggregationMode 'max': center shows "MAX"
- Click into a node (zoom): center shows node name
- Zoom back to root: shows AVG/MAX again
  </verify>
  <done>Center text displays "AVG" or "MAX" based on aggregation setting when at root view; shows node name when zoomed</done>
</task>

<task type="auto">
  <name>Task 2: Reposition legend inside sunburst container</name>
  <files>src/pages/SunburstPage.tsx, src/components/sunburst/SunburstLegend.tsx</files>
  <action>
Move legend from separate sidebar to overlay position inside the sunburst box.

1. In SunburstPage.tsx, restructure the layout:

Current structure:
```tsx
<div className="flex-1 flex gap-6 items-start mt-4">
  <div className="flex-1 flex justify-center items-center bg-surface-elevated rounded-lg p-4">
    <SunburstChart ref={svgRef} width={600} height={600} />
  </div>
  <div className="w-48">
    <SunburstLegend viewMode={viewMode} maxDelta={maxDelta} />
  </div>
</div>
```

New structure:
```tsx
<div className="flex-1 flex justify-center items-center mt-4">
  <div className="relative bg-surface-elevated rounded-lg p-4">
    <SunburstChart ref={svgRef} width={600} height={600} />
    {/* Legend positioned inside, top-right */}
    <div className="absolute top-4 right-4">
      <SunburstLegend viewMode={viewMode} maxDelta={maxDelta} compact />
    </div>
  </div>
</div>
```

2. In SunburstLegend.tsx, add compact prop for overlay styling:
   ```typescript
   interface SunburstLegendProps {
     inline?: boolean
     viewMode?: ViewMode
     maxDelta?: number
     compact?: boolean  // New prop for overlay mode
   }
   ```

3. Update SunburstLegend to use compact styling when prop is true:
   - Reduce padding: `p-2` -> `p-1.5`
   - Reduce gradient height: `h-24` -> `h-20`
   - Add slight transparency to background: `bg-surface-elevated/90`
   - Keep border for visual separation

4. Ensure legend doesn't block chart interaction:
   - Legend is in corner, away from arcs
   - pointer-events on legend remain normal (user can hover to see gradient)

5. Remove the separate sidebar div entirely - no longer needed.
  </action>
  <verify>
- Build passes: `npm run build`
- Legend appears inside the sunburst box, positioned top-right
- Legend does not overlap with chart arcs
- Legend is readable with semi-transparent background
- Layout is centered (no empty sidebar space)
- Legend updates correctly when viewMode changes
  </verify>
  <done>Legend positioned inside sunburst container box at top-right, layout is more compact</done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Center text verification:
   - Root view with "Weighted Avg" selected: center shows "AVG"
   - Root view with "Maximum" selected: center shows "MAX"
   - Zoomed view: shows node name
3. Legend position verification:
   - Legend is inside the rounded chart container
   - Positioned at top-right corner
   - Has slight transparency but remains readable
   - Does not overlap with sunburst arcs
4. Overall layout:
   - Page is more compact without separate legend sidebar
   - Chart remains centered on page
</verification>

<success_criteria>
- Center text shows aggregation mode (AVG/MAX) when at root view
- Center text shows node name when zoomed into a node
- Legend is positioned inside the sunburst container at top-right
- No empty sidebar space on the page
- Legend styling is compact and semi-transparent for overlay use
</success_criteria>

<output>
After completion, create `.planning/phases/27-sunburst-enhancements/27-03-SUMMARY.md`
</output>
