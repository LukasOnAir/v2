---
phase: 27-sunburst-enhancements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/SunburstPage.tsx
  - src/components/sunburst/SunburstChart.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Sunburst container fills available screen space"
    - "Labels fit within arc space without clipping"
    - "Fewer visible levels results in larger rings"
  artifacts:
    - path: "src/pages/SunburstPage.tsx"
      provides: "ResizeObserver for dynamic container dimensions"
      contains: "ResizeObserver"
    - path: "src/components/sunburst/SunburstChart.tsx"
      provides: "Dynamic label truncation based on arc length"
      contains: "arcLength"
  key_links:
    - from: "src/pages/SunburstPage.tsx"
      to: "src/components/sunburst/SunburstChart.tsx"
      via: "width/height props derived from container size"
      pattern: "width=\\{.*\\}.*height=\\{.*\\}"
---

<objective>
Fix sunburst sizing and label clipping issues identified in UAT.

Purpose: User reported that (1) the sunburst box doesn't use available screen real estate and (2) L1 labels clip/cut off even when there appears to be room. These are blocking issues for visual quality.

Output: Responsive sunburst container that fills available space, with labels that truncate intelligently based on actual arc dimensions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/pages/SunburstPage.tsx
@src/components/sunburst/SunburstChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement responsive container sizing with ResizeObserver</name>
  <files>src/pages/SunburstPage.tsx</files>
  <action>
Replace hardcoded width={600} height={600} with dynamic sizing using ResizeObserver:

1. Add state for container dimensions: `const [dimensions, setDimensions] = useState({ width: 600, height: 600 })`

2. Add a ref for the container div: `const containerRef = useRef<HTMLDivElement>(null)`

3. Use useEffect with ResizeObserver to track container size:
```typescript
useEffect(() => {
  if (!containerRef.current) return

  const resizeObserver = new ResizeObserver((entries) => {
    const entry = entries[0]
    if (entry) {
      const { width, height } = entry.contentRect
      // Use square dimensions (min of width/height) for sunburst
      // Leave padding for legend overlay (subtract ~80px from width)
      const availableWidth = width - 80
      const size = Math.min(availableWidth, height)
      setDimensions({ width: size, height: size })
    }
  })

  resizeObserver.observe(containerRef.current)
  return () => resizeObserver.disconnect()
}, [])
```

4. Update the container div to:
- Add `ref={containerRef}` to the relative container div
- Make it flex-1 to fill available space: change from fixed size to `className="relative bg-surface-elevated rounded-lg p-4 flex-1 flex items-center justify-center"`

5. Pass dynamic dimensions to SunburstChart:
```tsx
<SunburstChart ref={svgRef} width={dimensions.width} height={dimensions.height} />
```

6. Position legend relative to chart, not container (stays top-right of chart area).

Note: The chart should maintain 1:1 aspect ratio (square). Minimum size should be 400x400 to prevent unusably small charts.
  </action>
  <verify>
Resize browser window and observe:
- Sunburst grows/shrinks with available space
- Maintains square aspect ratio
- Minimum size enforced (doesn't become tiny)
- Legend stays positioned correctly relative to chart
  </verify>
  <done>Sunburst fills available container space responsively, adapting to window resize</done>
</task>

<task type="auto">
  <name>Task 2: Implement dynamic label truncation based on arc length</name>
  <files>src/components/sunburst/SunburstChart.tsx</files>
  <action>
Replace fixed 20-character truncation (line 589) with dynamic calculation based on arc space:

1. Create a helper function to calculate available characters:
```typescript
const calculateMaxLabelChars = (arcData: { x0: number; x1: number; y0: number; y1: number }): number => {
  // Calculate arc length at midpoint radius
  const midRadius = (arcData.y0 + arcData.y1) / 2
  const arcAngle = arcData.x1 - arcData.x0
  const arcLength = midRadius * arcAngle

  // Approximate character width in pixels (10px font = ~6px per char)
  const charWidth = 6
  // Leave 20% margin for padding
  const availableWidth = arcLength * 0.8

  // Return max characters that fit, minimum 3 (for "...")
  return Math.max(3, Math.floor(availableWidth / charWidth))
}
```

2. Update the label rendering section (around line 589) to use dynamic truncation:
```typescript
{label && animationComplete && (
  <text
    transform={getLabelTransform(arcData)}
    textAnchor="middle"
    dominantBaseline="middle"
    className="pointer-events-none text-[10px] font-medium"
    style={{ fill: textColor }}
  >
    {(() => {
      const maxChars = calculateMaxLabelChars(arcData)
      return label.length > maxChars ? label.substring(0, maxChars - 3) + '...' : label
    })()}
  </text>
)}
```

3. Also update getNodeLabel to return full label (remove existing 20-char check there if it truncates early):
- Keep the arc angle check for whether to show label at all (0.1 threshold)
- Keep the angle check for whether to include name (0.2 threshold)
- But return full label text, let render handle truncation

This allows larger arcs to show more text and smaller arcs to truncate appropriately.
  </action>
  <verify>
- L1 nodes (largest arcs) show longer labels than before
- L3 nodes (smaller arcs) show shorter labels appropriately
- No labels overflow their arc boundaries visually
- Labels remain readable (not truncated to unusable lengths)
  </verify>
  <done>Labels truncate dynamically based on available arc space, utilizing room when available</done>
</task>

</tasks>

<verification>
1. Navigate to Sunburst page
2. Resize browser window - chart should resize proportionally
3. Toggle L4/L5 off - rings should expand to fill radius (existing behavior)
4. Check L1 labels - should show more characters than before on large arcs
5. Check L3 labels - should truncate appropriately for smaller arcs
6. No visual overflow or clipping issues
</verification>

<success_criteria>
- Sunburst container uses available screen real estate (not fixed 600x600)
- Labels adapt to arc size (larger arcs show more text)
- Existing functionality preserved (animations, zooming, tooltips)
</success_criteria>

<output>
After completion, create `.planning/phases/27-sunburst-enhancements/27-04-SUMMARY.md`
</output>
