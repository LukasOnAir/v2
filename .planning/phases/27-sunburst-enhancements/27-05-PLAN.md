---
phase: 27-sunburst-enhancements
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/sunburst/SunburstChart.tsx
  - src/components/sunburst/SunburstLegend.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Sunburst opens with fan-style animation (small to large scale)"
    - "Legend bar reveals with top-to-bottom animation"
    - "Animations play only on initial load (not on setting changes)"
  artifacts:
    - path: "src/components/sunburst/SunburstChart.tsx"
      provides: "Scale transform animation on container group"
      contains: "scale"
    - path: "src/components/sunburst/SunburstLegend.tsx"
      provides: "Animated gradient bar with clipPath reveal"
      contains: "motion.div"
  key_links:
    - from: "src/components/sunburst/SunburstLegend.tsx"
      to: "useSunburstStore"
      via: "animationComplete state consumption"
      pattern: "animationComplete"
---

<objective>
Implement fan-style opening animation and legend bar reveal animation.

Purpose: User wanted sunburst to "start small and grow larger while opening up" (fan effect), not just arcs expanding. Also wants legend gradient bar to animate top-to-bottom after center reveals.

Output: Enhanced animations that feel more dynamic and polished.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/sunburst/SunburstChart.tsx
@src/components/sunburst/SunburstLegend.tsx
@src/stores/sunburstStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fan-style scale animation to sunburst container</name>
  <files>src/components/sunburst/SunburstChart.tsx</files>
  <action>
Add a scale transform to the main container group during the opening animation, creating a "fan opening" effect where the entire chart starts small and grows:

1. The existing animation (lines 554-556) already interpolates arc radii from innerRadius outward. Keep this.

2. Add a scale factor that goes from 0.3 to 1.0 during the animation. Apply it to the main `<g>` element:

Change the main group (around line 510):
```tsx
<g transform={`translate(${width / 2},${height / 2})`}>
```

To:
```tsx
<g
  transform={`translate(${width / 2},${height / 2}) scale(${0.3 + 0.7 * openingAnimationProgress})`}
  style={{ transformOrigin: 'center' }}
>
```

Note: SVG transform origin is at 0,0 of the element. Since we translate to center first, scale will expand from center.

3. The combined effect will be:
- Chart starts at 30% size and grows to 100%
- Arcs simultaneously expand from inner radius outward
- Creates the "fan opening up" visual the user requested

4. Keep the existing easeOutCubic easing (line 124) - this gives smooth deceleration.

No changes needed to the animation timing (800ms is good). The scale transform combines with arc expansion for the desired fan effect.
  </action>
  <verify>
- Navigate to Sunburst page (fresh load or navigate away and back)
- Animation should show chart starting small and growing while arcs expand
- Combined effect looks like a fan opening
- Animation only plays once per mount (existing guard preserved)
  </verify>
  <done>Sunburst opens with fan-style animation combining scale growth and arc expansion</done>
</task>

<task type="auto">
  <name>Task 2: Add top-to-bottom reveal animation to legend gradient bar</name>
  <files>src/components/sunburst/SunburstLegend.tsx</files>
  <action>
Animate the gradient bar to reveal from top to bottom after the sunburst animation completes:

1. Add imports at top of file:
```typescript
import { motion } from 'motion/react'
import { useSunburstStore } from '@/stores/sunburstStore'
```

2. Inside the component, consume animationComplete state:
```typescript
const animationComplete = useSunburstStore((state) => state.animationComplete)
```

3. For the vertical layout gradient bar (lines 112-116), replace the static div with motion.div using clipPath animation:

Current:
```tsx
<div
  className={clsx('w-5 rounded', compact ? 'h-20' : 'h-24')}
  style={{ background: gradient }}
  aria-label={...}
/>
```

Replace with:
```tsx
<motion.div
  className={clsx('w-5 rounded', compact ? 'h-20' : 'h-24')}
  style={{ background: gradient }}
  aria-label={...}
  initial={{ clipPath: 'inset(100% 0 0 0)' }}
  animate={{
    clipPath: animationComplete ? 'inset(0% 0 0 0)' : 'inset(100% 0 0 0)'
  }}
  transition={{
    duration: 0.5,
    delay: 0.2,  // Small delay after center text appears
    ease: 'easeOut'
  }}
/>
```

The clipPath 'inset(100% 0 0 0)' hides the element from top, animating to 'inset(0% 0 0 0)' reveals it top-to-bottom.

4. Also animate the labels to fade in with the bar. Wrap each label span in motion.span:
```tsx
<motion.span
  className="text-xs text-text-secondary"
  initial={{ opacity: 0 }}
  animate={{ opacity: animationComplete ? 1 : 0 }}
  transition={{ duration: 0.3, delay: 0.1 }}
>
  {labels.high}
</motion.span>
```

(Same for the low label but with slightly longer delay: delay: 0.6)

5. For inline mode (horizontal layout), the animation is less critical but can use similar pattern with 'inset(0 100% 0 0)' -> 'inset(0 0% 0 0)' for left-to-right reveal.

Note: The legend only animates on initial load because it depends on animationComplete state which is set once and persists in the store.
  </action>
  <verify>
- Fresh page load shows legend bar hidden initially
- After sunburst arcs finish and center reveals, legend bar slides down from top
- Labels fade in as bar reveals
- Subsequent interactions (toggle levels, zoom) don't replay animation
  </verify>
  <done>Legend gradient bar animates with top-to-bottom reveal after sunburst opens</done>
</task>

</tasks>

<verification>
1. Navigate away from Sunburst page, then return (triggers fresh animation)
2. Watch animation sequence:
   a. Chart starts small (30% scale) and grows while arcs expand outward
   b. Center circle and text appear after arcs finish
   c. Legend bar reveals top-to-bottom after center appears
3. Toggle L4/L5 visibility - no animation replay
4. Change aggregation mode - no animation replay
5. Zoom into a node and back - no animation replay
</verification>

<success_criteria>
- Fan-style opening animation (chart starts small, grows while opening)
- Legend bar reveals top-to-bottom in sequence
- Animations only play on initial page load
- Smooth, polished visual experience
</success_criteria>

<output>
After completion, create `.planning/phases/27-sunburst-enhancements/27-05-SUMMARY.md`
</output>
