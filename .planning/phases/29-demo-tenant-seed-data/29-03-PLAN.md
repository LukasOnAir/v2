---
phase: 29-demo-tenant-seed-data
plan: 03
type: execute
wave: 2
depends_on: ["29-01", "29-02"]
files_modified:
  - supabase/seed-scripts/29-03-rct-controls-remediation.sql
autonomous: true

must_haves:
  truths:
    - "RCT rows link lowest-level risks to lowest-level processes with gross scores"
    - "Controls exist with various types (Preventative, Detective, Corrective)"
    - "Control links connect controls to RCT rows with net scores"
    - "Control tests include pass, fail, and partial results"
    - "Remediation plans exist for failed control tests"
    - "All data belongs to tenant 5ea03edb-6e79-4b62-bd36-39f1963d0640"
  artifacts:
    - path: "supabase/seed-scripts/29-03-rct-controls-remediation.sql"
      provides: "RCT, controls, control_links, control_tests, remediation_plans seed SQL"
      contains: "INSERT INTO public.rct_rows"
  key_links:
    - from: "supabase/seed-scripts/29-03-rct-controls-remediation.sql"
      to: "public.rct_rows"
      via: "INSERT statements"
      pattern: "risk_id.*process_id"
    - from: "supabase/seed-scripts/29-03-rct-controls-remediation.sql"
      to: "public.control_links"
      via: "INSERT statements"
      pattern: "control_id.*rct_row_id"
---

<objective>
Create SQL seed script for RCT rows, controls, control links, control tests, and remediation plans in demo tenant.

Purpose: Create realistic risk-process combinations with controls, test history, and remediation plans that showcase all features of the Risk Control Table.

Output: SQL script that can be executed after taxonomy scripts to populate ~25 RCT rows, ~15 controls, ~30 control links, ~20 control tests, and ~5 remediation plans.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/00017_rct_rows.sql
@supabase/migrations/00015_controls.sql
@supabase/migrations/00016_control_links.sql
@supabase/migrations/00018_control_tests.sql
@supabase/migrations/00019_remediation_plans.sql
@.planning/phases/29-demo-tenant-seed-data/29-01-SUMMARY.md
@.planning/phases/29-demo-tenant-seed-data/29-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RCT and controls seed SQL script</name>
  <files>supabase/seed-scripts/29-03-rct-controls-remediation.sql</files>
  <action>
Create SQL seed script for RCT rows, controls, control links, control tests, and remediation plans. The script must:

1. **Header and setup:**
   - Comment explaining purpose and dependencies (requires 29-01 and 29-02 to run first)
   - Set tenant_id variable
   - Delete existing data in reverse dependency order (remediation_plans, control_tests, control_links, controls, rct_rows)

2. **RCT Rows (~25 rows):**
   Create risk-process pairings. Must lookup taxonomy node IDs by name.

   Use pattern:
   ```sql
   DO $$
   DECLARE
     tenant_id UUID := '5ea03edb-6e79-4b62-bd36-39f1963d0640';
     risk_competition UUID;
     process_business_dev UUID;
     rct_row_1 UUID;
     -- etc
   BEGIN
     -- Lookup taxonomy IDs
     SELECT id INTO risk_competition
     FROM taxonomy_nodes
     WHERE tenant_id = tenant_id AND type = 'risk' AND name = 'Competition';

     SELECT id INTO process_business_dev
     FROM taxonomy_nodes
     WHERE tenant_id = tenant_id AND type = 'process' AND name = 'Business Development';

     -- Create RCT row
     INSERT INTO rct_rows (tenant_id, row_id, risk_id, process_id, gross_probability, gross_impact, risk_appetite)
     VALUES (
       tenant_id,
       risk_competition || ':' || process_business_dev,
       risk_competition,
       process_business_dev,
       3, 4, 9
     )
     RETURNING id INTO rct_row_1;
   END $$;
   ```

   **Pairings to create (meaningful combinations):**
   - Competition risk -> Business Development process (gross: 3x4=12)
   - Customer Concentration -> Account Management (gross: 4x3=12)
   - Quality Failures -> Quality Assurance (gross: 3x4=12)
   - Delivery Delays -> Logistics & Distribution (gross: 2x4=8)
   - Key Person Dependency -> Human Resources (gross: 3x3=9)
   - Skills Gap -> Training (if L3 exists, else HR) (gross: 3x3=9)
   - System Failure -> Information Technology (gross: 4x5=20, high risk)
   - Data Breach -> Information Technology (gross: 4x5=20, high risk)
   - Ransomware -> Information Technology (gross: 3x5=15)
   - Supplier Failure -> Vendor Management (gross: 3x4=12)
   - Cash Flow Shortage -> Finance & Accounting (gross: 2x4=8)
   - Customer Default -> Accounts Receivable (gross: 3x3=9)
   - Commodity Prices -> Sourcing (gross: 2x3=6)
   - Foreign Exchange -> Finance & Accounting (gross: 2x2=4, low risk)
   - Reporting Requirements -> Regulatory Compliance (gross: 3x4=12)
   - Contract Disputes -> Legal (gross: 2x3=6)
   - GDPR Compliance -> Information Technology (gross: 4x4=16)
   - Product Issues -> Quality Assurance (gross: 3x5=15)
   - Service Failures -> Customer Service (gross: 3x4=12)
   - Phishing -> Help Desk (if exists, else IT) (gross: 3x3=9)
   - Employee Misconduct -> Human Resources (gross: 2x4=8)
   - Market Disruption -> Strategic Planning (gross: 3x5=15)
   - M&A Integration -> Project Management (gross: 3x4=12)
   - License Requirements -> Regulatory Compliance (gross: 4x4=16)
   - Data Quality -> Financial Reporting (gross: 3x3=9)

   Set varied gross_probability (1-5), gross_impact (1-5), and risk_appetite (6-15) to show different risk levels.

3. **Controls (~15 controls):**
   Create controls with various types:

   ```sql
   INSERT INTO controls (tenant_id, name, description, control_type, test_frequency, test_procedure, net_probability, net_impact)
   VALUES (
     tenant_id,
     'Access Control Review',
     'Quarterly review of user access to critical systems',
     'Detective',
     'quarterly',
     'Pull access reports. Verify terminated users removed. Review privileged access.',
     2, 3
   )
   RETURNING id INTO control_access_review;
   ```

   **Controls to create:**
   - Access Control Review (Detective, quarterly)
   - System Backup and Recovery (Corrective, quarterly)
   - Vendor Performance Scorecard (Detective, monthly)
   - Quality Control Inspection (Detective, monthly)
   - Succession Planning (Preventative, annually)
   - Employee Background Check (Preventative, quarterly)
   - Cash Flow Forecasting (Detective, monthly)
   - Credit Limit Authorization (Preventative, quarterly)
   - Regulatory Filing Calendar (Preventative, monthly)
   - Contract Review Checklist (Preventative, quarterly)
   - Privacy Impact Assessment (Preventative, quarterly)
   - Incident Response Plan (Corrective, annually)
   - Competitive Intelligence Monitoring (Detective, monthly)
   - Standard Operating Procedures (Preventative, annually)
   - Security Awareness Training (Preventative, quarterly)

4. **Control Links (~30 links):**
   Link controls to relevant RCT rows. Each control can link to 1-3 RCT rows.

   ```sql
   INSERT INTO control_links (tenant_id, control_id, rct_row_id, net_probability, net_impact)
   VALUES (tenant_id, control_access_review, rct_system_failure, 2, 3);
   ```

   **Link patterns:**
   - Access Control Review -> System Failure, Data Breach, Ransomware rows
   - System Backup and Recovery -> System Failure, Ransomware rows
   - Quality Control Inspection -> Quality Failures, Product Issues rows
   - Vendor Performance Scorecard -> Supplier Failure, Commodity Prices rows
   - Security Awareness Training -> Phishing, Data Breach rows
   - etc.

   Set net_probability/net_impact lower than gross to show control effectiveness.

5. **Control Tests (~20 tests):**
   Create test history with varied results:

   ```sql
   INSERT INTO control_tests (tenant_id, control_id, rct_row_id, tester_name, test_date, result, effectiveness, evidence, findings, recommendations)
   VALUES (
     tenant_id,
     control_access_review,
     rct_system_failure,
     'John Smith',
     '2025-11-15',
     'pass',
     4,
     'Access reports reviewed. 5 terminated users removed.',
     'No significant issues found.',
     'Continue quarterly reviews.'
   );
   ```

   **Test distribution:**
   - ~12 pass results (effectiveness 4-5)
   - ~4 partial results (effectiveness 2-3)
   - ~4 fail results (effectiveness 1-2, with findings and recommendations)

   Use realistic past dates (2025-01 to 2025-12).

6. **Remediation Plans (~5 plans):**
   Create remediation plans for failed tests:

   ```sql
   INSERT INTO remediation_plans (
     tenant_id, control_test_id, control_id, rct_row_id,
     title, description, owner, deadline, status, priority, action_items, notes
   )
   VALUES (
     tenant_id,
     test_failed_1,
     control_backup,
     rct_system_failure,
     'Improve backup recovery testing',
     'Recovery test failed to meet 4-hour RTO target',
     'IT Manager',
     '2026-02-15',
     'in-progress',
     'high',
     '[{"id":"1","description":"Identify bottlenecks in recovery process","completed":true,"completedDate":"2026-01-10"},{"id":"2","description":"Upgrade backup infrastructure","completed":false}]'::jsonb,
     'Budget approved for infrastructure upgrade'
   );
   ```

   **Remediation plan distribution:**
   - 1 open (critical priority)
   - 2 in-progress (high/medium priority)
   - 1 resolved (waiting for closure)
   - 1 closed (completed)

   Use realistic deadlines (2026-01 to 2026-06).
  </action>
  <verify>
Run SQL in Supabase SQL Editor after 29-01 and 29-02. Verify:
- `SELECT COUNT(*) FROM rct_rows WHERE tenant_id = '...'` returns ~25
- `SELECT COUNT(*) FROM controls WHERE tenant_id = '...'` returns ~15
- `SELECT COUNT(*) FROM control_links WHERE tenant_id = '...'` returns ~30
- `SELECT COUNT(*) FROM control_tests WHERE tenant_id = '...'` returns ~20
- `SELECT COUNT(*) FROM remediation_plans WHERE tenant_id = '...'` returns ~5
- `SELECT result, COUNT(*) FROM control_tests GROUP BY result` shows pass/partial/fail distribution
  </verify>
  <done>RCT seed script creates realistic risk-process combinations with controls, test history showing varied results, and remediation plans for failed tests</done>
</task>

</tasks>

<verification>
- [ ] SQL script exists at supabase/seed-scripts/29-03-rct-controls-remediation.sql
- [ ] Script is syntactically valid SQL
- [ ] Uses hardcoded tenant_id for demo tenant
- [ ] Deletes existing data before inserting (clean slate)
- [ ] Creates ~25 RCT rows with varied gross scores
- [ ] Creates ~15 controls with different types
- [ ] Creates ~30 control links with net scores
- [ ] Creates ~20 control tests with pass/partial/fail results
- [ ] Creates ~5 remediation plans with different statuses
- [ ] Foreign keys reference correct taxonomy nodes from 29-01/29-02
</verification>

<success_criteria>
SQL script can be executed in Supabase SQL Editor after taxonomy scripts to populate RCT data for demo tenant. All features are showcased: various risk levels, control types, test outcomes, and remediation workflows.
</success_criteria>

<output>
After completion, create `.planning/phases/29-demo-tenant-seed-data/29-03-SUMMARY.md`
</output>
