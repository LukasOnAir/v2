---
phase: 30-matrix-resizable-headers
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/components/matrix/ResizeHandle.tsx
  - src/components/matrix/MatrixGrid.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag column header right edge to resize width"
    - "User can drag row header bottom edge to resize height"
    - "Resize handles appear on hover (visual affordance)"
    - "Double-click auto-fits to content"
    - "Resizing works in both normal and inverted matrix orientations"
  artifacts:
    - path: "src/components/matrix/ResizeHandle.tsx"
      provides: "Reusable resize handle with drag logic"
      min_lines: 50
    - path: "src/components/matrix/MatrixGrid.tsx"
      provides: "Dynamic column/row sizing from store"
      contains: "columnWidths"
  key_links:
    - from: "ResizeHandle onDrag"
      to: "matrixStore.setColumnWidth"
      via: "onResize callback prop"
      pattern: "setColumnWidth|setRowHeight"
    - from: "MatrixGrid gridTemplateColumns"
      to: "columnWidths map"
      via: "lookup with fallback"
      pattern: "columnWidths\\[.*\\]|getColumnWidth"
---

<objective>
Implement resize handles and apply dynamic sizing to MatrixGrid

Purpose: Allow users to drag header edges to resize columns/rows for better readability when text doesn't fit.
Output: Working resize functionality with visual handles and auto-fit on double-click.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-matrix-resizable-headers/30-01-SUMMARY.md
@src/stores/matrixStore.ts
@src/components/matrix/MatrixGrid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResizeHandle component</name>
  <files>src/components/matrix/ResizeHandle.tsx</files>
  <action>
Create a new ResizeHandle component with the following specs:

Props interface:
```typescript
interface ResizeHandleProps {
  direction: 'horizontal' | 'vertical'  // horizontal = resize width (right edge), vertical = resize height (bottom edge)
  onResize: (delta: number) => void     // Called during drag with pixel delta
  onResizeEnd?: () => void              // Called when drag ends
  onDoubleClick?: () => void            // Called on double-click (auto-fit)
}
```

Implementation:
1. Render a div positioned absolutely on the edge:
   - horizontal: right edge, full height, 6px wide
   - vertical: bottom edge, full width, 6px tall

2. Styling:
   - Invisible by default (transparent background)
   - On hover: show a 2px line indicator (bg-primary/50)
   - Cursor: col-resize for horizontal, row-resize for vertical
   - z-index: 40 (above sticky headers)

3. Drag behavior using pointer events:
   - onPointerDown: capture pointer, record start position, set dragging state
   - onPointerMove: if dragging, calculate delta from start, call onResize(delta)
   - onPointerUp: release pointer, call onResizeEnd if provided

4. Double-click handler: call onDoubleClick prop if provided

Use useRef for tracking drag state (isDragging, startX/startY).
Use useCallback for event handlers to prevent re-renders.

CSS classes approach (Tailwind):
- Base: `absolute opacity-0 hover:opacity-100 transition-opacity`
- Horizontal: `right-0 top-0 bottom-0 w-1.5 cursor-col-resize hover:bg-primary/50`
- Vertical: `left-0 bottom-0 right-0 h-1.5 cursor-row-resize hover:bg-primary/50`
  </action>
  <verify>
`npx tsc --noEmit` passes.
Component file exists and exports ResizeHandle.
  </verify>
  <done>
ResizeHandle component created with drag logic, hover states, and double-click support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate resize handles into MatrixGrid</name>
  <files>src/components/matrix/MatrixGrid.tsx</files>
  <action>
Update MatrixGrid to use dynamic column/row sizes and add resize handles:

1. Import from store:
   - Add: `columnWidths, rowHeights, defaultColumnWidth, defaultRowHeight, setColumnWidth, setRowHeight`

2. Create helper functions:
```typescript
// Get column width with fallback to default (respecting zoom)
const getColumnWidth = (itemId: string) => {
  const customWidth = columnWidths[itemId]
  return customWidth ?? defaultColumnWidth * zoomLevel
}

// Get row height with fallback to default (respecting zoom)
const getRowHeight = (itemId: string) => {
  const customHeight = rowHeights[itemId]
  return customHeight ?? defaultRowHeight * zoomLevel
}
```

3. Update gridTemplateColumns calculation:
   - Instead of: `repeat(${columnItems.length}, ${cellSize}px)`
   - Use: `${columnItems.map(item => `${getColumnWidth(item.id)}px`).join(' ')}`

4. Update column headers:
   - Add `position: relative` to enable absolute positioning of resize handle
   - Add ResizeHandle with direction="horizontal"
   - onResize: `(delta) => setColumnWidth(item.id, getColumnWidth(item.id) + delta)`
   - onDoubleClick: Implement auto-fit by measuring text width (use a temporary hidden span or estimate ~8px per character)

5. Update row headers:
   - Add `position: relative`
   - Add ResizeHandle with direction="vertical"
   - onResize: `(delta) => setRowHeight(item.id, getRowHeight(item.id) + delta)`
   - onDoubleClick: Auto-fit to content height

6. Update data cell heights:
   - Row heights should apply to entire row, use `getRowHeight(rowItem.id)` for row header height
   - Data cells in same row should match row height

7. For auto-fit on double-click:
   - Column: Estimate width as `Math.max(80, label.length * 8)` (simple heuristic)
   - Row: Use default height (auto-fit less important for rows)

8. Ensure resize works regardless of isInverted state:
   - columnItems/rowItems are already derived based on inversion
   - Size maps are keyed by item ID, so they work correctly in both orientations
  </action>
  <verify>
`npx tsc --noEmit` passes.
Run dev server: `npm run dev`
Navigate to Risk-Process Matrix page.
Verify resize handles appear on header hover.
Verify dragging changes column/row sizes.
  </verify>
  <done>
- Column headers have resize handles on right edge
- Row headers have resize handles on bottom edge
- Dragging resizes columns/rows
- Double-click auto-fits column width
- Sizes persist across page refreshes (localStorage)
- Works in both normal and inverted orientations
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles
2. Visual test:
   - Hover column header edge - see resize indicator
   - Drag to resize - column width changes
   - Hover row header edge - see resize indicator
   - Drag to resize - row height changes
3. Persistence test:
   - Resize a column, refresh page - width preserved
4. Inversion test:
   - Toggle matrix inversion, resize still works
5. Double-click test:
   - Double-click column edge - auto-fits to content width
</verification>

<success_criteria>
- Resize handles visible on hover
- Drag resizing works for both columns and rows
- Sizes persist in localStorage
- Auto-fit on double-click works for columns
- Works in both normal and inverted matrix orientations
</success_criteria>

<output>
After completion, create `.planning/phases/30-matrix-resizable-headers/30-02-SUMMARY.md`
</output>
