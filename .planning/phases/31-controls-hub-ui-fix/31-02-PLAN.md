---
phase: 31-controls-hub-ui-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/rct/ControlTestSection.tsx
  - src/components/rct/ControlTestForm.tsx
autonomous: true

must_haves:
  truths:
    - "Control tests display in ControlTestSection when authenticated"
    - "Recording a control test persists to database"
    - "Test history shows database records for authenticated users"
    - "Demo mode continues to work with Zustand store"
  artifacts:
    - path: "src/components/rct/ControlTestSection.tsx"
      provides: "Dual-source control test section"
      contains: "useControlTests"
    - path: "src/components/rct/ControlTestForm.tsx"
      provides: "Dual-source test recording"
      contains: "useRecordTest"
  key_links:
    - from: "src/components/rct/ControlTestSection.tsx"
      to: "useControlTests"
      via: "React Query hook"
      pattern: "useTestHistory\\(control\\.id\\)"
    - from: "src/components/rct/ControlTestForm.tsx"
      to: "useRecordTest"
      via: "mutation hook"
      pattern: "useRecordTest\\(\\)"
---

<objective>
Wire control test components to use database data when authenticated.

Purpose: Fix bug where control tests don't display in UI for authenticated users. Components currently only read from Zustand store (controlTests) which is empty for authenticated users per decision [26-07].

Output: ControlTestSection and ControlTestForm use dual-source pattern (demo: store, auth: hooks) for reading and mutating control test data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-controls-hub-ui-fix/31-RESEARCH.md
@src/hooks/useControlTests.ts
@src/components/rct/ControlPanel.tsx (reference implementation of dual-source pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire ControlTestSection with dual-source pattern</name>
  <files>src/components/rct/ControlTestSection.tsx</files>
  <action>
Add dual-source pattern to ControlTestSection:

1. Add imports at top:
```typescript
import { useIsDemoMode } from '@/hooks/useTenantData'
import { useTestHistory } from '@/hooks/useControlTests'
```

2. Inside component, add dual-source data:
```typescript
const isDemoMode = useIsDemoMode()

// Store data (demo mode)
const { updateControlSchedule, controlTests: storeControlTests } = useRCTStore()

// Database hook (auth mode) - fetches test history for this control
const { data: dbTestHistory } = useTestHistory(control.id)

// Dual-source selection - filter store tests for this control
const controlTests = isDemoMode
  ? storeControlTests.filter(t => t.controlId === control.id)
  : (dbTestHistory || [])
```

3. Update the testHistory memo to use the dual-source controlTests:
```typescript
// Get test history for this control (already filtered by control.id for both sources)
const testHistory = useMemo(() => {
  return [...controlTests].sort(
    (a, b) => new Date(b.testDate).getTime() - new Date(a.testDate).getTime()
  )
}, [controlTests])
```

4. Note: updateControlSchedule is still store-only because control schedule fields (testFrequency, nextTestDate, testProcedure) are part of the Control entity, not ControlTest. Control updates are already handled by the ControlPanel's dual-source pattern. If schedule updates need to work for auth mode, they would need to use the control update mutation - but this is a separate concern from showing test history.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>ControlTestSection displays test history from database when authenticated</done>
</task>

<task type="auto">
  <name>Task 2: Wire ControlTestForm with dual-source pattern</name>
  <files>src/components/rct/ControlTestForm.tsx</files>
  <action>
Add dual-source pattern to ControlTestForm:

1. Add imports:
```typescript
import { useIsDemoMode } from '@/hooks/useTenantData'
import { useRecordTest } from '@/hooks/useControlTests'
```

2. Add dual-source mutation:
```typescript
const isDemoMode = useIsDemoMode()

// Store mutation (demo mode)
const storeRecordTest = useRCTStore((state) => state.recordControlTest)

// Database mutation (auth mode)
const recordTestMutation = useRecordTest()
```

3. Update handleSubmit to use dual-source:
```typescript
const handleSubmit = (e: React.FormEvent) => {
  e.preventDefault()

  const testData = {
    controlId,
    rowId,
    testDate,
    result,
    effectiveness: effectiveness === '' ? null : effectiveness,
    testerName: testerName.trim() || undefined,
    evidence: evidence.trim() || undefined,
    findings: findings.trim() || undefined,
    recommendations: recommendations.trim() || undefined,
  }

  if (isDemoMode) {
    storeRecordTest(testData)
  } else {
    recordTestMutation.mutate(testData)
  }

  onComplete()
}
```

4. Optionally add loading state for mutation:
```typescript
// In button, optionally show loading state
<button
  type="submit"
  disabled={recordTestMutation.isPending}
  className="..."
>
  {recordTestMutation.isPending ? 'Recording...' : 'Record Test'}
</button>
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Recording a test in ControlPanel persists to database for authenticated users.</verify>
  <done>ControlTestForm creates database records when authenticated, demo mode unchanged</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` - no errors
2. Log in as authenticated user with seeded demo tenant data
3. Navigate to RCT page, click Controls button on a row
4. Expand Testing section - should show test history from database (if any exists)
5. Record a new test - should persist to database (verify in Supabase SQL editor)
6. Refresh page - recorded test should appear in history
7. Test demo mode (unauthenticated) - should still work with Zustand store
</verification>

<success_criteria>
- ControlTestSection uses dual-source pattern
- Authenticated users see control test history from database
- Recording tests persists to database for authenticated users
- Demo mode continues to work with Zustand store
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-controls-hub-ui-fix/31-02-SUMMARY.md`
</output>
