---
phase: 32-rct-l4-l5-taxonomy-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/rct/RCTTable.tsx
  - supabase/seed-scripts/29-03-rct-controls-remediation.sql
autonomous: true

must_haves:
  truths:
    - "L4 taxonomy nodes display in RCT L4 columns when RCT row references L4+ depth item"
    - "L5 taxonomy nodes display in RCT L5 columns when RCT row references L5 depth item"
    - "RCT rows with L4/L5 risks show complete hierarchy path (L1 through L4/L5)"
    - "RCT rows with L4/L5 processes show complete hierarchy path"
    - "Demo tenant seed data includes RCT rows that reference L5 leaf nodes"
  artifacts:
    - path: "src/components/rct/RCTTable.tsx"
      provides: "Fixed getHierarchyPath function that correctly populates L4/L5"
      contains: "l4Id.*l4Name.*l5Id.*l5Name"
    - path: "supabase/seed-scripts/29-03-rct-controls-remediation.sql"
      provides: "RCT rows referencing L4/L5 taxonomy nodes"
      contains: "Annual Renewal|Final Assembly"
  key_links:
    - from: "src/components/rct/RCTTable.tsx"
      to: "getAncestryPath"
      via: "parent traversal loop"
      pattern: "ancestryPath\\[i\\]"
    - from: "rct_rows table"
      to: "taxonomy_nodes (L5)"
      via: "risk_id and process_id foreign keys"
      pattern: "risk_annual_renewal|proc_final_assembly"
---

<objective>
Fix L4 and L5 taxonomy levels not displaying values in RCT columns.

Purpose: The RCT table should show the complete hierarchy path (L1-L5) for each risk and process. Currently, L4 and L5 columns appear empty even when the taxonomy has L4/L5 depth nodes.

Output: Working L4/L5 column display in RCT, verified with seed data that includes L5 leaf items for both risks AND processes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-rct-l4-l5-taxonomy-display/32-RESEARCH.md
@src/components/rct/RCTTable.tsx
@src/utils/rctGenerator.ts
@src/hooks/useTaxonomy.ts
@supabase/seed-scripts/29-01-risk-taxonomy.sql
@supabase/seed-scripts/29-02-process-taxonomy.sql
@supabase/seed-scripts/29-03-rct-controls-remediation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add L5 leaf RCT rows to seed data (risk AND process)</name>
  <files>supabase/seed-scripts/29-03-rct-controls-remediation.sql</files>
  <action>
Update the seed script to include RCT rows that reference L5 leaf nodes for BOTH risk AND process taxonomies.

1. Add variable declarations for L5 risk nodes:
   - `risk_annual_renewal` - L5 node: Compliance Risk -> Regulatory Risk -> Industry Specific -> License Requirements -> Annual Renewal
   - `risk_apt` - L5 node: Technology Risk -> Cybersecurity Risk -> Data Breach -> External Attack -> APT

2. Add variable declarations for L5 process nodes:
   - `proc_final_assembly` - L5 node: Core Operations -> Production/Service Delivery -> Manufacturing -> Assembly -> Final Assembly
   - `proc_annual_report` - L5 node: Support Functions -> Finance & Accounting -> Financial Reporting -> Regulatory Filings -> Annual Report

3. Add SELECT statements to lookup these L5 nodes by name (add near the other lookups around line 240):
   ```sql
   -- L5 Risk nodes
   SELECT id INTO risk_annual_renewal FROM taxonomy_nodes
     WHERE tenant_id = v_tenant_id AND type = 'risk' AND name = 'Annual Renewal';
   SELECT id INTO risk_apt FROM taxonomy_nodes
     WHERE tenant_id = v_tenant_id AND type = 'risk' AND name = 'APT';

   -- L5 Process nodes
   SELECT id INTO proc_final_assembly FROM taxonomy_nodes
     WHERE tenant_id = v_tenant_id AND type = 'process' AND name = 'Final Assembly';
   SELECT id INTO proc_annual_report FROM taxonomy_nodes
     WHERE tenant_id = v_tenant_id AND type = 'process' AND name = 'Annual Report';
   ```

4. Add 3 RCT rows that showcase L5 taxonomy nodes (after line 471, before the Controls section):
   ```sql
   -- RCT row 26: L5 risk (Annual Renewal) + L3 process (Regulatory Compliance)
   -- Expected display: Risk L1-L5 populated, Process L1-L3 populated
   INSERT INTO rct_rows (tenant_id, row_id, risk_id, process_id, gross_probability, gross_impact, risk_appetite,
     gross_probability_comment, gross_impact_comment)
   VALUES (v_tenant_id, risk_annual_renewal || ':' || proc_regulatory_compliance, risk_annual_renewal, proc_regulatory_compliance,
     3, 3, 9,
     'License renewal process has multiple dependencies',
     'Missed renewal could halt regulated business activities')
   RETURNING id INTO rct_26;

   -- RCT row 27: L5 risk (APT) + L3 process (Cybersecurity)
   -- Expected display: Risk L1-L5 populated, Process L1-L3 populated
   INSERT INTO rct_rows (tenant_id, row_id, risk_id, process_id, gross_probability, gross_impact, risk_appetite,
     gross_probability_comment, gross_impact_comment)
   VALUES (v_tenant_id, risk_apt || ':' || proc_cybersecurity, risk_apt, proc_cybersecurity,
     4, 5, 12,
     'State-sponsored threat actors actively targeting our industry',
     'APT breach could result in long-term espionage and IP theft')
   RETURNING id INTO rct_27;

   -- RCT row 28: L3 risk (Process Failure) + L5 process (Final Assembly)
   -- Expected display: Risk L1-L3 populated, Process L1-L5 populated
   INSERT INTO rct_rows (tenant_id, row_id, risk_id, process_id, gross_probability, gross_impact, risk_appetite,
     gross_probability_comment, gross_impact_comment)
   VALUES (v_tenant_id, risk_process_failure || ':' || proc_final_assembly, risk_process_failure, proc_final_assembly,
     3, 4, 10,
     'Final assembly has complex multi-step procedures',
     'Assembly errors could result in product recalls')
   RETURNING id INTO rct_28;
   ```

5. Add the new rct_26, rct_27, rct_28 variable declarations to the DECLARE section (around line 99):
   ```sql
   rct_26 UUID; -- Annual Renewal (L5 risk) -> Regulatory Compliance (L3 process)
   rct_27 UUID; -- APT (L5 risk) -> Cybersecurity (L3 process)
   rct_28 UUID; -- Process Failure (L3 risk) -> Final Assembly (L5 process)
   ```

This creates test cases where:
- RCT row 26: L5 risk with L3 process (tests Risk L4/L5 columns)
- RCT row 27: L5 risk with L3 process (tests Risk L4/L5 columns)
- RCT row 28: L3 risk with L5 process (tests Process L4/L5 columns)
  </action>
  <verify>
Run SQL syntax validation and verify database state:
```bash
# Check SQL syntax - new variable declarations exist
grep -E "risk_annual_renewal|risk_apt|proc_final_assembly|proc_annual_report|rct_26|rct_27|rct_28" supabase/seed-scripts/29-03-rct-controls-remediation.sql

# Count occurrences to ensure all pieces are in place
grep -c "rct_2[678]" supabase/seed-scripts/29-03-rct-controls-remediation.sql
# Expected: 6 (3 declarations + 3 RETURNING INTO statements)
```

After running the seed script in Supabase, verify with this query:
```sql
-- Verify L5 nodes are referenced in rct_rows
SELECT
  r.id,
  rn.name as risk_name,
  rn.hierarchical_id as risk_hier,
  pn.name as process_name,
  pn.hierarchical_id as process_hier
FROM rct_rows r
JOIN taxonomy_nodes rn ON r.risk_id = rn.id
JOIN taxonomy_nodes pn ON r.process_id = pn.id
WHERE r.tenant_id = '5ea03edb-6e79-4b62-bd36-39f1963d0640'
  AND (
    rn.name IN ('Annual Renewal', 'APT')
    OR pn.name = 'Final Assembly'
  );
-- Expected: 3 rows with L5 taxonomy references
```
  </verify>
  <done>Seed script includes 3 RCT rows: 2 referencing L5 risk nodes (Annual Renewal, APT) and 1 referencing L5 process node (Final Assembly). Database verification query confirms L5 nodes are in rct_rows table.</done>
</task>

<task type="auto">
  <name>Task 2: Verify and fix getHierarchyPath for L4/L5</name>
  <files>src/components/rct/RCTTable.tsx</files>
  <action>
The `getHierarchyPath` function in RCTTable.tsx (lines 216-257) should already support L4/L5 levels based on the loop:
```typescript
for (let i = 0; i < ancestryPath.length && i < 5; i++) {
  // ... assigns l1-l5
}
```

Verify this logic is correct by:

1. Check that `findTaxonomyById` recursively searches children (confirmed - lines 130-139)
2. Check that `getAncestryPath` properly walks up the tree via parentMap (confirmed - lines 197-210)
3. Check that the loop correctly assigns l1-l5 based on index (confirmed)

The code appears correct. The issue is likely that:
- Current seed data RCT rows reference L3 nodes, so L4/L5 are correctly empty
- Adding L5 leaf references (Task 1) will prove the code works

However, add a console.log temporarily to verify during testing:

Add debug logging inside `denormalizeRCTRow` (after line 270):
```typescript
// DEBUG: Log L4/L5 values to verify hierarchy traversal
if (process.env.NODE_ENV === 'development') {
  if (riskPath.l4Name || riskPath.l5Name || processPath.l4Name || processPath.l5Name) {
    console.log('[RCT Debug] L4/L5 hierarchy:', {
      riskL4: riskPath.l4Name,
      riskL5: riskPath.l5Name,
      processL4: processPath.l4Name,
      processL5: processPath.l5Name,
    })
  }
}
```

This debug log will fire ONLY when L4/L5 values exist, confirming the hierarchy traversal works for deep nodes. Can be removed after verification.
  </action>
  <verify>
```bash
# Verify debug logging is added
grep -n "RCT Debug.*L4/L5" src/components/rct/RCTTable.tsx

# Verify getHierarchyPath loop handles 5 levels
grep -n "i < 5" src/components/rct/RCTTable.tsx
```

**Runtime verification steps (after running updated seed script):**
1. Start the dev server: `npm run dev`
2. Log in as demo tenant user
3. Navigate to RCT page
4. Open browser DevTools console
5. Look for `[RCT Debug] L4/L5 hierarchy:` log entries
6. Verify the output shows:
   - `riskL4: "License Requirements"` and `riskL5: "Annual Renewal"` for row 26
   - `riskL4: "External Attack"` and `riskL5: "APT"` for row 27
   - `processL4: "Assembly"` and `processL5: "Final Assembly"` for row 28
7. Visually confirm L4/L5 columns in the RCT table show these values (not empty)
  </verify>
  <done>Debug logging added to denormalizeRCTRow; runtime verification confirms L4/L5 values populate in console and display in RCT columns for test rows</done>
</task>

<task type="auto">
  <name>Task 3: Verify TypeScript build passes</name>
  <files>N/A (verification only)</files>
  <action>
Run TypeScript compiler to ensure no type errors introduced:

```bash
npm run build
```

If build fails, fix any TypeScript errors in the modified files.
  </action>
  <verify>
```bash
npm run build
# Should complete with exit code 0
```
  </verify>
  <done>TypeScript build passes with no errors</done>
</task>

</tasks>

<verification>
1. SQL seed script contains new L5 leaf RCT rows (for both risk and process taxonomies)
2. Database query confirms L5 nodes referenced in rct_rows table
3. Debug logging in place to confirm L4/L5 population
4. TypeScript build passes
5. After running updated seed SQL in Supabase and viewing RCT in authenticated mode:
   - RCT row for "Annual Renewal" risk should show:
     - Risk L1: Compliance Risk
     - Risk L2: Regulatory Risk
     - Risk L3: Industry Specific
     - Risk L4: License Requirements
     - Risk L5: Annual Renewal
   - RCT row for "Final Assembly" process should show:
     - Process L1: Core Operations
     - Process L2: Production/Service Delivery
     - Process L3: Manufacturing
     - Process L4: Assembly
     - Process L5: Final Assembly
   - L4/L5 columns display the correct values (not empty)
</verification>

<success_criteria>
- [ ] Seed script 29-03 includes 3 RCT rows referencing L5 nodes (2 risk, 1 process)
- [ ] Database verification query confirms L5 taxonomy nodes in rct_rows
- [ ] Debug logging confirms L4/L5 values are populated at runtime
- [ ] TypeScript build passes
- [ ] L4/L5 columns display correct hierarchy values for deep taxonomy items
</success_criteria>

<output>
After completion, create `.planning/phases/32-rct-l4-l5-taxonomy-display/32-01-SUMMARY.md`
</output>
