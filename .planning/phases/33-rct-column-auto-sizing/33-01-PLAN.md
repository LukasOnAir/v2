---
phase: 33-rct-column-auto-sizing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/rctStore.ts
  - src/components/rct/RCTTable.tsx
autonomous: true

must_haves:
  truths:
    - "User can double-click column header edge to auto-fit width"
    - "Auto-fit considers both header text and cell content"
    - "Column widths persist across page refresh in demo mode"
    - "Behavior matches Risk Process Matrix (ResizeHandle component)"
  artifacts:
    - path: "src/stores/rctStore.ts"
      provides: "columnWidths state and setColumnWidth/autoFitColumnWidth actions"
      contains: "columnWidths: Record<string, number>"
    - path: "src/components/rct/RCTTable.tsx"
      provides: "ResizeHandle integration with auto-fit on double-click"
      contains: "ResizeHandle"
  key_links:
    - from: "src/components/rct/RCTTable.tsx"
      to: "src/stores/rctStore.ts"
      via: "useRCTStore hook for columnWidths state"
      pattern: "useRCTStore.*columnWidths"
    - from: "src/components/rct/RCTTable.tsx"
      to: "src/components/matrix/ResizeHandle.tsx"
      via: "Import and render ResizeHandle in column headers"
      pattern: "import.*ResizeHandle"
---

<objective>
Add column auto-sizing to the RCT Table so users can double-click column header edges to auto-fit width to content.

Purpose: Improve RCT usability by allowing columns to be resized to fit their content, matching the existing Risk Process Matrix behavior for UI consistency.

Output: RCT columns resize on drag and auto-fit on double-click, with widths persisted to localStorage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference implementations
@src/stores/matrixStore.ts (columnWidths pattern to replicate)
@src/components/matrix/ResizeHandle.tsx (component to reuse)
@src/components/matrix/MatrixGrid.tsx (auto-fit pattern: autoFitColumnWidth callback)

# Files to modify
@src/stores/rctStore.ts
@src/components/rct/RCTTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add columnWidths state to rctStore</name>
  <files>src/stores/rctStore.ts</files>
  <action>
Add column width state and actions to rctStore, following the matrixStore pattern:

1. Add to RCTState interface:
   - `columnWidths: Record<string, number>` - Map of column ID to width in pixels
   - `defaultColumnWidth: number` - Default width when no custom width set (use 120px)
   - `setColumnWidth: (columnId: string, width: number) => void` - Set width (clamped 40-400px)
   - `resetColumnWidth: (columnId: string) => void` - Remove custom width
   - `resetAllColumnWidths: () => void` - Clear all custom widths

2. Add initial state values:
   - `columnWidths: {}` (empty record)
   - `defaultColumnWidth: 120`

3. Implement actions (using immer pattern already in store):
   - `setColumnWidth`: Clamp width to 40-400px range, store in columnWidths map
   - `resetColumnWidth`: Delete entry from columnWidths
   - `resetAllColumnWidths`: Reset columnWidths to empty object

4. Update partialize function to persist columnWidths in both demo and auth modes:
   - columnWidths is a UI preference like columnVisibility and columnOrder
   - Add `columnWidths: state.columnWidths` to BOTH the demo mode and authenticated returns
   - Add `defaultColumnWidth: state.defaultColumnWidth` to persist default

Pattern reference from matrixStore.ts:
```typescript
setColumnWidth: (columnId, width) =>
  set((state) => {
    const clampedWidth = Math.max(40, Math.min(400, width))
    state.columnWidths[columnId] = clampedWidth
  }),
```
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
rctStore exports columnWidths state and setColumnWidth/resetColumnWidth/resetAllColumnWidths actions with proper persistence
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ResizeHandle in RCTTable column headers</name>
  <files>src/components/rct/RCTTable.tsx</files>
  <action>
Replace TanStack Table's basic resize handler with ResizeHandle component and add auto-fit:

1. Import ResizeHandle component:
   ```typescript
   import { ResizeHandle } from '@/components/matrix/ResizeHandle'
   ```

2. Update useRCTStore destructuring to include new state/actions:
   ```typescript
   const {
     // ... existing
     columnWidths,
     defaultColumnWidth,
     setColumnWidth,
   } = useRCTStore()
   ```

3. Create auto-fit calculation function (before columns useMemo):
   ```typescript
   // Calculate auto-fit width for a column based on header and cell content
   const autoFitColumnWidth = useCallback((columnId: string, headerText: string) => {
     // Start with header width estimate (8px per char + 32px padding for sort/filter icons)
     let maxWidth = headerText.length * 8 + 32

     // Check all visible cell content for this column
     const column = table.getColumn(columnId)
     if (column) {
       for (const row of rows) {
         const cellValue = column.accessorFn?.(row) ?? (row as Record<string, unknown>)[columnId]
         if (cellValue !== null && cellValue !== undefined) {
           const contentWidth = String(cellValue).length * 8 + 16
           maxWidth = Math.max(maxWidth, contentWidth)
         }
       }
     }

     // Clamp to reasonable range (80-400px)
     const finalWidth = Math.max(80, Math.min(400, maxWidth))
     setColumnWidth(columnId, finalWidth)
   }, [rows, setColumnWidth])
   ```

   Note: This function must be declared BEFORE the table instance since it needs rows but the table needs it for the headers.

4. Create helper to get column width with fallback:
   ```typescript
   const getColumnWidth = useCallback((columnId: string, defaultSize: number): number => {
     return columnWidths[columnId] ?? defaultSize
   }, [columnWidths])
   ```

5. Update table column sizing to use store values:
   In the column definitions, each column already has a `size` property. The TanStack Table uses these as defaults.

   For dynamic widths, update the header cell style to use stored width:
   ```typescript
   style={{
     width: getColumnWidth(header.id, header.getSize()),
     minWidth: getColumnWidth(header.id, header.getSize())
   }}
   ```

6. Replace the inline resize div with ResizeHandle in the header row:

   Current code (lines ~942-948):
   ```tsx
   {/* Column resize handle */}
   <div
     onMouseDown={header.getResizeHandler()}
     onTouchStart={header.getResizeHandler()}
     className={`absolute right-0 top-0 h-full w-1 cursor-col-resize...`}
   />
   ```

   Replace with:
   ```tsx
   <ResizeHandle
     direction="horizontal"
     onResize={(delta) => {
       const currentWidth = getColumnWidth(header.id, header.getSize())
       setColumnWidth(header.id, currentWidth + delta)
     }}
     onDoubleClick={() => {
       const headerText = typeof header.column.columnDef.header === 'string'
         ? header.column.columnDef.header
         : header.id
       autoFitColumnWidth(header.id, headerText)
     }}
   />
   ```

7. Update cell width to match header (in the cell td element):
   ```typescript
   style={{
     width: getColumnWidth(cell.column.id, cell.column.getSize()),
     minWidth: getColumnWidth(cell.column.id, cell.column.getSize())
   }}
   ```

8. Ensure parent th/td use `position: relative` so ResizeHandle positions correctly:
   The th already has `relative` via the `group relative` class. Verify it's there.

Decision rationale: Using ResizeHandle instead of TanStack Table's built-in resize because:
- Consistent UX with MatrixGrid (users expect same behavior)
- ResizeHandle already supports double-click auto-fit
- Incremental delta calculation works better for smooth resizing
  </action>
  <verify>
1. `npx tsc --noEmit` - TypeScript compiles
2. `npm run dev` - Start dev server
3. Navigate to RCT page
4. Hover over column header edge - resize handle appears
5. Drag to resize - column width changes smoothly
6. Double-click column edge - column auto-fits to content
7. Refresh page - column widths persist
  </verify>
  <done>
RCT columns can be drag-resized and auto-fit via double-click, matching Risk Process Matrix behavior
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit`
2. RCT table loads without errors
3. Column resize handles appear on hover (right edge of headers)
4. Drag resize works smoothly with width clamped to 40-400px
5. Double-click auto-fits column to content width
6. Column widths persist after page refresh
7. Both demo mode and authenticated mode persist widths
</verification>

<success_criteria>
1. Double-click column header edge auto-fits to content width
2. Auto-sizing considers both header text and longest cell content
3. Column widths persist across sessions (localStorage)
4. Behavior matches Risk Process Matrix (same ResizeHandle component, same UX)
5. Existing functionality preserved (filters, sorting, virtualization)
</success_criteria>

<output>
After completion, create `.planning/phases/33-rct-column-auto-sizing/33-01-SUMMARY.md`
</output>
