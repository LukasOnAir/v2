---
phase: 34-tickets-dashboard-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/tickets/TicketForm.tsx
autonomous: true

must_haves:
  truths:
    - "User sees scrollable checkbox list instead of dropdown when linking entities"
    - "User can check multiple items in the list"
    - "Link Selected button adds all checked items to ticket at once"
    - "Entity type tabs remain unchanged for switching between Control/Risk/Process/RCT/Other"
    - "Existing single-add flow for 'Other' entity type preserved"
  artifacts:
    - path: "src/components/tickets/TicketForm.tsx"
      provides: "Multi-select checkbox list for entity linking"
      contains: "selectedEntities"
  key_links:
    - from: "TicketForm checkbox list"
      to: "handleAddEntity function"
      via: "Link Selected button onClick"
      pattern: "selectedEntities.*forEach.*handleAddEntity"
---

<objective>
Replace single-select dropdown with multi-select checkbox list for entity linking in TicketForm.

Purpose: Users can link multiple items to a ticket in one operation instead of adding one at a time, significantly improving workflow efficiency when tickets relate to multiple controls/risks/processes.

Output: TicketForm with scrollable checkbox list showing available entities, "Link Selected" button that bulk-adds all checked items.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/tickets/TicketForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-select state for entity selection</name>
  <files>src/components/tickets/TicketForm.tsx</files>
  <action>
1. Add state for tracking selected entity IDs (keyed by entity type):
```typescript
const [selectedEntityIds, setSelectedEntityIds] = useState<Set<string>>(new Set())
```

2. Add helper to toggle selection:
```typescript
const toggleEntitySelection = (entityId: string) => {
  setSelectedEntityIds((prev) => {
    const next = new Set(prev)
    if (next.has(entityId)) {
      next.delete(entityId)
    } else {
      next.add(entityId)
    }
    return next
  })
}
```

3. Clear selections when entity type changes:
In the entity type tab buttons onClick, after setSelectedEntityType:
```typescript
onClick={() => {
  setSelectedEntityType(opt.value)
  setSelectedEntityIds(new Set()) // Clear selections when switching type
}}
```

4. Add bulk add handler:
```typescript
const handleBulkAddEntities = () => {
  const entitiesToAdd = availableEntities.filter((e) => selectedEntityIds.has(e.id))
  for (const entity of entitiesToAdd) {
    handleAddEntity(selectedEntityType, entity.id, entity.name)
  }
  setSelectedEntityIds(new Set()) // Clear after adding
}
```
  </action>
  <verify>TypeScript compiles: `npm run build`</verify>
  <done>State management for multi-select entity selection in place with toggle and bulk add helpers</done>
</task>

<task type="auto">
  <name>Task 2: Replace dropdown with scrollable checkbox list</name>
  <files>src/components/tickets/TicketForm.tsx</files>
  <action>
1. Find the entity selector section (around line 696-736) that currently shows a dropdown.

2. Replace the dropdown with a scrollable checkbox list. Keep the 'other' type handling as-is (text input).

Replace this block (the non-'other' case with the select element):
```tsx
{/* OLD: dropdown selector */}
<select ... >
```

With checkbox list:
```tsx
{selectedEntityType !== 'other' && availableEntities.length > 0 && (
  <div className="space-y-2">
    {/* Scrollable checkbox list */}
    <div className="max-h-40 overflow-y-auto border border-surface-border rounded-lg divide-y divide-surface-border">
      {availableEntities.map((entity) => (
        <label
          key={entity.id}
          className="flex items-center gap-3 px-3 py-2 hover:bg-surface-overlay cursor-pointer"
        >
          <input
            type="checkbox"
            checked={selectedEntityIds.has(entity.id)}
            onChange={() => toggleEntitySelection(entity.id)}
            className="w-4 h-4 rounded border-surface-border text-accent-600 focus:ring-accent-500 focus:ring-offset-0"
          />
          <span className="text-sm text-text-primary truncate">{entity.name}</span>
        </label>
      ))}
    </div>

    {/* Link Selected button */}
    <button
      type="button"
      onClick={handleBulkAddEntities}
      disabled={selectedEntityIds.size === 0}
      className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-accent-600 hover:bg-accent-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <Plus size={16} />
      Link Selected ({selectedEntityIds.size})
    </button>
  </div>
)}
```

3. Keep the "No items available" message for when availableEntities.length === 0.

4. Keep the 'other' entity type flow unchanged (text input + single add button).
  </action>
  <verify>
1. `npm run build` - no TypeScript errors
2. Manual test in browser:
   - Open ticket form (create or edit)
   - Go to "Linked Items" section
   - Select "Control" tab - see checkbox list
   - Check multiple items
   - Click "Link Selected (N)" button
   - All checked items added to linked list
   - Switch to "Risk" tab - selections cleared, new list appears
   - "Other" tab still shows text input (unchanged)
  </verify>
  <done>TicketForm shows scrollable checkbox list for entity selection with bulk "Link Selected" button</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Create new ticket:
   - Linked Items section shows entity type tabs
   - Selecting Control/Risk/Process/RCT shows scrollable checkbox list
   - Can check multiple items in list
   - "Link Selected (N)" shows count of selected
   - Clicking button adds all selected to linked items
   - Switching tabs clears selection
   - "Other" tab shows text input (unchanged behavior)
3. Edit existing ticket:
   - Existing links displayed
   - Can add more via multi-select
   - Can remove individual links via trash icon
</verification>

<success_criteria>
- SC-4 met: User can select multiple items via checkboxes when linking
- SC-5 met: Bulk link action links all selected items in one operation
- Existing functionality preserved (remove links, jump to item, Other type input)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/34-tickets-dashboard-enhancements/34-02-SUMMARY.md`
</output>
