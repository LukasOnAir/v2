---
phase: 36-mobile-control-tester
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - public/manifest.webmanifest
  - public/pwa-192x192.png
  - public/pwa-512x512.png
  - src/components/pwa/ReloadPrompt.tsx
  - src/components/pwa/index.ts
  - src/main.tsx
autonomous: true

must_haves:
  truths:
    - "App can be installed to home screen on mobile devices"
    - "App works offline for cached pages"
    - "Update notification appears when new version available"
  artifacts:
    - path: "vite.config.ts"
      provides: "PWA plugin configuration"
      contains: "VitePWA"
    - path: "public/manifest.webmanifest"
      provides: "PWA manifest with app metadata"
      contains: "RiskGuard"
    - path: "src/components/pwa/ReloadPrompt.tsx"
      provides: "Update notification UI"
      exports: ["ReloadPrompt"]
  key_links:
    - from: "src/main.tsx"
      to: "ReloadPrompt"
      via: "component render"
      pattern: "<ReloadPrompt"
    - from: "vite.config.ts"
      to: "manifest.webmanifest"
      via: "VitePWA manifest config"
      pattern: "manifest:"
---

<objective>
Add PWA (Progressive Web App) infrastructure to enable mobile installation and offline caching.

Purpose: Control testers can install the app to their phone home screen for native-like experience with offline capability.
Output: PWA-enabled build with manifest, service worker auto-registration, and update notifications.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-mobile-control-tester/36-RESEARCH.md
@vite.config.ts
@src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure vite-plugin-pwa and manifest</name>
  <files>vite.config.ts, public/manifest.webmanifest</files>
  <action>
1. Install dependencies: `npm install vite-plugin-pwa -D`
2. Update vite.config.ts to add VitePWA plugin:
   - registerType: 'autoUpdate' (auto-update service worker)
   - includeAssets: ['favicon.ico', 'robots.txt']
   - manifest object with:
     - name: 'RiskGuard Control Tester'
     - short_name: 'Tester'
     - description: 'Complete control tests on mobile'
     - theme_color: '#1a1a2e' (matches app dark theme)
     - background_color: '#0d0d14'
     - display: 'standalone'
     - icons array for 192x192 and 512x512 (placeholder paths for now)
   - workbox config with:
     - globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}']
     - runtimeCaching for Supabase API calls with NetworkFirst strategy

3. Create public/manifest.webmanifest as backup (plugin generates from config, but good to have explicit file)

Note: DO NOT use @vite-plugin-pwa/vite-plugin-pwa - it's just 'vite-plugin-pwa'.
  </action>
  <verify>
    - `npm run build` completes without errors
    - Build output includes `sw.js` and `manifest.webmanifest`
    - `dist/manifest.webmanifest` contains correct app name and theme colors
  </verify>
  <done>
    - vite-plugin-pwa configured in vite.config.ts
    - Manifest has correct app branding (name, colors, display mode)
    - Service worker generated during build
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PWA icons and ReloadPrompt component</name>
  <files>public/pwa-192x192.png, public/pwa-512x512.png, src/components/pwa/ReloadPrompt.tsx, src/components/pwa/index.ts, src/main.tsx</files>
  <action>
1. Create placeholder PWA icons:
   - Use a simple programmatic approach: create SVG-based PNG files with "RG" text
   - Or create minimal placeholder files that can be replaced later
   - Files: public/pwa-192x192.png, public/pwa-512x512.png
   - Note: For production, proper icons should be designed, but placeholders work for PWA functionality

2. Create src/components/pwa/ReloadPrompt.tsx:
   - Import useRegisterSW from 'virtual:pwa-register/react'
   - Show toast via sonner when needRefresh is true
   - Toast has "Update" action button that calls updateServiceWorker(true)
   - Use Infinity duration so user must dismiss or click Update
   - Component returns null (no visible UI, just toast trigger)

3. Create src/components/pwa/index.ts barrel export

4. Update src/main.tsx:
   - Import and render ReloadPrompt component
   - Place it inside the app tree (inside ErrorBoundary, after Toaster)

Note: The 'virtual:pwa-register/react' import requires TypeScript declaration - add to vite-env.d.ts if needed.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Browser DevTools > Application > Manifest shows app info
    - No TypeScript errors on virtual import
  </verify>
  <done>
    - PWA icons exist in public folder (placeholder or actual)
    - ReloadPrompt component created and wired to main.tsx
    - App can register service worker on load
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build && npm run preview`
2. Open in Chrome, go to DevTools > Application tab
3. Manifest section shows correct app name and icons
4. Service Workers section shows registered worker
5. On mobile (or Chrome mobile emulation), "Install app" option appears in browser menu
</verification>

<success_criteria>
- PWA manifest generated with correct branding
- Service worker registers and caches static assets
- ReloadPrompt component shows update toast when new version deployed
- App installable on mobile devices
</success_criteria>

<output>
After completion, create `.planning/phases/36-mobile-control-tester/36-01-SUMMARY.md`
</output>
