---
phase: 36-mobile-control-tester
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/offlineQueue.ts
  - src/hooks/useNetworkStatus.ts
  - src/hooks/usePendingSync.ts
  - src/components/tester/OfflineIndicator.tsx
  - src/components/tester/index.ts
autonomous: true

must_haves:
  truths:
    - "Test submissions are queued in IndexedDB when offline"
    - "Queued submissions sync automatically when back online"
    - "User sees visual indicator when offline"
  artifacts:
    - path: "src/lib/offlineQueue.ts"
      provides: "IndexedDB queue utilities"
      exports: ["queueTestSubmission", "getPendingTests", "clearPendingTest", "getPendingCount"]
    - path: "src/hooks/useNetworkStatus.ts"
      provides: "Online/offline detection hook"
      exports: ["useNetworkStatus"]
    - path: "src/hooks/usePendingSync.ts"
      provides: "Background sync on reconnect"
      exports: ["usePendingSync"]
    - path: "src/components/tester/OfflineIndicator.tsx"
      provides: "Visual offline badge"
      exports: ["OfflineIndicator"]
  key_links:
    - from: "src/hooks/usePendingSync.ts"
      to: "src/lib/offlineQueue.ts"
      via: "getPendingTests + clearPendingTest"
      pattern: "getPendingTests|clearPendingTest"
    - from: "src/components/tester/OfflineIndicator.tsx"
      to: "src/hooks/useNetworkStatus.ts"
      via: "hook consumption"
      pattern: "useNetworkStatus"
---

<objective>
Build offline queue infrastructure for test submissions that cannot reach the server.

Purpose: Control testers in the field often have spotty connectivity. Their test submissions must not be lost when offline.
Output: IndexedDB-backed queue that stores submissions locally and syncs when connectivity returns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-mobile-control-tester/36-RESEARCH.md
@src/hooks/useControlTests.ts
@src/types/rct.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IndexedDB queue utilities</name>
  <files>src/lib/offlineQueue.ts</files>
  <action>
Create src/lib/offlineQueue.ts with the following:

1. Constants:
   - DB_NAME = 'riskguard-offline'
   - STORE_NAME = 'pending-tests'
   - DB_VERSION = 1

2. Helper function openDB(): Promise<IDBDatabase>
   - Uses indexedDB.open(DB_NAME, DB_VERSION)
   - onupgradeneeded creates object store with keyPath: 'id', autoIncrement: true
   - Returns promise that resolves to database instance

3. Export queueTestSubmission(test: Omit<ControlTest, 'id'>): Promise<void>
   - Opens DB, creates readwrite transaction
   - Adds test object with queuedAt: new Date().toISOString()
   - Returns when add completes

4. Export getPendingTests(): Promise<Array<{id: number} & Omit<ControlTest, 'id'>>>
   - Opens DB, creates readonly transaction
   - Uses getAll() on object store
   - Returns all pending test submissions with their IndexedDB ids

5. Export clearPendingTest(id: number): Promise<void>
   - Opens DB, creates readwrite transaction
   - Deletes entry by id
   - Used after successful sync

6. Export getPendingCount(): Promise<number>
   - Opens DB, counts entries in store
   - For badge display

Type the test data using ControlTest from '@/types/rct' (omit id since IndexedDB auto-generates).
  </action>
  <verify>
    - No TypeScript errors
    - Functions are properly exported
  </verify>
  <done>
    - IndexedDB utilities created with queue, get, clear, count operations
    - Proper TypeScript types for stored test data
  </done>
</task>

<task type="auto">
  <name>Task 2: Create network status hook and pending sync</name>
  <files>src/hooks/useNetworkStatus.ts, src/hooks/usePendingSync.ts</files>
  <action>
1. Create src/hooks/useNetworkStatus.ts:
   - useState initialized to navigator.onLine
   - useEffect adds 'online' and 'offline' event listeners to window
   - Returns boolean isOnline
   - Cleanup removes listeners

2. Create src/hooks/usePendingSync.ts:
   - Import useNetworkStatus, useRecordTest from hooks
   - Import getPendingTests, clearPendingTest from offlineQueue
   - Import toast from sonner
   - Track syncing state with useState
   - Track pending count with useState

   - useEffect runs when isOnline becomes true:
     a. Call getPendingTests() to get queued submissions
     b. If count > 0, show toast "Syncing X pending test(s)..."
     c. For each pending test:
        - Call recordTestMutation.mutateAsync(test data)
        - On success, call clearPendingTest(item.id)
        - On error, log and continue (don't clear failed ones)
     d. Show success toast with count synced
     e. Update pending count state

   - Return { pendingCount, isSyncing }

Note: Use mutateAsync not mutate for sequential processing with proper error handling.
  </action>
  <verify>
    - Hooks export correctly
    - No TypeScript errors
    - usePendingSync properly chains async operations
  </verify>
  <done>
    - useNetworkStatus detects online/offline transitions
    - usePendingSync auto-syncs pending tests on reconnect
    - Toast feedback for sync progress
  </done>
</task>

<task type="auto">
  <name>Task 3: Create OfflineIndicator component</name>
  <files>src/components/tester/OfflineIndicator.tsx, src/components/tester/index.ts</files>
  <action>
1. Create src/components/tester/OfflineIndicator.tsx:
   - Import useNetworkStatus hook
   - Import usePendingSync hook
   - Import WifiOff and CloudOff icons from lucide-react

   - Render conditions:
     a. If offline: Show red badge "Offline" with WifiOff icon
     b. If online but pendingCount > 0: Show amber badge "X pending" with CloudOff icon
     c. If online and no pending: Return null (invisible)

   - Badge styling:
     - Fixed position or inline depending on usage
     - min-h-[44px] for touch targets
     - px-3 py-2 rounded-full
     - Appropriate colors (red-500/20 for offline, amber-500/20 for pending)
     - Text: text-sm font-medium

2. Update src/components/tester/index.ts:
   - Add export for OfflineIndicator
   - Existing exports: TesterControlCard

Note: Component should work both standalone and embedded in TesterDashboardPage header.
  </action>
  <verify>
    - Component renders correctly in isolation
    - Shows nothing when online with no pending
    - Export added to barrel file
  </verify>
  <done>
    - OfflineIndicator component shows network status visually
    - Badge displays pending sync count when items queued
    - Component exported from tester barrel
  </done>
</task>

</tasks>

<verification>
1. Import and render OfflineIndicator in TesterDashboardPage header
2. Toggle network in DevTools (Network tab > Offline checkbox)
3. Verify:
   - Badge appears immediately when offline
   - Badge shows correct text and icon
   - Badge disappears when back online (no pending)
4. Test queue functions in browser console:
   - await queueTestSubmission({...test data...})
   - await getPendingCount() returns 1
   - await getPendingTests() returns array with item
</verification>

<success_criteria>
- IndexedDB queue persists test submissions across page refreshes
- Network status hook detects online/offline transitions
- Pending sync runs automatically on reconnect
- Visual indicator shows offline state and pending count
</success_criteria>

<output>
After completion, create `.planning/phases/36-mobile-control-tester/36-02-SUMMARY.md`
</output>
