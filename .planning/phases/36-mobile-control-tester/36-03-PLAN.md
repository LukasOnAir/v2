---
phase: 36-mobile-control-tester
plan: 03
type: execute
wave: 2
depends_on: ["36-01", "36-02"]
files_modified:
  - src/components/tester/TestWizard.tsx
  - src/components/tester/WizardStep.tsx
  - src/components/tester/PhotoUpload.tsx
  - src/components/tester/index.ts
  - src/components/tester/TesterControlCard.tsx
  - src/pages/TesterDashboardPage.tsx
  - supabase/migrations/00027_test_evidence_bucket.sql
autonomous: true
user_setup:
  - service: supabase-storage
    why: "Photo upload requires storage bucket"
    dashboard_config:
      - task: "Run migration to create test-evidence bucket (or create manually in Dashboard > Storage)"
        location: "Supabase Dashboard > Storage"

must_haves:
  truths:
    - "Tester can complete test via step-by-step wizard"
    - "Tester can take/upload photo as evidence"
    - "Progress bar shows current step position"
    - "Test submits successfully (online) or queues (offline)"
  artifacts:
    - path: "src/components/tester/TestWizard.tsx"
      provides: "Step-by-step test form"
      exports: ["TestWizard"]
      min_lines: 80
    - path: "src/components/tester/PhotoUpload.tsx"
      provides: "Camera capture and upload"
      exports: ["PhotoUpload"]
    - path: "supabase/migrations/00027_test_evidence_bucket.sql"
      provides: "Storage bucket for evidence photos"
      contains: "test-evidence"
  key_links:
    - from: "src/components/tester/TesterControlCard.tsx"
      to: "src/components/tester/TestWizard.tsx"
      via: "conditional render"
      pattern: "<TestWizard"
    - from: "src/components/tester/TestWizard.tsx"
      to: "src/lib/offlineQueue.ts"
      via: "queueTestSubmission for offline"
      pattern: "queueTestSubmission"
    - from: "src/components/tester/PhotoUpload.tsx"
      to: "supabase.storage"
      via: "upload call"
      pattern: "supabase\\.storage"
---

<objective>
Create a mobile-friendly step-by-step test wizard with photo upload capability.

Purpose: First-line employees need a simple, guided interface to complete tests without risk management jargon.
Output: TestWizard component that breaks test submission into 3-4 easy steps with progress tracking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-mobile-control-tester/36-RESEARCH.md
@.planning/phases/36-mobile-control-tester/36-02-SUMMARY.md
@src/components/tester/TesterControlCard.tsx
@src/components/rct/ControlTestForm.tsx
@src/hooks/useControlTests.ts
@src/lib/offlineQueue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage bucket migration and PhotoUpload component</name>
  <files>supabase/migrations/00027_test_evidence_bucket.sql, src/components/tester/PhotoUpload.tsx</files>
  <action>
1. Create supabase/migrations/00027_test_evidence_bucket.sql:
```sql
-- Create storage bucket for test evidence photos
INSERT INTO storage.buckets (id, name, public)
VALUES ('test-evidence', 'test-evidence', true)
ON CONFLICT (id) DO NOTHING;

-- Allow authenticated users to upload evidence
CREATE POLICY "Authenticated users can upload evidence"
ON storage.objects FOR INSERT TO authenticated
WITH CHECK (bucket_id = 'test-evidence');

-- Allow anyone to view evidence (images embedded in test records)
CREATE POLICY "Anyone can view evidence"
ON storage.objects FOR SELECT TO public
USING (bucket_id = 'test-evidence');

-- Allow users to delete their own uploads (within same session)
CREATE POLICY "Users can delete own uploads"
ON storage.objects FOR DELETE TO authenticated
USING (bucket_id = 'test-evidence' AND auth.uid()::text = (storage.foldername(name))[1]);
```

2. Create src/components/tester/PhotoUpload.tsx:
   - Props: onUpload: (url: string | null) => void, existingUrl?: string
   - State: uploading (boolean), preview (string | null), error (string | null)
   - Initialize preview from existingUrl prop

   - handleCapture function:
     a. Get file from input event
     b. Validate file size (< 10MB)
     c. Set preview using URL.createObjectURL
     d. Generate unique filename: `${crypto.randomUUID()}.${extension}`
     e. Upload to supabase.storage.from('test-evidence').upload(filename, file)
     f. Get public URL via getPublicUrl
     g. Call onUpload(publicUrl)
     h. Handle errors with toast and setError

   - Render:
     a. Preview image if exists (w-full rounded-lg)
     b. Label wrapper with:
        - Camera icon and "Take Photo" or "Replace Photo" text
        - Hidden file input with accept="image/*" capture="environment"
        - min-h-[48px] for touch target
     c. Error message if present
     d. Loading spinner if uploading

   - Import Camera icon from lucide-react
   - Import supabase client, toast from sonner

Note: capture="environment" opens rear camera on mobile. Use "user" for front camera.
  </action>
  <verify>
    - Migration file has valid SQL syntax
    - PhotoUpload component compiles without errors
    - File input has capture attribute for mobile camera
  </verify>
  <done>
    - Storage bucket migration ready for application
    - PhotoUpload component handles camera capture and Supabase upload
    - Preview shows selected image before upload completes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TestWizard and WizardStep components</name>
  <files>src/components/tester/TestWizard.tsx, src/components/tester/WizardStep.tsx, src/components/tester/index.ts</files>
  <action>
1. Create src/components/tester/WizardStep.tsx:
   - Props: step (object with id, title, subtitle), children (ReactNode)
   - Simple wrapper that renders title, subtitle, and children
   - Title: text-lg font-medium text-text-primary
   - Subtitle: text-sm text-text-secondary mt-1
   - Children container: mt-4

2. Create src/components/tester/TestWizard.tsx:
   - Props: control (Control), rowId (string), onComplete: () => void
   - Import useNetworkStatus, useRecordTest, queueTestSubmission
   - Import PhotoUpload, WizardStep
   - Import toast from sonner

   Define WIZARD_STEPS array:
   ```
   [
     { id: 'confirm', title: 'Review Control', subtitle: 'Verify this is the correct control' },
     { id: 'result', title: 'Test Result', subtitle: 'Did the control work as expected?' },
     { id: 'evidence', title: 'Add Evidence', subtitle: 'Optional: Take a photo or add notes' },
     { id: 'review', title: 'Review & Submit', subtitle: 'Check your answers before submitting' }
   ]
   ```

   State:
   - currentStep (number, default 0)
   - result (TestResult, default 'pass')
   - photoUrl (string | null)
   - notes (string, combines evidence/findings)
   - submitting (boolean)

   Computed:
   - progress = ((currentStep + 1) / WIZARD_STEPS.length) * 100
   - canProceed: step 0 always true, step 1 requires result selected, step 2 always true, step 3 always true

   handleSubmit function:
   - Build testData object (map result to default effectiveness: pass=5, partial=3, fail=1)
   - If online: recordTestMutation.mutateAsync(testData)
   - If offline: queueTestSubmission(testData), show toast "Test saved offline"
   - Call onComplete

   Render structure:
   a. Progress bar (h-2 bg-surface-border with accent-500 fill)
   b. Step indicator text: "Step X of Y: {title}"
   c. Step content based on currentStep:
      - Step 0 (confirm): Show control name, description, test procedure (read-only)
      - Step 1 (result): Large touch-friendly buttons for Pass/Fail/Partial
      - Step 2 (evidence): PhotoUpload + textarea for notes
      - Step 3 (review): Summary of selections with edit buttons
   d. Navigation buttons:
      - Back button (if currentStep > 0)
      - Next/Submit button (min-h-[48px], bg-accent-500)

   Mobile-first styling:
   - Full height flex column
   - Navigation at bottom (mt-auto)
   - Large touch targets (min-h-[48px])
   - Clear visual hierarchy

3. Update src/components/tester/index.ts:
   - Add exports for TestWizard, WizardStep, PhotoUpload

Note: Use jargon-free labels:
- "Pass" not "Effective"
- "Fail" not "Ineffective"
- "Partially" not "Partially Effective"
- "Add Evidence" not "Document Test Evidence"
  </action>
  <verify>
    - Components compile without TypeScript errors
    - TestWizard has 4 distinct steps
    - Navigation logic prevents invalid state
  </verify>
  <done>
    - TestWizard breaks test into 4 manageable steps
    - Each step has clear, jargon-free instructions
    - Progress bar shows position in wizard
    - Result buttons are large and touch-friendly
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate TestWizard into TesterControlCard and Dashboard</name>
  <files>src/components/tester/TesterControlCard.tsx, src/pages/TesterDashboardPage.tsx</files>
  <action>
1. Update src/components/tester/TesterControlCard.tsx:
   - Import TestWizard from './TestWizard'
   - Add state: showWizard (boolean, default false)

   - Replace existing "Record Test Result" button behavior:
     - Instead of showing inline ControlTestForm, set showWizard = true

   - When showWizard is true, render TestWizard in a modal/overlay:
     - Full screen on mobile (fixed inset-0 z-50)
     - Background: bg-surface-base
     - Header with control name and close button (X icon)
     - TestWizard component fills remaining space
     - Pass control, primaryRowId, onComplete={() => setShowWizard(false)}

   - Keep existing ControlTestForm for desktop fallback if needed, OR
   - Replace entirely with TestWizard (recommended for consistency)

   - Close wizard triggers showWizard = false

2. Update src/pages/TesterDashboardPage.tsx:
   - Import OfflineIndicator from '@/components/tester'
   - Import usePendingSync hook

   - Call usePendingSync() at component top (enables auto-sync)

   - Add OfflineIndicator to header area:
     - Position next to the "My Controls" title
     - Or fixed position at top-right

   - Ensure the page still reads controls from store (existing behavior)

Note: The wizard should be full-screen overlay on mobile for immersive experience. Use fixed positioning with proper z-index.
  </action>
  <verify>
    - Click "Record Test Result" opens full-screen wizard on mobile
    - Wizard can be closed via X button or completion
    - OfflineIndicator appears in dashboard header
    - usePendingSync activates (check for console logs on reconnect)
  </verify>
  <done>
    - TesterControlCard opens TestWizard instead of inline form
    - Wizard displays as full-screen overlay on mobile
    - TesterDashboardPage shows offline indicator
    - Pending sync runs automatically on page load and reconnect
  </done>
</task>

</tasks>

<verification>
1. Run `npx supabase db push` to apply storage bucket migration (or create bucket manually in Dashboard)
2. Navigate to /tester page on mobile device or emulator
3. Click a control card, then "Record Test Result"
4. Verify wizard opens full-screen with progress bar
5. Complete all 4 steps:
   - Step 1: Review control info, click Next
   - Step 2: Select Pass/Fail/Partial, click Next
   - Step 3: Optionally take photo and add notes, click Next
   - Step 4: Review summary, click Submit
6. Verify test is recorded (check database or store)
7. Test offline: Enable airplane mode, submit test, verify "saved offline" toast
8. Reconnect, verify test syncs automatically
</verification>

<success_criteria>
- TestWizard guides user through 4 simple steps
- Photo upload captures from mobile camera and uploads to Supabase
- Offline submissions queue and sync on reconnect
- Progress bar accurately reflects position
- All touch targets are 48px minimum
- Labels are jargon-free and clear to non-risk staff
</success_criteria>

<output>
After completion, create `.planning/phases/36-mobile-control-tester/36-03-SUMMARY.md`
</output>
