---
phase: 36-mobile-control-tester
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/process-reminders/index.ts
autonomous: true

must_haves:
  truths:
    - "Weekly reminder emails sent to testers with pending tests"
    - "Overdue test alerts sent to testers with past-due tests"
    - "Emails contain control name, due date, and link to tester dashboard"
  artifacts:
    - path: "supabase/functions/process-reminders/index.ts"
      provides: "Active reminder queries and batch processing"
      contains: "supabase.from('controls')"
  key_links:
    - from: "supabase/functions/process-reminders/index.ts"
      to: "controls table"
      via: "database query"
      pattern: "from\\('controls'\\)"
    - from: "supabase/functions/process-reminders/index.ts"
      to: "profiles table"
      via: "join for tester info"
      pattern: "from\\('profiles'\\)"
---

<objective>
Activate the stub queries in process-reminders Edge Function to send actual reminder emails.

Purpose: Control testers need automated reminders about upcoming and overdue tests so they don't miss deadlines.
Output: Working reminder system that sends emails 7 days before due and when overdue.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-mobile-control-tester/36-RESEARCH.md
@supabase/functions/process-reminders/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement test-due-7days and test-overdue queries</name>
  <files>supabase/functions/process-reminders/index.ts</files>
  <action>
Replace the stub comments with actual working queries in process-reminders/index.ts:

1. SCHED-01: Test Due in 7 Days
   After the results tracking setup, add:
   ```typescript
   // SCHED-01: Test due in 7 days
   const sevenDaysFromNow = new Date()
   sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7)
   const sevenDaysStr = sevenDaysFromNow.toISOString().split('T')[0]

   const { data: dueSoonTests, error: dueSoonError } = await supabaseAdmin
     .from('controls')
     .select(`
       id,
       name,
       next_test_date,
       assigned_tester_id,
       profiles!controls_assigned_tester_id_fkey (
         id,
         full_name,
         is_active
       )
     `)
     .eq('next_test_date', sevenDaysStr)
     .not('assigned_tester_id', 'is', null)
     .limit(BATCH_SIZE)

   if (dueSoonError) {
     logStructured('error', 'Failed to fetch due-soon tests', { requestId, error: dueSoonError.message })
   } else if (dueSoonTests) {
     results['test-due-7days'].queried = dueSoonTests.length

     for (const control of dueSoonTests) {
       const profile = control.profiles
       if (!profile || !profile.is_active) continue

       // Get email from auth.users
       const { data: authUser } = await supabaseAdmin.auth.admin.getUserById(profile.id)
       if (!authUser?.user?.email) continue

       if (!resendApiKey) {
         logStructured('info', 'Would send due-soon reminder', { requestId, controlName: control.name, email: authUser.user.email })
         continue
       }

       try {
         const html = testDueReminderTemplate({
           recipientName: profile.full_name,
           controlName: control.name,
           dueDate: control.next_test_date,
           appUrl,
         })

         const emailResponse = await fetch('https://api.resend.com/emails', {
           method: 'POST',
           headers: {
             'Authorization': `Bearer ${resendApiKey}`,
             'Content-Type': 'application/json',
           },
           body: JSON.stringify({
             from: emailFrom,
             to: [authUser.user.email],
             subject: `Control Test Due Soon: ${control.name}`,
             html,
           }),
         })

         if (emailResponse.ok) {
           results['test-due-7days'].sent++
           logStructured('info', 'Sent due-soon reminder', { requestId, controlId: control.id })
         } else {
           const errorText = await emailResponse.text()
           results['test-due-7days'].errors.push(`Failed: ${control.name} - ${errorText}`)
         }
       } catch (err) {
         results['test-due-7days'].errors.push(`Exception: ${control.name} - ${err}`)
       }
     }
   }
   ```

2. SCHED-02: Test Overdue
   Similar pattern but query for next_test_date < today:
   ```typescript
   // SCHED-02: Test overdue
   const today = new Date().toISOString().split('T')[0]

   const { data: overdueTests, error: overdueError } = await supabaseAdmin
     .from('controls')
     .select(`
       id,
       name,
       next_test_date,
       assigned_tester_id,
       profiles!controls_assigned_tester_id_fkey (
         id,
         full_name,
         is_active
       )
     `)
     .lt('next_test_date', today)
     .not('assigned_tester_id', 'is', null)
     .limit(BATCH_SIZE)

   if (overdueError) {
     logStructured('error', 'Failed to fetch overdue tests', { requestId, error: overdueError.message })
   } else if (overdueTests) {
     results['test-overdue'].queried = overdueTests.length

     for (const control of overdueTests) {
       const profile = control.profiles
       if (!profile || !profile.is_active) continue

       const { data: authUser } = await supabaseAdmin.auth.admin.getUserById(profile.id)
       if (!authUser?.user?.email) continue

       // Calculate days overdue
       const dueDate = new Date(control.next_test_date)
       const todayDate = new Date(today)
       const daysOverdue = Math.floor((todayDate.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24))

       if (!resendApiKey) {
         logStructured('info', 'Would send overdue alert', { requestId, controlName: control.name, daysOverdue })
         continue
       }

       try {
         const html = testOverdueTemplate({
           recipientName: profile.full_name,
           controlName: control.name,
           dueDate: control.next_test_date,
           daysOverdue,
           appUrl,
         })

         const emailResponse = await fetch('https://api.resend.com/emails', {
           method: 'POST',
           headers: {
             'Authorization': `Bearer ${resendApiKey}`,
             'Content-Type': 'application/json',
           },
           body: JSON.stringify({
             from: emailFrom,
             to: [authUser.user.email],
             subject: `OVERDUE: Control Test Required - ${control.name}`,
             html,
           }),
         })

         if (emailResponse.ok) {
           results['test-overdue'].sent++
           logStructured('info', 'Sent overdue alert', { requestId, controlId: control.id, daysOverdue })
         } else {
           const errorText = await emailResponse.text()
           results['test-overdue'].errors.push(`Failed: ${control.name} - ${errorText}`)
         }
       } catch (err) {
         results['test-overdue'].errors.push(`Exception: ${control.name} - ${err}`)
       }
     }
   }
   ```

3. Update the summary response to include actual counts (remove stub message)

4. Remove or update the stub comments/notes in the response

Note: Keep SCHED-03 (remediation reminders) as stub for now - it's lower priority and remediation_plans owner_id field may need verification.
  </action>
  <verify>
    - No TypeScript/Deno syntax errors in the function
    - Query uses correct foreign key relationship syntax for profiles join
    - Email templates receive all required parameters
  </verify>
  <done>
    - test-due-7days query fetches controls due in exactly 7 days
    - test-overdue query fetches controls with past due dates
    - Emails sent via Resend API with proper templates
    - Results tracked and logged for monitoring
  </done>
</task>

<task type="auto">
  <name>Task 2: Test reminder function locally</name>
  <files>supabase/functions/process-reminders/index.ts</files>
  <action>
After implementing the queries, verify locally:

1. Ensure the function handles edge cases:
   - No controls with assigned testers (empty results)
   - Profile not found or inactive
   - Auth user email not available
   - Resend API key not configured (graceful fallback with logging)

2. Add defensive checks:
   - Null check on profiles join result (typed as single object or null from foreign key)
   - Safe date parsing with fallback
   - Email validation before sending

3. Update the return summary:
   ```typescript
   const summary = {
     success: true,
     timestamp: triggerTime,
     triggerSource,
     authMethod,
     emailServiceConfigured: !!resendApiKey,
     processed: {
       'test-due-7days': results['test-due-7days'].sent,
       'test-overdue': results['test-overdue'].sent,
       'remediation-due-7days': 0, // Still stubbed
     },
     queried: {
       'test-due-7days': results['test-due-7days'].queried,
       'test-overdue': results['test-overdue'].queried,
       'remediation-due-7days': 0,
     },
     errors: [
       ...results['test-due-7days'].errors,
       ...results['test-overdue'].errors,
     ],
   }
   ```

4. Type the profiles join result correctly:
   - Since it's a foreign key to single profile, result is object not array
   - Type: `profiles: { id: string; full_name: string; is_active: boolean } | null`

Note: Test by invoking function with cron secret header to verify authentication works.
  </action>
  <verify>
    - Function deploys without errors: `npx supabase functions deploy process-reminders`
    - Function can be invoked: `curl -X POST [function-url] -H "x-cron-secret: [secret]"`
    - Response includes queried/processed counts
  </verify>
  <done>
    - Edge Function handles all edge cases gracefully
    - Response includes detailed processing statistics
    - Function ready for production pg_cron scheduling
  </done>
</task>

</tasks>

<verification>
1. Deploy function: `npx supabase functions deploy process-reminders`
2. Create test data in database:
   - Control with next_test_date = today + 7 days
   - Control with next_test_date = yesterday
   - Both assigned to a tester with valid profile and email
3. Invoke function manually:
   ```bash
   curl -X POST https://[project-ref].supabase.co/functions/v1/process-reminders \
     -H "x-cron-secret: $CRON_SECRET" \
     -H "Content-Type: application/json" \
     -d '{"trigger": "manual-test"}'
   ```
4. Check response for queried/processed counts
5. Check Resend dashboard for sent emails (if API key configured)
6. Check function logs in Supabase Dashboard for structured log entries
</verification>

<success_criteria>
- Function queries controls table for due-soon and overdue tests
- Emails sent to assigned testers with correct templates
- Function handles missing data gracefully (no crashes)
- Processing statistics returned in response
- pg_cron can invoke function on schedule
</success_criteria>

<output>
After completion, create `.planning/phases/36-mobile-control-tester/36-04-SUMMARY.md`
</output>
