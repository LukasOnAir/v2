---
phase: 37-rct-search-and-sort
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/rct/RCTTable.tsx
  - src/components/rct/RCTToolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can type in search box and visible rows filter to matching text"
    - "User can click column header to sort A-Z"
    - "User can click same column header again to reverse sort to Z-A"
    - "Visual indicator (arrow icon) shows current sort column and direction"
    - "Search and sort work together (sorted results are filtered, filtered results are sorted)"
  artifacts:
    - path: "src/components/rct/RCTTable.tsx"
      provides: "Sorting state, global filter state, getSortedRowModel integration"
      contains: "getSortedRowModel|globalFilter|SortingState"
    - path: "src/components/rct/RCTToolbar.tsx"
      provides: "Search input component with clear button"
      contains: "Search.*lucide|globalFilter|setGlobalFilter"
  key_links:
    - from: "src/components/rct/RCTToolbar.tsx"
      to: "table.setGlobalFilter"
      via: "input onChange callback"
      pattern: "setGlobalFilter"
    - from: "src/components/rct/RCTTable.tsx"
      to: "getToggleSortingHandler"
      via: "th onClick handler"
      pattern: "getToggleSortingHandler"
---

<objective>
Add search and sort functionality to the Risk Control Table (RCT), enabling users to quickly find specific rows via text search and sort any column alphabetically (A-Z / Z-A).

Purpose: Users with large RCT datasets need efficient navigation to locate specific risks, processes, or custom values without scrolling through hundreds of rows.

Output: RCTTable with sortable column headers (click to toggle direction) and RCTToolbar with search input that filters across all text columns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-rct-search-and-sort/37-RESEARCH.md

@src/components/rct/RCTTable.tsx
@src/components/rct/RCTToolbar.tsx
@src/components/remediation/RemediationTable.tsx (reference for sort pattern)
@src/components/tickets/TicketFilters.tsx (reference for search input styling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add column sorting to RCTTable</name>
  <files>src/components/rct/RCTTable.tsx</files>
  <action>
Add TanStack Table sorting to RCTTable following the established pattern from RemediationTable.tsx:

1. **Import additions** (line ~5):
   - Add `getSortedRowModel` to the existing @tanstack/react-table import
   - Add `SortingState` type to the import
   - Add `ArrowUpDown, ArrowUp, ArrowDown` to the lucide-react import (currently has Settings2, MessageSquare, X, Loader2)

2. **Add sorting state** (near line ~505 after columnFilters state):
   ```typescript
   const [sorting, setSorting] = useState<SortingState>([])
   ```

3. **Update table instance** (line ~859 in useReactTable call):
   - Add `sorting` to state object
   - Add `onSortingChange: setSorting` callback
   - Add `getSortedRowModel: getSortedRowModel()` to model getters (after getFilteredRowModel)

4. **Add clickable sort headers with indicators** (line ~959 in th element):
   - Add `cursor-pointer hover:bg-surface-overlay/50` to th className
   - Add `onClick={header.column.getToggleSortingHandler()}` to th element
   - Add sort indicator icons inside the header div (before ColumnFilter):
   ```tsx
   {header.column.getCanSort() && (
     header.column.getIsSorted() === 'asc' ? (
       <ArrowUp size={14} className="text-accent-500 flex-shrink-0" />
     ) : header.column.getIsSorted() === 'desc' ? (
       <ArrowDown size={14} className="text-accent-500 flex-shrink-0" />
     ) : (
       <ArrowUpDown size={14} className="opacity-40 group-hover:opacity-70 flex-shrink-0" />
     )
   )}
   ```

Note: Do NOT disable sorting on any columns. All columns should be sortable by default (TanStack enables sorting by default). The Controls column (id: 'controls') will be sortable but sorting on count column is acceptable UX.
  </action>
  <verify>
1. Run `npm run lint` - no errors
2. Run `npm run build` - compiles successfully
3. Inspect RCTTable.tsx: sorting state exists, getSortedRowModel configured, header has onClick and sort icons
  </verify>
  <done>
- Column headers show ArrowUpDown icon (neutral state) by default
- Clicking column header toggles to ArrowUp (A-Z) then ArrowDown (Z-A) then back to neutral
- Active sort column shows accent-500 colored arrow
- Rows reorder based on selected sort column and direction
  </done>
</task>

<task type="auto">
  <name>Task 2: Add global search to RCTToolbar</name>
  <files>src/components/rct/RCTTable.tsx, src/components/rct/RCTToolbar.tsx</files>
  <action>
Add global text search that filters across all text columns (risk names, process names, custom text values).

**Part A: Update RCTTable.tsx to support global filtering**

1. **Add global filter state** (near sorting state, line ~506):
   ```typescript
   const [globalFilter, setGlobalFilter] = useState('')
   ```

2. **Update table instance** (in useReactTable options):
   - Add `globalFilter` to state object
   - Add `onGlobalFilterChange: setGlobalFilter` callback
   - Add `globalFilterFn: 'includesString'` for case-insensitive substring matching

3. **Pass filter props to RCTToolbar** (line ~937):
   Update the RCTToolbar component call to include:
   ```tsx
   <RCTToolbar
     table={table}
     rowCount={rows.length}
     filteredCount={tableRows.length}
     onRegenerate={handleGenerateRows}
     globalFilter={globalFilter}
     setGlobalFilter={setGlobalFilter}
   />
   ```

**Part B: Update RCTToolbar.tsx with search input**

1. **Import additions** (line ~1):
   - Add `Search, X` to lucide-react import (currently has Plus, RefreshCw, Settings2, Download)

2. **Update props interface** (line ~14):
   ```typescript
   interface RCTToolbarProps {
     table: Table<RCTRow>
     rowCount: number
     filteredCount: number
     onRegenerate: () => void
     globalFilter: string
     setGlobalFilter: (value: string) => void
   }
   ```

3. **Update function signature** (line ~21):
   Add `globalFilter, setGlobalFilter` to destructured props

4. **Add search input** (after row count span, before Regenerate button, ~line 58):
   ```tsx
   <div className="relative flex-1 min-w-[200px] max-w-sm">
     <Search
       size={18}
       className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted"
     />
     <input
       type="text"
       value={globalFilter}
       onChange={(e) => setGlobalFilter(e.target.value)}
       placeholder="Search risks and processes..."
       className="w-full pl-10 pr-8 py-2 bg-surface-base border border-surface-border rounded-lg text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-accent-500"
     />
     {globalFilter && (
       <button
         onClick={() => setGlobalFilter('')}
         className="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-text-muted hover:text-text-primary transition-colors"
         aria-label="Clear search"
       >
         <X size={16} />
       </button>
     )}
   </div>
   ```

The 'includesString' built-in filter function searches ALL columns by default, which includes risk names, process names, and custom text values - exactly what success criteria #2 requires.
  </action>
  <verify>
1. Run `npm run lint` - no errors
2. Run `npm run build` - compiles successfully
3. Run `npm run dev` and test:
   - Search input appears in toolbar
   - Typing filters rows in real-time
   - Clear button appears when text entered
   - Filtered count updates correctly
4. Test combined search + sort: filter rows, then sort - sorted order applies to filtered set
  </verify>
  <done>
- Search input with Search icon and placeholder text visible in toolbar
- Typing in search box filters visible rows immediately
- Search matches text across risk names, process names, and custom text columns
- Clear (X) button appears when search has text, clicking clears search
- Row count shows "N of M rows" when search active
- Sorting works correctly on filtered results (success criteria #6)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Sorting verification:**
   - Click "Risk L1 Name" header - rows sort A-Z, ArrowUp shows
   - Click again - rows sort Z-A, ArrowDown shows
   - Click again - sort clears, ArrowUpDown shows (neutral)
   - Click "Gross Score" - numeric sort works correctly

2. **Search verification:**
   - Type "cyber" in search - only rows with "cyber" in any text column show
   - Clear search - all rows return
   - Search for text in custom column - matches correctly

3. **Combined verification:**
   - Search for "compliance" - filtered rows show
   - Click "Process L1 Name" to sort - filtered rows sort within filtered set
   - Clear search - all rows show, sort still active on column

4. **No regressions:**
   - Existing column filters (multi-select dropdowns) still work
   - Column visibility toggle still works
   - Column resizing still works
   - Virtualization still performs smoothly with search/sort
</verification>

<success_criteria>
1. User can search RCT by typing in search box (filters visible rows) - DONE when search input works
2. Search matches across all text columns - DONE when includesString filter configured
3. User can click any column header to sort A-Z - DONE when getToggleSortingHandler wired
4. Clicking same header reverses sort to Z-A - DONE when sorting toggle cycles correctly
5. Visual indicator shows current sort column and direction - DONE when ArrowUp/ArrowDown icons show
6. Search and sort can be combined - DONE when both features work independently and together
</success_criteria>

<output>
After completion, create `.planning/phases/37-rct-search-and-sort/37-01-SUMMARY.md`
</output>
