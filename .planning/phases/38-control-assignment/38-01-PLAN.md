---
phase: 38-control-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/rct/ControlPanel.tsx
  - src/components/controls/ControlsTable.tsx
  - src/pages/ControlsPage.tsx
autonomous: true

must_haves:
  truths:
    - "RCT ControlPanel side panel has 'Assigned Tester' dropdown"
    - "Controls Hub table shows 'Assigned To' column with assignee name"
    - "Assignment dropdown uses useControlTesters() hook in RCT panel"
    - "Assigned To column displays '-' when no assignee"
  artifacts:
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Assignment dropdown for linked controls"
      contains: "Assigned Tester"
    - path: "src/components/controls/ControlsTable.tsx"
      provides: "Assigned To column showing assignee name"
      contains: "assignedTesterName"
    - path: "src/pages/ControlsPage.tsx"
      provides: "Profile data passed to ControlsTable"
      contains: "useProfiles"
  key_links:
    - from: "src/components/rct/ControlPanel.tsx"
      to: "useControlTesters()"
      via: "hook import"
      pattern: "useControlTesters"
    - from: "src/components/controls/ControlsTable.tsx"
      to: "profiles prop"
      via: "name lookup"
      pattern: "profiles.*find"
---

<objective>
Add the "Assign to" dropdown to RCT ControlPanel (matching Controls Hub) and add "Assigned To" column to Controls Hub table.

Purpose: Create unified assignment experience across both control views so assignment can happen from either location.
Output: Both panels have assignment capability, Controls Hub table shows current assignee.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-control-assignment/38-RESEARCH.md

# Reference files
@src/components/controls/ControlDetailPanel.tsx (lines 777-822 - assignment dropdown implementation)
@src/components/rct/ControlPanel.tsx
@src/components/controls/ControlsTable.tsx
@src/pages/ControlsPage.tsx
@src/hooks/useProfiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Assignment Dropdown to RCT ControlPanel</name>
  <files>src/components/rct/ControlPanel.tsx</files>
  <action>
Add the Assigned Tester dropdown to linked controls in ControlPanel.tsx. The dropdown should appear for each linked control (similar to Control Type field).

1. Import useControlTesters from @/hooks/useProfiles
2. Import useSendNotification from @/hooks/useSendNotification (for assignment notification)
3. Add useControlTesters() hook call after other hooks
4. Add useSendNotification() hook call

For each linked control (in the linkedControls.map section around line 787), add after the Control Type section:

```tsx
{/* Tester Assignment */}
{canEditControlDefinitions && (
  <div className="mb-3">
    <label className="text-xs text-text-muted block mb-1.5">Assigned Tester</label>
    <select
      value={linkedControl.assignedTesterId ?? ''}
      onChange={(e) => {
        const newTesterId = e.target.value || null
        const previousTesterId = linkedControl.assignedTesterId

        // Update control
        handleLinkedControlUpdate(linkedControl.id, 'assignedTesterId', newTesterId)

        // Send notification if assigning to new tester
        if (newTesterId && newTesterId !== previousTesterId) {
          sendNotification({
            type: 'test-assigned',
            recipientId: newTesterId,
            data: {
              controlName: linkedControl.name,
              dueDate: linkedControl.nextTestDate || undefined,
            },
          })
        }
      }}
      className="w-full px-2 py-1.5 bg-surface-elevated border border-surface-border rounded text-sm text-text-primary focus:outline-none focus:ring-1 focus:ring-accent-500"
    >
      <option value="">Unassigned</option>
      {isDemoMode ? (
        <>
          <option value="tester-1">Tester 1</option>
          <option value="tester-2">Tester 2</option>
          <option value="tester-3">Tester 3</option>
        </>
      ) : (
        controlTesters.map(tester => (
          <option key={tester.id} value={tester.id}>
            {tester.full_name || tester.id}
          </option>
        ))
      )}
    </select>
  </div>
)}
```

Add similar dropdown for embedded controls (row.controls.map section around line 573).

Use the pattern from ControlDetailPanel (lines 777-822) as reference.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>RCT ControlPanel shows "Assigned Tester" dropdown for all controls when user has edit permissions</done>
</task>

<task type="auto">
  <name>Task 2: Add Assigned To Column to ControlsTable</name>
  <files>src/components/controls/ControlsTable.tsx, src/pages/ControlsPage.tsx</files>
  <action>
Add "Assigned To" column to ControlsTable that shows assignee name.

1. Update ControlsTable.tsx:
   - Add profiles prop to interface: `profiles: Profile[]`
   - Import Profile type from @/lib/supabase/types
   - Extend EnrichedControl to include assignedTesterName:
     ```tsx
     interface EnrichedControl extends Control {
       linkCount: number
       assignedTesterName: string | null
     }
     ```
   - In data useMemo, enrich with profile name:
     ```tsx
     const data = useMemo<EnrichedControl[]>(() => {
       return controls.map(control => {
         const links = controlLinks.filter(l => l.controlId === control.id)
         const tester = control.assignedTesterId
           ? profiles.find(p => p.id === control.assignedTesterId)
           : null
         return {
           ...control,
           linkCount: links.length,
           assignedTesterName: tester?.full_name || null,
         }
       })
     }, [controls, controlLinks, profiles])
     ```
   - Add column after Type column:
     ```tsx
     {
       accessorKey: 'assignedTesterName',
       header: 'Assigned To',
       cell: ({ getValue }) => (
         <span className="text-text-secondary">
           {getValue<string | null>() || '-'}
         </span>
       ),
     },
     ```

2. Update ControlsPage.tsx:
   - Import useProfiles from @/hooks/useProfiles
   - Add useProfiles() hook call to fetch all profiles
   - Pass profiles to ControlsTable:
     ```tsx
     <ControlsTable
       controls={filteredControls}
       controlLinks={controlLinks}
       profiles={isDemoMode ? [] : (profiles || [])}
       onControlClick={setSelectedControlId}
       isDemoMode={isDemoMode}
     />
     ```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Controls Hub table shows "Assigned To" column with tester name or "-" for unassigned</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify TypeScript compiles
2. Visual check: RCT ControlPanel shows assignment dropdown
3. Visual check: Controls Hub table has Assigned To column
</verification>

<success_criteria>
- RCT ControlPanel has Assigned Tester dropdown for each control
- Controls Hub table shows Assigned To column
- Assignment dropdown shows tester options (demo users in demo mode, real profiles when authenticated)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/38-control-assignment/38-01-SUMMARY.md`
</output>
