---
phase: 38-control-assignment
plan: 03
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - src/hooks/useControls.ts
  - src/pages/ControlsPage.tsx
autonomous: true

must_haves:
  truths:
    - "Control Testers see only controls assigned to them"
    - "Control Owners see only controls assigned to them"
    - "Risk Managers and above see all controls"
    - "Demo mode shows all controls (no filtering)"
  artifacts:
    - path: "src/hooks/useControls.ts"
      provides: "useMyAssignedControls hook for role-based filtering"
      contains: "useMyAssignedControls"
    - path: "src/pages/ControlsPage.tsx"
      provides: "Role-conditional control filtering"
      contains: "isControlTester"
  key_links:
    - from: "src/pages/ControlsPage.tsx"
      to: "useMyAssignedControls"
      via: "conditional hook usage"
      pattern: "useMyAssignedControls"
    - from: "src/hooks/useControls.ts"
      to: "assigned_tester_id"
      via: "Supabase query filter"
      pattern: "eq.*assigned_tester_id"
---

<objective>
Implement role-based filtering so Control Testers and Control Owners see only controls assigned to them.

Purpose: ROLE-04 and ROLE-05 requirements - restrict visibility based on assignment. Same mechanism for both roles (assigned_tester_id).
Output: Control Tester/Owner users see filtered Controls Hub, other roles see all controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-control-assignment/38-RESEARCH.md
@.planning/phases/38-control-assignment/38-01-SUMMARY.md

# Reference files
@src/hooks/useControls.ts
@src/pages/ControlsPage.tsx
@src/hooks/usePermissions.ts
@src/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add useMyAssignedControls Hook</name>
  <files>src/hooks/useControls.ts</files>
  <action>
Add a new hook that fetches only controls assigned to the current user.

Add after the existing useControls() hook:

```tsx
/**
 * Fetch controls assigned to the current user
 * Used by Control Tester and Control Owner roles
 */
export function useMyAssignedControls() {
  const { user } = useAuth()

  return useQuery({
    queryKey: ['controls', 'assigned', user?.id],
    queryFn: async () => {
      if (!user?.id) return []

      const { data, error } = await supabase
        .from('controls')
        .select('*')
        .eq('assigned_tester_id', user.id)
        .order('name')

      if (error) throw error
      return data.map(toControl)
    },
    enabled: !!user?.id,
  })
}
```

Import useAuth from @/contexts/AuthContext at the top of the file.

This hook:
- Uses the current user's ID from auth context
- Filters controls where assigned_tester_id matches user ID
- Returns empty array if no user is authenticated
- Only runs when user ID is available (enabled: !!user?.id)
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>useMyAssignedControls hook exists and filters by assigned_tester_id</done>
</task>

<task type="auto">
  <name>Task 2: Apply Role-Based Filtering in ControlsPage</name>
  <files>src/pages/ControlsPage.tsx</files>
  <action>
Update ControlsPage to use conditional data source based on user role.

1. Import the new hook and permissions:
```tsx
import { useControls, useAddControl, useMyAssignedControls } from '@/hooks/useControls'
```

2. Get role permissions from usePermissions (already imported):
```tsx
const { canEditControlDefinitions, isControlTester, isControlOwner } = usePermissions()
```

3. Add the assigned controls hook:
```tsx
// Fetch assigned controls for Tester/Owner roles
const { data: myAssignedControls, isLoading: isLoadingMyControls } = useMyAssignedControls()
```

4. Determine which controls to show based on role:
```tsx
// Role-based control selection
// Control Tester and Control Owner see only assigned controls
// Other roles see all controls
const shouldFilterByAssignment = !isDemoMode && (isControlTester || isControlOwner)

// Use appropriate data source
const allControls = isDemoMode ? storeControls : (dbControls || [])
const assignedControls = isDemoMode ? storeControls : (myAssignedControls || [])
const controls = shouldFilterByAssignment ? assignedControls : allControls
```

5. Update loading state check:
```tsx
// Loading state (only when authenticated)
if (!isDemoMode && (isLoading || (shouldFilterByAssignment && isLoadingMyControls))) {
  return (
    <div className="h-full flex items-center justify-center">
      <Loader2 className="w-8 h-8 text-accent-500 animate-spin" />
    </div>
  )
}
```

6. Update the header to show context-aware count:
```tsx
<p className="text-sm text-text-secondary">
  {shouldFilterByAssignment
    ? `${controls.length} assigned control${controls.length === 1 ? '' : 's'}`
    : `${controls.length} control${controls.length === 1 ? '' : 's'} total`}
</p>
```

This ensures:
- Demo mode always shows all controls (no filtering)
- Control Tester sees only controls assigned to them
- Control Owner sees only controls assigned to them
- Risk Manager, Manager, Director see all controls
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>ControlsPage conditionally filters controls based on user role</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify TypeScript compiles
2. Verify hook pattern: useMyAssignedControls filters by assigned_tester_id = auth.uid()
3. Verify page logic: shouldFilterByAssignment is true only for Tester/Owner roles when authenticated
</verification>

<success_criteria>
- useMyAssignedControls hook exists in useControls.ts
- Hook queries controls.assigned_tester_id = user.id
- ControlsPage uses role-based data source selection
- Demo mode bypasses filtering (shows all)
- Control Tester/Owner roles see filtered view
- Other roles see full list
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/38-control-assignment/38-03-SUMMARY.md`
</output>
