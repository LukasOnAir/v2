---
phase: 40-admin-feature-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00030_feature_flags.sql
  - src/lib/supabase/types.ts
autonomous: true

must_haves:
  truths:
    - "Feature flags table exists with global visibility toggles"
    - "Profiles table can store per-user feature overrides"
    - "RLS policies ensure tenant isolation for feature flags"
  artifacts:
    - path: "supabase/migrations/00030_feature_flags.sql"
      provides: "Feature flags table and profiles column migration"
      contains: "CREATE TABLE public.feature_flags"
    - path: "src/lib/supabase/types.ts"
      provides: "TypeScript types for feature flags"
      contains: "feature_flags"
  key_links:
    - from: "feature_flags table"
      to: "tenants table"
      via: "tenant_id foreign key"
      pattern: "REFERENCES public.tenants"
---

<objective>
Create database schema for feature flags with global tenant-level toggles and per-user overrides.

Purpose: Enable developers to control feature visibility from the database, supporting both global (all users in tenant) and per-user toggle granularity.

Output: Migration file with feature_flags table, profiles.feature_overrides column, RLS policies, and updated TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/00003_profiles.sql
@supabase/migrations/00001_tenants.sql
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature flags migration</name>
  <files>supabase/migrations/00030_feature_flags.sql</files>
  <action>
Create migration file with:

1. Feature flags table for global tenant settings:
```sql
CREATE TABLE public.feature_flags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  feature_key TEXT NOT NULL,  -- e.g., 'show_rfi', 'show_matrix'
  enabled BOOLEAN DEFAULT TRUE,
  description TEXT,  -- Optional description for admin UI
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(tenant_id, feature_key)  -- One entry per feature per tenant
);
```

2. Add feature_overrides JSONB column to profiles:
```sql
ALTER TABLE public.profiles
ADD COLUMN feature_overrides JSONB DEFAULT '{}';
-- Structure: { "show_rfi": false, "show_matrix": true }
-- Overrides global setting for this specific user
```

3. Create indexes for performance:
- idx_feature_flags_tenant_id ON feature_flags(tenant_id)
- idx_feature_flags_lookup ON feature_flags(tenant_id, feature_key)

4. Enable RLS on feature_flags with policies:
- "feature_flags_tenant_read": SELECT for authenticated where tenant_id = public.tenant_id()
- "feature_flags_director_write": INSERT/UPDATE/DELETE for authenticated where tenant_id = public.tenant_id() AND public.user_role() = 'director'

5. Grant SELECT to authenticated, INSERT/UPDATE/DELETE to authenticated (policy controls actual access)

6. Add comment: 'Feature visibility flags controllable by Directors'

7. Seed default RFI feature flag for demo tenant (5ea03edb-6e79-4b62-bd36-39f1963d0640):
```sql
INSERT INTO public.feature_flags (tenant_id, feature_key, enabled, description)
VALUES ('5ea03edb-6e79-4b62-bd36-39f1963d0640', 'show_rfi', true, 'Show RFI document button in header')
ON CONFLICT (tenant_id, feature_key) DO NOTHING;
```
  </action>
  <verify>
Review migration SQL for:
- Table created with correct columns and constraints
- Profiles column added with JSONB default
- RLS enabled with correct policies
- Indexes created
- Demo tenant seeded
  </verify>
  <done>
Migration file exists at supabase/migrations/00030_feature_flags.sql with feature_flags table, profiles.feature_overrides column, RLS policies, indexes, and demo seed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>src/lib/supabase/types.ts</files>
  <action>
Add to the Database types in src/lib/supabase/types.ts:

1. Add FeatureOverrides interface near other interfaces:
```typescript
/**
 * Per-user feature visibility overrides
 * Keys are feature_key strings, values are boolean (true=show, false=hide)
 * If not set, falls back to global feature_flags setting
 */
export interface FeatureOverrides {
  [key: string]: boolean
}
```

2. Add feature_flags table definition in Database.public.Tables (alphabetically positioned):
```typescript
feature_flags: {
  Row: {
    id: string
    tenant_id: string
    feature_key: string
    enabled: boolean
    description: string | null
    created_at: string
    updated_at: string
  }
  Insert: {
    id?: string
    tenant_id?: string
    feature_key: string
    enabled?: boolean
    description?: string | null
    created_at?: string
    updated_at?: string
  }
  Update: {
    id?: string
    tenant_id?: string
    feature_key?: string
    enabled?: boolean
    description?: string | null
    created_at?: string
    updated_at?: string
  }
  Relationships: [
    {
      foreignKeyName: 'feature_flags_tenant_id_fkey'
      columns: ['tenant_id']
      referencedRelation: 'tenants'
      referencedColumns: ['id']
    }
  ]
}
```

3. Update profiles table Row type to include feature_overrides:
```typescript
feature_overrides: FeatureOverrides | null
```

4. Update profiles Insert and Update types similarly.

5. Add type aliases at the bottom with other aliases:
```typescript
export type FeatureFlagRow = Tables<'feature_flags'>
export type FeatureFlagInsert = Insertable<'feature_flags'>
export type FeatureFlagUpdate = Updatable<'feature_flags'>
```

6. Update the migration list comment at the top to include 00030_feature_flags.sql
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
TypeScript types include FeatureOverrides interface, feature_flags table types, updated profiles types with feature_overrides, and type aliases.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at correct path
- [ ] Migration has feature_flags table with all columns
- [ ] Migration has profiles.feature_overrides column
- [ ] RLS policies restrict access correctly (read: all tenant users, write: director only)
- [ ] TypeScript types compile without errors
- [ ] Demo tenant has show_rfi feature flag seeded
</verification>

<success_criteria>
- Feature flags table schema created with tenant isolation
- Per-user override column added to profiles
- TypeScript types updated and compile
- Migration ready to apply with `npx supabase db push`
</success_criteria>

<output>
After completion, create `.planning/phases/40-admin-feature-visibility/40-01-SUMMARY.md`
</output>
