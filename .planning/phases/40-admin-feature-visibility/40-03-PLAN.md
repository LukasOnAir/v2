---
phase: 40-admin-feature-visibility
plan: 03
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - src/hooks/useFeatureFlagAdmin.ts
  - src/pages/FeatureFlagsPage.tsx
  - src/components/layout/Sidebar.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Directors can view list of feature flags for their tenant"
    - "Directors can toggle global feature visibility on/off"
    - "Directors can set per-user overrides"
    - "Non-Directors cannot access the Feature Flags page"
  artifacts:
    - path: "src/hooks/useFeatureFlagAdmin.ts"
      provides: "Admin hooks for CRUD operations on feature flags"
      exports: ["useFeatureFlagAdmin"]
    - path: "src/pages/FeatureFlagsPage.tsx"
      provides: "Admin page for managing feature flags"
      contains: "FeatureFlagsPage"
    - path: "src/components/layout/Sidebar.tsx"
      provides: "Navigation link to Feature Flags page"
      contains: "feature-flags"
    - path: "src/App.tsx"
      provides: "Route for /feature-flags"
      contains: "FeatureFlagsPage"
  key_links:
    - from: "src/pages/FeatureFlagsPage.tsx"
      to: "src/hooks/useFeatureFlagAdmin.ts"
      via: "hook import"
      pattern: "useFeatureFlagAdmin"
    - from: "src/components/layout/Sidebar.tsx"
      to: "/feature-flags"
      via: "NavLink"
      pattern: "to=\"/feature-flags\""
---

<objective>
Create the admin UI for Directors to manage feature flags - both global toggles and per-user overrides.

Purpose: Give developers/Directors control over which features are visible to end users, allowing phased rollouts or feature hiding.

Output: Feature Flags admin page with toggle controls, user override management, and navigation integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-admin-feature-visibility/40-01-SUMMARY.md
@src/pages/UserManagementPage.tsx
@src/components/layout/Sidebar.tsx
@src/App.tsx
@src/hooks/useUserManagement.ts
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFeatureFlagAdmin hook</name>
  <files>src/hooks/useFeatureFlagAdmin.ts</files>
  <action>
Create src/hooks/useFeatureFlagAdmin.ts for admin operations (pattern from useUserManagement):

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase/client'
import type { FeatureFlagRow, Profile, FeatureOverrides } from '@/lib/supabase/types'

interface FeatureFlagWithOverrides extends FeatureFlagRow {
  userOverrides: Array<{
    userId: string
    userName: string | null
    enabled: boolean
  }>
}

/**
 * Admin hook for managing feature flags (Director-only)
 */
export function useFeatureFlagAdmin() {
  const queryClient = useQueryClient()

  // Fetch all feature flags with user overrides
  const {
    data: featureFlags = [],
    isLoading,
    error,
  } = useQuery({
    queryKey: ['feature-flags-admin'],
    queryFn: async () => {
      // Fetch all flags
      const { data: flags, error: flagsError } = await supabase
        .from('feature_flags')
        .select('*')
        .order('feature_key')

      if (flagsError) throw flagsError

      // Fetch all profiles to get user overrides
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('id, full_name, feature_overrides')

      if (profilesError) throw profilesError

      // Combine flags with user overrides
      return (flags || []).map((flag): FeatureFlagWithOverrides => {
        const userOverrides = (profiles || [])
          .filter(p => p.feature_overrides && flag.feature_key in (p.feature_overrides as FeatureOverrides))
          .map(p => ({
            userId: p.id,
            userName: p.full_name,
            enabled: (p.feature_overrides as FeatureOverrides)[flag.feature_key],
          }))

        return { ...flag, userOverrides }
      })
    },
  })

  // Fetch profiles for user override dropdown
  const { data: profiles = [] } = useQuery({
    queryKey: ['profiles-for-flags'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('profiles')
        .select('id, full_name, role, feature_overrides')
        .order('full_name')

      if (error) throw error
      return data as Profile[]
    },
  })

  // Toggle global flag
  const toggleGlobalFlag = useMutation({
    mutationFn: async ({ flagId, enabled }: { flagId: string; enabled: boolean }) => {
      const { error } = await supabase
        .from('feature_flags')
        .update({ enabled, updated_at: new Date().toISOString() })
        .eq('id', flagId)

      if (error) throw error
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['feature-flags-admin'] })
      queryClient.invalidateQueries({ queryKey: ['feature-flags'] })
    },
  })

  // Set user override
  const setUserOverride = useMutation({
    mutationFn: async ({
      userId,
      featureKey,
      enabled,
    }: {
      userId: string
      featureKey: string
      enabled: boolean | null // null removes override
    }) => {
      // Fetch current overrides
      const { data: profile, error: fetchError } = await supabase
        .from('profiles')
        .select('feature_overrides')
        .eq('id', userId)
        .single()

      if (fetchError) throw fetchError

      const currentOverrides = (profile?.feature_overrides as FeatureOverrides) || {}
      let newOverrides: FeatureOverrides

      if (enabled === null) {
        // Remove override
        const { [featureKey]: _, ...rest } = currentOverrides
        newOverrides = rest
      } else {
        // Set/update override
        newOverrides = { ...currentOverrides, [featureKey]: enabled }
      }

      const { error: updateError } = await supabase
        .from('profiles')
        .update({ feature_overrides: newOverrides })
        .eq('id', userId)

      if (updateError) throw updateError
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['feature-flags-admin'] })
      queryClient.invalidateQueries({ queryKey: ['feature-overrides'] })
    },
  })

  // Create new feature flag
  const createFlag = useMutation({
    mutationFn: async ({
      featureKey,
      enabled,
      description,
    }: {
      featureKey: string
      enabled: boolean
      description?: string
    }) => {
      const { error } = await supabase
        .from('feature_flags')
        .insert({ feature_key: featureKey, enabled, description })

      if (error) throw error
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['feature-flags-admin'] })
    },
  })

  return {
    featureFlags,
    profiles,
    isLoading,
    error: error?.message ?? null,
    toggleGlobalFlag: toggleGlobalFlag.mutateAsync,
    setUserOverride: setUserOverride.mutateAsync,
    createFlag: createFlag.mutateAsync,
    isToggling: toggleGlobalFlag.isPending,
    isSettingOverride: setUserOverride.isPending,
  }
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useFeatureFlagAdmin hook exists with featureFlags query, toggleGlobalFlag mutation, setUserOverride mutation, and createFlag mutation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FeatureFlagsPage</name>
  <files>src/pages/FeatureFlagsPage.tsx</files>
  <action>
Create src/pages/FeatureFlagsPage.tsx following UserManagementPage pattern:

```typescript
import { useState } from 'react'
import { Navigate } from 'react-router'
import { Settings2, Users, ToggleLeft, ToggleRight, Plus, X } from 'lucide-react'
import { usePermissions } from '@/hooks/usePermissions'
import { useFeatureFlagAdmin } from '@/hooks/useFeatureFlagAdmin'

/**
 * Feature Flags admin page (Director-only)
 * Allows toggling feature visibility globally and per-user
 */
export function FeatureFlagsPage() {
  const { isDirector, isDemoMode } = usePermissions()
  const {
    featureFlags,
    profiles,
    isLoading,
    error,
    toggleGlobalFlag,
    setUserOverride,
    isToggling,
    isSettingOverride,
  } = useFeatureFlagAdmin()

  const [selectedFlag, setSelectedFlag] = useState<string | null>(null)
  const [showAddOverride, setShowAddOverride] = useState(false)
  const [selectedUserId, setSelectedUserId] = useState('')
  const [overrideValue, setOverrideValue] = useState<'true' | 'false'>('true')

  // Redirect non-Directors (same pattern as UserManagementPage)
  if (!isDirector) {
    return <Navigate to="/" replace />
  }

  // Demo mode message
  if (isDemoMode) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-semibold text-text-primary flex items-center gap-3">
            <Settings2 className="h-7 w-7" />
            Feature Flags
          </h1>
          <p className="text-text-muted mt-1">
            Control feature visibility for your organization
          </p>
        </div>
        <div className="bg-surface-elevated rounded-lg border border-surface-border p-8 text-center">
          <p className="text-text-muted">
            Feature flag management is available in authenticated mode only.
          </p>
        </div>
      </div>
    )
  }

  const handleToggleGlobal = async (flagId: string, currentEnabled: boolean) => {
    try {
      await toggleGlobalFlag({ flagId, enabled: !currentEnabled })
    } catch (err) {
      console.error('Failed to toggle flag:', err)
    }
  }

  const handleAddOverride = async () => {
    if (!selectedFlag || !selectedUserId) return

    try {
      await setUserOverride({
        userId: selectedUserId,
        featureKey: selectedFlag,
        enabled: overrideValue === 'true',
      })
      setShowAddOverride(false)
      setSelectedUserId('')
    } catch (err) {
      console.error('Failed to add override:', err)
    }
  }

  const handleRemoveOverride = async (userId: string, featureKey: string) => {
    try {
      await setUserOverride({ userId, featureKey, enabled: null })
    } catch (err) {
      console.error('Failed to remove override:', err)
    }
  }

  const selectedFlagData = featureFlags.find(f => f.id === selectedFlag)

  return (
    <div className="space-y-6">
      {/* Page header */}
      <div>
        <h1 className="text-2xl font-semibold text-text-primary flex items-center gap-3">
          <Settings2 className="h-7 w-7" />
          Feature Flags
        </h1>
        <p className="text-text-muted mt-1">
          Control feature visibility for your organization
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Global Flags Section */}
        <section className="bg-surface-elevated rounded-lg border border-surface-border p-6">
          <h2 className="text-lg font-medium text-text-primary mb-4">Global Settings</h2>
          <p className="text-sm text-text-muted mb-4">
            Toggle features on/off for all users in your organization.
          </p>

          {isLoading ? (
            <div className="flex items-center justify-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-500" />
            </div>
          ) : error ? (
            <div className="text-center py-8 text-red-400">Error: {error}</div>
          ) : featureFlags.length === 0 ? (
            <div className="text-center py-8 text-text-muted">
              No feature flags configured.
            </div>
          ) : (
            <div className="space-y-3">
              {featureFlags.map((flag) => (
                <div
                  key={flag.id}
                  className={`flex items-center justify-between p-3 rounded-lg border transition-colors cursor-pointer ${
                    selectedFlag === flag.id
                      ? 'border-accent-500 bg-accent-500/10'
                      : 'border-surface-border hover:bg-surface-overlay'
                  }`}
                  onClick={() => setSelectedFlag(flag.id)}
                >
                  <div className="flex-1">
                    <div className="font-medium text-text-primary">
                      {flag.feature_key}
                    </div>
                    {flag.description && (
                      <div className="text-sm text-text-muted">{flag.description}</div>
                    )}
                    {flag.userOverrides.length > 0 && (
                      <div className="text-xs text-amber-500 mt-1">
                        {flag.userOverrides.length} user override(s)
                      </div>
                    )}
                  </div>
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      handleToggleGlobal(flag.id, flag.enabled)
                    }}
                    disabled={isToggling}
                    className="p-1 hover:bg-surface-overlay rounded transition-colors"
                    title={flag.enabled ? 'Disable globally' : 'Enable globally'}
                  >
                    {flag.enabled ? (
                      <ToggleRight className="w-8 h-8 text-green-500" />
                    ) : (
                      <ToggleLeft className="w-8 h-8 text-text-muted" />
                    )}
                  </button>
                </div>
              ))}
            </div>
          )}
        </section>

        {/* Per-User Overrides Section */}
        <section className="bg-surface-elevated rounded-lg border border-surface-border p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h2 className="text-lg font-medium text-text-primary flex items-center gap-2">
                <Users className="h-5 w-5" />
                User Overrides
              </h2>
              <p className="text-sm text-text-muted mt-1">
                {selectedFlagData
                  ? `Overrides for "${selectedFlagData.feature_key}"`
                  : 'Select a flag to manage user overrides'}
              </p>
            </div>
            {selectedFlagData && (
              <button
                onClick={() => setShowAddOverride(true)}
                className="flex items-center gap-1 px-3 py-1.5 text-sm bg-accent-500 text-white rounded-md hover:bg-accent-600 transition-colors"
              >
                <Plus className="w-4 h-4" />
                Add Override
              </button>
            )}
          </div>

          {!selectedFlagData ? (
            <div className="text-center py-8 text-text-muted">
              Select a feature flag from the left to manage user overrides.
            </div>
          ) : selectedFlagData.userOverrides.length === 0 ? (
            <div className="text-center py-8 text-text-muted">
              No user overrides. All users follow the global setting.
            </div>
          ) : (
            <div className="space-y-2">
              {selectedFlagData.userOverrides.map((override) => (
                <div
                  key={override.userId}
                  className="flex items-center justify-between p-3 rounded-lg border border-surface-border"
                >
                  <div>
                    <div className="font-medium text-text-primary">
                      {override.userName || 'Unnamed User'}
                    </div>
                    <div className={`text-sm ${override.enabled ? 'text-green-500' : 'text-red-400'}`}>
                      {override.enabled ? 'Enabled' : 'Disabled'}
                    </div>
                  </div>
                  <button
                    onClick={() => handleRemoveOverride(override.userId, selectedFlagData.feature_key)}
                    disabled={isSettingOverride}
                    className="p-1.5 text-text-muted hover:text-red-400 hover:bg-red-500/10 rounded transition-colors"
                    title="Remove override"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              ))}
            </div>
          )}

          {/* Add Override Form */}
          {showAddOverride && selectedFlagData && (
            <div className="mt-4 p-4 bg-surface-overlay rounded-lg border border-surface-border">
              <h3 className="text-sm font-medium text-text-primary mb-3">Add User Override</h3>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm text-text-muted mb-1">User</label>
                  <select
                    value={selectedUserId}
                    onChange={(e) => setSelectedUserId(e.target.value)}
                    className="w-full bg-surface-elevated text-text-primary border border-surface-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500"
                  >
                    <option value="">Select a user...</option>
                    {profiles
                      .filter(p => !selectedFlagData.userOverrides.some(o => o.userId === p.id))
                      .map((profile) => (
                        <option key={profile.id} value={profile.id}>
                          {profile.full_name || profile.id} ({profile.role})
                        </option>
                      ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm text-text-muted mb-1">Override Value</label>
                  <select
                    value={overrideValue}
                    onChange={(e) => setOverrideValue(e.target.value as 'true' | 'false')}
                    className="w-full bg-surface-elevated text-text-primary border border-surface-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500"
                  >
                    <option value="true">Enabled (show feature)</option>
                    <option value="false">Disabled (hide feature)</option>
                  </select>
                </div>
                <div className="flex gap-2 pt-2">
                  <button
                    onClick={handleAddOverride}
                    disabled={!selectedUserId || isSettingOverride}
                    className="flex-1 px-3 py-2 bg-accent-500 text-white rounded-md text-sm font-medium hover:bg-accent-600 transition-colors disabled:opacity-50"
                  >
                    Add Override
                  </button>
                  <button
                    onClick={() => {
                      setShowAddOverride(false)
                      setSelectedUserId('')
                    }}
                    className="px-3 py-2 border border-surface-border text-text-secondary rounded-md text-sm hover:bg-surface-overlay transition-colors"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
        </section>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
FeatureFlagsPage.tsx exists with global toggle list, per-user override management, Director-only access check, and demo mode message.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add navigation and route</name>
  <files>src/components/layout/Sidebar.tsx, src/App.tsx</files>
  <action>
1. Update src/components/layout/Sidebar.tsx to add Feature Flags link:

Find the navigation items section (look for navItems array or similar). Add a new item for Feature Flags, visible only to Directors (same pattern as User Management):

```typescript
// Import Settings2 icon if not already imported
import { Settings2 } from 'lucide-react'

// In navItems or equivalent, add conditionally:
{canViewUserManagement && (
  <NavLink
    to="/feature-flags"
    className={({ isActive }) =>
      `flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ${
        isActive
          ? 'bg-accent-500/10 text-accent-500'
          : 'text-text-secondary hover:bg-surface-overlay hover:text-text-primary'
      }`
    }
  >
    <Settings2 className="w-5 h-5" />
    {!sidebarCollapsed && <span>Feature Flags</span>}
  </NavLink>
)}
```

Position it near/after User Management in the admin section.

2. Update src/App.tsx to add the route:

Import the page:
```typescript
import { FeatureFlagsPage } from '@/pages/FeatureFlagsPage'
```

Add route inside the Layout wrapper (same level as other pages, before the catch-all):
```typescript
<Route path="feature-flags" element={<FeatureFlagsPage />} />
```
  </action>
  <verify>
1. App builds: `npm run build`
2. Navigation to /feature-flags loads the page
  </verify>
  <done>
Sidebar has Feature Flags link (Director-only), App.tsx has /feature-flags route pointing to FeatureFlagsPage.
  </done>
</task>

</tasks>

<verification>
- [ ] useFeatureFlagAdmin hook exists with all CRUD operations
- [ ] FeatureFlagsPage renders for Directors only
- [ ] Global toggle works (click switches enabled state)
- [ ] User override can be added and removed
- [ ] Sidebar shows Feature Flags link for Directors
- [ ] Route /feature-flags loads correctly
- [ ] Demo mode shows informational message
- [ ] App builds without errors
</verification>

<success_criteria>
- Directors can access Feature Flags page from sidebar
- Directors can toggle global feature visibility
- Directors can add/remove per-user overrides
- Non-Directors are redirected away from the page
- UI matches existing admin page patterns (UserManagementPage)
</success_criteria>

<output>
After completion, create `.planning/phases/40-admin-feature-visibility/40-03-SUMMARY.md`
</output>
