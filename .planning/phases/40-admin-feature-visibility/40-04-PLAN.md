---
phase: 40-admin-feature-visibility
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00031_super_admin_and_global_flags.sql
  - src/lib/supabase/types.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Global feature flags exist without tenant scope"
    - "Super-admin accounts are distinguishable from regular users"
    - "Global flags affect all tenants simultaneously"
    - "Demo tenant has global show_rfi flag seeded"
  artifacts:
    - path: "supabase/migrations/00031_super_admin_and_global_flags.sql"
      provides: "Global feature flags table and super-admin column"
      contains: "global_feature_flags"
    - path: "src/lib/supabase/types.ts"
      provides: "TypeScript types for global flags and super-admin"
      contains: "GlobalFeatureFlagRow"
  key_links:
    - from: "supabase/migrations/00031_super_admin_and_global_flags.sql"
      to: "public.profiles"
      via: "ALTER TABLE"
      pattern: "is_super_admin"
---

<objective>
Create database infrastructure for super-admin accounts and global (tenant-agnostic) feature flags.

Purpose: Enable a developer account that can control feature visibility across ALL tenants, not just their own tenant. This is distinct from the existing Director role which manages features within a single tenant.

Output: Migration with global_feature_flags table, is_super_admin column on profiles, and updated TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/00030_feature_flags.sql
@supabase/migrations/00003_profiles.sql
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create global feature flags migration</name>
  <files>supabase/migrations/00031_super_admin_and_global_flags.sql</files>
  <action>
Create supabase/migrations/00031_super_admin_and_global_flags.sql:

```sql
-- Super-admin flag and global (tenant-agnostic) feature flags
-- Super-admins can toggle features that affect ALL tenants

-- Add is_super_admin column to profiles
-- Super-admins are developer accounts that manage global settings
ALTER TABLE public.profiles
ADD COLUMN is_super_admin BOOLEAN DEFAULT FALSE;

-- Index for super-admin lookups
CREATE INDEX idx_profiles_is_super_admin ON public.profiles(is_super_admin) WHERE is_super_admin = TRUE;

-- Global feature flags table (no tenant_id - affects ALL tenants)
CREATE TABLE public.global_feature_flags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feature_key TEXT NOT NULL UNIQUE,  -- e.g., 'show_rfi', 'show_matrix'
  enabled BOOLEAN DEFAULT TRUE,
  description TEXT,  -- Optional description for admin UI
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for feature lookup
CREATE INDEX idx_global_feature_flags_key ON public.global_feature_flags(feature_key);

-- Enable RLS
ALTER TABLE public.global_feature_flags ENABLE ROW LEVEL SECURITY;

-- RLS Policies:
-- All authenticated users can READ global flags (need to know what's enabled)
CREATE POLICY "global_feature_flags_read" ON public.global_feature_flags
  FOR SELECT TO authenticated
  USING (TRUE);

-- Only super-admins can INSERT global flags
CREATE POLICY "global_feature_flags_superadmin_insert" ON public.global_feature_flags
  FOR INSERT TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.profiles
      WHERE id = auth.uid() AND is_super_admin = TRUE
    )
  );

-- Only super-admins can UPDATE global flags
CREATE POLICY "global_feature_flags_superadmin_update" ON public.global_feature_flags
  FOR UPDATE TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.profiles
      WHERE id = auth.uid() AND is_super_admin = TRUE
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.profiles
      WHERE id = auth.uid() AND is_super_admin = TRUE
    )
  );

-- Only super-admins can DELETE global flags
CREATE POLICY "global_feature_flags_superadmin_delete" ON public.global_feature_flags
  FOR DELETE TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.profiles
      WHERE id = auth.uid() AND is_super_admin = TRUE
    )
  );

-- Grant permissions (RLS policies control actual access)
GRANT SELECT ON public.global_feature_flags TO authenticated;
GRANT INSERT, UPDATE, DELETE ON public.global_feature_flags TO authenticated;

-- Table comment
COMMENT ON TABLE public.global_feature_flags IS 'Global feature visibility flags controllable by super-admins only';
COMMENT ON COLUMN public.profiles.is_super_admin IS 'Developer accounts with cross-tenant admin access';

-- Helper function to check if current user is super-admin
CREATE OR REPLACE FUNCTION public.is_super_admin()
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT COALESCE(
    (SELECT is_super_admin FROM public.profiles WHERE id = auth.uid()),
    FALSE
  );
$$;

COMMENT ON FUNCTION public.is_super_admin() IS 'Returns TRUE if current user is a super-admin';

-- Seed default global RFI feature flag (enabled by default)
INSERT INTO public.global_feature_flags (feature_key, enabled, description)
VALUES ('show_rfi', true, 'Show RFI document button in header')
ON CONFLICT (feature_key) DO NOTHING;
```
  </action>
  <verify>
SQL syntax is valid. Check migration file exists and contains:
- ALTER TABLE profiles ADD COLUMN is_super_admin
- CREATE TABLE global_feature_flags
- RLS policies for super-admin access
- is_super_admin() helper function
- Seed data for show_rfi flag
  </verify>
  <done>
Migration 00031 exists with global_feature_flags table, is_super_admin column, RLS policies restricting write to super-admins, and show_rfi seed data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>src/lib/supabase/types.ts</files>
  <action>
Update src/lib/supabase/types.ts to add types for global feature flags and super-admin:

1. Find the existing types section and add GlobalFeatureFlagRow type:

```typescript
/**
 * Global feature flag row (tenant-agnostic, super-admin controlled)
 */
export interface GlobalFeatureFlagRow {
  id: string
  feature_key: string
  enabled: boolean
  description: string | null
  created_at: string
  updated_at: string
}
```

2. Update the Profile type to include is_super_admin:

Find the Profile interface/type and add:
```typescript
is_super_admin: boolean
```

3. Add global_feature_flags to the Database interface Tables section:

```typescript
global_feature_flags: {
  Row: {
    id: string
    feature_key: string
    enabled: boolean
    description: string | null
    created_at: string
    updated_at: string
  }
  Insert: {
    id?: string
    feature_key: string
    enabled?: boolean
    description?: string | null
    created_at?: string
    updated_at?: string
  }
  Update: {
    id?: string
    feature_key?: string
    enabled?: boolean
    description?: string | null
    created_at?: string
    updated_at?: string
  }
}
```

4. Update profiles Row/Insert/Update to include is_super_admin:
```typescript
// In profiles.Row:
is_super_admin: boolean

// In profiles.Insert:
is_super_admin?: boolean

// In profiles.Update:
is_super_admin?: boolean
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
types.ts has GlobalFeatureFlagRow interface, global_feature_flags table in Database, and is_super_admin in Profile type.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration 00031 exists at supabase/migrations/00031_super_admin_and_global_flags.sql
- [ ] global_feature_flags table has no tenant_id column
- [ ] is_super_admin column added to profiles
- [ ] RLS policies restrict write access to super-admins only
- [ ] is_super_admin() helper function created
- [ ] TypeScript types updated for global flags and super-admin
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- Global feature flags table exists separate from tenant-scoped flags
- Super-admin accounts can be identified via is_super_admin column
- Only super-admins can modify global feature flags
- All authenticated users can read global flags
- TypeScript types reflect new schema
</success_criteria>

<output>
After completion, create `.planning/phases/40-admin-feature-visibility/40-04-SUMMARY.md`
</output>
