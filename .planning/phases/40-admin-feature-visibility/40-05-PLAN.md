---
phase: 40-admin-feature-visibility
plan: 05
type: execute
wave: 2
depends_on: ["40-04"]
files_modified:
  - src/hooks/useFeatureFlags.ts
  - src/pages/admin/AdminFeatureFlagsPage.tsx
  - src/hooks/useGlobalFeatureFlagAdmin.ts
  - src/components/admin/AdminLayout.tsx
  - src/App.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Super-admins can access /admin routes"
    - "Regular users cannot access /admin routes"
    - "Super-admins can toggle global feature flags"
    - "useFeatureFlags checks global flags for all authenticated users"
    - "Demo mode continues to show all features"
  artifacts:
    - path: "src/pages/admin/AdminFeatureFlagsPage.tsx"
      provides: "Super-admin feature flag management UI"
      contains: "AdminFeatureFlagsPage"
    - path: "src/hooks/useGlobalFeatureFlagAdmin.ts"
      provides: "CRUD operations for global flags"
      exports: ["useGlobalFeatureFlagAdmin"]
    - path: "src/components/admin/AdminLayout.tsx"
      provides: "Layout wrapper for admin app"
      contains: "AdminLayout"
    - path: "src/hooks/useFeatureFlags.ts"
      provides: "Updated hook checking global flags"
      contains: "global_feature_flags"
    - path: "src/App.tsx"
      provides: "Admin routes at /admin/*"
      contains: "AdminFeatureFlagsPage"
  key_links:
    - from: "src/pages/admin/AdminFeatureFlagsPage.tsx"
      to: "src/hooks/useGlobalFeatureFlagAdmin.ts"
      via: "hook import"
      pattern: "useGlobalFeatureFlagAdmin"
    - from: "src/components/admin/AdminLayout.tsx"
      to: "is_super_admin"
      via: "auth check"
      pattern: "is_super_admin"
    - from: "src/hooks/useFeatureFlags.ts"
      to: "global_feature_flags"
      via: "supabase query"
      pattern: "from\\('global_feature_flags'\\)"
---

<objective>
Create the super-admin app at /admin/* routes with feature flag management UI and update useFeatureFlags to check global flags.

Purpose: Provide a separate admin interface for developer accounts to manage global feature visibility across all tenants. Regular users are blocked from these routes.

Output: Admin layout with super-admin gate, feature flags admin page, global flag admin hook, and updated consumer hook.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-admin-feature-visibility/40-04-PLAN.md
@src/hooks/useFeatureFlags.ts
@src/pages/FeatureFlagsPage.tsx
@src/hooks/useFeatureFlagAdmin.ts
@src/App.tsx
@src/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useFeatureFlags to check global flags</name>
  <files>src/hooks/useFeatureFlags.ts</files>
  <action>
Update src/hooks/useFeatureFlags.ts to check global_feature_flags table instead of (or in addition to) tenant-scoped flags.

Replace the current implementation with:

```typescript
import { useQuery } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase/client'
import { useAuth } from '@/contexts/AuthContext'
import type { GlobalFeatureFlagRow, FeatureOverrides } from '@/lib/supabase/types'

/**
 * Known feature flags - extend this as new features are added
 */
export type FeatureKey = 'show_rfi'

/**
 * Default feature visibility in demo mode (all features shown)
 */
const DEMO_DEFAULTS: Record<FeatureKey, boolean> = {
  show_rfi: true,
}

/**
 * Hook to check feature visibility
 *
 * Priority: User override > Global flag > Demo default
 *
 * In demo mode (not authenticated), returns DEMO_DEFAULTS
 * In authenticated mode, fetches from database:
 *   1. Global feature flags (affects all tenants)
 *   2. User's feature_overrides from profile (per-user customization)
 *   3. User override wins if set
 */
export function useFeatureFlags() {
  const { session, user } = useAuth()
  const isDemoMode = !session

  // Fetch global feature flags (tenant-agnostic)
  const { data: globalFlags = [] } = useQuery({
    queryKey: ['global-feature-flags'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('global_feature_flags')
        .select('feature_key, enabled')

      if (error) {
        console.error('Error fetching global feature flags:', error)
        return []
      }
      return data as Pick<GlobalFeatureFlagRow, 'feature_key' | 'enabled'>[]
    },
    enabled: !isDemoMode,
    staleTime: 5 * 60 * 1000, // 5 minutes - flags don't change often
  })

  // Fetch user's feature overrides from profile
  const { data: userOverrides } = useQuery({
    queryKey: ['feature-overrides', user?.id],
    queryFn: async () => {
      if (!user?.id) return null

      const { data, error } = await supabase
        .from('profiles')
        .select('feature_overrides')
        .eq('id', user.id)
        .single()

      if (error) {
        console.error('Error fetching feature overrides:', error)
        return null
      }
      return data?.feature_overrides as FeatureOverrides | null
    },
    enabled: !isDemoMode && !!user?.id,
    staleTime: 5 * 60 * 1000,
  })

  /**
   * Check if a feature is enabled
   * @param key Feature key to check
   * @returns true if feature should be visible
   */
  const isFeatureEnabled = (key: FeatureKey): boolean => {
    // Demo mode: use defaults (all features visible)
    if (isDemoMode) {
      return DEMO_DEFAULTS[key] ?? true
    }

    // Check user override first (highest priority)
    if (userOverrides && key in userOverrides) {
      return userOverrides[key]
    }

    // Check global flag
    const globalFlag = globalFlags.find(f => f.feature_key === key)
    if (globalFlag) {
      return globalFlag.enabled
    }

    // Default to visible if not configured
    return true
  }

  return {
    isFeatureEnabled,
    // Convenience accessors for common features
    showRfi: isFeatureEnabled('show_rfi'),
    // Loading state
    isLoading: !isDemoMode && globalFlags.length === 0,
    isDemoMode,
  }
}
```

Key changes:
- Query `global_feature_flags` instead of `feature_flags`
- Query key changed to `['global-feature-flags']`
- Import `GlobalFeatureFlagRow` type
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useFeatureFlags now queries global_feature_flags table for feature visibility, with user overrides taking priority.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useGlobalFeatureFlagAdmin hook</name>
  <files>src/hooks/useGlobalFeatureFlagAdmin.ts</files>
  <action>
Create src/hooks/useGlobalFeatureFlagAdmin.ts for super-admin CRUD operations:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase/client'
import type { GlobalFeatureFlagRow } from '@/lib/supabase/types'

/**
 * Admin hook for managing global feature flags (super-admin only)
 */
export function useGlobalFeatureFlagAdmin() {
  const queryClient = useQueryClient()

  // Fetch all global feature flags
  const {
    data: featureFlags = [],
    isLoading,
    error,
  } = useQuery({
    queryKey: ['global-feature-flags-admin'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('global_feature_flags')
        .select('*')
        .order('feature_key')

      if (error) throw error
      return data as GlobalFeatureFlagRow[]
    },
  })

  // Toggle global flag
  const toggleFlag = useMutation({
    mutationFn: async ({ flagId, enabled }: { flagId: string; enabled: boolean }) => {
      const { error } = await supabase
        .from('global_feature_flags')
        .update({ enabled, updated_at: new Date().toISOString() })
        .eq('id', flagId)

      if (error) throw error
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['global-feature-flags-admin'] })
      queryClient.invalidateQueries({ queryKey: ['global-feature-flags'] })
    },
  })

  // Create new global feature flag
  const createFlag = useMutation({
    mutationFn: async ({
      featureKey,
      enabled,
      description,
    }: {
      featureKey: string
      enabled: boolean
      description?: string
    }) => {
      const { error } = await supabase
        .from('global_feature_flags')
        .insert({ feature_key: featureKey, enabled, description })

      if (error) throw error
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['global-feature-flags-admin'] })
    },
  })

  // Delete global feature flag
  const deleteFlag = useMutation({
    mutationFn: async (flagId: string) => {
      const { error } = await supabase
        .from('global_feature_flags')
        .delete()
        .eq('id', flagId)

      if (error) throw error
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['global-feature-flags-admin'] })
      queryClient.invalidateQueries({ queryKey: ['global-feature-flags'] })
    },
  })

  return {
    featureFlags,
    isLoading,
    error: error?.message ?? null,
    toggleFlag: toggleFlag.mutateAsync,
    createFlag: createFlag.mutateAsync,
    deleteFlag: deleteFlag.mutateAsync,
    isToggling: toggleFlag.isPending,
  }
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useGlobalFeatureFlagAdmin hook exists with query for global flags, toggleFlag mutation, createFlag mutation, and deleteFlag mutation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AdminLayout and AdminFeatureFlagsPage</name>
  <files>src/components/admin/AdminLayout.tsx, src/pages/admin/AdminFeatureFlagsPage.tsx</files>
  <action>
1. Create src/components/admin/AdminLayout.tsx - layout wrapper with super-admin gate:

```typescript
import { Outlet, Navigate } from 'react-router'
import { useQuery } from '@tanstack/react-query'
import { Settings2 } from 'lucide-react'
import { supabase } from '@/lib/supabase/client'
import { useAuth } from '@/contexts/AuthContext'

/**
 * Admin layout - only accessible to super-admins
 */
export function AdminLayout() {
  const { session, user } = useAuth()

  // Check if current user is super-admin
  const { data: isSuperAdmin, isLoading } = useQuery({
    queryKey: ['is-super-admin', user?.id],
    queryFn: async () => {
      if (!user?.id) return false

      const { data, error } = await supabase
        .from('profiles')
        .select('is_super_admin')
        .eq('id', user.id)
        .single()

      if (error) {
        console.error('Error checking super-admin status:', error)
        return false
      }
      return data?.is_super_admin ?? false
    },
    enabled: !!user?.id,
  })

  // Not authenticated - redirect to login
  if (!session) {
    return <Navigate to="/login" replace />
  }

  // Still loading - show spinner
  if (isLoading) {
    return (
      <div className="min-h-screen bg-surface-base flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-500" />
      </div>
    )
  }

  // Not super-admin - redirect to main app
  if (!isSuperAdmin) {
    return <Navigate to="/" replace />
  }

  return (
    <div className="min-h-screen bg-surface-base">
      {/* Admin Header */}
      <header className="h-14 bg-surface-elevated border-b border-surface-border flex items-center px-4">
        <div className="flex items-center gap-3">
          <Settings2 className="h-6 w-6 text-accent-500" />
          <h1 className="text-lg font-semibold text-text-primary">
            RiskLytix Admin
          </h1>
        </div>
      </header>

      {/* Admin Content */}
      <main className="p-6">
        <Outlet />
      </main>
    </div>
  )
}
```

2. Create src/pages/admin/AdminFeatureFlagsPage.tsx:

```typescript
import { Settings2, ToggleLeft, ToggleRight, Plus, Trash2 } from 'lucide-react'
import { useState } from 'react'
import { useGlobalFeatureFlagAdmin } from '@/hooks/useGlobalFeatureFlagAdmin'

/**
 * Super-admin page for managing global feature flags
 */
export function AdminFeatureFlagsPage() {
  const {
    featureFlags,
    isLoading,
    error,
    toggleFlag,
    createFlag,
    deleteFlag,
    isToggling,
  } = useGlobalFeatureFlagAdmin()

  const [showAddForm, setShowAddForm] = useState(false)
  const [newFeatureKey, setNewFeatureKey] = useState('')
  const [newDescription, setNewDescription] = useState('')

  const handleToggle = async (flagId: string, currentEnabled: boolean) => {
    try {
      await toggleFlag({ flagId, enabled: !currentEnabled })
    } catch (err) {
      console.error('Failed to toggle flag:', err)
    }
  }

  const handleCreate = async () => {
    if (!newFeatureKey.trim()) return

    try {
      await createFlag({
        featureKey: newFeatureKey.trim(),
        enabled: true,
        description: newDescription.trim() || undefined,
      })
      setShowAddForm(false)
      setNewFeatureKey('')
      setNewDescription('')
    } catch (err) {
      console.error('Failed to create flag:', err)
    }
  }

  const handleDelete = async (flagId: string) => {
    if (!confirm('Are you sure you want to delete this feature flag?')) return

    try {
      await deleteFlag(flagId)
    } catch (err) {
      console.error('Failed to delete flag:', err)
    }
  }

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      {/* Page header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-text-primary flex items-center gap-3">
            <Settings2 className="h-7 w-7" />
            Global Feature Flags
          </h1>
          <p className="text-text-muted mt-1">
            Control feature visibility across ALL tenants
          </p>
        </div>
        <button
          onClick={() => setShowAddForm(true)}
          className="flex items-center gap-1 px-3 py-1.5 text-sm bg-accent-500 text-white rounded-md hover:bg-accent-600 transition-colors"
        >
          <Plus className="w-4 h-4" />
          Add Flag
        </button>
      </div>

      {/* Add Flag Form */}
      {showAddForm && (
        <div className="bg-surface-elevated rounded-lg border border-surface-border p-4">
          <h3 className="text-sm font-medium text-text-primary mb-3">New Feature Flag</h3>
          <div className="space-y-3">
            <div>
              <label className="block text-sm text-text-muted mb-1">Feature Key</label>
              <input
                type="text"
                value={newFeatureKey}
                onChange={(e) => setNewFeatureKey(e.target.value)}
                placeholder="e.g., show_analytics"
                className="w-full bg-surface-base text-text-primary border border-surface-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500"
              />
            </div>
            <div>
              <label className="block text-sm text-text-muted mb-1">Description (optional)</label>
              <input
                type="text"
                value={newDescription}
                onChange={(e) => setNewDescription(e.target.value)}
                placeholder="What does this flag control?"
                className="w-full bg-surface-base text-text-primary border border-surface-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500"
              />
            </div>
            <div className="flex gap-2 pt-2">
              <button
                onClick={handleCreate}
                disabled={!newFeatureKey.trim()}
                className="flex-1 px-3 py-2 bg-accent-500 text-white rounded-md text-sm font-medium hover:bg-accent-600 transition-colors disabled:opacity-50"
              >
                Create Flag
              </button>
              <button
                onClick={() => {
                  setShowAddForm(false)
                  setNewFeatureKey('')
                  setNewDescription('')
                }}
                className="px-3 py-2 border border-surface-border text-text-secondary rounded-md text-sm hover:bg-surface-overlay transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Flags List */}
      <section className="bg-surface-elevated rounded-lg border border-surface-border p-6">
        <h2 className="text-lg font-medium text-text-primary mb-4">Active Flags</h2>

        {isLoading ? (
          <div className="flex items-center justify-center py-8">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-500" />
          </div>
        ) : error ? (
          <div className="text-center py-8 text-red-400">Error: {error}</div>
        ) : featureFlags.length === 0 ? (
          <div className="text-center py-8 text-text-muted">
            No feature flags configured. Click "Add Flag" to create one.
          </div>
        ) : (
          <div className="space-y-3">
            {featureFlags.map((flag) => (
              <div
                key={flag.id}
                className="flex items-center justify-between p-3 rounded-lg border border-surface-border hover:bg-surface-overlay transition-colors"
              >
                <div className="flex-1">
                  <div className="font-medium text-text-primary">
                    {flag.feature_key}
                  </div>
                  {flag.description && (
                    <div className="text-sm text-text-muted">{flag.description}</div>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => handleToggle(flag.id, flag.enabled)}
                    disabled={isToggling}
                    className="p-1 hover:bg-surface-overlay rounded transition-colors"
                    title={flag.enabled ? 'Disable globally' : 'Enable globally'}
                  >
                    {flag.enabled ? (
                      <ToggleRight className="w-8 h-8 text-green-500" />
                    ) : (
                      <ToggleLeft className="w-8 h-8 text-text-muted" />
                    )}
                  </button>
                  <button
                    onClick={() => handleDelete(flag.id)}
                    className="p-1.5 text-text-muted hover:text-red-400 hover:bg-red-500/10 rounded transition-colors"
                    title="Delete flag"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>

      {/* Info Box */}
      <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 text-sm text-blue-300">
        <strong>Note:</strong> Changes to global flags affect all tenants immediately.
        Individual users can still have per-user overrides set by their tenant Directors.
      </div>
    </div>
  )
}
```
  </action>
  <verify>
- Files exist at correct paths
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
AdminLayout exists with super-admin gate, AdminFeatureFlagsPage exists with toggle controls and CRUD operations.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add admin routes to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Update src/App.tsx to add admin routes:

1. Add imports at the top:
```typescript
import { AdminLayout } from '@/components/admin/AdminLayout'
import { AdminFeatureFlagsPage } from '@/pages/admin/AdminFeatureFlagsPage'
```

2. Add admin routes BEFORE the closing Routes tag (after the TesterLayout routes, before </Routes>):

```typescript
{/* Super-admin routes */}
<Route path="admin" element={<AdminLayout />}>
  <Route index element={<Navigate to="/admin/feature-flags" replace />} />
  <Route path="feature-flags" element={<AdminFeatureFlagsPage />} />
</Route>
```

Note: Admin routes are NOT inside ProtectedRoute because AdminLayout handles its own authentication check (checks is_super_admin).
  </action>
  <verify>
1. App builds: `npm run build`
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
App.tsx has /admin/* routes pointing to AdminLayout, with /admin/feature-flags route for AdminFeatureFlagsPage.
  </done>
</task>

</tasks>

<verification>
- [ ] useFeatureFlags queries global_feature_flags table
- [ ] useGlobalFeatureFlagAdmin hook has CRUD operations
- [ ] AdminLayout checks is_super_admin and redirects non-admins
- [ ] AdminFeatureFlagsPage renders with toggle controls
- [ ] App.tsx has /admin/* routes
- [ ] Regular users redirected from /admin routes
- [ ] Demo mode still shows all features
- [ ] App builds without errors
</verification>

<success_criteria>
- Super-admins can access /admin/feature-flags
- Regular users are redirected away from /admin routes
- Super-admins can toggle global feature flags
- Global flag changes affect feature visibility for all tenants
- useFeatureFlags correctly reads from global_feature_flags
- Demo mode continues to show all features by default
</success_criteria>

<output>
After completion, create `.planning/phases/40-admin-feature-visibility/40-05-SUMMARY.md`
</output>
