---
phase: 41-control-tester-visibility-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/controls/ControlDetailPanel.tsx
  - supabase/seed-scripts/41-01-fix-assigned-tester-ids.sql
autonomous: true

must_haves:
  truths:
    - "Demo mode assignment dropdown shows real profile names (Alice Tester, Bob Tester, Carol Tester)"
    - "Demo mode assignment stores actual UUIDs, not mock strings"
    - "Existing controls with mock string IDs are migrated to valid UUIDs"
    - "Control Testers can see controls assigned to them in My Controls"
  artifacts:
    - path: "src/components/controls/ControlDetailPanel.tsx"
      provides: "Demo tester constants with real UUIDs"
      contains: "DEMO_TESTERS"
    - path: "supabase/seed-scripts/41-01-fix-assigned-tester-ids.sql"
      provides: "Migration to fix existing mock string assignments"
      contains: "UPDATE controls"
  key_links:
    - from: "src/components/controls/ControlDetailPanel.tsx"
      to: "supabase/seed-scripts/38-02-demo-profiles.sql"
      via: "UUID matching"
      pattern: "a1b2c3d4-e5f6-7890-abcd-ef123456789"
---

<objective>
Fix control tester visibility by correcting ID mismatches in assignment system

Purpose: Control Testers cannot see their assigned controls because the demo mode dropdown uses mock string IDs ("tester-1") while real queries match against UUIDs. This breaks the assignment -> visibility chain.

Output: Updated ControlDetailPanel with real UUIDs for demo testers, migration script to fix existing data
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-control-tester-visibility-fix/41-RESEARCH.md

# Key files to understand the fix
@src/components/controls/ControlDetailPanel.tsx
@supabase/seed-scripts/38-02-demo-profiles.sql
@src/hooks/useControls.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update demo mode assignment dropdown to use real profile UUIDs</name>
  <files>src/components/controls/ControlDetailPanel.tsx</files>
  <action>
Replace the hardcoded mock string options ("tester-1", "tester-2", "tester-3") in the demo mode assignment dropdown with a constant array that uses the actual demo profile UUIDs from the 38-02 seed script.

1. Add a DEMO_TESTERS constant at the top of the file (after imports):
```typescript
// Demo profile UUIDs from supabase/seed-scripts/38-02-demo-profiles.sql
const DEMO_TESTERS = [
  { id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567891', name: 'Alice Tester' },
  { id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567892', name: 'Bob Tester' },
  { id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567893', name: 'Carol Tester' },
] as const
```

2. Update the isDemoMode conditional in the assignment dropdown (around lines 816-821) to use DEMO_TESTERS.map() instead of hardcoded option elements:
```typescript
{isDemoMode ? (
  DEMO_TESTERS.map(tester => (
    <option key={tester.id} value={tester.id}>
      {tester.name}
    </option>
  ))
) : (
  controlTesters.map(tester => (
    <option key={tester.id} value={tester.id}>
      {tester.full_name || tester.id}
    </option>
  ))
)}
```

This ensures demo mode assignments use real UUIDs that will match when queried.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Visually inspect the code diff to confirm:
- DEMO_TESTERS constant is defined with 3 entries
- UUIDs match those in 38-02-demo-profiles.sql
- Dropdown renders tester.name (not "Tester 1")
  </verify>
  <done>
Demo mode assignment dropdown shows "Alice Tester", "Bob Tester", "Carol Tester" with corresponding real UUIDs as values
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration script to fix existing mock string assignments</name>
  <files>supabase/seed-scripts/41-01-fix-assigned-tester-ids.sql</files>
  <action>
Create a SQL migration script that updates any existing controls with mock string assigned_tester_id values ("tester-1", "tester-2", "tester-3") to use the real demo profile UUIDs.

The script should:
1. Map "tester-1" -> 'a1b2c3d4-e5f6-7890-abcd-ef1234567891' (Alice Tester)
2. Map "tester-2" -> 'a1b2c3d4-e5f6-7890-abcd-ef1234567892' (Bob Tester)
3. Map "tester-3" -> 'a1b2c3d4-e5f6-7890-abcd-ef1234567893' (Carol Tester)
4. Only update controls in the demo tenant (5ea03edb-6e79-4b62-bd36-39f1963d0640)
5. Report how many rows were updated

```sql
-- Fix assigned_tester_id values that use mock strings instead of real profile UUIDs
-- Phase 41-01: Control Tester Visibility Fix
--
-- Problem: Demo mode dropdown previously used "tester-1", "tester-2", "tester-3"
-- but actual queries use UUID-based user.id values.
--
-- This migration updates existing controls to use the correct demo profile UUIDs.

DO $$
DECLARE
  demo_tenant_id UUID := '5ea03edb-6e79-4b62-bd36-39f1963d0640';
  rows_updated INTEGER;
BEGIN
  -- Update tester-1 -> Alice Tester UUID
  UPDATE public.controls
  SET assigned_tester_id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567891'
  WHERE assigned_tester_id = 'tester-1'
  AND tenant_id = demo_tenant_id;
  GET DIAGNOSTICS rows_updated = ROW_COUNT;
  IF rows_updated > 0 THEN
    RAISE NOTICE 'Updated % controls from tester-1 to Alice Tester UUID', rows_updated;
  END IF;

  -- Update tester-2 -> Bob Tester UUID
  UPDATE public.controls
  SET assigned_tester_id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567892'
  WHERE assigned_tester_id = 'tester-2'
  AND tenant_id = demo_tenant_id;
  GET DIAGNOSTICS rows_updated = ROW_COUNT;
  IF rows_updated > 0 THEN
    RAISE NOTICE 'Updated % controls from tester-2 to Bob Tester UUID', rows_updated;
  END IF;

  -- Update tester-3 -> Carol Tester UUID
  UPDATE public.controls
  SET assigned_tester_id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567893'
  WHERE assigned_tester_id = 'tester-3'
  AND tenant_id = demo_tenant_id;
  GET DIAGNOSTICS rows_updated = ROW_COUNT;
  IF rows_updated > 0 THEN
    RAISE NOTICE 'Updated % controls from tester-3 to Carol Tester UUID', rows_updated;
  END IF;

  RAISE NOTICE 'Migration complete: mock string assigned_tester_id values updated to real UUIDs';
END $$;

-- Verification query (run manually to confirm):
-- SELECT name, assigned_tester_id
-- FROM public.controls
-- WHERE tenant_id = '5ea03edb-6e79-4b62-bd36-39f1963d0640'
-- AND assigned_tester_id IS NOT NULL;
```
  </action>
  <verify>
Verify the SQL script is syntactically correct by reviewing:
- Uses DO block pattern consistent with other seed scripts
- Demo tenant UUID matches (5ea03edb-6e79-4b62-bd36-39f1963d0640)
- Demo tester UUIDs match 38-02-demo-profiles.sql
- Includes verification query comment
  </verify>
  <done>
Migration script created that converts mock string IDs to real profile UUIDs for demo tenant controls
  </done>
</task>

<task type="auto">
  <name>Task 3: Run build and document manual migration step</name>
  <files></files>
  <action>
1. Run `npm run build` to verify no TypeScript errors in the updated ControlDetailPanel.tsx

2. Add a pending todo to STATE.md noting the migration script needs to be run:
   "Run supabase/seed-scripts/41-01-fix-assigned-tester-ids.sql to migrate existing mock string assignments"

The migration script is idempotent (safe to run multiple times) and only affects the demo tenant, so it can be run via Supabase SQL Editor or CLI when convenient.

Note: The profiles table FK constraint to auth.users may prevent demo profiles from existing in production. This is acceptable - the fix primarily ensures NEW assignments use correct UUIDs. For production users, the invite flow creates proper auth.users + profiles atomically.
  </action>
  <verify>
`npm run build` completes without errors. STATE.md updated with pending todo for migration.
  </verify>
  <done>
Build passes with no TypeScript errors. Migration step documented in STATE.md pending todos section.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Code verification:**
   - `npm run build` passes
   - DEMO_TESTERS constant uses UUIDs matching 38-02 seed script
   - Dropdown renders proper names (Alice, Bob, Carol)

2. **Logic verification:**
   - New demo mode assignments will use UUIDs, not mock strings
   - Query in useMyAssignedControls will match UUID-based assigned_tester_id
   - TesterHeader auto-selection continues to work (uses useControlTesters which returns profile UUIDs)

3. **Migration script verification:**
   - Script syntax is valid SQL
   - Only affects demo tenant
   - Handles all three mock string values
</verification>

<success_criteria>
- Build passes with no TypeScript errors
- ControlDetailPanel demo mode dropdown uses real profile UUIDs
- Migration script exists to fix existing mock string assignments
- STATE.md documents pending migration step
</success_criteria>

<output>
After completion, create `.planning/phases/41-control-tester-visibility-fix/41-01-SUMMARY.md`
</output>
