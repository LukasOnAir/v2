---
phase: 43-signup-button-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00032_anon_global_flags_read.sql
  - src/hooks/useFeatureFlags.ts
  - src/hooks/usePublicFeatureFlags.ts
  - src/pages/LoginPage.tsx
autonomous: true

must_haves:
  truths:
    - "Super-admin can toggle signup button on/off from admin panel"
    - "Login page shows signup link when show_signup flag is enabled"
    - "Login page hides signup link when show_signup flag is disabled"
    - "Unauthenticated visitors see correct button state (no session required)"
    - "Default state is signup visible (backwards compatible)"
  artifacts:
    - path: "supabase/migrations/00032_anon_global_flags_read.sql"
      provides: "Anon SELECT policy on global_feature_flags + show_signup flag seed"
      contains: "anon"
    - path: "src/hooks/usePublicFeatureFlags.ts"
      provides: "Hook for unauthenticated pages to check global flags"
      exports: ["usePublicFeatureFlags"]
    - path: "src/hooks/useFeatureFlags.ts"
      provides: "Updated with show_signup FeatureKey"
      contains: "show_signup"
    - path: "src/pages/LoginPage.tsx"
      provides: "Conditional signup link rendering"
      contains: "usePublicFeatureFlags"
  key_links:
    - from: "src/pages/LoginPage.tsx"
      to: "src/hooks/usePublicFeatureFlags.ts"
      via: "import and hook call"
      pattern: "usePublicFeatureFlags"
    - from: "src/hooks/usePublicFeatureFlags.ts"
      to: "global_feature_flags table"
      via: "Supabase query"
      pattern: "from\\('global_feature_flags'\\)"
---

<objective>
Enable super-admin control of signup button visibility on the login page.

Purpose: Allow super-admin to disable public signup when the application is in invite-only mode (e.g., enterprise deployment) while keeping signup available for demo/open registration scenarios.

Output:
- Database migration adding anon read policy and seeding show_signup flag
- New usePublicFeatureFlags hook for unauthenticated flag checking
- Updated useFeatureFlags with show_signup type
- LoginPage with conditional signup link
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@supabase/migrations/00031_super_admin_and_global_flags.sql
@src/hooks/useFeatureFlags.ts
@src/pages/LoginPage.tsx
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for anon access and show_signup flag</name>
  <files>supabase/migrations/00032_anon_global_flags_read.sql</files>
  <action>
Create migration that:

1. Add anon SELECT policy on global_feature_flags:
```sql
DROP POLICY IF EXISTS "global_feature_flags_anon_read" ON public.global_feature_flags;
CREATE POLICY "global_feature_flags_anon_read" ON public.global_feature_flags
  FOR SELECT TO anon
  USING (TRUE);
```

2. Grant SELECT to anon role:
```sql
GRANT SELECT ON public.global_feature_flags TO anon;
```

3. Seed the show_signup flag (enabled=true by default for backwards compatibility):
```sql
INSERT INTO public.global_feature_flags (feature_key, enabled, description)
VALUES ('show_signup', true, 'Show signup link on login page for public registration')
ON CONFLICT (feature_key) DO NOTHING;
```

Add appropriate comments explaining that this enables unauthenticated users (login page visitors) to check feature flags.
  </action>
  <verify>SQL file exists with valid syntax. Run `npx supabase db lint` if available, otherwise visual inspection of SQL structure.</verify>
  <done>Migration file 00032_anon_global_flags_read.sql exists with anon SELECT policy and show_signup flag seed.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePublicFeatureFlags hook and update FeatureKey type</name>
  <files>src/hooks/usePublicFeatureFlags.ts, src/hooks/useFeatureFlags.ts</files>
  <action>
**Update src/hooks/useFeatureFlags.ts:**

1. Add 'show_signup' to FeatureKey type:
```typescript
export type FeatureKey = 'show_rfi' | 'show_signup'
```

2. Add show_signup to DEMO_DEFAULTS (true - show all features in demo):
```typescript
const DEMO_DEFAULTS: Record<FeatureKey, boolean> = {
  show_rfi: true,
  show_signup: true,
}
```

3. Add showSignup convenience accessor to return value (alongside existing showRfi):
```typescript
return {
  isFeatureEnabled,
  showRfi: isFeatureEnabled('show_rfi'),
  showSignup: isFeatureEnabled('show_signup'),
  isLoading: !isDemoMode && globalFlags.length === 0,
  isDemoMode,
}
```

**Create src/hooks/usePublicFeatureFlags.ts:**

Create a lightweight hook for unauthenticated pages (login, signup) that:
- Does NOT depend on useAuth or session
- Queries global_feature_flags directly using anonymous Supabase access
- Returns simple object: { showSignup: boolean, isLoading: boolean }
- Defaults to true while loading (show button to avoid flash of missing content)

```typescript
import { useQuery } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase/client'

/**
 * Feature flags for unauthenticated pages (login, signup)
 * Uses anonymous Supabase access to read global feature flags
 *
 * Note: This hook does NOT check user session - it's for public pages only
 */
export function usePublicFeatureFlags() {
  const { data: flags = [], isLoading } = useQuery({
    queryKey: ['public-feature-flags'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('global_feature_flags')
        .select('feature_key, enabled')

      if (error) {
        console.error('Error fetching public feature flags:', error)
        return []
      }
      return data ?? []
    },
    staleTime: 5 * 60 * 1000, // 5 minutes - flags don't change often
    gcTime: 30 * 60 * 1000, // 30 minutes cache
  })

  const showSignup = flags.find(f => f.feature_key === 'show_signup')?.enabled ?? true

  return {
    showSignup,
    isLoading,
  }
}
```

Key design decisions:
- Default to true (show signup) when loading or on error - backwards compatible
- No dependency on AuthContext (avoids circular dependency issues on login page)
- Simple return type focused on what public pages need
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`. Check that both hooks export correctly.</verify>
  <done>FeatureKey includes 'show_signup', DEMO_DEFAULTS has show_signup: true, usePublicFeatureFlags hook exports showSignup boolean.</done>
</task>

<task type="auto">
  <name>Task 3: Update LoginPage with conditional signup link</name>
  <files>src/pages/LoginPage.tsx</files>
  <action>
Update LoginPage to conditionally show signup link based on feature flag:

1. Import the new hook at top of file:
```typescript
import { usePublicFeatureFlags } from '@/hooks/usePublicFeatureFlags'
```

2. Call hook inside component (before any conditional returns):
```typescript
const { showSignup, isLoading: flagsLoading } = usePublicFeatureFlags()
```

3. Replace the current help text section (around line 277-281) which says:
```jsx
<motion.div variants={itemVariants} className="text-center">
  <span className="text-text-muted text-sm">
    Need access? Contact your organization's Director for an invitation.
  </span>
</motion.div>
```

With conditional signup link:
```jsx
<motion.div variants={itemVariants} className="text-center">
  {showSignup ? (
    <span className="text-text-muted text-sm">
      Don't have an account?{' '}
      <Link
        to="/signup"
        className="text-accent-500 hover:text-accent-400 transition-colors"
      >
        Sign up
      </Link>
    </span>
  ) : (
    <span className="text-text-muted text-sm">
      Need access? Contact your organization's Director for an invitation.
    </span>
  )}
</motion.div>
```

Design notes:
- While flags are loading, showSignup defaults to true (show the link) to avoid content flash
- When signup is disabled, show the invitation message instead
- Link uses existing accent color styling pattern from forgot password link
  </action>
  <verify>Run `npm run dev` and visit /login page. Verify: (1) Signup link visible by default, (2) Link navigates to /signup, (3) No console errors.</verify>
  <done>LoginPage shows "Sign up" link when show_signup enabled, shows invitation message when disabled.</done>
</task>

</tasks>

<verification>
1. **Migration validation**: SQL file has valid syntax with anon policy and show_signup seed
2. **Type safety**: `npx tsc --noEmit` passes - FeatureKey includes show_signup
3. **Hook functionality**: usePublicFeatureFlags returns { showSignup: true, isLoading: false } after initial load
4. **UI verification**: Visit /login - signup link visible (default state)
5. **Admin toggle**: From super-admin panel, toggle show_signup off - login page should hide signup link
6. **No regression**: Authenticated users' feature flags still work (showRfi toggle)
</verification>

<success_criteria>
- [ ] Migration 00032 creates anon SELECT policy on global_feature_flags
- [ ] Migration seeds show_signup flag with enabled=true
- [ ] FeatureKey type includes 'show_signup'
- [ ] usePublicFeatureFlags hook works without authentication
- [ ] LoginPage shows signup link when flag enabled (default)
- [ ] LoginPage shows invitation message when flag disabled
- [ ] Super-admin can toggle the flag from existing AdminFeatureFlagsPage
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-signup-button-visibility/43-01-SUMMARY.md`
</output>
