---
phase: 44-super-admin-tenant-switching
plan: 02
type: execute
wave: 2
depends_on: [44-01]
files_modified:
  - src/components/admin/ImpersonationBanner.tsx
  - src/components/admin/TenantSwitcher.tsx
  - src/components/admin/ProfileSwitcher.tsx
  - src/pages/admin/AdminTenantsPage.tsx
  - src/hooks/useTenants.ts
autonomous: true

must_haves:
  truths:
    - "Super-admin can view list of all tenants"
    - "Super-admin can select a tenant to view as"
    - "Super-admin can view profiles within selected tenant"
    - "Banner shows current impersonation state"
  artifacts:
    - path: "src/components/admin/ImpersonationBanner.tsx"
      provides: "Visual indicator for impersonation state"
      exports: ["ImpersonationBanner"]
    - path: "src/components/admin/TenantSwitcher.tsx"
      provides: "Tenant selection list"
      exports: ["TenantSwitcher"]
    - path: "src/components/admin/ProfileSwitcher.tsx"
      provides: "Profile selection within tenant"
      exports: ["ProfileSwitcher"]
    - path: "src/pages/admin/AdminTenantsPage.tsx"
      provides: "Admin page for tenant/profile browsing"
      exports: ["AdminTenantsPage"]
    - path: "src/hooks/useTenants.ts"
      provides: "Hook for fetching all tenants"
      exports: ["useTenants"]
  key_links:
    - from: "src/pages/admin/AdminTenantsPage.tsx"
      to: "src/components/admin/TenantSwitcher.tsx"
      via: "component import"
      pattern: "TenantSwitcher"
    - from: "src/pages/admin/AdminTenantsPage.tsx"
      to: "src/components/admin/ProfileSwitcher.tsx"
      via: "component import"
      pattern: "ProfileSwitcher"
---

<objective>
Create the admin UI components for tenant/profile impersonation: banner indicator, tenant list, profile list, and admin page.

Purpose: Super-admins need a UI to browse tenants, select one to impersonate, and optionally select a specific profile within that tenant. A visible banner must show the current impersonation state.

Output: ImpersonationBanner component, TenantSwitcher component, ProfileSwitcher component, AdminTenantsPage, and useTenants hook for data fetching.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-super-admin-tenant-switching/44-RESEARCH.md

# Dependency from 44-01
@.planning/phases/44-super-admin-tenant-switching/44-01-SUMMARY.md

# Existing patterns to follow
@src/components/admin/AdminLayout.tsx
@src/components/admin/UserTable.tsx
@src/pages/admin/AdminFeatureFlagsPage.tsx
@src/components/tester/OfflineIndicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTenants hook for fetching all tenants</name>
  <files>src/hooks/useTenants.ts</files>
  <action>
Create data hook for fetching all tenants (super-admin only).

Implementation:
```typescript
import { useQuery } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase/client'

interface Tenant {
  id: string
  name: string
  createdAt: string
}

export function useTenants() {
  return useQuery({
    queryKey: ['tenants'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('tenants')
        .select('id, name, created_at')
        .order('name')

      if (error) throw error
      return data.map(t => ({
        id: t.id,
        name: t.name,
        createdAt: t.created_at,
      })) as Tenant[]
    },
  })
}
```

Note: This query will only return data if the user is a super-admin (RLS policy from 44-01 migration restricts access).

Also create useProfilesByTenant hook in the same file:
```typescript
interface Profile {
  id: string
  name: string
  email: string
  role: string
  isActive: boolean
}

export function useProfilesByTenant(tenantId: string | null) {
  return useQuery({
    queryKey: ['profiles', 'tenant', tenantId],
    queryFn: async () => {
      if (!tenantId) return []

      const { data, error } = await supabase
        .from('profiles')
        .select('id, name, email, role, is_active')
        .eq('tenant_id', tenantId)
        .order('name')

      if (error) throw error
      return data.map(p => ({
        id: p.id,
        name: p.name || p.email,
        email: p.email,
        role: p.role,
        isActive: p.is_active,
      })) as Profile[]
    },
    enabled: !!tenantId,
  })
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>useTenants and useProfilesByTenant hooks export from src/hooks/useTenants.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create ImpersonationBanner component</name>
  <files>src/components/admin/ImpersonationBanner.tsx</files>
  <action>
Create a prominent banner that displays when super-admin is impersonating a tenant/profile.

Design requirements:
1. Amber/warning color scheme (bg-amber-500 text-amber-950)
2. Fixed position at top of viewport (before all other content)
3. Shows: "Viewing as: [Tenant Name]" and optionally "[Profile Name] ([Role])"
4. Shows "(Read-only mode)" reminder
5. Exit button to stop impersonation
6. Icons: Eye for viewing, User for profile, X for exit

Implementation:
```typescript
import { Eye, X, User } from 'lucide-react'
import { useImpersonation } from '@/contexts/ImpersonationContext'

export function ImpersonationBanner() {
  const { impersonation, isImpersonating, exitImpersonation } = useImpersonation()

  if (!isImpersonating) return null

  return (
    <div className="bg-amber-500 text-amber-950 px-4 py-2 flex items-center justify-center gap-4">
      <div className="flex items-center gap-2">
        <Eye className="w-4 h-4" />
        <span className="font-medium">Viewing as:</span>
        <span>{impersonation.tenantName}</span>
        {impersonation.profileName && (
          <>
            <User className="w-4 h-4 ml-2" />
            <span>{impersonation.profileName}</span>
            {impersonation.profileRole && (
              <span className="text-amber-700">({impersonation.profileRole})</span>
            )}
          </>
        )}
        <span className="text-amber-800 ml-2">(Read-only mode)</span>
      </div>
      <button
        onClick={exitImpersonation}
        className="flex items-center gap-1 px-2 py-1 rounded bg-amber-600 hover:bg-amber-700 text-white text-sm transition-colors"
      >
        <X className="w-4 h-4" />
        Exit
      </button>
    </div>
  )
}
```

Export as named export.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>ImpersonationBanner shows tenant name, optional profile name/role, read-only indicator, and exit button</done>
</task>

<task type="auto">
  <name>Task 3: Create TenantSwitcher, ProfileSwitcher, and AdminTenantsPage</name>
  <files>src/components/admin/TenantSwitcher.tsx, src/components/admin/ProfileSwitcher.tsx, src/pages/admin/AdminTenantsPage.tsx</files>
  <action>
Create three files:

**1. TenantSwitcher.tsx** - List of tenants with selection
```typescript
import { Building2, Eye } from 'lucide-react'
import { useTenants } from '@/hooks/useTenants'
import { useImpersonation } from '@/contexts/ImpersonationContext'

interface TenantSwitcherProps {
  onTenantSelect?: (tenantId: string) => void
}

export function TenantSwitcher({ onTenantSelect }: TenantSwitcherProps) {
  const { data: tenants, isLoading, error } = useTenants()
  const { impersonation, startTenantImpersonation } = useImpersonation()

  const handleSelect = (tenantId: string, tenantName: string) => {
    startTenantImpersonation(tenantId, tenantName)
    onTenantSelect?.(tenantId)
  }

  if (isLoading) return <div className="text-text-secondary">Loading tenants...</div>
  if (error) return <div className="text-red-500">Error loading tenants</div>

  return (
    <div className="space-y-2">
      <h3 className="text-sm font-medium text-text-secondary uppercase tracking-wide">
        Select Tenant
      </h3>
      <div className="space-y-1">
        {tenants?.map(tenant => (
          <button
            key={tenant.id}
            onClick={() => handleSelect(tenant.id, tenant.name)}
            className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-colors ${
              impersonation.tenantId === tenant.id
                ? 'bg-accent-500/20 text-accent-400'
                : 'hover:bg-surface-elevated text-text-primary'
            }`}
          >
            <Building2 className="w-4 h-4 text-text-secondary" />
            <span className="flex-1">{tenant.name}</span>
            {impersonation.tenantId === tenant.id && (
              <Eye className="w-4 h-4 text-accent-400" />
            )}
          </button>
        ))}
        {tenants?.length === 0 && (
          <div className="text-text-secondary text-sm py-2">No tenants found</div>
        )}
      </div>
    </div>
  )
}
```

**2. ProfileSwitcher.tsx** - List of profiles within selected tenant
```typescript
import { User, Eye, UserCheck } from 'lucide-react'
import { useProfilesByTenant } from '@/hooks/useTenants'
import { useImpersonation } from '@/contexts/ImpersonationContext'

interface ProfileSwitcherProps {
  tenantId: string | null
}

export function ProfileSwitcher({ tenantId }: ProfileSwitcherProps) {
  const { data: profiles, isLoading, error } = useProfilesByTenant(tenantId)
  const { impersonation, selectProfile } = useImpersonation()

  if (!tenantId) {
    return (
      <div className="text-text-secondary text-sm">
        Select a tenant first to view profiles
      </div>
    )
  }

  if (isLoading) return <div className="text-text-secondary">Loading profiles...</div>
  if (error) return <div className="text-red-500">Error loading profiles</div>

  return (
    <div className="space-y-2">
      <h3 className="text-sm font-medium text-text-secondary uppercase tracking-wide">
        Select Profile (Optional)
      </h3>
      <p className="text-xs text-text-secondary">
        Impersonating a profile shows you their exact view based on role
      </p>
      <div className="space-y-1">
        {profiles?.map(profile => (
          <button
            key={profile.id}
            onClick={() => selectProfile(profile.id, profile.name, profile.role)}
            disabled={!profile.isActive}
            className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-colors ${
              impersonation.profileId === profile.id
                ? 'bg-accent-500/20 text-accent-400'
                : profile.isActive
                  ? 'hover:bg-surface-elevated text-text-primary'
                  : 'opacity-50 cursor-not-allowed text-text-secondary'
            }`}
          >
            <User className="w-4 h-4 text-text-secondary" />
            <div className="flex-1">
              <div>{profile.name}</div>
              <div className="text-xs text-text-secondary">{profile.email}</div>
            </div>
            <span className={`text-xs px-2 py-0.5 rounded ${
              profile.role === 'director' ? 'bg-purple-500/20 text-purple-400' :
              profile.role === 'manager' ? 'bg-blue-500/20 text-blue-400' :
              profile.role === 'risk-manager' ? 'bg-green-500/20 text-green-400' :
              profile.role === 'control-owner' ? 'bg-yellow-500/20 text-yellow-400' :
              'bg-gray-500/20 text-gray-400'
            }`}>
              {profile.role}
            </span>
            {impersonation.profileId === profile.id && (
              <Eye className="w-4 h-4 text-accent-400" />
            )}
            {!profile.isActive && (
              <span className="text-xs text-red-400">Inactive</span>
            )}
          </button>
        ))}
        {profiles?.length === 0 && (
          <div className="text-text-secondary text-sm py-2">No profiles in this tenant</div>
        )}
      </div>
    </div>
  )
}
```

**3. AdminTenantsPage.tsx** - Page combining both switchers
```typescript
import { useNavigate } from 'react-router'
import { ArrowRight, Shield } from 'lucide-react'
import { TenantSwitcher } from '@/components/admin/TenantSwitcher'
import { ProfileSwitcher } from '@/components/admin/ProfileSwitcher'
import { useImpersonation } from '@/contexts/ImpersonationContext'

export function AdminTenantsPage() {
  const navigate = useNavigate()
  const { impersonation, isImpersonating } = useImpersonation()

  const handleViewAsTenant = () => {
    // Navigate to main app to see the impersonated view
    navigate('/')
  }

  return (
    <div className="max-w-4xl">
      <div className="flex items-center gap-3 mb-6">
        <Shield className="w-6 h-6 text-accent-500" />
        <h1 className="text-2xl font-bold text-text-primary">
          Tenant Impersonation
        </h1>
      </div>

      <p className="text-text-secondary mb-6">
        View the application as any tenant or user to verify their experience.
        All actions are read-only while impersonating.
      </p>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Tenant Selection */}
        <div className="bg-surface-elevated border border-surface-border rounded-lg p-4">
          <TenantSwitcher />
        </div>

        {/* Profile Selection */}
        <div className="bg-surface-elevated border border-surface-border rounded-lg p-4">
          <ProfileSwitcher tenantId={impersonation.tenantId} />
        </div>
      </div>

      {/* Action Button */}
      {isImpersonating && (
        <div className="mt-6">
          <button
            onClick={handleViewAsTenant}
            className="flex items-center gap-2 px-4 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg transition-colors"
          >
            View as {impersonation.tenantName}
            {impersonation.profileName && ` (${impersonation.profileName})`}
            <ArrowRight className="w-4 h-4" />
          </button>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>TenantSwitcher shows tenant list, ProfileSwitcher shows profiles within tenant, AdminTenantsPage combines both with navigation button</done>
</task>

</tasks>

<verification>
1. useTenants.ts exports useTenants and useProfilesByTenant hooks
2. ImpersonationBanner.tsx exports ImpersonationBanner component
3. TenantSwitcher.tsx exports TenantSwitcher component
4. ProfileSwitcher.tsx exports ProfileSwitcher component
5. AdminTenantsPage.tsx exports AdminTenantsPage component
6. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- useTenants hook fetches all tenants (super-admin RLS restricts access)
- useProfilesByTenant hook fetches profiles within a specific tenant
- ImpersonationBanner displays current impersonation state with exit button
- TenantSwitcher allows selecting a tenant to impersonate
- ProfileSwitcher allows selecting a profile within the selected tenant
- AdminTenantsPage provides complete UI for tenant/profile browsing
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/44-super-admin-tenant-switching/44-02-SUMMARY.md`
</output>
