---
phase: 44-super-admin-tenant-switching
plan: 04
type: execute
wave: 3
depends_on: [44-02, 44-03]
files_modified:
  - src/App.tsx
  - src/components/admin/AdminLayout.tsx
  - src/components/layout/Layout.tsx
autonomous: false

must_haves:
  truths:
    - "ImpersonationProvider wraps the app tree"
    - "Banner appears when impersonating"
    - "Admin tenants page is accessible"
    - "Super-admin can complete full impersonation flow"
  artifacts:
    - path: "src/App.tsx"
      provides: "App with ImpersonationProvider"
      contains: "ImpersonationProvider"
    - path: "src/components/admin/AdminLayout.tsx"
      provides: "Admin layout with banner and nav"
      contains: "ImpersonationBanner"
  key_links:
    - from: "src/App.tsx"
      to: "src/contexts/ImpersonationContext.tsx"
      via: "provider import"
      pattern: "ImpersonationProvider"
    - from: "src/components/admin/AdminLayout.tsx"
      to: "src/components/admin/ImpersonationBanner.tsx"
      via: "component import"
      pattern: "ImpersonationBanner"
---

<objective>
Integrate all impersonation components into the application: wrap App with ImpersonationProvider, add banner to AdminLayout and main Layout, add tenants page route, and verify the complete flow.

Purpose: Connect all the pieces built in previous plans to create a working end-to-end impersonation feature. User should be able to select a tenant, optionally select a profile, navigate to main app, see the banner, and see that tenant's data.

Output: Fully integrated impersonation feature ready for testing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-super-admin-tenant-switching/44-RESEARCH.md
@.planning/phases/44-super-admin-tenant-switching/44-01-SUMMARY.md
@.planning/phases/44-super-admin-tenant-switching/44-02-SUMMARY.md
@.planning/phases/44-super-admin-tenant-switching/44-03-SUMMARY.md

# Files to modify
@src/App.tsx
@src/components/admin/AdminLayout.tsx
@src/components/layout/Layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap App with ImpersonationProvider</name>
  <files>src/App.tsx</files>
  <action>
Add ImpersonationProvider to the App component tree.

**Import:**
```typescript
import { ImpersonationProvider } from '@/contexts/ImpersonationContext'
```

**Wrap the provider:**
The ImpersonationProvider should wrap inside AuthProvider but around everything else that might use impersonation. Place it right after AuthProvider:

```typescript
<ErrorBoundary FallbackComponent={ErrorFallback} onError={handleError}>
  <QueryProvider>
    <AuthProvider>
      <ImpersonationProvider>  {/* Add this */}
        <RealtimeProvider>
          {/* ... rest of app ... */}
        </RealtimeProvider>
      </ImpersonationProvider>  {/* Add this */}
    </AuthProvider>
  </QueryProvider>
</ErrorBoundary>
```

**Add tenants route to admin section:**
```typescript
import { AdminTenantsPage } from '@/pages/admin/AdminTenantsPage'

// In Routes, admin section:
<Route path="admin" element={<AdminLayout />}>
  <Route index element={<Navigate to="/admin/feature-flags" replace />} />
  <Route path="feature-flags" element={<AdminFeatureFlagsPage />} />
  <Route path="tenants" element={<AdminTenantsPage />} />  {/* Add this */}
</Route>
```

This allows super-admins to access /admin/tenants to manage impersonation.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>App.tsx wraps with ImpersonationProvider and has /admin/tenants route</done>
</task>

<task type="auto">
  <name>Task 2: Update AdminLayout with banner and navigation</name>
  <files>src/components/admin/AdminLayout.tsx</files>
  <action>
Update AdminLayout to include the ImpersonationBanner and navigation to tenants page.

**Imports:**
```typescript
import { Link, useLocation } from 'react-router'
import { ImpersonationBanner } from '@/components/admin/ImpersonationBanner'
import { Building2, Flag } from 'lucide-react'
```

**Add ImpersonationBanner at the very top (before header):**
```typescript
return (
  <div className="min-h-screen bg-surface-base">
    <ImpersonationBanner />  {/* Add this at very top */}

    {/* Admin Header */}
    <header className="h-14 bg-surface-elevated border-b border-surface-border flex items-center px-4">
      {/* ... existing header content ... */}
    </header>
    {/* ... */}
  </div>
)
```

**Add navigation links in header:**
Replace the simple header content with navigation:
```typescript
<header className="h-14 bg-surface-elevated border-b border-surface-border flex items-center px-4 justify-between">
  <div className="flex items-center gap-3">
    <Settings2 className="h-6 w-6 text-accent-500" />
    <h1 className="text-lg font-semibold text-text-primary">
      RiskLytix Admin
    </h1>
  </div>

  {/* Navigation */}
  <nav className="flex items-center gap-4">
    <NavLink to="/admin/feature-flags" icon={Flag} label="Feature Flags" />
    <NavLink to="/admin/tenants" icon={Building2} label="Tenants" />
  </nav>
</header>
```

**Add NavLink helper component (inside the file):**
```typescript
function NavLink({ to, icon: Icon, label }: { to: string; icon: React.ComponentType<{ className?: string }>; label: string }) {
  const location = useLocation()
  const isActive = location.pathname === to

  return (
    <Link
      to={to}
      className={`flex items-center gap-2 px-3 py-1.5 rounded-lg transition-colors ${
        isActive
          ? 'bg-accent-500/20 text-accent-400'
          : 'text-text-secondary hover:text-text-primary hover:bg-surface-elevated'
      }`}
    >
      <Icon className="w-4 h-4" />
      <span className="text-sm">{label}</span>
    </Link>
  )
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>AdminLayout shows ImpersonationBanner at top and has navigation to Feature Flags and Tenants pages</done>
</task>

<task type="auto">
  <name>Task 3: Add banner to main Layout for impersonation visibility</name>
  <files>src/components/layout/Layout.tsx</files>
  <action>
Add ImpersonationBanner to the main Layout so users see the impersonation indicator when viewing the main app as another tenant.

**Import:**
```typescript
import { ImpersonationBanner } from '@/components/admin/ImpersonationBanner'
```

**Add at very top of Layout return:**
The banner should appear above the Header, so it's the first thing visible:

Look for the return statement in Layout and add ImpersonationBanner at the very top of the outermost div:

```typescript
return (
  <div className="min-h-screen bg-surface-base flex flex-col">
    <ImpersonationBanner />  {/* Add this at very top */}
    <Header />
    {/* ... rest of layout ... */}
  </div>
)
```

This ensures the impersonation banner is visible when super-admin navigates from admin panel to main app while impersonating.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Main Layout shows ImpersonationBanner at top when impersonating</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete tenant impersonation feature:
1. Database RLS policies allowing super-admin cross-tenant read access
2. ImpersonationContext for state management with sessionStorage persistence
3. useEffectiveTenant hook combining auth + impersonation
4. All 15 data hooks modified with effectiveTenantId in queryKey and explicit filtering
5. Mutation hooks block changes in read-only mode
6. ImpersonationBanner showing current impersonation state
7. Admin tenants page with tenant/profile selection UI
8. Navigation in admin header to switch between pages
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Ensure you have at least 2 tenants in the database
- Ensure you have a super-admin account (is_super_admin = true in profiles)
- Apply migration: `npx supabase db push` (if not auto-applied)

**Test Flow:**
1. Log in as super-admin
2. Navigate to /admin
3. Click "Tenants" in navigation bar
4. Verify: List of all tenants appears
5. Click on a tenant to select it
6. Verify: Tenant row shows Eye icon indicating selection
7. Verify: Profiles list appears on right side
8. (Optional) Click a profile to impersonate specific user
9. Click "View as [Tenant]" button
10. Verify: Main app loads with amber banner at top showing "Viewing as: [Tenant Name]"
11. Verify: Data shown is from the impersonated tenant (not your own)
12. Navigate to RCT, Controls, Taxonomy pages - all should show impersonated tenant's data
13. Try to edit something (e.g., change a score in RCT)
14. Verify: Toast error "Cannot modify data while viewing as another user"
15. Click "Exit" button in banner
16. Verify: Banner disappears
17. Verify: Data returns to super-admin view (likely empty since super-admin has no tenant)
18. Refresh the page
19. Navigate back to /admin/tenants
20. Verify: Previous impersonation state is preserved (sessionStorage persistence)

**Failure modes to check:**
- Selecting tenant does not clear profile selection from previous tenant
- Query cache shows stale data from previously viewed tenant
- Mutations succeed despite read-only mode
- Banner doesn't appear in main app after navigating from admin
  </how-to-verify>
  <resume-signal>Type "approved" if the impersonation flow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. App.tsx imports and uses ImpersonationProvider
2. App.tsx has /admin/tenants route
3. AdminLayout imports and renders ImpersonationBanner
4. AdminLayout has navigation links to Feature Flags and Tenants
5. Main Layout renders ImpersonationBanner
6. TypeScript compiles: `npx tsc --noEmit`
7. Human verification of complete flow
</verification>

<success_criteria>
- ImpersonationProvider wraps the entire app inside AuthProvider
- /admin/tenants route accessible to super-admins
- ImpersonationBanner appears in both admin and main layouts when impersonating
- Admin navigation includes links to Feature Flags and Tenants pages
- Complete impersonation flow verified by human tester
- Data isolation works (sees impersonated tenant's data only)
- Read-only mode enforced (mutations blocked)
- Session persistence works (refresh doesn't lose impersonation state)
</success_criteria>

<output>
After completion, create `.planning/phases/44-super-admin-tenant-switching/44-04-SUMMARY.md`
</output>
