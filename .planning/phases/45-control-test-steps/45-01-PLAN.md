---
phase: 45-control-test-steps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00035_test_steps.sql
  - src/lib/supabase/types.ts
  - src/types/rct.ts
  - src/hooks/useControls.ts
  - src/hooks/useControlTests.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Controls table has test_steps JSONB column"
    - "Control tests table has step_responses JSONB column"
    - "TypeScript types include TestStep and StepResponse interfaces"
    - "useControls hook returns testSteps field when present"
    - "useControlTests hook returns stepResponses field when present"
  artifacts:
    - path: "supabase/migrations/00035_test_steps.sql"
      provides: "Database schema for test steps"
      contains: "ALTER TABLE public.controls"
    - path: "src/types/rct.ts"
      provides: "TestStep and StepResponse type definitions"
      contains: "TestStepInputType"
    - path: "src/hooks/useControls.ts"
      provides: "Updated toControl transformer with testSteps"
      contains: "testSteps"
  key_links:
    - from: "src/hooks/useControls.ts"
      to: "src/types/rct.ts"
      via: "import TestStep type"
      pattern: "testSteps.*TestStep"
---

<objective>
Add database schema and TypeScript types for structured test steps.

Purpose: Establish the data foundation for storing test step configurations on controls and step responses on test records. This enables guided, repeatable testing workflows.

Output: Migration file for JSONB columns, updated TypeScript types, and hooks that handle the new fields.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/45-control-test-steps/45-RESEARCH.md

@src/types/rct.ts
@src/hooks/useControls.ts
@src/hooks/useControlTests.ts
@src/lib/supabase/types.ts
@supabase/migrations/00015_controls.sql
@supabase/migrations/00018_control_tests.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for test steps columns</name>
  <files>supabase/migrations/00035_test_steps.sql</files>
  <action>
Create migration that adds:
1. `test_steps` JSONB column on `public.controls` table (DEFAULT NULL for backward compatibility)
2. `step_responses` JSONB column on `public.control_tests` table (DEFAULT NULL)
3. Index for querying controls with defined steps

Follow existing migration patterns from 00015_controls.sql and 00019_remediation_plans.sql.

JSONB structure for test_steps: `[{id, label, inputType, options, required, helpText, order}]`
JSONB structure for step_responses: `[{stepId, value, cannotRecord, cannotRecordReason, evidenceUrl, recordedAt}]`

Add COMMENT ON COLUMN for documentation.
  </action>
  <verify>File exists at supabase/migrations/00035_test_steps.sql with valid SQL syntax</verify>
  <done>Migration file contains ALTER TABLE statements for both columns with appropriate defaults and comments</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript type definitions for test steps</name>
  <files>src/types/rct.ts</files>
  <action>
Add to src/types/rct.ts:

1. `TestStepInputType` union type: `'text' | 'binary' | 'multiple_choice' | 'number' | 'date'`

2. `TestStep` interface:
   - id: string (UUID for stable identity)
   - label: string (display text)
   - inputType: TestStepInputType
   - options?: string[] (for multiple_choice)
   - required: boolean
   - helpText?: string
   - order: number (0-indexed)

3. `StepResponse` interface:
   - stepId: string (references TestStep.id)
   - value: string | number | boolean | null
   - cannotRecord: boolean
   - cannotRecordReason?: string
   - evidenceUrl?: string
   - recordedAt: string (ISO timestamp)

4. Update `Control` interface:
   - Add `testSteps?: TestStep[]` (optional for backward compatibility)

5. Update `ControlTest` interface:
   - Add `stepResponses?: StepResponse[]` (optional)

Place new types BEFORE the Control interface definition so they're available.
  </action>
  <verify>`grep -n "TestStepInputType\|TestStep\|StepResponse" src/types/rct.ts` shows all type definitions</verify>
  <done>All five type additions present: TestStepInputType, TestStep, StepResponse, Control.testSteps, ControlTest.stepResponses</done>
</task>

<task type="auto">
  <name>Task 3: Update hooks to handle test steps fields</name>
  <files>src/hooks/useControls.ts, src/hooks/useControlTests.ts, src/lib/supabase/types.ts</files>
  <action>
1. In src/lib/supabase/types.ts:
   - Add `test_steps` to ControlRow type (JSONB maps to any/unknown, cast in transformer)
   - Add `step_responses` to ControlTestRow type (if exists, otherwise note in types)

2. In src/hooks/useControls.ts:
   - Update `toControl` transformer: add `testSteps: row.test_steps ?? undefined`
   - Update `useAddControl` mutationFn: include `test_steps: control.testSteps || null`
   - Update `useUpdateControl` mutationFn: add mapping for `testSteps` to `test_steps`

3. In src/hooks/useControlTests.ts:
   - Update the toControlTest transformer (or equivalent): add `stepResponses: row.step_responses ?? undefined`
   - Update record test mutation to include `step_responses` if provided

Ensure JSONB fields are passed directly to Supabase (it handles serialization).
  </action>
  <verify>
`grep -n "test_steps\|testSteps" src/hooks/useControls.ts` shows mappings in transformer and mutations
`grep -n "step_responses\|stepResponses" src/hooks/useControlTests.ts` shows mapping
  </verify>
  <done>Hooks correctly transform JSONB columns to/from TypeScript types, existing functionality unchanged</done>
</task>

</tasks>

<verification>
- [ ] Migration file has valid SQL (no syntax errors)
- [ ] TypeScript compiles without errors (`npm run build` passes type checking)
- [ ] New types exported from src/types/rct.ts
- [ ] Controls without test_steps continue to work (undefined, not error)
- [ ] Control tests without step_responses continue to work
</verification>

<success_criteria>
1. Database migration adds test_steps and step_responses JSONB columns
2. TypeScript types define TestStep, StepResponse, and related interfaces
3. Hooks transform database rows to include new optional fields
4. Backward compatibility: existing controls/tests work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/45-control-test-steps/45-01-SUMMARY.md`
</output>
