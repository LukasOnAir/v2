---
phase: 45-control-test-steps
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - src/components/controls/TestStepsEditor.tsx
  - src/components/controls/TestStepItem.tsx
  - src/components/controls/AddStepDialog.tsx
  - src/components/controls/ControlDetailPanel.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Risk Manager can add a new test step with label and input type"
    - "Risk Manager can reorder test steps via drag-and-drop"
    - "Risk Manager can edit existing test step label, type, options"
    - "Risk Manager can delete a test step"
    - "Changes persist to database when saved"
    - "Controls without steps show empty state with add button"
  artifacts:
    - path: "src/components/controls/TestStepsEditor.tsx"
      provides: "Main step editor with dnd-kit integration"
      min_lines: 80
    - path: "src/components/controls/TestStepItem.tsx"
      provides: "Sortable individual step item"
      min_lines: 40
    - path: "src/components/controls/AddStepDialog.tsx"
      provides: "Dialog for adding/editing step configuration"
      min_lines: 100
  key_links:
    - from: "src/components/controls/ControlDetailPanel.tsx"
      to: "src/components/controls/TestStepsEditor.tsx"
      via: "import and render"
      pattern: "TestStepsEditor"
    - from: "src/components/controls/TestStepsEditor.tsx"
      to: "@dnd-kit/sortable"
      via: "drag-drop reordering"
      pattern: "useSortable"
---

<objective>
Create the Controls Hub UI for defining structured test steps on a control.

Purpose: Enable Risk Managers to define step-by-step test procedures with configurable input types. This replaces or supplements the free-text test procedure with guided testing steps.

Output: TestStepsEditor component integrated into ControlDetailPanel, with full CRUD and drag-drop reordering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/45-control-test-steps/45-RESEARCH.md
@.planning/phases/45-control-test-steps/45-01-SUMMARY.md

@src/components/controls/ControlDetailPanel.tsx
@src/components/rct/ColumnManager.tsx
@src/types/rct.ts
@src/hooks/useControls.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestStepItem sortable component</name>
  <files>src/components/controls/TestStepItem.tsx</files>
  <action>
Create a sortable step item component following ColumnManager.tsx pattern:

```typescript
interface TestStepItemProps {
  step: TestStep
  onEdit: (step: TestStep) => void
  onDelete: (stepId: string) => void
  disabled?: boolean
}
```

Structure:
1. Use `useSortable` hook from @dnd-kit/sortable with step.id as identifier
2. Apply CSS.Transform.toString(transform) for drag styling
3. Layout: drag handle (GripVertical) | step label | input type badge | edit button | delete button
4. Input type badges with colors:
   - text: blue-500/20
   - binary: green-500/20
   - multiple_choice: purple-500/20
   - number: orange-500/20
   - date: cyan-500/20
5. Show required indicator (*) if step.required is true
6. Drag handle uses {...attributes} {...listeners} from useSortable
7. opacity: 0.5 when isDragging

Use existing Tailwind patterns from ColumnManager.tsx for consistent styling.
  </action>
  <verify>File exists with useSortable hook, GripVertical import, and type badge styling</verify>
  <done>TestStepItem renders sortable step with drag handle, type badge, edit/delete buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create AddStepDialog for step configuration</name>
  <files>src/components/controls/AddStepDialog.tsx</files>
  <action>
Create dialog for adding/editing test steps using @radix-ui/react-dialog:

```typescript
interface AddStepDialogProps {
  isOpen: boolean
  onClose: () => void
  onSave: (step: Omit<TestStep, 'id' | 'order'>) => void
  editingStep?: TestStep  // If provided, editing mode
}
```

Form fields:
1. Label (required text input) - what the tester sees
2. Input Type (required select dropdown):
   - text - "Text (free-form response)"
   - binary - "Yes/No (binary choice)"
   - multiple_choice - "Multiple Choice (pick one)"
   - number - "Number (numeric value)"
   - date - "Date (calendar picker)"
3. Options (conditional, only for multiple_choice):
   - Text input for adding option
   - List of current options with delete buttons
   - Add button to append new option
4. Required (checkbox) - whether step must be completed
5. Help Text (optional textarea) - guidance for tester

Validation:
- Label must not be empty
- Multiple choice must have at least 2 options

Dialog has Cancel and Save buttons. Save calls onSave with step data (without id/order, parent assigns those).

Match existing dialog patterns from ControlDetailPanel.tsx (header, content padding, button styles).
  </action>
  <verify>File has Dialog.Root, form fields for all input types, options management for multiple_choice</verify>
  <done>AddStepDialog allows configuring all step properties with validation</done>
</task>

<task type="auto">
  <name>Task 3: Create TestStepsEditor and integrate into ControlDetailPanel</name>
  <files>src/components/controls/TestStepsEditor.tsx, src/components/controls/ControlDetailPanel.tsx</files>
  <action>
**TestStepsEditor.tsx:**

```typescript
interface TestStepsEditorProps {
  controlId: string
  steps: TestStep[]
  onChange: (steps: TestStep[]) => void
  disabled?: boolean
}
```

Implementation:
1. DndContext with closestCenter collision detection
2. SortableContext with verticalListSortingStrategy
3. handleDragEnd uses arrayMove and re-indexes order field
4. "Add Step" button opens AddStepDialog
5. Map steps to TestStepItem components
6. Empty state: "No test steps defined. Add steps to guide testers through structured testing."
7. Sensors: PointerSensor, KeyboardSensor (match ColumnManager.tsx)

When adding step:
- Generate UUID with crypto.randomUUID()
- Set order = steps.length (appends at end)
- Call onChange with [...steps, newStep]

When editing step:
- Open AddStepDialog with editingStep prop
- On save, replace step in array, call onChange

When deleting step:
- Filter out step, re-index remaining steps' order field

**ControlDetailPanel.tsx integration:**

Add a "Test Steps" section after the existing test procedure textarea:

1. Import TestStepsEditor
2. Add section header "Test Steps" with count badge
3. Render TestStepsEditor with:
   - controlId={control.id}
   - steps={control.testSteps || []}
   - onChange={(steps) => doUpdateControl({ testSteps: steps })}
   - disabled={!canEditControlDefinitions}
4. Position between test procedure and testing schedule fields
5. Add collapsible behavior similar to other sections (optional, can be always expanded)

The test procedure textarea remains for backward compatibility - controls can have both free-text and structured steps.
  </action>
  <verify>
`grep -n "TestStepsEditor" src/components/controls/ControlDetailPanel.tsx` shows import and usage
TestStepsEditor.tsx has DndContext, SortableContext, and AddStepDialog integration
  </verify>
  <done>TestStepsEditor component with full CRUD operations integrated into ControlDetailPanel</done>
</task>

</tasks>

<verification>
- [ ] TestStepItem renders with drag handle and is draggable
- [ ] AddStepDialog opens and validates all input type configurations
- [ ] Multiple choice step requires at least 2 options
- [ ] Steps can be added, edited, reordered, and deleted
- [ ] Changes persist via doUpdateControl when steps are modified
- [ ] Controls without testSteps show empty array (no errors)
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. TestStepItem is a fully functional sortable item with edit/delete
2. AddStepDialog supports all 5 input types with appropriate configuration
3. TestStepsEditor provides complete CRUD with drag-drop reordering
4. ControlDetailPanel shows test steps section for Risk Managers
5. Saving steps persists to database via existing useUpdateControl hook
</success_criteria>

<output>
After completion, create `.planning/phases/45-control-test-steps/45-02-SUMMARY.md`
</output>
