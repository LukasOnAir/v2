---
phase: 45-control-test-steps
plan: 04
type: execute
wave: 3
depends_on: ["45-02", "45-03"]
files_modified:
  - src/components/rct/TestStepsDisplay.tsx
  - src/components/rct/ControlPanel.tsx
  - src/components/rct/ControlTestSection.tsx
autonomous: false

must_haves:
  truths:
    - "RCT control panel shows test steps in read-only view"
    - "Test history shows step responses for each test"
    - "Steps displayed in order with input type indicator"
    - "Cannot record steps show reason in history"
    - "Per-step evidence links shown in test details"
  artifacts:
    - path: "src/components/rct/TestStepsDisplay.tsx"
      provides: "Read-only test steps list"
      min_lines: 40
    - path: "src/components/rct/ControlPanel.tsx"
      provides: "Integrated TestStepsDisplay"
      contains: "TestStepsDisplay"
  key_links:
    - from: "src/components/rct/ControlPanel.tsx"
      to: "src/components/rct/TestStepsDisplay.tsx"
      via: "import and render"
      pattern: "TestStepsDisplay"
---

<objective>
Add read-only test steps display to RCT control panel and enhance test history to show step responses.

Purpose: Allow users viewing controls in the RCT to see defined test steps without editing capability. Show step-by-step test results in test history for complete audit trail.

Output: TestStepsDisplay component, ControlPanel integration, ControlTestSection enhancement for step responses.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/45-control-test-steps/45-RESEARCH.md
@.planning/phases/45-control-test-steps/45-02-SUMMARY.md
@.planning/phases/45-control-test-steps/45-03-SUMMARY.md

@src/components/rct/ControlPanel.tsx
@src/components/rct/ControlTestSection.tsx
@src/types/rct.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestStepsDisplay read-only component</name>
  <files>src/components/rct/TestStepsDisplay.tsx</files>
  <action>
Create read-only display component for test steps:

```typescript
interface TestStepsDisplayProps {
  steps: TestStep[]
}
```

Layout:
1. Section header: "Test Steps ({count})" with ClipboardList icon
2. Ordered list (ol) with numbered steps
3. Each step shows:
   - Step number and label
   - Input type badge (same color scheme as TestStepItem)
   - Required indicator (red *) if step.required
   - Help text in muted smaller font if present
4. Empty state if no steps: return null (don't render section)

Input type badge colors (consistent with TestStepItem):
- text: bg-blue-500/20 text-blue-400
- binary: bg-green-500/20 text-green-400
- multiple_choice: bg-purple-500/20 text-purple-400
- number: bg-orange-500/20 text-orange-400
- date: bg-cyan-500/20 text-cyan-400

Sort steps by order field before rendering.

Styling:
- Use existing RCT panel patterns (bg-surface-overlay, rounded-lg)
- Compact layout suitable for side panel
- text-sm for step labels
  </action>
  <verify>File exists with ordered list, type badges, required indicators</verify>
  <done>TestStepsDisplay renders read-only step list with type badges and required indicators</done>
</task>

<task type="auto">
  <name>Task 2: Integrate TestStepsDisplay into ControlPanel</name>
  <files>src/components/rct/ControlPanel.tsx</files>
  <action>
Add TestStepsDisplay to the RCT ControlPanel:

1. Import TestStepsDisplay at top of file

2. For each control (both embedded row.controls and linkedControls), add TestStepsDisplay after the description/notes section and before ControlTestSection:

```tsx
{/* Test Steps (read-only display) */}
{control.testSteps && control.testSteps.length > 0 && (
  <div className="mt-3 pt-3 border-t border-surface-border">
    <TestStepsDisplay steps={control.testSteps} />
  </div>
)}
```

3. Position between Notes section and ControlTestSection

4. Repeat for both the row.controls.map and linkedControls.map sections

The display is purely read-only - editing happens in ControlDetailPanel (Controls Hub).
  </action>
  <verify>
`grep -n "TestStepsDisplay" src/components/rct/ControlPanel.tsx` shows import and usage in both control sections
  </verify>
  <done>ControlPanel shows TestStepsDisplay for controls with defined test steps</done>
</task>

<task type="auto">
  <name>Task 3: Enhance ControlTestSection to show step responses in history</name>
  <files>src/components/rct/ControlTestSection.tsx</files>
  <action>
Enhance test history display to show step-by-step responses:

1. When rendering test history items, check if test has stepResponses:

```tsx
{test.stepResponses && test.stepResponses.length > 0 && (
  <div className="mt-2 pt-2 border-t border-surface-border/50">
    <p className="text-xs text-text-muted mb-1">Step Responses:</p>
    <div className="space-y-1">
      {test.stepResponses.map((response, idx) => (
        <StepResponseItem key={response.stepId} response={response} index={idx} />
      ))}
    </div>
  </div>
)}
```

2. Create inline StepResponseItem helper:
```tsx
function StepResponseItem({ response, index }: { response: StepResponse; index: number }) {
  return (
    <div className="text-xs flex items-start gap-2">
      <span className="text-text-muted w-4">{index + 1}.</span>
      {response.cannotRecord ? (
        <div className="flex-1">
          <span className="text-amber-400">Cannot record:</span>
          <span className="text-text-secondary ml-1">{response.cannotRecordReason}</span>
        </div>
      ) : (
        <div className="flex-1">
          <span className="text-text-primary">
            {formatStepValue(response.value)}
          </span>
          {response.evidenceUrl && (
            <a
              href={response.evidenceUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="ml-2 text-accent-400 hover:text-accent-300"
            >
              [evidence]
            </a>
          )}
        </div>
      )}
    </div>
  )
}

function formatStepValue(value: string | number | boolean | null): string {
  if (value === null || value === undefined) return '(no response)'
  if (typeof value === 'boolean') return value ? 'Yes' : 'No'
  return String(value)
}
```

3. Import StepResponse type from @/types/rct

4. The step responses are already loaded via useTestHistory hook (from 45-01 changes to hooks).

This provides an audit trail showing exactly how each step was completed.
  </action>
  <verify>
`grep -n "stepResponses\|StepResponseItem" src/components/rct/ControlTestSection.tsx` shows response rendering
Test history items with step responses display step-by-step details
  </verify>
  <done>ControlTestSection shows step responses in test history with cannot-record handling and evidence links</done>
</task>

</tasks>

<verification>
- [ ] TestStepsDisplay shows steps sorted by order
- [ ] Type badges have correct colors
- [ ] Required steps marked with asterisk
- [ ] ControlPanel shows TestStepsDisplay for controls with steps
- [ ] Controls without steps don't show empty section
- [ ] Test history shows step-by-step responses when present
- [ ] Cannot record responses show reason in amber
- [ ] Per-step evidence links are clickable
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. TestStepsDisplay renders read-only step list in ControlPanel
2. Test history shows complete step responses for audit trail
3. Cannot record steps display reason explanation
4. Per-step evidence URLs are accessible
5. Backward compatibility: tests without step responses show normally
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete structured test steps feature:
- Database schema for test steps and responses
- Controls Hub editor for defining test steps (add/edit/reorder/delete)
- Mobile wizard extended with dynamic procedure steps
- RCT panel read-only display of test steps
- Test history with step-by-step responses
  </what-built>
  <how-to-verify>
1. **Controls Hub (ControlDetailPanel):**
   - Open a control in Controls Hub
   - Scroll to Test Steps section
   - Click "Add Step" and create steps with different input types:
     - Text step: "Describe the control implementation"
     - Binary step: "Is the control documented?" (required)
     - Multiple choice: "Control effectiveness" with options "High", "Medium", "Low"
     - Number step: "Count of exceptions found"
     - Date step: "Last audit date"
   - Drag to reorder steps
   - Edit a step to change its configuration
   - Delete a step
   - Verify steps persist after page refresh

2. **RCT Control Panel:**
   - Open RCT and click on a row's controls
   - For the control with steps, verify Test Steps section shows
   - Verify read-only display matches what was configured

3. **Mobile Test Wizard:**
   - Click "Record Test" on a control with steps
   - Verify wizard shows: Review > Step1 > Step2 > ... > Result > Evidence > Submit
   - Test each input type renders correctly
   - Test "Cannot record" toggle shows reason textarea
   - Verify required steps block Next button until completed
   - Complete test and submit

4. **Test History:**
   - View test history for the completed test
   - Verify step responses are shown
   - Verify cannot record steps show reason
   - Verify evidence links work

5. **Backward Compatibility:**
   - Open a control WITHOUT test steps
   - Verify standard 4-step wizard still works
   - Verify Controls Hub shows empty Test Steps section with add button
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/45-control-test-steps/45-04-SUMMARY.md`
</output>
